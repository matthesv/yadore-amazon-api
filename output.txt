Projekt:Wordpress Plugin yadore-amazon-api
Deine Rolle: Du hast diese Anwendung für mich programmiert. Bitte unterstütze mich bei der Optimierung und Erweiterung des Codes.
Anforderungen:
1. Vollständige Dateien bereitstellen:
- Wenn Änderungen an einer Datei notwendig sind, gib mir bitte stets die vollständige Datei zurück.
2. Sinnvolle Architektur bedenken:
- Nicht zu viel Code in einer Datei, damit der Code gut gewartet werden kann.
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\yadore-amazon-api.php 
 
<?php
/**
 * Plugin Name: Yadore-Amazon-API
 * Plugin URI: https://github.com/matthesv/yadore-amazon-api
 * Description: Universelles Affiliate-Plugin für Yadore und Amazon PA-API 5.0 mit Redis-Caching, eigenen Produkten und vollständiger Backend-Konfiguration.
 * Version: 1.2.5
 * Author: Matthes Vogel
 * Author URI: https://example.com
 * Text Domain: yadore-amazon-api
 * Domain Path: /languages
 * Requires at least: 6.0
 * Requires PHP: 8.1
 * License: GPL v2 or later
 * * GitHub Plugin URI: https://github.com/matthesv/yadore-amazon-api
 * Primary Branch: main
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

// Plugin Constants
define('YAA_VERSION', '1.2.5');
define('YAA_PLUGIN_PATH', plugin_dir_path(__FILE__));
define('YAA_PLUGIN_URL', plugin_dir_url(__FILE__));
define('YAA_PLUGIN_BASENAME', plugin_basename(__FILE__));
define('YAA_PLUGIN_FILE', __FILE__);

/**
 * Load plugin textdomain
 */
function yaa_load_textdomain(): void {
    load_plugin_textdomain('yadore-amazon-api', false, dirname(YAA_PLUGIN_BASENAME) . '/languages');
}
add_action('plugins_loaded', 'yaa_load_textdomain');

/**
 * Get plugin option with default
 */
function yaa_get_option(string $key, mixed $default = ''): mixed {
    $options = get_option('yaa_settings', []);
    return $options[$key] ?? $default;
}

/**
 * Get cache time settings
 */
function yaa_get_cache_time(): int {
    $hours = (int) yaa_get_option('cache_duration', 6);
    return max(1, $hours) * 3600;
}

function yaa_get_fallback_time(): int {
    $hours = (int) yaa_get_option('fallback_duration', 24);
    return max(1, $hours) * 3600;
}

// =========================================
// AUTOLOAD CLASSES
// =========================================
require_once YAA_PLUGIN_PATH . 'includes/class-cache-handler.php';
require_once YAA_PLUGIN_PATH . 'includes/class-yadore-api.php';
require_once YAA_PLUGIN_PATH . 'includes/class-amazon-paapi.php';
require_once YAA_PLUGIN_PATH . 'includes/class-custom-products.php';
require_once YAA_PLUGIN_PATH . 'includes/class-shortcode-renderer.php';
require_once YAA_PLUGIN_PATH . 'includes/class-admin.php';

// =========================================
// PLUGIN UPDATE CHECKER (GitHub)
// =========================================
if (file_exists(YAA_PLUGIN_PATH . 'includes/plugin-update-checker/plugin-update-checker.php')) {
    require_once YAA_PLUGIN_PATH . 'includes/plugin-update-checker/plugin-update-checker.php';
    
    $yaaUpdateChecker = \YahnisElsts\PluginUpdateChecker\v5\PucFactory::buildUpdateChecker(
        'https://github.com/matthesv/yadore-amazon-api/',
        YAA_PLUGIN_FILE,
        'yadore-amazon-api'
    );
    
    $yaaUpdateChecker->setBranch('main');
    
    $github_token = defined('YAA_GITHUB_TOKEN') ? YAA_GITHUB_TOKEN : yaa_get_option('github_token', '');
    if (!empty($github_token)) {
        $yaaUpdateChecker->setAuthentication($github_token);
    }
}

/**
 * Main Plugin Class - PHP 8.3+ compatible
 */
final class Yadore_Amazon_API_Plugin {
    
    private static ?self $instance = null;
    
    public readonly YAA_Cache_Handler $cache;
    public readonly YAA_Yadore_API $yadore_api;
    public readonly YAA_Amazon_PAAPI $amazon_api;
    public readonly YAA_Custom_Products $custom_products;
    public readonly YAA_Shortcode_Renderer $shortcode;
    public readonly YAA_Admin $admin;
    
    public static function get_instance(): self {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    private function __construct() {
        $this->init_components();
        $this->register_hooks();
    }
    
    private function init_components(): void {
        $this->cache           = new YAA_Cache_Handler();
        $this->yadore_api      = new YAA_Yadore_API($this->cache);
        $this->amazon_api      = new YAA_Amazon_PAAPI($this->cache);
        $this->custom_products = new YAA_Custom_Products();
        $this->shortcode       = new YAA_Shortcode_Renderer(
            $this->yadore_api, 
            $this->amazon_api, 
            $this->cache,
            $this->custom_products
        );
        $this->admin           = new YAA_Admin($this->cache, $this->yadore_api, $this->amazon_api);
    }
    
    private function register_hooks(): void {
        register_activation_hook(YAA_PLUGIN_FILE, [$this, 'activate']);
        register_deactivation_hook(YAA_PLUGIN_FILE, [$this, 'deactivate']);
        
        add_action('wp_enqueue_scripts', [$this, 'enqueue_frontend_assets']);
        add_action('yaa_cache_refresh_event', [$this, 'preload_cache']);
    }
    
    public function activate(): void {
        // Default settings
        $defaults = [
            // Yadore Settings
            'enable_yadore'          => 'yes',
            'yadore_api_key'         => '',
            'yadore_market'          => 'de',
            'yadore_precision'       => 'fuzzy',
            'yadore_default_limit'   => 9,
            
            // Amazon Settings
            'enable_amazon'          => 'yes',
            'amazon_access_key'      => '',
            'amazon_secret_key'      => '',
            'amazon_partner_tag'     => '',
            'amazon_marketplace'     => 'de',
            'amazon_default_category'=> 'All',
            'amazon_language'        => '',
            
            // Cache Settings
            'cache_duration'         => 6,
            'fallback_duration'      => 24,
            'enable_redis'           => 'auto',
            'redis_host'             => '127.0.0.1',
            'redis_port'             => 6379,
            'redis_password'         => '',
            'redis_database'         => 0,
            
            // Display Settings
            'disable_default_css'    => 'no',
            'grid_columns_desktop'   => 3,
            'grid_columns_tablet'    => 2,
            'grid_columns_mobile'    => 1,
            'button_text_yadore'     => 'Zum Angebot',
            'button_text_amazon'     => 'Bei Amazon kaufen',
            'button_text_custom'     => 'Zum Angebot',
            'show_prime_badge'       => 'yes',
            'show_merchant'          => 'yes',
            'show_description'       => 'yes',
            'color_primary'          => '#ff00cc',
            'color_secondary'        => '#00ffff',
            'color_amazon'           => '#ff9900',
            'color_custom'           => '#4CAF50',
            
            // Update Settings
            'github_token'           => '',
        ];
        
        $existing = get_option('yaa_settings', []);
        $merged = array_merge($defaults, $existing);
        update_option('yaa_settings', $merged);
        
        // Schedule cron
        if (!wp_next_scheduled('yaa_cache_refresh_event')) {
            wp_schedule_event(time(), 'twicedaily', 'yaa_cache_refresh_event');
        }
        
        flush_rewrite_rules();
    }
    
    public function deactivate(): void {
        wp_clear_scheduled_hook('yaa_cache_refresh_event');
        flush_rewrite_rules();
    }
    
    public function enqueue_frontend_assets(): void {
        global $post;
        
        if (!($post instanceof WP_Post)) {
            return;
        }
        
        // Erweiterte Shortcode-Liste
        $shortcodes = [
            'yaa_products', 
            'yadore_products', 
            'amazon_products', 
            'combined_products',
            'custom_products',
            'all_products',
        ];
        
        $has_shortcode = false;
        
        foreach ($shortcodes as $shortcode) {
            if (has_shortcode($post->post_content, $shortcode)) {
                $has_shortcode = true;
                break;
            }
        }
        
        if ($has_shortcode) {
            $this->load_assets();
        }
    }
    
    public function load_assets(): void {
        $disable_css = yaa_get_option('disable_default_css', 'no') === 'yes';

        // 1. Wenn CSS NICHT deaktiviert ist, laden wir das volle Stylesheet
        if (!$disable_css) {
            wp_enqueue_style(
                'yaa-frontend-grid',
                YAA_PLUGIN_URL . 'assets/css/frontend-grid.css',
                [],
                YAA_VERSION
            );
            
            // Dynamic Colors & Grid Variables
            $primary = esc_attr((string) yaa_get_option('color_primary', '#ff00cc'));
            $secondary = esc_attr((string) yaa_get_option('color_secondary', '#00ffff'));
            $amazon = esc_attr((string) yaa_get_option('color_amazon', '#ff9900'));
            $custom = esc_attr((string) yaa_get_option('color_custom', '#4CAF50'));
            $columns_desktop = (int) yaa_get_option('grid_columns_desktop', 3);
            $columns_tablet = (int) yaa_get_option('grid_columns_tablet', 2);
            $columns_mobile = (int) yaa_get_option('grid_columns_mobile', 1);
            
            $custom_css = "
                .yaa-grid-container {
                    --yaa-primary: {$primary};
                    --yaa-secondary: {$secondary};
                    --yaa-amazon: {$amazon};
                    --yaa-custom: {$custom};
                    --yaa-columns-desktop: {$columns_desktop};
                    --yaa-columns-tablet: {$columns_tablet};
                    --yaa-columns-mobile: {$columns_mobile};
                }
            ";
            wp_add_inline_style('yaa-frontend-grid', $custom_css);
        } 
        // 2. Wenn CSS deaktiviert IST, laden wir nur ein Minimal-CSS für die Funktionalität
        else {
            // Wir registrieren einen "Dummy"-Handle, um Inline-CSS anzuhängen
            wp_register_style('yaa-minimal-functional', false);
            wp_enqueue_style('yaa-minimal-functional');
            
            // Minimales CSS, damit "Mehr lesen" technisch funktioniert
            // WICHTIG: Die .expanded Regeln nutzen !important, um Custom CSS (wie line-clamp) zu überschreiben
            $minimal_css = "
                .yaa-description {
                    overflow: hidden;
                    position: relative;
                    /* Fallback für Themes ohne eigenes CSS */
                    max-height: 4.8em; 
                    transition: max-height 0.4s ease-out;
                }
                
                .yaa-description.expanded {
                    max-height: none !important; /* Maximale Höhe aufheben */
                    -webkit-line-clamp: unset !important; /* Line-Clamp aufheben */
                    line-clamp: unset !important;
                    display: block !important; /* -webkit-box aufheben */
                    overflow: visible !important;
                }
                
                .yaa-read-more {
                    cursor: pointer;
                    display: inline-block;
                }
                
                /* Basis-Grid, falls vom Theme nicht definiert */
                .yaa-grid-container {
                    display: grid;
                    gap: 20px;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                }
            ";
            wp_add_inline_style('yaa-minimal-functional', $minimal_css);
        }
        
        // JS immer laden (wichtig für Read More Toggle & Lazy Load)
        wp_enqueue_script(
            'yaa-frontend-grid',
            YAA_PLUGIN_URL . 'assets/js/frontend-grid.js',
            [],
            YAA_VERSION,
            true
        );
    }
    
    public function preload_cache(): void {
        $cached_keywords = get_option('yaa_cached_keywords', []);
        
        if (empty($cached_keywords)) {
            return;
        }
        
        foreach ($cached_keywords as $entry) {
            $source = $entry['source'] ?? 'yadore';
            
            if ($source === 'amazon' && $this->amazon_api->is_configured()) {
                $this->amazon_api->search_items(
                    $entry['keyword'] ?? '',
                    $entry['category'] ?? 'All',
                    $entry['limit'] ?? 10
                );
            } elseif ($this->yadore_api->is_configured()) {
                $this->yadore_api->fetch([
                    'keyword' => $entry['keyword'] ?? '',
                    'limit'   => $entry['limit'] ?? 9,
                    'market'  => $entry['market'] ?? yaa_get_option('yadore_market', 'de'),
                ]);
            }
            
            sleep(1);
        }
    }
}

/**
 * Initialize Plugin
 */
function yaa_init(): Yadore_Amazon_API_Plugin {
    return Yadore_Amazon_API_Plugin::get_instance();
}
add_action('plugins_loaded', 'yaa_init', 10);

/**
 * Plugin action links
 */
function yaa_plugin_action_links(array $links): array {
    $settings_link = '<a href="' . admin_url('admin.php?page=yaa-settings') . '">' . 
                     __('Einstellungen', 'yadore-amazon-api') . '</a>';
    array_unshift($links, $settings_link);
    return $links;
}
add_filter('plugin_action_links_' . YAA_PLUGIN_BASENAME, 'yaa_plugin_action_links'); 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\assets\css\frontend-grid.css 
 
/**
 * Yadore-Amazon-API Frontend Grid Styles
 * Version 1.0.0 - PHP 8.3+ compatible
 */

/* =========================================
 * CSS CUSTOM PROPERTIES
 * ========================================= */
.yaa-grid-container {
    --yaa-primary: #ff00cc;
    --yaa-secondary: #00ffff;
    --yaa-amazon: #ff9900;
    --yaa-dark-bg: #0a0a0a;
    --yaa-glass-bg: rgba(255, 255, 255, 0.05);
    --yaa-glass-border: rgba(255, 255, 255, 0.1);
    --yaa-text-main: #ffffff;
    --yaa-text-muted: #aaaaaa;
    --yaa-columns-desktop: 3;
    --yaa-columns-tablet: 2;
    --yaa-columns-mobile: 1;
}

/* =========================================
 * GRID CONTAINER
 * ========================================= */
.yaa-grid-container {
    display: grid;
    grid-template-columns: repeat(var(--yaa-columns-desktop), 1fr);
    gap: 25px;
    padding: 10px 0;
    font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* =========================================
 * PRODUCT CARD
 * ========================================= */
.yaa-item {
    background: var(--yaa-glass-bg);
    border: 1px solid var(--yaa-glass-border);
    border-bottom: 2px solid var(--yaa-primary);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
}

.yaa-item:nth-child(even) {
    border-bottom-color: var(--yaa-secondary);
}

.yaa-item.yaa-amazon {
    border-bottom-color: var(--yaa-amazon);
}

/* Hover Effects */
.yaa-item:hover {
    transform: translateY(-8px);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-primary), transparent 80%);
}

.yaa-item:nth-child(even):hover {
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-secondary), transparent 80%);
}

.yaa-item.yaa-amazon:hover {
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-amazon), transparent 80%);
}

/* =========================================
 * PRIME BADGE
 * ========================================= */
.yaa-prime-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--yaa-amazon);
    color: #000;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(255, 153, 0, 0.4);
}

/* =========================================
 * IMAGE WRAPPER
 * ========================================= */
.yaa-image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%; /* 1:1 Aspect Ratio */
    background: linear-gradient(180deg, 
        rgba(10, 10, 10, 0.3) 0%, 
        rgba(10, 10, 10, 0.6) 100%);
    overflow: hidden;
}

.yaa-image-wrapper a {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}

.yaa-image-wrapper img {
    width: 85%;
    height: 85%;
    object-fit: contain;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    filter: brightness(0.95) saturate(0.95) drop-shadow(0 4px 20px rgba(0, 0, 0, 0.5));
}

.yaa-item:hover .yaa-image-wrapper img {
    transform: scale(1.08);
    filter: brightness(1.05) saturate(1.1) drop-shadow(0 8px 30px rgba(255, 0, 204, 0.3));
}

.yaa-item.yaa-amazon:hover .yaa-image-wrapper img {
    filter: brightness(1.05) saturate(1.1) drop-shadow(0 8px 30px rgba(255, 153, 0, 0.3));
}

/* No Image Placeholder */
.yaa-no-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
}

.yaa-no-image span {
    font-size: 4rem;
    opacity: 0.3;
}

/* =========================================
 * CONTENT SECTION
 * ========================================= */
.yaa-content {
    padding: 20px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    border-top: 1px solid var(--yaa-glass-border);
}

/* Title */
.yaa-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.05rem;
    font-weight: 700;
    line-height: 1.4;
    margin: 0 0 12px 0;
    color: var(--yaa-text-main);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.8em;
}

.yaa-title a {
    color: var(--yaa-text-main);
    text-decoration: none;
    transition: all 0.3s ease;
}

.yaa-title a:hover {
    color: var(--yaa-secondary);
    text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}

.yaa-item.yaa-amazon .yaa-title a:hover {
    color: var(--yaa-amazon);
    text-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
}

/* =========================================
 * DESCRIPTION
 * ========================================= */
.yaa-description-wrapper {
    position: relative;
    margin-bottom: 15px;
}

.yaa-description {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--yaa-text-muted);
    max-height: 4.8em;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
    position: relative;
}

.yaa-description::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2.4em;
    background: linear-gradient(to bottom, transparent 0%, rgba(10, 10, 10, 0.9) 100%);
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.yaa-description.expanded {
    max-height: 500px;
}

.yaa-description.expanded::after {
    opacity: 0;
}

/* Read More Button */
.yaa-read-more {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--yaa-primary);
    cursor: pointer;
    margin-top: 8px;
    padding: 5px 0;
    border: none;
    background: none;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

.yaa-read-more:hover {
    color: var(--yaa-secondary);
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}

.yaa-read-more::after {
    content: "▼";
    font-size: 0.6rem;
    transition: transform 0.3s ease;
}

.yaa-read-more.expanded::after {
    transform: rotate(180deg);
}

.yaa-item.yaa-amazon .yaa-read-more {
    color: var(--yaa-amazon);
}

.yaa-no-description {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.3);
    font-style: italic;
    margin-bottom: 15px;
}

/* =========================================
 * META & PRICE
 * ========================================= */
.yaa-meta {
    margin: 0 0 15px 0;
}

.yaa-price {
    display: block;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.6rem;
    font-weight: 900;
    background: linear-gradient(135deg, 
        var(--yaa-primary) 0%, 
        #ff66dd 50%, 
        var(--yaa-secondary) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: yaa-price-glow 3s ease-in-out infinite;
    margin-bottom: 5px;
}

.yaa-item.yaa-amazon .yaa-price {
    background: linear-gradient(135deg, 
        var(--yaa-amazon) 0%, 
        #ffb84d 50%, 
        var(--yaa-amazon) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

@keyframes yaa-price-glow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
}

.yaa-merchant {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--yaa-text-muted);
    font-weight: 600;
}

.yaa-merchant::before {
    content: "via ";
    color: var(--yaa-secondary);
}

.yaa-item.yaa-amazon .yaa-merchant::before {
    color: var(--yaa-amazon);
}

/* =========================================
 * BUTTON
 * ========================================= */
.yaa-button-wrapper {
    margin-top: auto;
}

.yaa-button {
    display: block;
    width: 100%;
    text-align: center;
    background-color: transparent;
    border: 2px solid var(--yaa-primary);
    color: var(--yaa-primary);
    padding: 14px 20px;
    border-radius: 50px;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-sizing: border-box;
}

.yaa-button:hover {
    background-color: var(--yaa-primary);
    color: #000;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-primary), transparent 30%);
    transform: translateY(-2px);
    text-decoration: none;
}

/* Alternating Colors */
.yaa-item:nth-child(even) .yaa-button {
    border-color: var(--yaa-secondary);
    color: var(--yaa-secondary);
}

.yaa-item:nth-child(even) .yaa-button:hover {
    background-color: var(--yaa-secondary);
    color: #000;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-secondary), transparent 30%);
}

/* Amazon Button */
.yaa-item.yaa-amazon .yaa-button {
    border-color: var(--yaa-amazon);
    color: var(--yaa-amazon);
}

.yaa-item.yaa-amazon .yaa-button:hover {
    background-color: var(--yaa-amazon);
    color: #000;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-amazon), transparent 30%);
}

/* =========================================
 * MESSAGE STATES (Error/Empty)
 * ========================================= */
.yaa-message {
    text-align: center;
    padding: 50px 30px;
    background: var(--yaa-glass-bg);
    border: 1px solid var(--yaa-glass-border);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.yaa-message .yaa-icon {
    display: block;
    font-size: 3rem;
    margin-bottom: 15px;
    filter: drop-shadow(0 0 15px var(--yaa-primary));
    animation: yaa-pulse 2s infinite ease-in-out;
}

.yaa-message p {
    margin: 0;
    font-size: 1.1rem;
    color: var(--yaa-text-main);
}

.yaa-error .yaa-icon {
    filter: drop-shadow(0 0 15px #ff4444);
}

@keyframes yaa-pulse {
    0%, 100% { 
        filter: drop-shadow(0 0 10px var(--yaa-primary)); 
        transform: scale(1);
    }
    50% { 
        filter: drop-shadow(0 0 20px var(--yaa-secondary)); 
        transform: scale(1.05);
    }
}

/* =========================================
 * RESPONSIVE DESIGN
 * ========================================= */
@media (max-width: 1400px) {
    .yaa-grid-container {
        grid-template-columns: repeat(var(--yaa-columns-desktop), 1fr);
    }
}

@media (max-width: 1024px) {
    .yaa-grid-container {
        grid-template-columns: repeat(var(--yaa-columns-tablet), 1fr);
        gap: 20px;
    }
}

@media (max-width: 600px) {
    .yaa-grid-container {
        grid-template-columns: repeat(var(--yaa-columns-mobile), 1fr);
        gap: 20px;
    }
    
    .yaa-title {
        font-size: 1rem;
    }
    
    .yaa-price {
        font-size: 1.4rem;
    }
    
    .yaa-content {
        padding: 15px;
    }
    
    .yaa-button {
        padding: 12px 18px;
        font-size: 0.75rem;
    }
    
    .yaa-description {
        font-size: 0.8rem;
    }
    
    .yaa-prime-badge {
        top: 8px;
        left: 8px;
        font-size: 0.6rem;
        padding: 3px 8px;
    }
}

/* Large screens */
@media (min-width: 1600px) {
    .yaa-grid-container {
        gap: 30px;
    }
    
    .yaa-title {
        font-size: 1.15rem;
    }
    
    .yaa-price {
        font-size: 1.8rem;
    }
}

/* =========================================
 * ACCESSIBILITY
 * ========================================= */
@media (prefers-reduced-motion: reduce) {
    .yaa-item,
    .yaa-image-wrapper img,
    .yaa-button,
    .yaa-description,
    .yaa-read-more::after {
        transition: none;
    }
    
    .yaa-price,
    .yaa-message .yaa-icon {
        animation: none;
    }
}

/* Focus styles for keyboard navigation */
.yaa-button:focus,
.yaa-read-more:focus,
.yaa-title a:focus,
.yaa-image-wrapper a:focus {
    outline: 2px solid var(--yaa-secondary);
    outline-offset: 2px;
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .yaa-item {
        border-width: 2px;
    }
    
    .yaa-button {
        border-width: 3px;
    }
}

/* Dark mode support (if system prefers) */
@media (prefers-color-scheme: light) {
    .yaa-grid-container {
        --yaa-glass-bg: rgba(0, 0, 0, 0.03);
        --yaa-glass-border: rgba(0, 0, 0, 0.1);
        --yaa-text-main: #1a1a1a;
        --yaa-text-muted: #666666;
    }
    
    .yaa-description::after {
        background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.95) 100%);
    }
}
/* =========================================
 * CUSTOM PRODUCTS STYLES
 * ========================================= */

/* Custom Product Card */
.yaa-item.yaa-custom {
    border-bottom-color: var(--yaa-custom, #4CAF50);
}

.yaa-item.yaa-custom:hover {
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-custom, #4CAF50), transparent 80%);
}

/* Custom Badge */
.yaa-custom-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--yaa-custom, #4CAF50);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
}

/* Wenn Prime UND Custom Badge vorhanden */
.yaa-item.yaa-custom .yaa-prime-badge {
    top: 12px;
    left: auto;
    right: 12px;
}

/* Custom Button */
.yaa-item.yaa-custom .yaa-button {
    border-color: var(--yaa-custom, #4CAF50);
    color: var(--yaa-custom, #4CAF50);
}

.yaa-item.yaa-custom .yaa-button:hover {
    background-color: var(--yaa-custom, #4CAF50);
    color: #fff;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-custom, #4CAF50), transparent 30%);
}

/* Custom Title Hover */
.yaa-item.yaa-custom .yaa-title a:hover {
    color: var(--yaa-custom, #4CAF50);
    text-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
}

/* Custom Merchant */
.yaa-item.yaa-custom .yaa-merchant::before {
    color: var(--yaa-custom, #4CAF50);
}

/* Custom Price */
.yaa-item.yaa-custom .yaa-price {
    background: linear-gradient(135deg, 
        var(--yaa-custom, #4CAF50) 0%, 
        #81C784 50%, 
        var(--yaa-custom, #4CAF50) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\assets\js\frontend-grid.js 
 
/**
 * Yadore-Amazon-API Frontend JavaScript
 * Version 1.0.0 - PHP 8.3+ compatible
 */

(function() {
    'use strict';

    /**
     * Initialize when DOM is ready
     */
    document.addEventListener('DOMContentLoaded', function() {
        initReadMoreButtons();
        initLazyLoadImages();
        initAccessibilityEnhancements();
    });

    /**
     * Initialize read more/less toggle buttons
     */
    function initReadMoreButtons() {
        const buttons = document.querySelectorAll('.yaa-read-more');
        
        buttons.forEach(function(button) {
            button.addEventListener('click', handleReadMoreClick);
            button.addEventListener('keydown', handleReadMoreKeydown);
        });
    }

    /**
     * Handle read more button click
     * @param {Event} event
     */
    function handleReadMoreClick(event) {
        event.preventDefault();
        
        const button = event.currentTarget;
        const targetId = button.getAttribute('data-target');
        const description = document.getElementById('desc-' + targetId);
        
        if (!description) {
            return;
        }
        
        toggleDescription(description, button);
    }

    /**
     * Handle keyboard navigation for read more
     * @param {KeyboardEvent} event
     */
    function handleReadMoreKeydown(event) {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            handleReadMoreClick(event);
        }
    }

    /**
     * Toggle description expanded state
     * @param {HTMLElement} description
     * @param {HTMLElement} button
     */
    function toggleDescription(description, button) {
        const isExpanded = description.classList.contains('expanded');
        const expandText = button.getAttribute('data-expand-text') || 'mehr lesen';
        const collapseText = button.getAttribute('data-collapse-text') || 'weniger';
        
        if (isExpanded) {
            description.classList.remove('expanded');
            button.classList.remove('expanded');
            button.textContent = expandText;
            button.setAttribute('aria-expanded', 'false');
        } else {
            description.classList.add('expanded');
            button.classList.add('expanded');
            button.textContent = collapseText;
            button.setAttribute('aria-expanded', 'true');
        }
    }

    /**
     * Initialize lazy loading for images
     * Fallback for browsers without native lazy loading
     */
    function initLazyLoadImages() {
        // Check if native lazy loading is supported
        if ('loading' in HTMLImageElement.prototype) {
            return; // Native support, no need for JS
        }

        // Fallback for older browsers
        const images = document.querySelectorAll('.yaa-image-wrapper img[loading="lazy"]');
        
        if (images.length === 0) {
            return;
        }

        // Use IntersectionObserver if available
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        const image = entry.target;
                        if (image.dataset.src) {
                            image.src = image.dataset.src;
                            image.removeAttribute('data-src');
                        }
                        observer.unobserve(image);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });

            images.forEach(function(image) {
                imageObserver.observe(image);
            });
        }
    }

    /**
     * Initialize accessibility enhancements
     */
    function initAccessibilityEnhancements() {
        // Add ARIA labels to read more buttons
        const buttons = document.querySelectorAll('.yaa-read-more');
        buttons.forEach(function(button) {
            if (!button.hasAttribute('aria-expanded')) {
                button.setAttribute('aria-expanded', 'false');
            }
            if (!button.hasAttribute('role')) {
                button.setAttribute('role', 'button');
            }
        });

        // Add ARIA labels to product links
        const productLinks = document.querySelectorAll('.yaa-item .yaa-title a, .yaa-item .yaa-button');
        productLinks.forEach(function(link) {
            if (link.hasAttribute('target') && link.getAttribute('target') === '_blank') {
                if (!link.querySelector('.screen-reader-text')) {
                    const srText = document.createElement('span');
                    srText.className = 'screen-reader-text';
                    srText.textContent = ' (öffnet in neuem Tab)';
                    srText.style.cssText = 'position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;';
                    link.appendChild(srText);
                }
            }
        });
    }

    /**
     * Public API for external access
     */
    window.YAA = window.YAA || {};
    
    /**
     * Toggle description by ID
     * @param {string} id - The description ID (without 'desc-' prefix)
     */
    window.YAA.toggleDescription = function(id) {
        const description = document.getElementById('desc-' + id);
        const button = description ? description.parentElement.querySelector('.yaa-read-more') : null;
        
        if (description && button) {
            toggleDescription(description, button);
        }
    };

    /**
     * Refresh all read more buttons (useful after AJAX content load)
     */
    window.YAA.refresh = function() {
        initReadMoreButtons();
        initLazyLoadImages();
        initAccessibilityEnhancements();
    };

    /**
     * Get product data from a grid item
     * @param {HTMLElement} item - The .yaa-item element
     * @returns {Object|null} Product data object
     */
    window.YAA.getProductData = function(item) {
        if (!item || !item.classList.contains('yaa-item')) {
            return null;
        }

        const titleElement = item.querySelector('.yaa-title a');
        const priceElement = item.querySelector('.yaa-price');
        const merchantElement = item.querySelector('.yaa-merchant');
        const imageElement = item.querySelector('.yaa-image-wrapper img');

        return {
            title: titleElement ? titleElement.textContent.trim() : '',
            url: titleElement ? titleElement.href : '',
            price: priceElement ? priceElement.textContent.trim() : '',
            merchant: merchantElement ? merchantElement.textContent.replace('via ', '').trim() : '',
            image: imageElement ? imageElement.src : '',
            isAmazon: item.classList.contains('yaa-amazon'),
            isPrime: item.querySelector('.yaa-prime-badge') !== null
        };
    };

})();
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-admin.php 
 
<?php
/**
 * Admin Settings & Dashboard
 * PHP 8.3+ compatible with full backend configuration
 * * Features:
 * - Yadore API Configuration
 * - Amazon PA-API 5.0 Configuration (all marketplaces)
 * - Custom Products Management
 * - Redis Cache Configuration
 * - Display Settings
 * - Status & Documentation
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin {
    
    private YAA_Cache_Handler $cache;
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    
    public function __construct(
        YAA_Cache_Handler $cache, 
        YAA_Yadore_API $yadore_api, 
        YAA_Amazon_PAAPI $amazon_api
    ) {
        $this->cache = $cache;
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        
        add_action('admin_menu', [$this, 'add_menu']);
        add_action('admin_init', [$this, 'register_settings']);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_assets']);
        add_action('admin_bar_menu', [$this, 'add_admin_bar_button'], 100);
        add_action('admin_post_yaa_clear_cache', [$this, 'handle_clear_cache']);
        add_action('admin_notices', [$this, 'admin_notices']);
        add_action('wp_dashboard_setup', [$this, 'add_dashboard_widget']);
        
        // AJAX handlers
        add_action('wp_ajax_yaa_test_yadore', [$this, 'ajax_test_yadore']);
        add_action('wp_ajax_yaa_test_amazon', [$this, 'ajax_test_amazon']);
        add_action('wp_ajax_yaa_test_redis', [$this, 'ajax_test_redis']);
    }
    
    /**
     * Add admin menu
     */
    public function add_menu(): void {
        add_menu_page(
            __('Yadore-Amazon-API', 'yadore-amazon-api'),
            __('Yadore-Amazon', 'yadore-amazon-api'),
            'manage_options',
            'yaa-settings',
            [$this, 'render_settings_page'],
            'dashicons-cart',
            30
        );
        
        add_submenu_page(
            'yaa-settings',
            __('Einstellungen', 'yadore-amazon-api'),
            __('Einstellungen', 'yadore-amazon-api'),
            'manage_options',
            'yaa-settings',
            [$this, 'render_settings_page']
        );
        
        add_submenu_page(
            'yaa-settings',
            __('Cache & Status', 'yadore-amazon-api'),
            __('Cache & Status', 'yadore-amazon-api'),
            'manage_options',
            'yaa-status',
            [$this, 'render_status_page']
        );
        
        add_submenu_page(
            'yaa-settings',
            __('Dokumentation', 'yadore-amazon-api'),
            __('Dokumentation', 'yadore-amazon-api'),
            'manage_options',
            'yaa-docs',
            [$this, 'render_docs_page']
        );
    }
    
    /**
     * Register settings
     */
    public function register_settings(): void {
        register_setting('yaa_settings', 'yaa_settings', [
            'type'              => 'array',
            'sanitize_callback' => [$this, 'sanitize_settings'],
        ]);
    }
    
    /**
     * Sanitize settings
     * * @param array<string, mixed>|null $input
     * @return array<string, mixed>
     */
    public function sanitize_settings(?array $input): array {
        if ($input === null) {
            $input = [];
        }
        
        $sanitized = [];
        
        // Yadore settings
        $sanitized['enable_yadore'] = isset($input['enable_yadore']) ? 'yes' : 'no';
        $sanitized['yadore_api_key'] = sanitize_text_field($input['yadore_api_key'] ?? '');
        $sanitized['yadore_market'] = sanitize_text_field($input['yadore_market'] ?? 'de');
        $sanitized['yadore_precision'] = in_array($input['yadore_precision'] ?? '', ['strict', 'fuzzy'], true) 
            ? $input['yadore_precision'] : 'fuzzy';
        $sanitized['yadore_default_limit'] = max(1, min(50, (int) ($input['yadore_default_limit'] ?? 9)));
        
        // Amazon settings
        $sanitized['enable_amazon'] = isset($input['enable_amazon']) ? 'yes' : 'no';
        $sanitized['amazon_access_key'] = sanitize_text_field($input['amazon_access_key'] ?? '');
        $sanitized['amazon_secret_key'] = $input['amazon_secret_key'] ?? '';
        $sanitized['amazon_partner_tag'] = sanitize_text_field($input['amazon_partner_tag'] ?? '');
        $sanitized['amazon_marketplace'] = sanitize_text_field($input['amazon_marketplace'] ?? 'de');
        $sanitized['amazon_default_category'] = sanitize_text_field($input['amazon_default_category'] ?? 'All');
        $sanitized['amazon_language'] = sanitize_text_field($input['amazon_language'] ?? '');
        
        // Cache settings
        $sanitized['cache_duration'] = max(1, min(168, (int) ($input['cache_duration'] ?? 6)));
        $sanitized['fallback_duration'] = max(1, min(720, (int) ($input['fallback_duration'] ?? 24)));
        
        // Redis settings
        $sanitized['enable_redis'] = in_array($input['enable_redis'] ?? '', ['auto', 'yes', 'no'], true) 
            ? $input['enable_redis'] : 'auto';
        $sanitized['redis_host'] = sanitize_text_field($input['redis_host'] ?? '127.0.0.1');
        $sanitized['redis_port'] = max(1, min(65535, (int) ($input['redis_port'] ?? 6379)));
        $sanitized['redis_password'] = $input['redis_password'] ?? '';
        $sanitized['redis_database'] = max(0, min(15, (int) ($input['redis_database'] ?? 0)));
        
        // Display settings
        $sanitized['disable_default_css'] = isset($input['disable_default_css']) ? 'yes' : 'no'; // NEU
        $sanitized['grid_columns_desktop'] = max(1, min(6, (int) ($input['grid_columns_desktop'] ?? 3)));
        $sanitized['grid_columns_tablet'] = max(1, min(4, (int) ($input['grid_columns_tablet'] ?? 2)));
        $sanitized['grid_columns_mobile'] = max(1, min(2, (int) ($input['grid_columns_mobile'] ?? 1)));
        $sanitized['button_text_yadore'] = sanitize_text_field($input['button_text_yadore'] ?? 'Zum Angebot');
        $sanitized['button_text_amazon'] = sanitize_text_field($input['button_text_amazon'] ?? 'Bei Amazon kaufen');
        $sanitized['button_text_custom'] = sanitize_text_field($input['button_text_custom'] ?? 'Zum Angebot');
        $sanitized['show_prime_badge'] = isset($input['show_prime_badge']) ? 'yes' : 'no';
        $sanitized['show_merchant'] = isset($input['show_merchant']) ? 'yes' : 'no';
        $sanitized['show_description'] = isset($input['show_description']) ? 'yes' : 'no';
        $sanitized['show_custom_badge'] = isset($input['show_custom_badge']) ? 'yes' : 'no';
        $sanitized['custom_badge_text'] = sanitize_text_field($input['custom_badge_text'] ?? 'Empfohlen');
        $sanitized['color_primary'] = sanitize_hex_color($input['color_primary'] ?? '#ff00cc') ?: '#ff00cc';
        $sanitized['color_secondary'] = sanitize_hex_color($input['color_secondary'] ?? '#00ffff') ?: '#00ffff';
        $sanitized['color_amazon'] = sanitize_hex_color($input['color_amazon'] ?? '#ff9900') ?: '#ff9900';
        $sanitized['color_custom'] = sanitize_hex_color($input['color_custom'] ?? '#4CAF50') ?: '#4CAF50';
        
        // GitHub Token
        $sanitized['github_token'] = sanitize_text_field($input['github_token'] ?? '');
        
        return $sanitized;
    }
    
    /**
     * Enqueue admin assets
     */
    public function enqueue_admin_assets(string $hook): void {
        if (!str_contains($hook, 'yaa-') && $hook !== 'toplevel_page_yaa-settings') {
            return;
        }
        
        wp_enqueue_style('wp-color-picker');
        wp_enqueue_script('wp-color-picker');
        
        // Inline admin styles
        $admin_css = $this->get_admin_css();
        wp_add_inline_style('wp-color-picker', $admin_css);
        
        // Admin JS
        $admin_js = $this->get_admin_js();
        wp_add_inline_script('wp-color-picker', $admin_js);
        
        wp_localize_script('wp-color-picker', 'yaaAdmin', [
            'nonce' => wp_create_nonce('yaa_admin_nonce'),
            'ajaxurl' => admin_url('admin-ajax.php'),
        ]);
    }
    
    /**
     * Get admin CSS
     */
    private function get_admin_css(): string {
        return '
            .yaa-admin-wrap { max-width: 1200px; }
            .yaa-card { background: #fff; border: 1px solid #ccd0d4; border-radius: 4px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 1px rgba(0,0,0,.04); }
            .yaa-card h2 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
            .yaa-card h3 { margin-top: 20px; color: #1d2327; }
            .yaa-card h4 { margin: 15px 0 10px; color: #50575e; }
            .yaa-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
            .yaa-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .yaa-status-badge { display: inline-block; padding: 4px 10px; border-radius: 3px; font-size: 12px; font-weight: 600; }
            .yaa-status-success { background: #d4edda; color: #155724; }
            .yaa-status-warning { background: #fff3cd; color: #856404; }
            .yaa-status-error { background: #f8d7da; color: #721c24; }
            .yaa-status-info { background: #cce5ff; color: #004085; }
            .yaa-tabs { display: flex; flex-wrap: wrap; gap: 0; margin-bottom: 0; border-bottom: 1px solid #ccd0d4; background: #f6f7f7; }
            .yaa-tab { padding: 12px 20px; background: transparent; border: 1px solid transparent; border-bottom: none; cursor: pointer; margin-bottom: -1px; transition: all 0.2s; font-weight: 500; }
            .yaa-tab:hover { background: #fff; }
            .yaa-tab.active { background: #fff; border-color: #ccd0d4; border-bottom-color: #fff; font-weight: 600; }
            .yaa-tab-content { display: none; padding-top: 20px; }
            .yaa-tab-content.active { display: block; }
            .yaa-form-row { margin-bottom: 20px; }
            .yaa-form-row label { display: block; font-weight: 600; margin-bottom: 5px; color: #1d2327; }
            .yaa-form-row label.inline { display: inline; font-weight: normal; }
            .yaa-form-row input[type="text"],
            .yaa-form-row input[type="password"],
            .yaa-form-row input[type="number"],
            .yaa-form-row input[type="url"],
            .yaa-form-row select,
            .yaa-form-row textarea { width: 100%; max-width: 400px; padding: 8px 10px; border: 1px solid #8c8f94; border-radius: 4px; }
            .yaa-form-row textarea { min-height: 80px; max-width: 600px; }
            .yaa-form-row .description { color: #646970; font-size: 13px; margin-top: 6px; line-height: 1.5; }
            .yaa-form-row .description code { background: #f0f0f1; padding: 2px 6px; border-radius: 3px; }
            .yaa-shortcode-box { background: #f6f7f7; padding: 12px 15px; border-radius: 4px; font-family: Consolas, Monaco, monospace; font-size: 13px; margin: 10px 0; overflow-x: auto; border: 1px solid #dcdcde; }
            .yaa-test-result { margin-top: 10px; padding: 12px; border-radius: 4px; display: none; }
            .yaa-marketplace-info { background: #f0f6fc; border: 1px solid #c8d9e8; border-radius: 4px; padding: 15px; margin-top: 15px; }
            .yaa-marketplace-info h4 { margin: 0 0 10px 0; color: #1d2327; }
            .yaa-marketplace-info table { margin-top: 10px; }
            .yaa-preview-box { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-top: 15px; }
            .yaa-preview-item { display: inline-block; padding: 15px 20px; margin: 5px; border-radius: 8px; text-align: center; }
            .yaa-code-block { background: #23282d; color: #fff; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; line-height: 1.6; }
            .yaa-code-block code { color: #98c379; }
            .yaa-tip { background: #fff8e5; border-left: 4px solid #ffb900; padding: 12px 15px; margin: 15px 0; }
            .yaa-tip strong { color: #826200; }
            .yaa-columns-2 { column-count: 2; column-gap: 30px; }
            .yaa-columns-3 { column-count: 3; column-gap: 20px; }
            @media (max-width: 782px) { 
                .yaa-grid { grid-template-columns: 1fr; }
                .yaa-grid-3 { grid-template-columns: 1fr; }
                .yaa-columns-2, .yaa-columns-3 { column-count: 1; }
            }
        ';
    }
    
    /**
     * Get admin JavaScript
     */
    private function get_admin_js(): string {
        return '
            jQuery(document).ready(function($) {
                // Color pickers
                $(".yaa-color-picker").wpColorPicker();
                
                // Tabs
                $(".yaa-tab").on("click", function() {
                    var tab = $(this).data("tab");
                    $(".yaa-tab").removeClass("active");
                    $(this).addClass("active");
                    $(".yaa-tab-content").removeClass("active");
                    $("#yaa-tab-" + tab).addClass("active");
                    localStorage.setItem("yaa_active_tab", tab);
                });
                
                // Restore active tab
                var savedTab = localStorage.getItem("yaa_active_tab");
                if (savedTab && $(".yaa-tab[data-tab=\"" + savedTab + "\"]").length) {
                    $(".yaa-tab[data-tab=\"" + savedTab + "\"]").click();
                }
                
                // Marketplace change
                $("select[name=\'yaa_settings[amazon_marketplace]\']").on("change", function() {
                    var marketplace = $(this).val();
                    $(".yaa-marketplace-detail").hide();
                    $("#marketplace-info-" + marketplace.replace(/\\./g, "-")).show();
                });
                
                // Test buttons
                $(".yaa-test-btn").on("click", function(e) {
                    e.preventDefault();
                    var $btn = $(this);
                    var action = $btn.data("action");
                    var $result = $btn.siblings(".yaa-test-result");
                    
                    $btn.prop("disabled", true);
                    var originalText = $btn.text();
                    $btn.text("Teste...");
                    
                    var data = {
                        action: action,
                        nonce: yaaAdmin.nonce,
                        yadore_api_key: $("input[name=\'yaa_settings[yadore_api_key]\']").val(),
                        amazon_access_key: $("input[name=\'yaa_settings[amazon_access_key]\']").val(),
                        amazon_secret_key: $("input[name=\'yaa_settings[amazon_secret_key]\']").val(),
                        amazon_partner_tag: $("input[name=\'yaa_settings[amazon_partner_tag]\']").val(),
                        amazon_marketplace: $("select[name=\'yaa_settings[amazon_marketplace]\']").val(),
                        redis_host: $("input[name=\'yaa_settings[redis_host]\']").val(),
                        redis_port: $("input[name=\'yaa_settings[redis_port]\']").val(),
                        redis_password: $("input[name=\'yaa_settings[redis_password]\']").val(),
                        redis_database: $("input[name=\'yaa_settings[redis_database]\']").val()
                    };
                    
                    $.post(yaaAdmin.ajaxurl, data, function(response) {
                        $btn.prop("disabled", false).text(originalText);
                        if (response.success) {
                            $result.html("<div class=\'yaa-status-success\' style=\'padding:12px;border-radius:4px;\'>✅ " + response.data.message + "</div>").show();
                        } else {
                            $result.html("<div class=\'yaa-status-error\' style=\'padding:12px;border-radius:4px;\'>❌ " + response.data.message + "</div>").show();
                        }
                    }).fail(function() {
                        $btn.prop("disabled", false).text(originalText);
                        $result.html("<div class=\'yaa-status-error\' style=\'padding:12px;border-radius:4px;\'>❌ Verbindungsfehler</div>").show();
                    });
                });
            });
        ';
    }
    
    /**
     * Render main settings page
     */
    public function render_settings_page(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $options = get_option('yaa_settings', []);
        if (!is_array($options)) {
            $options = [];
        }
        
        $cache_status = $this->cache->get_status();
        $marketplaces = $this->amazon_api->get_marketplace_options();
        $yadore_markets = $this->yadore_api->get_markets();
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
            
            <form method="post" action="options.php">
                <?php settings_fields('yaa_settings'); ?>
                
                <!-- Tabs -->
                <div class="yaa-tabs">
                    <div class="yaa-tab active" data-tab="yadore">📦 Yadore API</div>
                    <div class="yaa-tab" data-tab="amazon">🛒 Amazon PA-API</div>
                    <div class="yaa-tab" data-tab="custom">⭐ Eigene Produkte</div>
                    <div class="yaa-tab" data-tab="cache">⚡ Cache & Redis</div>
                    <div class="yaa-tab" data-tab="display">🎨 Darstellung</div>
                </div>
                
                <!-- Yadore Tab -->
                <div id="yaa-tab-yadore" class="yaa-tab-content active">
                    <?php $this->render_yadore_settings($options, $yadore_markets); ?>
                </div>
                
                <!-- Amazon Tab -->
                <div id="yaa-tab-amazon" class="yaa-tab-content">
                    <?php $this->render_amazon_settings($options, $marketplaces); ?>
                </div>
                
                <!-- Custom Products Tab -->
                <div id="yaa-tab-custom" class="yaa-tab-content">
                    <?php $this->render_custom_products_settings($options); ?>
                </div>
                
                <!-- Cache Tab -->
                <div id="yaa-tab-cache" class="yaa-tab-content">
                    <?php $this->render_cache_settings($options, $cache_status); ?>
                </div>
                
                <!-- Display Tab -->
                <div id="yaa-tab-display" class="yaa-tab-content">
                    <?php $this->render_display_settings($options); ?>
                </div>
                
                <?php submit_button(__('Einstellungen speichern', 'yadore-amazon-api')); ?>
            </form>
        </div>
        <?php
    }
    
    /**
     * Render Yadore settings
     * * @param array<string, mixed> $options
     * @param array<string, string> $markets
     */
    private function render_yadore_settings(array $options, array $markets): void {
        ?>
        <div class="yaa-card">
            <h2>📦 Yadore API Konfiguration</h2>
            <p class="description">
                Yadore bietet Zugang zu über 9.000 Shops und 250 Millionen Produkten. 
                <a href="https://www.yadore.com/publisher" target="_blank" rel="noopener">Publisher-Account erstellen →</a>
            </p>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[enable_yadore]" value="yes" 
                        <?php checked(($options['enable_yadore'] ?? 'yes'), 'yes'); ?>>
                    Yadore API aktivieren
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label for="yadore_api_key">API-Key</label>
                <input type="text" id="yadore_api_key" name="yaa_settings[yadore_api_key]" 
                       value="<?php echo esc_attr($options['yadore_api_key'] ?? ''); ?>"
                       <?php echo defined('YADORE_API_KEY') ? 'disabled' : ''; ?>
                       placeholder="Dein Yadore API-Key">
                <?php if (defined('YADORE_API_KEY')): ?>
                    <p class="description">✅ Via <code>wp-config.php</code> definiert (YADORE_API_KEY)</p>
                <?php else: ?>
                    <p class="description">Den API-Key erhältst du nach der Registrierung bei Yadore.</p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="yadore_market">Standard-Markt</label>
                    <select id="yadore_market" name="yaa_settings[yadore_market]">
                        <?php foreach ($markets as $code => $name): ?>
                            <option value="<?php echo esc_attr($code); ?>" 
                                <?php selected(($options['yadore_market'] ?? 'de'), $code); ?>>
                                <?php echo esc_html($name . ' (' . strtoupper($code) . ')'); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <p class="description">Kann im Shortcode mit <code>market="xx"</code> überschrieben werden.</p>
                </div>
                
                <div class="yaa-form-row">
                    <label for="yadore_precision">Such-Genauigkeit</label>
                    <select id="yadore_precision" name="yaa_settings[yadore_precision]">
                        <option value="fuzzy" <?php selected(($options['yadore_precision'] ?? 'fuzzy'), 'fuzzy'); ?>>
                            Fuzzy (mehr Ergebnisse)
                        </option>
                        <option value="strict" <?php selected(($options['yadore_precision'] ?? 'fuzzy'), 'strict'); ?>>
                            Strict (exaktere Treffer)
                        </option>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="yadore_default_limit">Standard-Limit</label>
                    <input type="number" id="yadore_default_limit" name="yaa_settings[yadore_default_limit]" 
                           value="<?php echo esc_attr($options['yadore_default_limit'] ?? '9'); ?>"
                           min="1" max="50">
                </div>
            </div>
            
            <div class="yaa-form-row">
                <button type="button" class="button yaa-test-btn" data-action="yaa_test_yadore">
                    🔍 Verbindung testen
                </button>
                <div class="yaa-test-result"></div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>💡 Multi-Keyword Feature</h2>
            <p class="description">
                Du kannst mehrere Keywords in einem Shortcode verwenden. Das Limit wird automatisch aufgeteilt.
            </p>
            <div class="yaa-shortcode-box">[yadore_products keywords="Smartphone,Tablet,Laptop" limit="9"]</div>
            <div class="yaa-tip">
                <strong>Tipp:</strong> Bei 3 Keywords und limit="9" werden je 3 Produkte pro Keyword geladen.
            </div>
        </div>
        <?php
    }
    
    /**
     * Render Amazon settings
     * * @param array<string, mixed> $options
     * @param array<string, string> $marketplaces
     */
    private function render_amazon_settings(array $options, array $marketplaces): void {
        $current_marketplace = $options['amazon_marketplace'] ?? 'de';
        $all_marketplaces = $this->amazon_api->get_marketplaces();
        ?>
        <div class="yaa-card">
            <h2>🛒 Amazon Product Advertising API 5.0</h2>
            <p class="description">
                Für die Amazon PA-API benötigst du ein Amazon Associates Konto mit mindestens 10 qualifizierten Verkäufen in 30 Tagen.
                <a href="https://webservices.amazon.com/paapi5/documentation/" target="_blank" rel="noopener">Dokumentation →</a>
            </p>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[enable_amazon]" value="yes" 
                        <?php checked(($options['enable_amazon'] ?? 'yes'), 'yes'); ?>>
                    Amazon PA-API aktivieren
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label for="amazon_access_key">Access Key</label>
                <input type="text" id="amazon_access_key" name="yaa_settings[amazon_access_key]" 
                       value="<?php echo esc_attr($options['amazon_access_key'] ?? ''); ?>"
                       <?php echo defined('AMAZON_PAAPI_ACCESS_KEY') ? 'disabled' : ''; ?>
                       placeholder="AKIAXXXXXXXXXX">
                <?php if (defined('AMAZON_PAAPI_ACCESS_KEY')): ?>
                    <p class="description">✅ Via <code>wp-config.php</code> definiert</p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-form-row">
                <label for="amazon_secret_key">Secret Key</label>
                <input type="password" id="amazon_secret_key" name="yaa_settings[amazon_secret_key]" 
                       value="<?php echo esc_attr($options['amazon_secret_key'] ?? ''); ?>"
                       <?php echo defined('AMAZON_PAAPI_SECRET_KEY') ? 'disabled' : ''; ?>>
                <?php if (defined('AMAZON_PAAPI_SECRET_KEY')): ?>
                    <p class="description">✅ Via <code>wp-config.php</code> definiert</p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-form-row">
                <label for="amazon_partner_tag">Partner Tag (Tracking-ID)</label>
                <input type="text" id="amazon_partner_tag" name="yaa_settings[amazon_partner_tag]" 
                       value="<?php echo esc_attr($options['amazon_partner_tag'] ?? ''); ?>"
                       placeholder="deinshop-21"
                       <?php echo defined('AMAZON_PAAPI_PARTNER_TAG') ? 'disabled' : ''; ?>>
                <p class="description">
                    Deine Tracking-ID aus dem Amazon PartnerNet. <strong>Muss zum Marketplace passen!</strong>
                </p>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="amazon_marketplace">Marketplace</label>
                    <select id="amazon_marketplace" name="yaa_settings[amazon_marketplace]">
                        <optgroup label="🇪🇺 Europa">
                            <?php foreach (['de', 'fr', 'it', 'es', 'co.uk', 'nl', 'pl', 'se', 'be', 'com.tr'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                        <optgroup label="🌍 Naher Osten & Afrika">
                            <?php foreach (['ae', 'sa', 'eg'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                        <optgroup label="🌎 Amerika">
                            <?php foreach (['com', 'ca', 'com.mx', 'com.br'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                        <optgroup label="🌏 Asien-Pazifik">
                            <?php foreach (['co.jp', 'in', 'com.au', 'sg'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="amazon_default_category">Standard-Kategorie</label>
                    <select id="amazon_default_category" name="yaa_settings[amazon_default_category]">
                        <?php 
                        $search_indexes = $this->amazon_api->get_search_indexes();
                        foreach ($search_indexes as $code => $name): 
                        ?>
                            <option value="<?php echo esc_attr($code); ?>" <?php selected(($options['amazon_default_category'] ?? 'All'), $code); ?>>
                                <?php echo esc_html($code === $name ? $code : "$code - $name"); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
            
            <!-- Marketplace Info -->
            <div class="yaa-marketplace-info">
                <h4>📍 Marketplace-Details</h4>
                <?php foreach ($all_marketplaces as $code => $info): ?>
                <div id="marketplace-info-<?php echo esc_attr(str_replace('.', '-', $code)); ?>" 
                     class="yaa-marketplace-detail" 
                     style="<?php echo $code !== $current_marketplace ? 'display:none;' : ''; ?>">
                    <table class="widefat" style="margin-top: 10px;">
                        <tr><td width="150"><strong>Host:</strong></td><td><code><?php echo esc_html($info['host']); ?></code></td></tr>
                        <tr><td><strong>Region:</strong></td><td><?php echo esc_html($info['region']); ?></td></tr>
                        <tr><td><strong>Währung:</strong></td><td><?php echo esc_html($info['currency']); ?></td></tr>
                        <tr><td><strong>Sprache:</strong></td><td><?php echo esc_html($info['language']); ?></td></tr>
                    </table>
                </div>
                <?php endforeach; ?>
            </div>
            
            <div class="yaa-form-row" style="margin-top: 20px;">
                <button type="button" class="button yaa-test-btn" data-action="yaa_test_amazon">
                    🔍 Verbindung testen
                </button>
                <div class="yaa-test-result"></div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>⚠️ Amazon API Einschränkungen</h2>
            <ul style="list-style: disc; margin-left: 20px; line-height: 1.8;">
                <li><strong>10 qualifizierte Verkäufe</strong> in den letzten 30 Tagen erforderlich (seit Nov. 2025)</li>
                <li>Maximal <strong>1 Request/Sekunde</strong> bei wenigen Verkäufen</li>
                <li>Maximal <strong>10 Produkte</strong> pro API-Anfrage</li>
                <li>Partner-Tag <strong>muss zum Marketplace</strong> passen</li>
            </ul>
        </div>
        <?php
    }
    
    /**
     * Render custom products settings
     * * @param array<string, mixed> $options
     */
    private function render_custom_products_settings(array $options): void {
        $product_count = wp_count_posts(YAA_Custom_Products::get_post_type());
        $published_count = $product_count->publish ?? 0;
        
        $categories = get_terms([
            'taxonomy' => YAA_Custom_Products::get_taxonomy(),
            'hide_empty' => false,
        ]);
        $category_count = is_array($categories) ? count($categories) : 0;
        ?>
        <div class="yaa-card">
            <h2>⭐ Eigene Produkte</h2>
            <p class="description">
                Erstelle eigene Produkteinträge mit individuellen Links, Bildern und Preisen.
            </p>
            
            <div class="yaa-grid" style="margin: 20px 0;">
                <div style="background: #f0f6fc; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: #0073aa;"><?php echo (int) $published_count; ?></div>
                    <div style="color: #50575e;">Veröffentlichte Produkte</div>
                </div>
                <div style="background: #fef8ee; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: #996800;"><?php echo (int) $category_count; ?></div>
                    <div style="color: #50575e;">Kategorien</div>
                </div>
                <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; text-align: center;">
                    <a href="<?php echo admin_url('post-new.php?post_type=' . YAA_Custom_Products::get_post_type()); ?>" 
                       class="button button-primary button-hero" style="margin-top: 10px;">
                        ➕ Neues Produkt
                    </a>
                </div>
            </div>
            
            <p>
                <a href="<?php echo admin_url('edit.php?post_type=' . YAA_Custom_Products::get_post_type()); ?>" class="button">
                    📋 Alle Produkte verwalten
                </a>
                <a href="<?php echo admin_url('edit-tags.php?taxonomy=' . YAA_Custom_Products::get_taxonomy() . '&post_type=' . YAA_Custom_Products::get_post_type()); ?>" class="button" style="margin-left: 10px;">
                    🏷️ Kategorien verwalten
                </a>
            </p>
        </div>
        
        <div class="yaa-card">
            <h2>📝 Shortcodes für eigene Produkte</h2>
            
            <h4>Nach IDs anzeigen:</h4>
            <div class="yaa-shortcode-box">[custom_products ids="123,456,789"]</div>
            
            <h4>Nach Kategorie anzeigen:</h4>
            <div class="yaa-shortcode-box">[custom_products category="elektronik" limit="6"]</div>
            
            <h4>Kombiniert mit anderen Quellen:</h4>
            <div class="yaa-shortcode-box">[combined_products keyword="Kopfhörer" custom_ids="10,15" yadore_limit="4" amazon_limit="2"]</div>
        </div>
        
        <div class="yaa-card">
            <h2>🎨 Darstellung eigener Produkte</h2>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[show_custom_badge]" value="yes" 
                        <?php checked(($options['show_custom_badge'] ?? 'yes'), 'yes'); ?>>
                    Badge bei eigenen Produkten anzeigen
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label for="custom_badge_text">Badge-Text</label>
                <input type="text" id="custom_badge_text" name="yaa_settings[custom_badge_text]" 
                       value="<?php echo esc_attr($options['custom_badge_text'] ?? 'Empfohlen'); ?>"
                       placeholder="Empfohlen">
            </div>
            
            <div class="yaa-form-row">
                <label for="button_text_custom">Button-Text</label>
                <input type="text" id="button_text_custom" name="yaa_settings[button_text_custom]" 
                       value="<?php echo esc_attr($options['button_text_custom'] ?? 'Zum Angebot'); ?>">
            </div>
            
            <div class="yaa-form-row">
                <label for="color_custom">Farbe für eigene Produkte</label>
                <input type="text" id="color_custom" name="yaa_settings[color_custom]" 
                       value="<?php echo esc_attr($options['color_custom'] ?? '#4CAF50'); ?>"
                       class="yaa-color-picker">
            </div>
        </div>
        <?php
    }
    
    /**
     * Render cache settings
     * * @param array<string, mixed> $options
     * @param array<string, mixed> $cache_status
     */
    private function render_cache_settings(array $options, array $cache_status): void {
        ?>
        <div class="yaa-card">
            <h2>⚡ Cache-Einstellungen</h2>
            
            <div class="yaa-grid">
                <div>
                    <div class="yaa-form-row">
                        <label for="cache_duration">Cache-Dauer (Stunden)</label>
                        <input type="number" id="cache_duration" name="yaa_settings[cache_duration]" 
                               value="<?php echo esc_attr($options['cache_duration'] ?? '6'); ?>"
                               min="1" max="168">
                        <p class="description">Wie lange API-Daten im Cache bleiben (1-168 Stunden).</p>
                    </div>
                    
                    <div class="yaa-form-row">
                        <label for="fallback_duration">Fallback-Dauer (Stunden)</label>
                        <input type="number" id="fallback_duration" name="yaa_settings[fallback_duration]" 
                               value="<?php echo esc_attr($options['fallback_duration'] ?? '24'); ?>"
                               min="1" max="720">
                        <p class="description">Backup-Cache bei API-Fehlern (1-720 Stunden).</p>
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-top: 0;">📊 Aktueller Status</h4>
                    <table class="widefat" style="margin-top: 10px;">
                        <tr>
                            <td><strong>Backend:</strong></td>
                            <td>
                                <span class="yaa-status-badge <?php echo $cache_status['redis_available'] ? 'yaa-status-success' : 'yaa-status-warning'; ?>">
                                    <?php echo esc_html($cache_status['cache_backend']); ?>
                                </span>
                            </td>
                        </tr>
                        <?php if (!empty($cache_status['redis_info'])): ?>
                        <tr>
                            <td><strong>Redis Version:</strong></td>
                            <td><?php echo esc_html($cache_status['redis_info']['version']); ?></td>
                        </tr>
                        <tr>
                            <td><strong>Speicher:</strong></td>
                            <td><?php echo esc_html($cache_status['redis_info']['used_memory']); ?></td>
                        </tr>
                        <?php endif; ?>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🔴 Redis-Konfiguration</h2>
            <p class="description">
                Redis bietet schnelleres Caching als WordPress-Transients.
            </p>
            
            <div class="yaa-form-row">
                <label for="enable_redis">Redis verwenden</label>
                <select id="enable_redis" name="yaa_settings[enable_redis]">
                    <option value="auto" <?php selected(($options['enable_redis'] ?? 'auto'), 'auto'); ?>>
                        🔄 Automatisch erkennen
                    </option>
                    <option value="yes" <?php selected(($options['enable_redis'] ?? 'auto'), 'yes'); ?>>
                        ✅ Ja, Redis verwenden
                    </option>
                    <option value="no" <?php selected(($options['enable_redis'] ?? 'auto'), 'no'); ?>>
                        ❌ Nein, nur Transients
                    </option>
                </select>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="redis_host">Host</label>
                    <input type="text" id="redis_host" name="yaa_settings[redis_host]" 
                           value="<?php echo esc_attr($options['redis_host'] ?? '127.0.0.1'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="redis_port">Port</label>
                    <input type="number" id="redis_port" name="yaa_settings[redis_port]" 
                           value="<?php echo esc_attr($options['redis_port'] ?? '6379'); ?>"
                           min="1" max="65535">
                </div>
                
                <div class="yaa-form-row">
                    <label for="redis_password">Passwort (optional)</label>
                    <input type="password" id="redis_password" name="yaa_settings[redis_password]" 
                           value="<?php echo esc_attr($options['redis_password'] ?? ''); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="redis_database">Datenbank (0-15)</label>
                    <input type="number" id="redis_database" name="yaa_settings[redis_database]" 
                           value="<?php echo esc_attr($options['redis_database'] ?? '0'); ?>"
                           min="0" max="15">
                </div>
            </div>
            
            <div class="yaa-form-row">
                <button type="button" class="button yaa-test-btn" data-action="yaa_test_redis">
                    🔍 Redis-Verbindung testen
                </button>
                <div class="yaa-test-result"></div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Render display settings
     * * @param array<string, mixed> $options
     */
    private function render_display_settings(array $options): void {
        ?>
        <div class="yaa-card">
            <h2>🎨 Styling Optionen</h2>
            
            <div class="yaa-form-row" style="background: #fff0f0; padding: 15px; border-left: 4px solid #ff4444;">
                <label>
                    <input type="checkbox" name="yaa_settings[disable_default_css]" value="yes" 
                        <?php checked(($options['disable_default_css'] ?? 'no'), 'yes'); ?>>
                    <strong>Standard-CSS komplett deaktivieren</strong>
                </label>
                <p class="description">
                    Aktivieren Sie diese Option, wenn Sie das Grid-Layout <strong>vollständig über Ihr Theme oder Custom CSS</strong> steuern möchten. 
                    Das Plugin lädt dann keine Stylesheets mehr im Frontend (nur noch JS für "mehr lesen").
                </p>
            </div>
        </div>

        <div class="yaa-card">
            <h2>📐 Grid-Layout</h2>
            <p class="description">Diese Einstellungen werden nur angewendet, wenn das Standard-CSS aktiv ist.</p>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="grid_columns_desktop">Spalten Desktop (>1024px)</label>
                    <select id="grid_columns_desktop" name="yaa_settings[grid_columns_desktop]">
                        <?php for ($i = 1; $i <= 6; $i++): ?>
                            <option value="<?php echo $i; ?>" <?php selected(($options['grid_columns_desktop'] ?? 3), $i); ?>>
                                <?php echo $i; ?> Spalte<?php echo $i > 1 ? 'n' : ''; ?>
                            </option>
                        <?php endfor; ?>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="grid_columns_tablet">Spalten Tablet (601-1024px)</label>
                    <select id="grid_columns_tablet" name="yaa_settings[grid_columns_tablet]">
                        <?php for ($i = 1; $i <= 4; $i++): ?>
                            <option value="<?php echo $i; ?>" <?php selected(($options['grid_columns_tablet'] ?? 2), $i); ?>>
                                <?php echo $i; ?> Spalte<?php echo $i > 1 ? 'n' : ''; ?>
                            </option>
                        <?php endfor; ?>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="grid_columns_mobile">Spalten Mobile (≤600px)</label>
                    <select id="grid_columns_mobile" name="yaa_settings[grid_columns_mobile]">
                        <?php for ($i = 1; $i <= 2; $i++): ?>
                            <option value="<?php echo $i; ?>" <?php selected(($options['grid_columns_mobile'] ?? 1), $i); ?>>
                                <?php echo $i; ?> Spalte<?php echo $i > 1 ? 'n' : ''; ?>
                            </option>
                        <?php endfor; ?>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🎨 Farben</h2>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="color_primary">Primärfarbe (Yadore)</label>
                    <input type="text" id="color_primary" name="yaa_settings[color_primary]" 
                           value="<?php echo esc_attr($options['color_primary'] ?? '#ff00cc'); ?>"
                           class="yaa-color-picker">
                </div>
                
                <div class="yaa-form-row">
                    <label for="color_secondary">Sekundärfarbe</label>
                    <input type="text" id="color_secondary" name="yaa_settings[color_secondary]" 
                           value="<?php echo esc_attr($options['color_secondary'] ?? '#00ffff'); ?>"
                           class="yaa-color-picker">
                </div>
                
                <div class="yaa-form-row">
                    <label for="color_amazon">Amazon-Farbe</label>
                    <input type="text" id="color_amazon" name="yaa_settings[color_amazon]" 
                           value="<?php echo esc_attr($options['color_amazon'] ?? '#ff9900'); ?>"
                           class="yaa-color-picker">
                </div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>⚙️ Anzeige-Optionen</h2>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[show_prime_badge]" value="yes" 
                        <?php checked(($options['show_prime_badge'] ?? 'yes'), 'yes'); ?>>
                    Prime-Badge bei Amazon-Produkten anzeigen
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[show_merchant]" value="yes" 
                        <?php checked(($options['show_merchant'] ?? 'yes'), 'yes'); ?>>
                    Händler-Namen anzeigen
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[show_description]" value="yes" 
                        <?php checked(($options['show_description'] ?? 'yes'), 'yes'); ?>>
                    Produktbeschreibung anzeigen
                </label>
            </div>
            
            <hr style="margin: 20px 0;">
            
            <h3>Button-Texte</h3>
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="button_text_yadore">Button-Text (Yadore)</label>
                    <input type="text" id="button_text_yadore" name="yaa_settings[button_text_yadore]" 
                           value="<?php echo esc_attr($options['button_text_yadore'] ?? 'Zum Angebot'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="button_text_amazon">Button-Text (Amazon)</label>
                    <input type="text" id="button_text_amazon" name="yaa_settings[button_text_amazon]" 
                           value="<?php echo esc_attr($options['button_text_amazon'] ?? 'Bei Amazon kaufen'); ?>">
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Render status page
     */
    public function render_status_page(): void {
        global $wpdb;
        
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $cache_status = $this->cache->get_status();
        $cached_keywords = get_option('yaa_cached_keywords', []);
        if (!is_array($cached_keywords)) {
            $cached_keywords = [];
        }
        $next_cron = wp_next_scheduled('yaa_cache_refresh_event');
        
        $cache_count = (int) $wpdb->get_var(
            "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '_transient_yaa_%' AND option_name NOT LIKE '_transient_timeout_%'"
        );
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1><?php esc_html_e('Cache & Status', 'yadore-amazon-api'); ?></h1>
            
            <div class="yaa-grid">
                <div class="yaa-card">
                    <h2>📊 Cache-Status</h2>
                    <table class="widefat striped">
                        <tr>
                            <td><strong>Backend:</strong></td>
                            <td>
                                <span class="yaa-status-badge <?php echo $cache_status['redis_available'] ? 'yaa-status-success' : 'yaa-status-warning'; ?>">
                                    <?php echo esc_html($cache_status['cache_backend']); ?>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Cache-Einträge:</strong></td>
                            <td><?php echo $cache_count; ?></td>
                        </tr>
                        <tr>
                            <td><strong>Getrackte Keywords:</strong></td>
                            <td><?php echo count($cached_keywords); ?></td>
                        </tr>
                        <tr>
                            <td><strong>Nächster Cron:</strong></td>
                            <td><?php echo $next_cron ? esc_html(date_i18n('d.m.Y H:i', $next_cron)) : 'Nicht geplant'; ?></td>
                        </tr>
                    </table>
                    
                    <p style="margin-top: 15px;">
                        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin-post.php?action=yaa_clear_cache'), 'yaa_clear_cache_nonce')); ?>" 
                           class="button button-primary">
                            🗑️ Cache leeren
                        </a>
                    </p>
                </div>
                
                <div class="yaa-card">
                    <h2>🔌 API-Status</h2>
                    <table class="widefat striped">
                        <tr>
                            <td><strong>Yadore API:</strong></td>
                            <td>
                                <?php if ($this->yadore_api->is_configured()): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Aktiv</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-error">❌ Nicht konfiguriert</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Amazon PA-API:</strong></td>
                            <td>
                                <?php if ($this->amazon_api->is_configured()): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Aktiv</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-error">❌ Nicht konfiguriert</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Redis:</strong></td>
                            <td>
                                <?php if ($cache_status['redis_available']): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Verbunden</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-warning">⚠️ Nicht verfügbar</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="yaa-card">
                <h2>🛠️ System-Informationen</h2>
                <table class="widefat striped">
                    <tr>
                        <td><strong>PHP Version:</strong></td>
                        <td><?php echo esc_html(PHP_VERSION); ?>
                            <?php if (version_compare(PHP_VERSION, '8.1', '>=')): ?>
                                <span class="yaa-status-badge yaa-status-success">✓</span>
                            <?php else: ?>
                                <span class="yaa-status-badge yaa-status-error">Minimum 8.1 erforderlich</span>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>WordPress Version:</strong></td>
                        <td><?php echo esc_html(get_bloginfo('version')); ?></td>
                    </tr>
                    <tr>
                        <td><strong>Plugin Version:</strong></td>
                        <td><?php echo esc_html(YAA_VERSION); ?></td>
                    </tr>
                    <tr>
                        <td><strong>PHP Redis Extension:</strong></td>
                        <td>
                            <?php if (extension_loaded('redis')): ?>
                                <span class="yaa-status-badge yaa-status-success">✅ Installiert</span>
                            <?php else: ?>
                                <span class="yaa-status-badge yaa-status-warning">Nicht installiert</span>
                            <?php endif; ?>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <?php
    }
    
    /**
     * Render documentation page
     */
    public function render_docs_page(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1><?php esc_html_e('Dokumentation', 'yadore-amazon-api'); ?></h1>
            
            <div class="yaa-card">
                <h2>🎨 CSS Klassen Referenz</h2>
                <p>Nutzen Sie diese Klassen, um das Design über <strong>Custom CSS</strong> in Ihrem Theme anzupassen.</p>
                <p>Wenn Sie die Option <em>"Standard-CSS deaktivieren"</em> nutzen, müssen Sie das Grid-Layout (z.B. mit Flexbox oder Grid) selbst definieren.</p>
                
                <div class="yaa-code-block">
                    <pre>
/* Haupt-Container */
.yaa-grid-container { }

/* Einzelnes Produkt-Element */
.yaa-item { }
.yaa-item.yaa-amazon { }  /* Nur Amazon Produkte */
.yaa-item.yaa-custom { }  /* Nur Eigene Produkte */
.yaa-item.yaa-yadore { }  /* Nur Yadore Produkte */

/* Badges */
.yaa-prime-badge { }      /* Prime Label */
.yaa-custom-badge { }     /* "Empfohlen" Label */

/* Bild-Bereich */
.yaa-image-wrapper { }
.yaa-image-wrapper img { }
.yaa-no-image { }         /* Fallback wenn kein Bild */

/* Inhalt */
.yaa-content { }
.yaa-title { }
.yaa-title a { }

/* Beschreibung & Mehr lesen */
.yaa-description-wrapper { }
.yaa-description { }
.yaa-description.expanded { } /* Wenn aufgeklappt */
.yaa-read-more { }        /* Button zum Aufklappen */
.yaa-no-description { }

/* Preis & Meta */
.yaa-meta { }
.yaa-price { }            /* Preis-Text */
.yaa-merchant { }         /* Händler-Name */

/* Buttons */
.yaa-button-wrapper { }
.yaa-button { }

/* Status Meldungen */
.yaa-message { }          /* Fehlermeldungen / Leere Suche */
.yaa-error { }
.yaa-empty { }
.yaa-icon { }
                    </pre>
                </div>
            </div>

            <div class="yaa-card">
                <h2>📝 Shortcodes</h2>
                
                <h3>Yadore Produkte</h3>
                <div class="yaa-shortcode-box">[yadore_products keyword="Smartphone" limit="9"]</div>
                <div class="yaa-shortcode-box">[yadore_products keywords="Smartphone,Tablet,Laptop" limit="9"]</div>
                
                <h3>Amazon Produkte</h3>
                <div class="yaa-shortcode-box">[amazon_products keyword="Laptop" category="Computers" limit="10"]</div>
                <div class="yaa-shortcode-box">[amazon_products asins="B08N5WRWNW,B09V3KXJPB"]</div>
                
                <h3>Eigene Produkte</h3>
                <div class="yaa-shortcode-box">[custom_products ids="123,456,789"]</div>
                <div class="yaa-shortcode-box">[custom_products category="elektronik" limit="6"]</div>
                
                <h3>Kombinierte Ansicht</h3>
                <div class="yaa-shortcode-box">[combined_products keyword="Kopfhörer" yadore_limit="6" amazon_limit="4" custom_ids="10,15"]</div>
                <div class="yaa-shortcode-box">[all_products keyword="Smartphone" total_limit="12" priority="custom,yadore,amazon"]</div>
            </div>
            
            <div class="yaa-card">
                <h2>⚙️ wp-config.php Konstanten</h2>
                <div class="yaa-code-block">
                    <pre>
// Yadore API
define('YADORE_API_KEY', 'dein-api-key');

// Amazon PA-API 5.0
define('AMAZON_PAAPI_ACCESS_KEY', 'AKIAXXXXXXXXXX');
define('AMAZON_PAAPI_SECRET_KEY', 'dein-secret-key');
define('AMAZON_PAAPI_PARTNER_TAG', 'deinshop-21');

// Redis (optional)
define('WP_REDIS_HOST', '127.0.0.1');
define('WP_REDIS_PORT', 6379);
                    </pre>
                </div>
            </div>
            
            <div class="yaa-card">
                <h2>🔗 Nützliche Links</h2>
                <ul style="list-style: disc; margin-left: 20px;">
                    <li><a href="https://www.yadore.com/publisher" target="_blank">Yadore Publisher Portal</a></li>
                    <li><a href="https://webservices.amazon.com/paapi5/documentation/" target="_blank">Amazon PA-API 5.0 Dokumentation</a></li>
                    <li><a href="https://affiliate-program.amazon.de/" target="_blank">Amazon PartnerNet (DE)</a></li>
                </ul>
            </div>
        </div>
        <?php
    }
    
    /**
     * Add admin bar button
     */
    public function add_admin_bar_button(\WP_Admin_Bar $admin_bar): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $admin_bar->add_menu([
            'id'    => 'yaa-clear-cache',
            'title' => '🗑️ YAA Cache leeren',
            'href'  => wp_nonce_url(admin_url('admin-post.php?action=yaa_clear_cache'), 'yaa_clear_cache_nonce'),
        ]);
    }
    
    /**
     * Handle clear cache action
     */
    public function handle_clear_cache(): void {
        if (!current_user_can('manage_options')) {
            wp_die(__('Keine Berechtigung', 'yadore-amazon-api'));
        }
        
        $nonce = $_GET['_wpnonce'] ?? '';
        if (!wp_verify_nonce($nonce, 'yaa_clear_cache_nonce')) {
            wp_die(__('Sicherheitscheck fehlgeschlagen', 'yadore-amazon-api'));
        }
        
        $this->cache->clear_all();
        
        set_transient('yaa_admin_notice', [
            'type'    => 'success', 
            'message' => __('Cache erfolgreich geleert!', 'yadore-amazon-api'),
        ], 30);
        
        $redirect = wp_get_referer() ?: admin_url('admin.php?page=yaa-status');
        wp_safe_redirect($redirect);
        exit;
    }
    
    /**
     * AJAX: Test Yadore connection
     */
    public function ajax_test_yadore(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $api_key = sanitize_text_field($_POST['yadore_api_key'] ?? '');
        $result = $this->yadore_api->test_connection($api_key !== '' ? $api_key : null);
        
        if ($result['success']) {
            wp_send_json_success($result);
        } else {
            wp_send_json_error($result);
        }
    }
    
    /**
     * AJAX: Test Amazon connection
     */
    public function ajax_test_amazon(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $access_key = sanitize_text_field($_POST['amazon_access_key'] ?? '');
        $secret_key = $_POST['amazon_secret_key'] ?? '';
        $partner_tag = sanitize_text_field($_POST['amazon_partner_tag'] ?? '');
        $marketplace = sanitize_text_field($_POST['amazon_marketplace'] ?? 'de');
        
        $result = $this->amazon_api->test_connection(
            $access_key !== '' ? $access_key : null,
            $secret_key !== '' ? $secret_key : null,
            $partner_tag !== '' ? $partner_tag : null,
            $marketplace
        );
        
        if ($result['success']) {
            wp_send_json_success($result);
        } else {
            wp_send_json_error($result);
        }
    }
    
    /**
     * AJAX: Test Redis connection
     */
    public function ajax_test_redis(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $host = sanitize_text_field($_POST['redis_host'] ?? '127.0.0.1');
        $port = (int) ($_POST['redis_port'] ?? 6379);
        $password = $_POST['redis_password'] ?? '';
        $database = (int) ($_POST['redis_database'] ?? 0);
        
        $result = $this->cache->test_connection($host, $port, $password, $database);
        
        if ($result['success']) {
            wp_send_json_success($result);
        } else {
            wp_send_json_error($result);
        }
    }
    
    /**
     * Admin notices
     */
    public function admin_notices(): void {
        $notice = get_transient('yaa_admin_notice');
        
        if ($notice !== false && is_array($notice)) {
            delete_transient('yaa_admin_notice');
            $type = ($notice['type'] ?? '') === 'success' ? 'success' : 'error';
            $message = $notice['message'] ?? '';
            
            echo '<div class="notice notice-' . esc_attr($type) . ' is-dismissible">';
            echo '<p><strong>Yadore-Amazon-API:</strong> ' . esc_html($message) . '</p>';
            echo '</div>';
        }
    }
    
    /**
     * Dashboard widget
     */
    public function add_dashboard_widget(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        wp_add_dashboard_widget(
            'yaa_status_widget',
            '📦 Yadore-Amazon-API Status',
            [$this, 'render_dashboard_widget']
        );
    }
    
    /**
     * Dashboard widget content
     */
    public function render_dashboard_widget(): void {
        $cache_status = $this->cache->get_status();
        $next_cron = wp_next_scheduled('yaa_cache_refresh_event');
        
        echo '<table class="widefat striped" style="border:none;">';
        echo '<tr><td>Yadore API:</td><td>' . ($this->yadore_api->is_configured() ? '✅ Aktiv' : '❌') . '</td></tr>';
        echo '<tr><td>Amazon PA-API:</td><td>' . ($this->amazon_api->is_configured() ? '✅ Aktiv' : '❌') . '</td></tr>';
        echo '<tr><td>Cache:</td><td>' . esc_html($cache_status['cache_backend']) . '</td></tr>';
        echo '<tr><td>Nächster Cron:</td><td>' . ($next_cron ? esc_html(date_i18n('d.m.Y H:i', $next_cron)) : '-') . '</td></tr>';
        echo '</table>';
        
        echo '<p style="margin-top:15px;">';
        echo '<a href="' . esc_url(admin_url('admin.php?page=yaa-settings')) . '" class="button">⚙️ Einstellungen</a> ';
        echo '<a href="' . esc_url(admin_url('admin.php?page=yaa-status')) . '" class="button">📊 Status</a>';
        echo '</p>';
    }
} 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-amazon-paapi.php 
 
<?php
/**
 * Amazon Product Advertising API 5.0 Handler
 * PHP 8.3+ compatible with ALL marketplaces
 * 
 * @see https://webservices.amazon.com/paapi5/documentation/
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Amazon_PAAPI {
    
    private YAA_Cache_Handler $cache;
    
    private string $access_key = '';
    private string $secret_key = '';
    private string $partner_tag = '';
    private string $host = '';
    private string $region = '';
    private string $marketplace = 'de';
    
    /**
     * All Amazon PA-API 5.0 Marketplaces
     * @see https://webservices.amazon.com/paapi5/documentation/locale-reference.html
     */
    private const ENDPOINTS = [
        // Europe
        'de' => [
            'host'        => 'webservices.amazon.de',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.de',
            'name'        => 'Amazon.de (Deutschland)',
            'currency'    => 'EUR',
            'language'    => 'de_DE',
            'languages'   => ['cs_CZ', 'de_DE', 'en_GB', 'nl_NL', 'pl_PL', 'tr_TR'],
        ],
        'fr' => [
            'host'        => 'webservices.amazon.fr',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.fr',
            'name'        => 'Amazon.fr (Frankreich)',
            'currency'    => 'EUR',
            'language'    => 'fr_FR',
            'languages'   => ['de_DE', 'en_GB', 'fr_FR'],
        ],
        'it' => [
            'host'        => 'webservices.amazon.it',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.it',
            'name'        => 'Amazon.it (Italien)',
            'currency'    => 'EUR',
            'language'    => 'it_IT',
            'languages'   => ['de_DE', 'en_GB', 'it_IT'],
        ],
        'es' => [
            'host'        => 'webservices.amazon.es',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.es',
            'name'        => 'Amazon.es (Spanien)',
            'currency'    => 'EUR',
            'language'    => 'es_ES',
            'languages'   => ['de_DE', 'en_GB', 'es_ES'],
        ],
        'co.uk' => [
            'host'        => 'webservices.amazon.co.uk',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.co.uk',
            'name'        => 'Amazon.co.uk (Großbritannien)',
            'currency'    => 'GBP',
            'language'    => 'en_GB',
            'languages'   => ['de_DE', 'en_GB'],
        ],
        'nl' => [
            'host'        => 'webservices.amazon.nl',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.nl',
            'name'        => 'Amazon.nl (Niederlande)',
            'currency'    => 'EUR',
            'language'    => 'nl_NL',
            'languages'   => ['de_DE', 'en_GB', 'nl_NL'],
        ],
        'pl' => [
            'host'        => 'webservices.amazon.pl',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.pl',
            'name'        => 'Amazon.pl (Polen)',
            'currency'    => 'PLN',
            'language'    => 'pl_PL',
            'languages'   => ['de_DE', 'en_GB', 'pl_PL'],
        ],
        'se' => [
            'host'        => 'webservices.amazon.se',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.se',
            'name'        => 'Amazon.se (Schweden)',
            'currency'    => 'SEK',
            'language'    => 'sv_SE',
            'languages'   => ['de_DE', 'en_GB', 'sv_SE'],
        ],
        'be' => [
            'host'        => 'webservices.amazon.com.be',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.com.be',
            'name'        => 'Amazon.com.be (Belgien)',
            'currency'    => 'EUR',
            'language'    => 'fr_BE',
            'languages'   => ['de_DE', 'en_GB', 'fr_BE', 'nl_BE'],
        ],
        'com.tr' => [
            'host'        => 'webservices.amazon.com.tr',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.com.tr',
            'name'        => 'Amazon.com.tr (Türkei)',
            'currency'    => 'TRY',
            'language'    => 'tr_TR',
            'languages'   => ['en_GB', 'tr_TR'],
        ],
        
        // Middle East & Africa
        'ae' => [
            'host'        => 'webservices.amazon.ae',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.ae',
            'name'        => 'Amazon.ae (VAE)',
            'currency'    => 'AED',
            'language'    => 'en_AE',
            'languages'   => ['ar_AE', 'en_AE'],
        ],
        'sa' => [
            'host'        => 'webservices.amazon.sa',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.sa',
            'name'        => 'Amazon.sa (Saudi-Arabien)',
            'currency'    => 'SAR',
            'language'    => 'en_AE',
            'languages'   => ['ar_AE', 'en_AE'],
        ],
        'eg' => [
            'host'        => 'webservices.amazon.eg',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.eg',
            'name'        => 'Amazon.eg (Ägypten)',
            'currency'    => 'EGP',
            'language'    => 'en_AE',
            'languages'   => ['ar_AE', 'en_AE'],
        ],
        
        // North America
        'com' => [
            'host'        => 'webservices.amazon.com',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.com',
            'name'        => 'Amazon.com (USA)',
            'currency'    => 'USD',
            'language'    => 'en_US',
            'languages'   => ['de_DE', 'en_US', 'es_US', 'ko_KR', 'pt_BR', 'zh_CN', 'zh_TW'],
        ],
        'ca' => [
            'host'        => 'webservices.amazon.ca',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.ca',
            'name'        => 'Amazon.ca (Kanada)',
            'currency'    => 'CAD',
            'language'    => 'en_CA',
            'languages'   => ['en_CA', 'fr_CA'],
        ],
        'com.mx' => [
            'host'        => 'webservices.amazon.com.mx',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.com.mx',
            'name'        => 'Amazon.com.mx (Mexiko)',
            'currency'    => 'MXN',
            'language'    => 'es_MX',
            'languages'   => ['en_US', 'es_MX'],
        ],
        'com.br' => [
            'host'        => 'webservices.amazon.com.br',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.com.br',
            'name'        => 'Amazon.com.br (Brasilien)',
            'currency'    => 'BRL',
            'language'    => 'pt_BR',
            'languages'   => ['en_US', 'pt_BR'],
        ],
        
        // Asia Pacific
        'co.jp' => [
            'host'        => 'webservices.amazon.co.jp',
            'region'      => 'us-west-2',
            'marketplace' => 'www.amazon.co.jp',
            'name'        => 'Amazon.co.jp (Japan)',
            'currency'    => 'JPY',
            'language'    => 'ja_JP',
            'languages'   => ['en_US', 'ja_JP', 'zh_CN'],
        ],
        'in' => [
            'host'        => 'webservices.amazon.in',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.in',
            'name'        => 'Amazon.in (Indien)',
            'currency'    => 'INR',
            'language'    => 'en_IN',
            'languages'   => ['en_IN', 'hi_IN', 'kn_IN', 'ml_IN', 'ta_IN', 'te_IN'],
        ],
        'com.au' => [
            'host'        => 'webservices.amazon.com.au',
            'region'      => 'us-west-2',
            'marketplace' => 'www.amazon.com.au',
            'name'        => 'Amazon.com.au (Australien)',
            'currency'    => 'AUD',
            'language'    => 'en_AU',
            'languages'   => ['en_AU'],
        ],
        'sg' => [
            'host'        => 'webservices.amazon.sg',
            'region'      => 'us-west-2',
            'marketplace' => 'www.amazon.sg',
            'name'        => 'Amazon.sg (Singapur)',
            'currency'    => 'SGD',
            'language'    => 'en_SG',
            'languages'   => ['en_SG', 'zh_CN'],
        ],
    ];
    
    /**
     * Search indexes for DE marketplace (example - varies by marketplace)
     */
    private const SEARCH_INDEXES_DE = [
        'All'                     => 'Alle Kategorien',
        'AmazonVideo'             => 'Prime Video',
        'Apparel'                 => 'Bekleidung',
        'Appliances'              => 'Elektro-Großgeräte',
        'Automotive'              => 'Auto & Motorrad',
        'Baby'                    => 'Baby',
        'Beauty'                  => 'Beauty',
        'Books'                   => 'Bücher',
        'Classical'               => 'Klassik',
        'Computers'               => 'Computer & Zubehör',
        'DigitalMusic'            => 'Musik-Downloads',
        'Electronics'             => 'Elektronik & Foto',
        'EverythingElse'          => 'Sonstiges',
        'Fashion'                 => 'Fashion',
        'ForeignBooks'            => 'Bücher (Fremdsprachig)',
        'GardenAndOutdoor'        => 'Garten',
        'GiftCards'               => 'Geschenkgutscheine',
        'GroceryAndGourmetFood'   => 'Lebensmittel & Getränke',
        'Handmade'                => 'Handmade',
        'HealthPersonalCare'      => 'Drogerie & Körperpflege',
        'HomeAndKitchen'          => 'Küche, Haushalt & Wohnen',
        'Industrial'              => 'Gewerbe, Industrie & Wissenschaft',
        'Jewelry'                 => 'Schmuck',
        'KindleStore'             => 'Kindle-Shop',
        'Lighting'                => 'Beleuchtung',
        'Luggage'                 => 'Koffer, Rucksäcke & Taschen',
        'LuxuryBeauty'            => 'Luxury Beauty',
        'Magazines'               => 'Zeitschriften',
        'MobileApps'              => 'Apps & Spiele',
        'MoviesAndTV'             => 'DVD & Blu-ray',
        'Music'                   => 'Musik-CDs & Vinyl',
        'MusicalInstruments'      => 'Musikinstrumente & DJ-Equipment',
        'OfficeProducts'          => 'Bürobedarf & Schreibwaren',
        'PetSupplies'             => 'Haustier',
        'Photo'                   => 'Kamera & Foto',
        'Shoes'                   => 'Schuhe & Handtaschen',
        'Software'                => 'Software',
        'SportsAndOutdoors'       => 'Sport & Freizeit',
        'ToolsAndHomeImprovement' => 'Baumarkt',
        'ToysAndGames'            => 'Spielzeug',
        'VHS'                     => 'VHS',
        'VideoGames'              => 'Games',
        'Watches'                 => 'Uhren',
    ];
    
    /**
     * Generic search indexes (available in most marketplaces)
     */
    private const SEARCH_INDEXES_GENERIC = [
        'All', 'Apparel', 'Appliances', 'Automotive', 'Baby', 'Beauty', 'Books',
        'Computers', 'Electronics', 'Fashion', 'GardenAndOutdoor', 'GiftCards',
        'GroceryAndGourmetFood', 'HealthPersonalCare', 'HomeAndKitchen', 'Industrial',
        'Jewelry', 'KindleStore', 'Luggage', 'MobileApps', 'MoviesAndTV', 'Music',
        'MusicalInstruments', 'OfficeProducts', 'PetSupplies', 'Shoes', 'Software',
        'SportsAndOutdoors', 'ToolsAndHomeImprovement', 'ToysAndGames', 'VideoGames', 'Watches',
    ];
    
    public function __construct(YAA_Cache_Handler $cache) {
        $this->cache = $cache;
        $this->load_credentials();
    }
    
    /**
     * Load API credentials
     */
    private function load_credentials(): void {
        $this->access_key = defined('AMAZON_PAAPI_ACCESS_KEY') 
            ? (string) AMAZON_PAAPI_ACCESS_KEY 
            : (string) yaa_get_option('amazon_access_key', '');
            
        $this->secret_key = defined('AMAZON_PAAPI_SECRET_KEY') 
            ? (string) AMAZON_PAAPI_SECRET_KEY 
            : (string) yaa_get_option('amazon_secret_key', '');
            
        $this->partner_tag = defined('AMAZON_PAAPI_PARTNER_TAG') 
            ? (string) AMAZON_PAAPI_PARTNER_TAG 
            : (string) yaa_get_option('amazon_partner_tag', '');
            
        $this->marketplace = (string) yaa_get_option('amazon_marketplace', 'de');
        
        $this->set_marketplace($this->marketplace);
    }
    
    /**
     * Set marketplace configuration
     */
    private function set_marketplace(string $marketplace): void {
        if (isset(self::ENDPOINTS[$marketplace])) {
            $this->host = self::ENDPOINTS[$marketplace]['host'];
            $this->region = self::ENDPOINTS[$marketplace]['region'];
            $this->marketplace = $marketplace;
        } else {
            // Default to Germany
            $this->host = self::ENDPOINTS['de']['host'];
            $this->region = self::ENDPOINTS['de']['region'];
            $this->marketplace = 'de';
        }
    }
    
    /**
     * Reload credentials
     */
    public function reload_credentials(): void {
        $this->load_credentials();
    }
    
    /**
     * Check if API is configured
     */
    public function is_configured(): bool {
        return $this->access_key !== '' 
            && $this->secret_key !== '' 
            && $this->partner_tag !== ''
            && yaa_get_option('enable_amazon', 'yes') === 'yes';
    }
    
    /**
     * Get Partner Tag
     */
    public function get_partner_tag(): string {
        return $this->partner_tag;
    }
    
    /**
     * Get current marketplace info
     * 
     * @return array<string, mixed>|null
     */
    public function get_current_marketplace(): ?array {
        return self::ENDPOINTS[$this->marketplace] ?? null;
    }
    
    /**
     * Get all available marketplaces
     * 
     * @return array<string, array<string, mixed>>
     */
    public function get_marketplaces(): array {
        return self::ENDPOINTS;
    }
    
    /**
     * Get marketplaces for select dropdown
     * 
     * @return array<string, string>
     */
    public function get_marketplace_options(): array {
        $options = [];
        foreach (self::ENDPOINTS as $code => $data) {
            $options[$code] = $data['name'];
        }
        return $options;
    }
    
    /**
     * Get languages for current marketplace
     * 
     * @return array<string>
     */
    public function get_available_languages(): array {
        return self::ENDPOINTS[$this->marketplace]['languages'] ?? ['en_US'];
    }
    
    /**
     * Get search indexes for current marketplace
     * 
     * @return array<string, string>
     */
    public function get_search_indexes(): array {
        // Return German-specific indexes if German marketplace
        if ($this->marketplace === 'de') {
            return self::SEARCH_INDEXES_DE;
        }
        
        // Return generic indexes for other marketplaces
        $indexes = [];
        foreach (self::SEARCH_INDEXES_GENERIC as $index) {
            $indexes[$index] = $index;
        }
        return $indexes;
    }
    
    /**
     * Get search indexes as simple list
     * 
     * @return array<string>
     */
    public function get_search_index_list(): array {
        return array_keys($this->get_search_indexes());
    }
    
    /**
     * Search products
     * 
     * @param array<string, mixed> $additional_params
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    public function search_items(
        string $keyword, 
        string $category = 'All', 
        int $item_count = 10,
        array $additional_params = []
    ): array|\WP_Error {
        if (!$this->is_configured()) {
            return new \WP_Error('not_configured', __('Amazon PA-API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        $keyword = trim($keyword);
        if ($keyword === '') {
            return new \WP_Error('no_keyword', __('Kein Suchbegriff angegeben.', 'yadore-amazon-api'));
        }
        
        // Check cache
        $cache_key = 'amazon_search_' . md5($keyword . $category . $item_count . serialize($additional_params) . $this->marketplace);
        $cached = $this->cache->get($cache_key);
        
        if ($cached !== false && is_array($cached)) {
            return $cached;
        }
        
        // Build payload
        $payload = [
            'Keywords'    => $keyword,
            'SearchIndex' => $category,
            'ItemCount'   => min(max(1, $item_count), 10),
            'PartnerTag'  => $this->partner_tag,
            'PartnerType' => 'Associates',
            'Resources'   => [
                'Images.Primary.Large',
                'Images.Primary.Medium',
                'ItemInfo.Title',
                'ItemInfo.Features',
                'ItemInfo.ProductInfo',
                'ItemInfo.ByLineInfo',
                'Offers.Listings.Price',
                'Offers.Listings.DeliveryInfo.IsPrimeEligible',
                'Offers.Listings.Condition',
                'Offers.Listings.MerchantInfo',
            ],
        ];
        
        // Add optional language
        $language = (string) yaa_get_option('amazon_language', '');
        if ($language !== '' && in_array($language, $this->get_available_languages(), true)) {
            $payload['LanguagesOfPreference'] = [$language];
        }
        
        // Add optional parameters
        if (!empty($additional_params['min_price'])) {
            $payload['MinPrice'] = (int) ($additional_params['min_price'] * 100);
        }
        if (!empty($additional_params['max_price'])) {
            $payload['MaxPrice'] = (int) ($additional_params['max_price'] * 100);
        }
        if (!empty($additional_params['brand'])) {
            $payload['Brand'] = (string) $additional_params['brand'];
        }
        if (!empty($additional_params['sort_by'])) {
            $payload['SortBy'] = (string) $additional_params['sort_by'];
        }
        
        $response = $this->send_request('SearchItems', $payload);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $items = $this->parse_search_response($response);
        
        // Cache results
        $this->cache->set($cache_key, $items, yaa_get_cache_time());
        
        // Track for preload
        $this->track_keyword($keyword, $category, $item_count);
        
        return $items;
    }
    
    /**
     * Get items by ASIN
     * 
     * @param string|array<string> $asins
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    public function get_items(string|array $asins): array|\WP_Error {
        if (!$this->is_configured()) {
            return new \WP_Error('not_configured', __('Amazon PA-API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        if (is_string($asins)) {
            $asins = [$asins];
        }
        
        $asins = array_slice(array_filter($asins), 0, 10);
        
        if (empty($asins)) {
            return new \WP_Error('no_asins', __('Keine ASINs angegeben.', 'yadore-amazon-api'));
        }
        
        // Check cache
        $cache_key = 'amazon_items_' . md5(implode(',', $asins) . $this->marketplace);
        $cached = $this->cache->get($cache_key);
        
        if ($cached !== false && is_array($cached)) {
            return $cached;
        }
        
        $payload = [
            'ItemIds'     => $asins,
            'PartnerTag'  => $this->partner_tag,
            'PartnerType' => 'Associates',
            'Resources'   => [
                'Images.Primary.Large',
                'Images.Primary.Medium',
                'ItemInfo.Title',
                'ItemInfo.Features',
                'ItemInfo.ProductInfo',
                'ItemInfo.ByLineInfo',
                'Offers.Listings.Price',
                'Offers.Listings.DeliveryInfo.IsPrimeEligible',
                'Offers.Listings.MerchantInfo',
            ],
        ];
        
        $response = $this->send_request('GetItems', $payload);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $items = $this->parse_items_response($response);
        
        // Cache results
        $this->cache->set($cache_key, $items, yaa_get_cache_time());
        
        return $items;
    }
    
    /**
     * Send request to Amazon PA-API
     * 
     * @param array<string, mixed> $payload
     * @return array<string, mixed>|\WP_Error
     */
    private function send_request(string $operation, array $payload): array|\WP_Error {
        $path = '/paapi5/' . strtolower($operation);
        $service = 'ProductAdvertisingAPI';
        
        $payload_json = wp_json_encode($payload);
        
        if ($payload_json === false) {
            return new \WP_Error('json_error', __('JSON Encoding fehlgeschlagen.', 'yadore-amazon-api'));
        }
        
        // Create signature
        $headers = $this->create_signed_headers('POST', $path, $payload_json, $service, $operation);
        
        $url = 'https://' . $this->host . $path;
        
        $response = wp_remote_post($url, [
            'headers' => $headers,
            'body'    => $payload_json,
            'timeout' => 15,
        ]);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if (!is_array($data)) {
            $data = [];
        }
        
        if ($status_code !== 200) {
            $error_message = $data['Errors'][0]['Message'] ?? 'HTTP Error ' . $status_code;
            $error_code = $data['Errors'][0]['Code'] ?? 'unknown_error';
            
            error_log('Amazon PA-API Error: ' . $error_code . ' - ' . $error_message);
            return new \WP_Error($error_code, $error_message);
        }
        
        return $data;
    }
    
    /**
     * Create AWS Signature v4 headers
     * 
     * @return array<string, string>
     */
    private function create_signed_headers(
        string $method, 
        string $path, 
        string $payload, 
        string $service, 
        string $operation
    ): array {
        $timestamp = gmdate('Ymd\THis\Z');
        $date = gmdate('Ymd');
        
        $content_type = 'application/json; charset=utf-8';
        $amz_target = 'com.amazon.paapi5.v1.ProductAdvertisingAPIv1.' . $operation;
        
        // Canonical headers (must be sorted)
        $canonical_headers = 
            'content-encoding:amz-1.0' . "\n" .
            'content-type:' . $content_type . "\n" .
            'host:' . $this->host . "\n" .
            'x-amz-date:' . $timestamp . "\n" .
            'x-amz-target:' . $amz_target . "\n";
        
        $signed_headers = 'content-encoding;content-type;host;x-amz-date;x-amz-target';
        
        // Canonical request
        $payload_hash = hash('sha256', $payload);
        $canonical_request = implode("\n", [
            $method,
            $path,
            '', // Query string
            $canonical_headers,
            $signed_headers,
            $payload_hash,
        ]);
        
        // String to sign
        $algorithm = 'AWS4-HMAC-SHA256';
        $credential_scope = $date . '/' . $this->region . '/' . $service . '/aws4_request';
        $string_to_sign = implode("\n", [
            $algorithm,
            $timestamp,
            $credential_scope,
            hash('sha256', $canonical_request),
        ]);
        
        // Signing key
        $signing_key = $this->get_signature_key($date, $service);
        $signature = hash_hmac('sha256', $string_to_sign, $signing_key);
        
        // Authorization header
        $authorization = $algorithm . ' ' .
            'Credential=' . $this->access_key . '/' . $credential_scope . ', ' .
            'SignedHeaders=' . $signed_headers . ', ' .
            'Signature=' . $signature;
        
        return [
            'Content-Type'     => $content_type,
            'Content-Encoding' => 'amz-1.0',
            'Host'             => $this->host,
            'X-Amz-Date'       => $timestamp,
            'X-Amz-Target'     => $amz_target,
            'Authorization'    => $authorization,
        ];
    }
    
    /**
     * Get AWS4 signing key
     */
    private function get_signature_key(string $date, string $service): string {
        $k_date    = hash_hmac('sha256', $date, 'AWS4' . $this->secret_key, true);
        $k_region  = hash_hmac('sha256', $this->region, $k_date, true);
        $k_service = hash_hmac('sha256', $service, $k_region, true);
        $k_signing = hash_hmac('sha256', 'aws4_request', $k_service, true);
        
        return $k_signing;
    }
    
    /**
     * Parse search response
     * 
     * @param array<string, mixed> $response
     * @return array<int, array<string, mixed>>
     */
    private function parse_search_response(array $response): array {
        $items = [];
        
        $search_items = $response['SearchResult']['Items'] ?? [];
        
        foreach ($search_items as $item) {
            $items[] = $this->normalize_item($item);
        }
        
        return $items;
    }
    
    /**
     * Parse items response
     * 
     * @param array<string, mixed> $response
     * @return array<int, array<string, mixed>>
     */
    private function parse_items_response(array $response): array {
        $items = [];
        
        $result_items = $response['ItemsResult']['Items'] ?? [];
        
        foreach ($result_items as $item) {
            $items[] = $this->normalize_item($item);
        }
        
        return $items;
    }
    
    /**
     * Normalize item to standard format
     * 
     * @param array<string, mixed> $item
     * @return array<string, mixed>
     */
    private function normalize_item(array $item): array {
        $marketplace_info = self::ENDPOINTS[$this->marketplace] ?? self::ENDPOINTS['de'];
        
        $normalized = [
            'id'          => $item['ASIN'] ?? uniqid('amazon_'),
            'asin'        => $item['ASIN'] ?? '',
            'title'       => $item['ItemInfo']['Title']['DisplayValue'] ?? '',
            'description' => '',
            'url'         => $item['DetailPageURL'] ?? '',
            'image'       => [
                'url'    => $item['Images']['Primary']['Large']['URL'] 
                         ?? $item['Images']['Primary']['Medium']['URL'] 
                         ?? '',
                'width'  => $item['Images']['Primary']['Large']['Width'] ?? 0,
                'height' => $item['Images']['Primary']['Large']['Height'] ?? 0,
            ],
            'price'       => [
                'amount'   => '',
                'currency' => $marketplace_info['currency'],
                'display'  => '',
            ],
            'merchant'    => [
                'name' => 'Amazon',
                'logo' => '',
            ],
            'source'      => 'amazon',
            'is_prime'    => false,
            'partner_tag' => $this->partner_tag,
            'marketplace' => $this->marketplace,
        ];
        
        // Extract price
        $listing = $item['Offers']['Listings'][0] ?? null;
        if ($listing !== null && isset($listing['Price'])) {
            $normalized['price']['amount'] = (string) ($listing['Price']['Amount'] ?? '');
            $normalized['price']['currency'] = $listing['Price']['Currency'] ?? $marketplace_info['currency'];
            $normalized['price']['display'] = $listing['Price']['DisplayAmount'] ?? '';
        }
        
        // Extract features as description
        $features = $item['ItemInfo']['Features']['DisplayValues'] ?? [];
        if (!empty($features)) {
            $normalized['description'] = implode(' • ', array_slice($features, 0, 3));
        }
        
        // Prime eligibility
        if (isset($listing['DeliveryInfo']['IsPrimeEligible'])) {
            $normalized['is_prime'] = (bool) $listing['DeliveryInfo']['IsPrimeEligible'];
        }
        
        // Merchant info
        if (isset($listing['MerchantInfo']['Name'])) {
            $normalized['merchant']['name'] = $listing['MerchantInfo']['Name'];
        }
        
        // Brand
        if (isset($item['ItemInfo']['ByLineInfo']['Brand']['DisplayValue'])) {
            $normalized['brand'] = $item['ItemInfo']['ByLineInfo']['Brand']['DisplayValue'];
        }
        
        return $normalized;
    }
    
    /**
     * Track keyword for cron preload
     */
    private function track_keyword(string $keyword, string $category, int $limit): void {
        $cached_keywords = get_option('yaa_cached_keywords', []);
        
        if (!is_array($cached_keywords)) {
            $cached_keywords = [];
        }
        
        $new_entry = [
            'keyword'     => $keyword,
            'category'    => $category,
            'limit'       => $limit,
            'source'      => 'amazon',
            'marketplace' => $this->marketplace,
        ];
        
        foreach ($cached_keywords as $entry) {
            if (($entry['keyword'] ?? '') === $keyword 
                && ($entry['source'] ?? '') === 'amazon'
                && ($entry['category'] ?? 'All') === $category
                && ($entry['marketplace'] ?? 'de') === $this->marketplace) {
                return;
            }
        }
        
        $cached_keywords[] = $new_entry;
        $cached_keywords = array_slice($cached_keywords, -30);
        update_option('yaa_cached_keywords', $cached_keywords);
    }
    
    /**
     * Test API connection
     * 
     * @return array{success: bool, message: string, code?: string}
     */
    public function test_connection(
        ?string $access_key = null, 
        ?string $secret_key = null, 
        ?string $partner_tag = null, 
        ?string $marketplace = null
    ): array {
        // Temporarily override credentials for test
        $orig_access = $this->access_key;
        $orig_secret = $this->secret_key;
        $orig_tag = $this->partner_tag;
        $orig_host = $this->host;
        $orig_region = $this->region;
        $orig_marketplace = $this->marketplace;
        
        if ($access_key !== null) {
            $this->access_key = $access_key;
        }
        if ($secret_key !== null) {
            $this->secret_key = $secret_key;
        }
        if ($partner_tag !== null) {
            $this->partner_tag = $partner_tag;
        }
        if ($marketplace !== null) {
            $this->set_marketplace($marketplace);
        }
        
        // Validation
        if ($this->access_key === '' || $this->secret_key === '' || $this->partner_tag === '') {
            // Restore
            $this->access_key = $orig_access;
            $this->secret_key = $orig_secret;
            $this->partner_tag = $orig_tag;
            $this->host = $orig_host;
            $this->region = $orig_region;
            $this->marketplace = $orig_marketplace;
            
            return [
                'success' => false,
                'message' => __('Bitte alle Felder ausfüllen.', 'yadore-amazon-api'),
            ];
        }
        
        // Simple search test
        $payload = [
            'Keywords'    => 'test',
            'SearchIndex' => 'All',
            'ItemCount'   => 1,
            'PartnerTag'  => $this->partner_tag,
            'PartnerType' => 'Associates',
            'Resources'   => ['ItemInfo.Title'],
        ];
        
        $result = $this->send_request('SearchItems', $payload);
        
        // Restore original credentials
        $this->access_key = $orig_access;
        $this->secret_key = $orig_secret;
        $this->partner_tag = $orig_tag;
        $this->host = $orig_host;
        $this->region = $orig_region;
        $this->marketplace = $orig_marketplace;
        
        if (is_wp_error($result)) {
            return [
                'success' => false,
                'message' => $result->get_error_message(),
                'code'    => $result->get_error_code(),
            ];
        }
        
        return [
            'success' => true,
            'message' => __('Verbindung erfolgreich!', 'yadore-amazon-api'),
        ];
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-cache-handler.php 
 
<?php
/**
 * Cache Handler - Redis detection and caching logic
 * PHP 8.3+ compatible
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Cache_Handler {
    
    private bool $redis_available = false;
    private ?\Redis $redis_client = null;
    private bool $using_object_cache = false;
    private ?object $predis_client = null;
    
    public function __construct() {
        $this->detect_redis();
    }
    
    /**
     * Detect if Redis is available
     */
    private function detect_redis(): void {
        $enable_redis = (string) yaa_get_option('enable_redis', 'auto');
        
        if ($enable_redis === 'no') {
            $this->redis_available = false;
            return;
        }
        
        // Method 1: Check WordPress object cache
        if (wp_using_ext_object_cache()) {
            global $wp_object_cache;
            
            $redis_detected = (defined('WP_REDIS_DISABLED') && !WP_REDIS_DISABLED)
                || (class_exists('Redis') && is_object($wp_object_cache) && property_exists($wp_object_cache, 'redis'))
                || defined('WP_REDIS_CLIENT');
            
            if ($redis_detected) {
                $this->redis_available = true;
                $this->using_object_cache = true;
                return;
            }
        }
        
        // Method 2: Direct Redis connection
        if ($enable_redis === 'yes' || $enable_redis === 'auto') {
            $this->try_direct_redis_connection();
        }
    }
    
    /**
     * Try direct Redis connection
     */
    private function try_direct_redis_connection(): void {
        $host = $this->get_redis_config('host', '127.0.0.1');
        $port = (int) $this->get_redis_config('port', 6379);
        $password = $this->get_redis_config('password', '');
        $database = (int) $this->get_redis_config('database', 0);
        
        // Try native Redis extension
        if (extension_loaded('redis') && class_exists('Redis')) {
            try {
                $redis = new \Redis();
                
                // PHP 8.3+ compatible connection
                $connected = @$redis->connect($host, $port, 2.0);
                
                if ($connected) {
                    if ($password !== '') {
                        $redis->auth($password);
                    }
                    if ($database > 0) {
                        $redis->select($database);
                    }
                    
                    // Test connection
                    $pong = $redis->ping();
                    if ($pong === true || $pong === '+PONG' || $pong === 'PONG') {
                        $this->redis_client = $redis;
                        $this->redis_available = true;
                        return;
                    }
                }
            } catch (\RedisException|\Exception $e) {
                error_log('YAA Redis Error: ' . $e->getMessage());
            }
        }
        
        // Try Predis (if available)
        if (!$this->redis_available && class_exists('Predis\Client')) {
            try {
                $config = [
                    'scheme' => 'tcp',
                    'host'   => $host,
                    'port'   => $port,
                ];
                
                if ($password !== '') {
                    $config['password'] = $password;
                }
                if ($database > 0) {
                    $config['database'] = $database;
                }
                
                /** @var \Predis\Client $predis */
                $predis = new \Predis\Client($config);
                $predis->ping();
                
                $this->predis_client = $predis;
                $this->redis_available = true;
            } catch (\Exception $e) {
                error_log('YAA Predis Error: ' . $e->getMessage());
            }
        }
    }
    
    /**
     * Get Redis configuration value
     */
    private function get_redis_config(string $key, mixed $default): mixed {
        // Constants take priority
        $constant_map = [
            'host'     => 'WP_REDIS_HOST',
            'port'     => 'WP_REDIS_PORT',
            'password' => 'WP_REDIS_PASSWORD',
            'database' => 'WP_REDIS_DATABASE',
        ];
        
        if (isset($constant_map[$key]) && defined($constant_map[$key])) {
            return constant($constant_map[$key]);
        }
        
        return yaa_get_option('redis_' . $key, $default);
    }
    
    /**
     * Check if Redis is available
     */
    public function is_redis_available(): bool {
        return $this->redis_available;
    }
    
    /**
     * Get cached data
     */
    public function get(string $key): mixed {
        $prefixed_key = 'yaa_' . $key;
        
        if ($this->redis_available) {
            if ($this->using_object_cache) {
                $data = wp_cache_get($prefixed_key, 'yaa');
                if ($data !== false) {
                    return $data;
                }
            } elseif ($this->redis_client instanceof \Redis) {
                try {
                    $data = $this->redis_client->get($prefixed_key);
                    if ($data !== false && $data !== null) {
                        return maybe_unserialize($data);
                    }
                } catch (\RedisException|\Exception $e) {
                    error_log('YAA Redis GET Error: ' . $e->getMessage());
                }
            } elseif ($this->predis_client !== null) {
                try {
                    $data = $this->predis_client->get($prefixed_key);
                    if ($data !== null) {
                        return maybe_unserialize($data);
                    }
                } catch (\Exception $e) {
                    error_log('YAA Predis GET Error: ' . $e->getMessage());
                }
            }
        }
        
        return get_transient($prefixed_key);
    }
    
    /**
     * Set cached data
     */
    public function set(string $key, mixed $data, ?int $expiration = null): bool {
        $expiration ??= yaa_get_cache_time();
        $prefixed_key = 'yaa_' . $key;
        
        if ($this->redis_available) {
            if ($this->using_object_cache) {
                wp_cache_set($prefixed_key, $data, 'yaa', $expiration);
            } elseif ($this->redis_client instanceof \Redis) {
                try {
                    $serialized = maybe_serialize($data);
                    $this->redis_client->setex($prefixed_key, $expiration, $serialized);
                } catch (\RedisException|\Exception $e) {
                    error_log('YAA Redis SET Error: ' . $e->getMessage());
                }
            } elseif ($this->predis_client !== null) {
                try {
                    $serialized = maybe_serialize($data);
                    $this->predis_client->setex($prefixed_key, $expiration, $serialized);
                } catch (\Exception $e) {
                    error_log('YAA Predis SET Error: ' . $e->getMessage());
                }
            }
        }
        
        return set_transient($prefixed_key, $data, $expiration);
    }
    
    /**
     * Delete cached data
     */
    public function delete(string $key): void {
        $prefixed_key = 'yaa_' . $key;
        
        if ($this->redis_available) {
            if ($this->using_object_cache) {
                wp_cache_delete($prefixed_key, 'yaa');
            } elseif ($this->redis_client instanceof \Redis) {
                try {
                    $this->redis_client->del($prefixed_key);
                } catch (\RedisException|\Exception $e) {
                    error_log('YAA Redis DEL Error: ' . $e->getMessage());
                }
            } elseif ($this->predis_client !== null) {
                try {
                    $this->predis_client->del([$prefixed_key]);
                } catch (\Exception $e) {
                    error_log('YAA Predis DEL Error: ' . $e->getMessage());
                }
            }
        }
        
        delete_transient($prefixed_key);
    }
    
    /**
     * Clear all YAA cache entries
     */
    public function clear_all(): bool {
        global $wpdb;
        
        // Clear Redis
        if ($this->redis_available && !$this->using_object_cache) {
            try {
                if ($this->redis_client instanceof \Redis) {
                    $keys = $this->redis_client->keys('yaa_*');
                    if (!empty($keys)) {
                        $this->redis_client->del($keys);
                    }
                } elseif ($this->predis_client !== null) {
                    $keys = $this->predis_client->keys('yaa_*');
                    if (!empty($keys)) {
                        $this->predis_client->del($keys);
                    }
                }
            } catch (\Exception $e) {
                error_log('YAA Redis CLEAR Error: ' . $e->getMessage());
            }
        }
        
        // Clear object cache group
        if (function_exists('wp_cache_flush_group')) {
            wp_cache_flush_group('yaa');
        }
        
        // Clear transients
        $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_yaa_%'");
        $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_yaa_%'");
        
        return true;
    }
    
    /**
     * Get detailed cache status
     * 
     * @return array<string, mixed>
     */
    public function get_status(): array {
        $status = [
            'redis_available'    => $this->redis_available,
            'using_object_cache' => $this->using_object_cache,
            'cache_backend'      => 'WordPress Transients',
            'redis_info'         => null,
        ];
        
        if ($this->redis_available) {
            $status['cache_backend'] = $this->using_object_cache 
                ? 'WordPress Object Cache (Redis)' 
                : 'Direct Redis Connection';
            
            if ($this->redis_client instanceof \Redis) {
                try {
                    $info = $this->redis_client->info();
                    $status['redis_info'] = [
                        'version'           => $info['redis_version'] ?? 'Unknown',
                        'used_memory'       => $info['used_memory_human'] ?? 'Unknown',
                        'connected_clients' => $info['connected_clients'] ?? 'Unknown',
                    ];
                } catch (\Exception $e) {
                    // Ignore
                }
            }
        }
        
        return $status;
    }
    
    /**
     * Test Redis connection with custom settings
     * 
     * @return array{success: bool, message: string}
     */
    public function test_connection(string $host, int $port, string $password = '', int $database = 0): array {
        if (!extension_loaded('redis') || !class_exists('Redis')) {
            return [
                'success' => false,
                'message' => __('PHP Redis Extension nicht installiert.', 'yadore-amazon-api'),
            ];
        }
        
        try {
            $redis = new \Redis();
            
            $connected = @$redis->connect($host, $port, 2.0);
            
            if (!$connected) {
                return [
                    'success' => false,
                    'message' => __('Verbindung zu Redis fehlgeschlagen.', 'yadore-amazon-api'),
                ];
            }
            
            if ($password !== '') {
                $auth_result = $redis->auth($password);
                if (!$auth_result) {
                    return [
                        'success' => false,
                        'message' => __('Redis-Authentifizierung fehlgeschlagen.', 'yadore-amazon-api'),
                    ];
                }
            }
            
            if ($database > 0) {
                $redis->select($database);
            }
            
            $pong = $redis->ping();
            $redis->close();
            
            $success = $pong === true || $pong === '+PONG' || $pong === 'PONG';
            
            return [
                'success' => $success,
                'message' => $success 
                    ? __('Redis-Verbindung erfolgreich!', 'yadore-amazon-api')
                    : __('Redis-Ping fehlgeschlagen.', 'yadore-amazon-api'),
            ];
        } catch (\RedisException|\Exception $e) {
            return [
                'success' => false,
                'message' => 'Fehler: ' . $e->getMessage(),
            ];
        }
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-custom-products.php 
 
<?php
/**
 * Custom Products - Eigene Produkte verwalten
 * PHP 8.3+ compatible
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Custom_Products {
    
    private const POST_TYPE = 'yaa_product';
    private const TAXONOMY = 'yaa_product_category';
    
    public function __construct() {
        add_action('init', [$this, 'register_post_type']);
        add_action('init', [$this, 'register_taxonomy']);
        add_action('add_meta_boxes', [$this, 'add_meta_boxes']);
        add_action('save_post_' . self::POST_TYPE, [$this, 'save_meta_data']);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_scripts']);
        add_filter('manage_' . self::POST_TYPE . '_posts_columns', [$this, 'add_admin_columns']);
        add_action('manage_' . self::POST_TYPE . '_posts_custom_column', [$this, 'render_admin_columns'], 10, 2);
    }
    
    /**
     * Register Custom Post Type
     */
    public function register_post_type(): void {
        $labels = [
            'name'                  => __('Eigene Produkte', 'yadore-amazon-api'),
            'singular_name'         => __('Produkt', 'yadore-amazon-api'),
            'menu_name'             => __('Eigene Produkte', 'yadore-amazon-api'),
            'add_new'               => __('Neues Produkt', 'yadore-amazon-api'),
            'add_new_item'          => __('Neues Produkt hinzufügen', 'yadore-amazon-api'),
            'edit_item'             => __('Produkt bearbeiten', 'yadore-amazon-api'),
            'new_item'              => __('Neues Produkt', 'yadore-amazon-api'),
            'view_item'             => __('Produkt ansehen', 'yadore-amazon-api'),
            'search_items'          => __('Produkte suchen', 'yadore-amazon-api'),
            'not_found'             => __('Keine Produkte gefunden', 'yadore-amazon-api'),
            'not_found_in_trash'    => __('Keine Produkte im Papierkorb', 'yadore-amazon-api'),
            'all_items'             => __('Alle Produkte', 'yadore-amazon-api'),
            'featured_image'        => __('Produktbild', 'yadore-amazon-api'),
            'set_featured_image'    => __('Produktbild festlegen', 'yadore-amazon-api'),
            'remove_featured_image' => __('Produktbild entfernen', 'yadore-amazon-api'),
            'use_featured_image'    => __('Als Produktbild verwenden', 'yadore-amazon-api'),
        ];
        
        $args = [
            'labels'              => $labels,
            'public'              => false,
            'publicly_queryable'  => false,
            'show_ui'             => true,
            'show_in_menu'        => 'yaa-settings', // Als Untermenü von YAA
            'query_var'           => false,
            'rewrite'             => false,
            'capability_type'     => 'post',
            'has_archive'         => false,
            'hierarchical'        => false,
            'menu_position'       => null,
            'menu_icon'           => 'dashicons-products',
            'supports'            => ['title', 'thumbnail'],
            'show_in_rest'        => true,
        ];
        
        register_post_type(self::POST_TYPE, $args);
    }
    
    /**
     * Register Taxonomy for Product Categories
     */
    public function register_taxonomy(): void {
        $labels = [
            'name'              => __('Produkt-Kategorien', 'yadore-amazon-api'),
            'singular_name'     => __('Kategorie', 'yadore-amazon-api'),
            'search_items'      => __('Kategorien suchen', 'yadore-amazon-api'),
            'all_items'         => __('Alle Kategorien', 'yadore-amazon-api'),
            'parent_item'       => __('Übergeordnete Kategorie', 'yadore-amazon-api'),
            'parent_item_colon' => __('Übergeordnete Kategorie:', 'yadore-amazon-api'),
            'edit_item'         => __('Kategorie bearbeiten', 'yadore-amazon-api'),
            'update_item'       => __('Kategorie aktualisieren', 'yadore-amazon-api'),
            'add_new_item'      => __('Neue Kategorie hinzufügen', 'yadore-amazon-api'),
            'new_item_name'     => __('Neuer Kategorie-Name', 'yadore-amazon-api'),
            'menu_name'         => __('Kategorien', 'yadore-amazon-api'),
        ];
        
        $args = [
            'hierarchical'      => true,
            'labels'            => $labels,
            'show_ui'           => true,
            'show_admin_column' => true,
            'query_var'         => false,
            'rewrite'           => false,
            'show_in_rest'      => true,
        ];
        
        register_taxonomy(self::TAXONOMY, self::POST_TYPE, $args);
    }
    
    /**
     * Add Meta Boxes
     */
    public function add_meta_boxes(): void {
        add_meta_box(
            'yaa_product_details',
            __('Produkt-Details', 'yadore-amazon-api'),
            [$this, 'render_meta_box'],
            self::POST_TYPE,
            'normal',
            'high'
        );
    }
    
    /**
     * Render Meta Box
     */
    public function render_meta_box(\WP_Post $post): void {
        wp_nonce_field('yaa_product_meta', 'yaa_product_meta_nonce');
        
        // Bestehende Werte laden
        $url = get_post_meta($post->ID, '_yaa_product_url', true);
        $price = get_post_meta($post->ID, '_yaa_product_price', true);
        $currency = get_post_meta($post->ID, '_yaa_product_currency', true) ?: 'EUR';
        $merchant = get_post_meta($post->ID, '_yaa_product_merchant', true);
        $description = get_post_meta($post->ID, '_yaa_product_description', true);
        $button_text = get_post_meta($post->ID, '_yaa_product_button_text', true);
        $is_prime = get_post_meta($post->ID, '_yaa_product_is_prime', true);
        $external_image = get_post_meta($post->ID, '_yaa_product_external_image', true);
        $sort_order = get_post_meta($post->ID, '_yaa_product_sort_order', true) ?: 0;
        
        ?>
        <style>
            .yaa-meta-row { margin-bottom: 15px; }
            .yaa-meta-row label { display: block; font-weight: 600; margin-bottom: 5px; }
            .yaa-meta-row input[type="text"],
            .yaa-meta-row input[type="url"],
            .yaa-meta-row input[type="number"],
            .yaa-meta-row select,
            .yaa-meta-row textarea { width: 100%; max-width: 600px; }
            .yaa-meta-row textarea { min-height: 100px; }
            .yaa-meta-row .description { color: #666; font-size: 12px; margin-top: 4px; }
            .yaa-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            @media (max-width: 782px) { .yaa-meta-grid { grid-template-columns: 1fr; } }
            .yaa-required { color: #dc3232; }
        </style>
        
        <div class="yaa-meta-grid">
            <div>
                <div class="yaa-meta-row">
                    <label for="yaa_product_url">
                        <?php esc_html_e('Produkt-URL / Affiliate-Link', 'yadore-amazon-api'); ?>
                        <span class="yaa-required">*</span>
                    </label>
                    <input type="url" id="yaa_product_url" name="yaa_product_url" 
                           value="<?php echo esc_attr($url); ?>" required>
                    <p class="description"><?php esc_html_e('Der Link zum Produkt oder Affiliate-Link.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_price"><?php esc_html_e('Preis', 'yadore-amazon-api'); ?></label>
                    <input type="text" id="yaa_product_price" name="yaa_product_price" 
                           value="<?php echo esc_attr($price); ?>" placeholder="29.99">
                    <p class="description"><?php esc_html_e('Numerischer Preis ohne Währungszeichen.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_currency"><?php esc_html_e('Währung', 'yadore-amazon-api'); ?></label>
                    <select id="yaa_product_currency" name="yaa_product_currency">
                        <?php
                        $currencies = ['EUR' => '€ Euro', 'USD' => '$ US-Dollar', 'GBP' => '£ Pfund', 'CHF' => 'CHF Franken', 'PLN' => 'zł Zloty'];
                        foreach ($currencies as $code => $label):
                        ?>
                            <option value="<?php echo esc_attr($code); ?>" <?php selected($currency, $code); ?>>
                                <?php echo esc_html($label); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_merchant"><?php esc_html_e('Händler / Shop', 'yadore-amazon-api'); ?></label>
                    <input type="text" id="yaa_product_merchant" name="yaa_product_merchant" 
                           value="<?php echo esc_attr($merchant); ?>" placeholder="Amazon, eBay, ...">
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_button_text"><?php esc_html_e('Button-Text (optional)', 'yadore-amazon-api'); ?></label>
                    <input type="text" id="yaa_product_button_text" name="yaa_product_button_text" 
                           value="<?php echo esc_attr($button_text); ?>" placeholder="Zum Angebot">
                    <p class="description"><?php esc_html_e('Überschreibt den Standard-Button-Text.', 'yadore-amazon-api'); ?></p>
                </div>
            </div>
            
            <div>
                <div class="yaa-meta-row">
                    <label for="yaa_product_description"><?php esc_html_e('Beschreibung', 'yadore-amazon-api'); ?></label>
                    <textarea id="yaa_product_description" name="yaa_product_description"><?php echo esc_textarea($description); ?></textarea>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_external_image"><?php esc_html_e('Externes Bild (URL)', 'yadore-amazon-api'); ?></label>
                    <input type="url" id="yaa_product_external_image" name="yaa_product_external_image" 
                           value="<?php echo esc_attr($external_image); ?>">
                    <p class="description"><?php esc_html_e('Optional: Externe Bild-URL. Hat Vorrang vor dem Beitragsbild.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_sort_order"><?php esc_html_e('Sortierung', 'yadore-amazon-api'); ?></label>
                    <input type="number" id="yaa_product_sort_order" name="yaa_product_sort_order" 
                           value="<?php echo esc_attr($sort_order); ?>" min="0" step="1">
                    <p class="description"><?php esc_html_e('Kleinere Zahlen werden zuerst angezeigt.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label>
                        <input type="checkbox" name="yaa_product_is_prime" value="1" <?php checked($is_prime, '1'); ?>>
                        <?php esc_html_e('Prime-Badge anzeigen', 'yadore-amazon-api'); ?>
                    </label>
                    <p class="description"><?php esc_html_e('Zeigt ein Prime-Badge wie bei Amazon-Produkten.', 'yadore-amazon-api'); ?></p>
                </div>
            </div>
        </div>
        
        <hr style="margin: 20px 0;">
        
        <h4><?php esc_html_e('Shortcode-Verwendung', 'yadore-amazon-api'); ?></h4>
        <p>
            <code>[custom_products ids="<?php echo $post->ID; ?>"]</code> – 
            <?php esc_html_e('Dieses Produkt einzeln anzeigen', 'yadore-amazon-api'); ?>
        </p>
        <?php
    }
    
    /**
     * Save Meta Data
     */
    public function save_meta_data(int $post_id): void {
        // Nonce check
        if (!isset($_POST['yaa_product_meta_nonce']) || 
            !wp_verify_nonce($_POST['yaa_product_meta_nonce'], 'yaa_product_meta')) {
            return;
        }
        
        // Auto-save check
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        
        // Permission check
        if (!current_user_can('edit_post', $post_id)) {
            return;
        }
        
        // Felder speichern
        $fields = [
            '_yaa_product_url'            => 'esc_url_raw',
            '_yaa_product_price'          => 'sanitize_text_field',
            '_yaa_product_currency'       => 'sanitize_text_field',
            '_yaa_product_merchant'       => 'sanitize_text_field',
            '_yaa_product_description'    => 'sanitize_textarea_field',
            '_yaa_product_button_text'    => 'sanitize_text_field',
            '_yaa_product_external_image' => 'esc_url_raw',
            '_yaa_product_sort_order'     => 'absint',
        ];
        
        foreach ($fields as $meta_key => $sanitize_callback) {
            $field_name = str_replace('_yaa_product_', 'yaa_product_', $meta_key);
            
            if (isset($_POST[$field_name])) {
                $value = call_user_func($sanitize_callback, $_POST[$field_name]);
                update_post_meta($post_id, $meta_key, $value);
            }
        }
        
        // Checkbox
        $is_prime = isset($_POST['yaa_product_is_prime']) ? '1' : '';
        update_post_meta($post_id, '_yaa_product_is_prime', $is_prime);
    }
    
    /**
     * Enqueue admin scripts
     */
    public function enqueue_admin_scripts(string $hook): void {
        global $post_type;
        
        if ($post_type !== self::POST_TYPE) {
            return;
        }
        
        wp_enqueue_media();
    }
    
    /**
     * Add admin columns
     * 
     * @param array<string, string> $columns
     * @return array<string, string>
     */
    public function add_admin_columns(array $columns): array {
        $new_columns = [];
        
        foreach ($columns as $key => $value) {
            $new_columns[$key] = $value;
            
            if ($key === 'title') {
                $new_columns['yaa_image'] = __('Bild', 'yadore-amazon-api');
                $new_columns['yaa_price'] = __('Preis', 'yadore-amazon-api');
                $new_columns['yaa_merchant'] = __('Händler', 'yadore-amazon-api');
            }
        }
        
        $new_columns['yaa_shortcode'] = __('Shortcode', 'yadore-amazon-api');
        
        return $new_columns;
    }
    
    /**
     * Render admin columns
     */
    public function render_admin_columns(string $column, int $post_id): void {
        switch ($column) {
            case 'yaa_image':
                $external_image = get_post_meta($post_id, '_yaa_product_external_image', true);
                if ($external_image) {
                    echo '<img src="' . esc_url($external_image) . '" style="width:50px;height:50px;object-fit:contain;">';
                } elseif (has_post_thumbnail($post_id)) {
                    echo get_the_post_thumbnail($post_id, [50, 50], ['style' => 'object-fit:contain;']);
                } else {
                    echo '—';
                }
                break;
                
            case 'yaa_price':
                $price = get_post_meta($post_id, '_yaa_product_price', true);
                $currency = get_post_meta($post_id, '_yaa_product_currency', true) ?: 'EUR';
                echo $price ? esc_html($price . ' ' . $currency) : '—';
                break;
                
            case 'yaa_merchant':
                $merchant = get_post_meta($post_id, '_yaa_product_merchant', true);
                echo $merchant ? esc_html($merchant) : '—';
                break;
                
            case 'yaa_shortcode':
                echo '<code style="font-size:11px;">[custom_products ids="' . $post_id . '"]</code>';
                break;
        }
    }
    
    /**
     * Get products by IDs
     * 
     * @param array<int> $ids
     * @return array<int, array<string, mixed>>
     */
    public function get_products_by_ids(array $ids): array {
        if (empty($ids)) {
            return [];
        }
        
        $args = [
            'post_type'      => self::POST_TYPE,
            'post__in'       => $ids,
            'posts_per_page' => count($ids),
            'orderby'        => 'post__in',
            'post_status'    => 'publish',
        ];
        
        $query = new \WP_Query($args);
        
        return $this->format_products($query->posts);
    }
    
    /**
     * Get products by category
     * 
     * @return array<int, array<string, mixed>>
     */
    public function get_products_by_category(string $category, int $limit = 10): array {
        $args = [
            'post_type'      => self::POST_TYPE,
            'posts_per_page' => $limit,
            'post_status'    => 'publish',
            'meta_key'       => '_yaa_product_sort_order',
            'orderby'        => 'meta_value_num',
            'order'          => 'ASC',
            'tax_query'      => [
                [
                    'taxonomy' => self::TAXONOMY,
                    'field'    => 'slug',
                    'terms'    => $category,
                ],
            ],
        ];
        
        $query = new \WP_Query($args);
        
        return $this->format_products($query->posts);
    }
    
    /**
     * Get all products
     * 
     * @return array<int, array<string, mixed>>
     */
    public function get_all_products(int $limit = -1): array {
        $args = [
            'post_type'      => self::POST_TYPE,
            'posts_per_page' => $limit,
            'post_status'    => 'publish',
            'meta_key'       => '_yaa_product_sort_order',
            'orderby'        => 'meta_value_num',
            'order'          => 'ASC',
        ];
        
        $query = new \WP_Query($args);
        
        return $this->format_products($query->posts);
    }
    
    /**
     * Format products to standard array format
     * 
     * @param array<\WP_Post> $posts
     * @return array<int, array<string, mixed>>
     */
    private function format_products(array $posts): array {
        $products = [];
        
        foreach ($posts as $post) {
            $external_image = get_post_meta($post->ID, '_yaa_product_external_image', true);
            $image_url = '';
            
            if (!empty($external_image)) {
                $image_url = $external_image;
            } elseif (has_post_thumbnail($post->ID)) {
                $image_url = get_the_post_thumbnail_url($post->ID, 'large');
            }
            
            $products[] = [
                'id'          => 'custom_' . $post->ID,
                'post_id'     => $post->ID,
                'title'       => $post->post_title,
                'description' => get_post_meta($post->ID, '_yaa_product_description', true) ?: '',
                'url'         => get_post_meta($post->ID, '_yaa_product_url', true) ?: '#',
                'image'       => [
                    'url' => $image_url,
                ],
                'price'       => [
                    'amount'   => get_post_meta($post->ID, '_yaa_product_price', true) ?: '',
                    'currency' => get_post_meta($post->ID, '_yaa_product_currency', true) ?: 'EUR',
                    'display'  => '',
                ],
                'merchant'    => [
                    'name' => get_post_meta($post->ID, '_yaa_product_merchant', true) ?: '',
                ],
                'source'      => 'custom',
                'is_prime'    => get_post_meta($post->ID, '_yaa_product_is_prime', true) === '1',
                'button_text' => get_post_meta($post->ID, '_yaa_product_button_text', true) ?: '',
            ];
        }
        
        return $products;
    }
    
    /**
     * Get post type name
     */
    public static function get_post_type(): string {
        return self::POST_TYPE;
    }
    
    /**
     * Get taxonomy name
     */
    public static function get_taxonomy(): string {
        return self::TAXONOMY;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-image-handler.php 
 
<?php
/**
 * Image Handler Class
 * Handles downloading remote images and serving local versions.
 * Includes fallback to placeholder if download fails.
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

class YAA_Image_Handler {

    /**
     * Process an image: Download if not exists, return local URL.
     * * @param string|null $remote_url The remote image URL.
     * @param string $id Unique identifier (ASIN or EAN) for the filename.
     * @return string Local URL or Placeholder URL.
     */
    public static function process(?string $remote_url, string $id): string {
        // 1. Check if remote URL is valid
        if (empty($remote_url)) {
            return self::get_placeholder_url();
        }

        // 2. Setup Upload Directory
        $upload_dir = wp_upload_dir();
        if (isset($upload_dir['error']) && $upload_dir['error'] !== false) {
            return $remote_url; // Fallback to remote if uploads folder is broken
        }

        $base_dir = $upload_dir['basedir'] . '/yadore-amazon-api';
        $base_url = $upload_dir['baseurl'] . '/yadore-amazon-api';

        // Create directory if not exists
        if (!file_exists($base_dir)) {
            if (!wp_mkdir_p($base_dir)) {
                return $remote_url; // Fallback if cannot create dir
            }
        }

        // 3. Define Filename
        // Remove query parameters from extension (e.g. image.jpg?size=...)
        $path_parts = pathinfo(parse_url($remote_url, PHP_URL_PATH));
        $ext = isset($path_parts['extension']) ? $path_parts['extension'] : 'jpg';
        if (empty($ext) || strlen($ext) > 4) $ext = 'jpg';
        
        $filename = sanitize_file_name($id) . '.' . $ext;
        $file_path = $base_dir . '/' . $filename;
        $file_url = $base_url . '/' . $filename;

        // 4. Return local URL if already exists
        if (file_exists($file_path)) {
            return $file_url;
        }

        // 5. Download Image
        $response = wp_remote_get($remote_url, [
            'timeout' => 15,
            'sslverify' => false, // Sometimes needed for specific CDNs
            'user-agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36'
        ]);

        if (is_wp_error($response) || wp_remote_retrieve_response_code($response) !== 200) {
            // Download failed
            return self::get_placeholder_url();
        }

        $body = wp_remote_retrieve_body($response);
        if (empty($body)) {
            return self::get_placeholder_url();
        }

        // 6. Save File
        if (file_put_contents($file_path, $body) === false) {
            return self::get_placeholder_url();
        }

        return $file_url;
    }

    /**
     * Returns a Data URI for a placeholder image (SVG).
     * No external request needed.
     */
    public static function get_placeholder_url(): string {
        // Simple gray placeholder with a "No Image" icon style
        $svg = '<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300" fill="#f0f0f0">
            <rect width="300" height="300" fill="#e0e0e0"/>
            <path d="M110 130 L150 90 L190 130" stroke="#999" stroke-width="10" fill="none"/>
            <rect x="130" y="110" width="40" height="80" fill="#999"/>
            <text x="50%" y="80%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" fill="#777">Kein Bild</text>
        </svg>';
        
        return 'data:image/svg+xml;base64,' . base64_encode($svg);
    }
} 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-shortcode-renderer.php 
 
<?php
/**
 * Shortcode Renderer - Erweitert mit eigenen Produkten & Multi-Keyword Support
 * PHP 8.3+ compatible
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Shortcode_Renderer {
    
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    private YAA_Cache_Handler $cache;
    private YAA_Custom_Products $custom_products;
    
    public function __construct(
        YAA_Yadore_API $yadore_api, 
        YAA_Amazon_PAAPI $amazon_api, 
        YAA_Cache_Handler $cache,
        YAA_Custom_Products $custom_products
    ) {
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        $this->cache = $cache;
        $this->custom_products = $custom_products;
        
        // Register shortcodes
        add_shortcode('yaa_products', [$this, 'render_combined']);
        add_shortcode('yadore_products', [$this, 'render_yadore']);
        add_shortcode('amazon_products', [$this, 'render_amazon']);
        add_shortcode('combined_products', [$this, 'render_combined']);
        add_shortcode('custom_products', [$this, 'render_custom']);      // NEU
        add_shortcode('all_products', [$this, 'render_all_sources']);    // NEU
    }
    
    /**
     * Render Yadore products - ERWEITERT mit Multi-Keyword Support
     */
    public function render_yadore(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'    => '',
            'keywords'   => '',  // NEU: Mehrere Keywords komma-separiert
            'limit'      => (int) yaa_get_option('yadore_default_limit', 9),
            'market'     => (string) yaa_get_option('yadore_market', 'de'),
            'precision'  => (string) yaa_get_option('yadore_precision', 'fuzzy'),
            'columns'    => '',
            'class'      => '',
        ], $atts, 'yadore_products');
        
        if (!$this->yadore_api->is_configured()) {
            return $this->render_error(__('Yadore API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        // Multi-Keyword Support
        $keywords = [];
        
        if (!empty($atts['keywords'])) {
            // Mehrere Keywords
            $keywords = array_map('trim', explode(',', (string) $atts['keywords']));
            $keywords = array_filter($keywords);
        } elseif (!empty($atts['keyword'])) {
            // Einzelnes Keyword
            $keywords = [trim((string) $atts['keyword'])];
        }
        
        if (empty($keywords)) {
            return $this->render_error(__('Bitte keyword oder keywords angeben.', 'yadore-amazon-api'));
        }
        
        $total_limit = (int) $atts['limit'];
        $items = [];
        
        if (count($keywords) === 1) {
            // Einzelnes Keyword - normales Verhalten
            $result = $this->yadore_api->fetch([
                'keyword'   => $keywords[0],
                'limit'     => $total_limit,
                'market'    => (string) $atts['market'],
                'precision' => (string) $atts['precision'],
            ]);
            
            if (!is_wp_error($result)) {
                $items = $result;
            }
        } else {
            // Mehrere Keywords - Limit aufteilen
            $items = $this->fetch_multi_keywords($keywords, $total_limit, $atts);
        }
        
        if (empty($items)) {
            return $this->render_empty();
        }
        
        return $this->render_grid($items, $atts);
    }
    
    /**
     * Fetch products for multiple keywords with distributed limit
     * 
     * @param array<string> $keywords
     * @param array<string, mixed> $atts
     * @return array<int, array<string, mixed>>
     */
    private function fetch_multi_keywords(array $keywords, int $total_limit, array $atts): array {
        $keyword_count = count($keywords);
        
        // Gleichmäßig aufteilen, Rest dem ersten Keyword
        $base_per_keyword = (int) floor($total_limit / $keyword_count);
        $remainder = $total_limit % $keyword_count;
        
        $all_items = [];
        $items_per_keyword = [];
        
        // Erst alle Anfragen durchführen
        foreach ($keywords as $index => $keyword) {
            $limit_for_this = $base_per_keyword;
            
            // Rest auf die ersten Keywords verteilen
            if ($index < $remainder) {
                $limit_for_this++;
            }
            
            if ($limit_for_this <= 0) {
                continue;
            }
            
            $result = $this->yadore_api->fetch([
                'keyword'   => $keyword,
                'limit'     => $limit_for_this,
                'market'    => (string) $atts['market'],
                'precision' => (string) $atts['precision'],
            ]);
            
            if (!is_wp_error($result) && !empty($result)) {
                $items_per_keyword[$keyword] = $result;
            }
            
            // Kleine Pause um API nicht zu überlasten
            if ($index < $keyword_count - 1) {
                usleep(200000); // 200ms
            }
        }
        
        // Wenn ein Keyword weniger liefert als erwartet, 
        // können andere Keywords mehr bekommen
        $collected = 0;
        
        foreach ($items_per_keyword as $keyword => $items) {
            $remaining_slots = $total_limit - $collected;
            $to_add = min(count($items), $remaining_slots);
            
            for ($i = 0; $i < $to_add; $i++) {
                $all_items[] = $items[$i];
                $collected++;
            }
            
            if ($collected >= $total_limit) {
                break;
            }
        }
        
        return $all_items;
    }
    
    /**
     * Render Amazon products
     */
    public function render_amazon(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'    => '',
            'category'   => (string) yaa_get_option('amazon_default_category', 'All'),
            'limit'      => 10,
            'min_price'  => '',
            'max_price'  => '',
            'brand'      => '',
            'sort'       => '',
            'asins'      => '',
            'columns'    => '',
            'class'      => '',
        ], $atts, 'amazon_products');
        
        if (!$this->amazon_api->is_configured()) {
            return $this->render_error(__('Amazon PA-API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        $asins = trim((string) $atts['asins']);
        if ($asins !== '') {
            $asin_array = array_map('trim', explode(',', $asins));
            $items = $this->amazon_api->get_items($asin_array);
        } else {
            $keyword = trim((string) $atts['keyword']);
            if ($keyword === '') {
                return $this->render_error(__('Bitte keyword oder asins angeben.', 'yadore-amazon-api'));
            }
            
            $additional = [];
            if ((string) $atts['min_price'] !== '') {
                $additional['min_price'] = (float) $atts['min_price'];
            }
            if ((string) $atts['max_price'] !== '') {
                $additional['max_price'] = (float) $atts['max_price'];
            }
            if ((string) $atts['brand'] !== '') {
                $additional['brand'] = (string) $atts['brand'];
            }
            if ((string) $atts['sort'] !== '') {
                $additional['sort_by'] = (string) $atts['sort'];
            }
            
            $items = $this->amazon_api->search_items(
                $keyword,
                (string) $atts['category'],
                (int) $atts['limit'],
                $additional
            );
        }
        
        if (is_wp_error($items)) {
            return $this->render_error($items->get_error_message());
        }
        
        if (empty($items)) {
            return $this->render_empty();
        }
        
        return $this->render_grid($items, $atts);
    }
    
    /**
     * Render custom products
     * NEU: Shortcode für eigene Produkte
     */
    public function render_custom(array|string $atts = []): string {
        $atts = shortcode_atts([
            'ids'      => '',      // Komma-separierte Post-IDs
            'category' => '',      // Kategorie-Slug
            'limit'    => 10,
            'columns'  => '',
            'class'    => '',
        ], $atts, 'custom_products');
        
        $items = [];
        
        // Nach IDs laden
        if (!empty($atts['ids'])) {
            $ids = array_map('intval', explode(',', (string) $atts['ids']));
            $ids = array_filter($ids);
            $items = $this->custom_products->get_products_by_ids($ids);
        }
        // Nach Kategorie laden
        elseif (!empty($atts['category'])) {
            $items = $this->custom_products->get_products_by_category(
                (string) $atts['category'],
                (int) $atts['limit']
            );
        }
        // Alle laden
        else {
            $items = $this->custom_products->get_all_products((int) $atts['limit']);
        }
        
        if (empty($items)) {
            return $this->render_empty();
        }
        
        return $this->render_grid($items, $atts);
    }
    
    /**
     * Render combined products (Yadore + Amazon + Custom)
     * ERWEITERT mit eigenen Produkten
     */
    public function render_combined(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'       => '',
            'keywords'      => '',  // NEU: Mehrere Yadore-Keywords
            'yadore_limit'  => 6,
            'amazon_limit'  => 4,
            'custom_ids'    => '',  // NEU: IDs eigener Produkte
            'custom_category' => '', // NEU: Kategorie eigener Produkte
            'custom_limit'  => 0,   // NEU: Anzahl eigener Produkte
            'market'        => (string) yaa_get_option('yadore_market', 'de'),
            'category'      => (string) yaa_get_option('amazon_default_category', 'All'),
            'shuffle'       => 'yes',
            'columns'       => '',
            'class'         => '',
        ], $atts, 'combined_products');
        
        $combined = [];
        $yadore_limit = (int) $atts['yadore_limit'];
        $amazon_limit = (int) $atts['amazon_limit'];
        $custom_limit = (int) $atts['custom_limit'];
        
        // Keyword ermitteln
        $keyword = trim((string) $atts['keyword']);
        $keywords_string = trim((string) $atts['keywords']);
        
        // 1. Eigene Produkte laden (haben Priorität)
        if (!empty($atts['custom_ids'])) {
            $ids = array_map('intval', explode(',', (string) $atts['custom_ids']));
            $ids = array_filter($ids);
            $custom_items = $this->custom_products->get_products_by_ids($ids);
            $combined = array_merge($combined, $custom_items);
        } elseif (!empty($atts['custom_category'])) {
            $custom_items = $this->custom_products->get_products_by_category(
                (string) $atts['custom_category'],
                $custom_limit > 0 ? $custom_limit : 5
            );
            $combined = array_merge($combined, $custom_items);
        } elseif ($custom_limit > 0) {
            $custom_items = $this->custom_products->get_all_products($custom_limit);
            $combined = array_merge($combined, $custom_items);
        }
        
        // 2. Yadore Produkte laden
        if ($this->yadore_api->is_configured() && $yadore_limit > 0 && ($keyword !== '' || $keywords_string !== '')) {
            if ($keywords_string !== '') {
                // Multi-Keyword
                $keywords = array_map('trim', explode(',', $keywords_string));
                $keywords = array_filter($keywords);
                $yadore_items = $this->fetch_multi_keywords($keywords, $yadore_limit, [
                    'market'    => (string) $atts['market'],
                    'precision' => (string) yaa_get_option('yadore_precision', 'fuzzy'),
                ]);
            } else {
                // Single Keyword
                $yadore_items = $this->yadore_api->fetch([
                    'keyword' => $keyword,
                    'limit'   => $yadore_limit,
                    'market'  => (string) $atts['market'],
                ]);
                
                if (is_wp_error($yadore_items)) {
                    $yadore_items = [];
                }
            }
            
            if (!empty($yadore_items)) {
                $combined = array_merge($combined, $yadore_items);
            }
        }
        
        // 3. Amazon Produkte laden
        if ($this->amazon_api->is_configured() && $amazon_limit > 0 && $keyword !== '') {
            $amazon_items = $this->amazon_api->search_items(
                $keyword,
                (string) $atts['category'],
                $amazon_limit
            );
            
            if (!is_wp_error($amazon_items) && !empty($amazon_items)) {
                $combined = array_merge($combined, $amazon_items);
            }
        }
        
        if (empty($combined)) {
            return $this->render_empty();
        }
        
        // Shuffle wenn aktiviert
        if ((string) $atts['shuffle'] === 'yes') {
            shuffle($combined);
        }
        
        return $this->render_grid($combined, $atts);
    }
    
    /**
     * Render all sources combined
     * NEU: Shortcode der alle Quellen intelligent kombiniert
     */
    public function render_all_sources(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'       => '',
            'keywords'      => '',
            'total_limit'   => 12,
            'custom_ids'    => '',
            'custom_category' => '',
            'market'        => (string) yaa_get_option('yadore_market', 'de'),
            'category'      => (string) yaa_get_option('amazon_default_category', 'All'),
            'priority'      => 'custom,yadore,amazon', // Reihenfolge der Quellen
            'shuffle'       => 'no',
            'columns'       => '',
            'class'         => '',
        ], $atts, 'all_products');
        
        $total_limit = (int) $atts['total_limit'];
        $combined = [];
        $remaining = $total_limit;
        
        // Priority-Reihenfolge parsen
        $priorities = array_map('trim', explode(',', (string) $atts['priority']));
        
        foreach ($priorities as $source) {
            if ($remaining <= 0) {
                break;
            }
            
            $items = [];
            
            switch ($source) {
                case 'custom':
                    if (!empty($atts['custom_ids'])) {
                        $ids = array_map('intval', explode(',', (string) $atts['custom_ids']));
                        $items = $this->custom_products->get_products_by_ids($ids);
                    } elseif (!empty($atts['custom_category'])) {
                        $items = $this->custom_products->get_products_by_category(
                            (string) $atts['custom_category'],
                            $remaining
                        );
                    } else {
                        $items = $this->custom_products->get_all_products($remaining);
                    }
                    break;
                    
                case 'yadore':
                    if ($this->yadore_api->is_configured()) {
                        $keyword = trim((string) $atts['keyword']);
                        $keywords_string = trim((string) $atts['keywords']);
                        
                        if ($keywords_string !== '') {
                            $keywords = array_map('trim', explode(',', $keywords_string));
                            $items = $this->fetch_multi_keywords($keywords, $remaining, [
                                'market'    => (string) $atts['market'],
                                'precision' => (string) yaa_get_option('yadore_precision', 'fuzzy'),
                            ]);
                        } elseif ($keyword !== '') {
                            $result = $this->yadore_api->fetch([
                                'keyword' => $keyword,
                                'limit'   => $remaining,
                                'market'  => (string) $atts['market'],
                            ]);
                            if (!is_wp_error($result)) {
                                $items = $result;
                            }
                        }
                    }
                    break;
                    
                case 'amazon':
                    if ($this->amazon_api->is_configured()) {
                        $keyword = trim((string) $atts['keyword']);
                        if ($keyword !== '') {
                            $result = $this->amazon_api->search_items(
                                $keyword,
                                (string) $atts['category'],
                                min($remaining, 10)
                            );
                            if (!is_wp_error($result)) {
                                $items = $result;
                            }
                        }
                    }
                    break;
            }
            
            if (!empty($items)) {
                $to_add = array_slice($items, 0, $remaining);
                $combined = array_merge($combined, $to_add);
                $remaining -= count($to_add);
            }
        }
        
        if (empty($combined)) {
            return $this->render_empty();
        }
        
        // Shuffle wenn aktiviert
        if ((string) $atts['shuffle'] === 'yes') {
            shuffle($combined);
        }
        
        return $this->render_grid($combined, $atts);
    }
    
    /**
     * Render the product grid
     */
    private function render_grid(array $items, array $atts): string {
        $widget_id = 'yaa-' . uniqid();
        $extra_class = isset($atts['class']) && (string) $atts['class'] !== '' 
            ? ' ' . esc_attr((string) $atts['class']) 
            : '';
        
        $style = '';
        if (isset($atts['columns']) && (string) $atts['columns'] !== '') {
            $cols = (int) $atts['columns'];
            if ($cols >= 1 && $cols <= 6) {
                $style = ' style="--yaa-columns-desktop: ' . $cols . ';"';
            }
        }
        
        // Settings
        $show_prime = yaa_get_option('show_prime_badge', 'yes') === 'yes';
        $show_merchant = yaa_get_option('show_merchant', 'yes') === 'yes';
        $show_description = yaa_get_option('show_description', 'yes') === 'yes';
        $button_yadore = (string) yaa_get_option('button_text_yadore', 'Zum Angebot');
        $button_amazon = (string) yaa_get_option('button_text_amazon', 'Bei Amazon kaufen');
        $button_custom = (string) yaa_get_option('button_text_custom', 'Zum Angebot');
        
        // Ensure assets are loaded
        $plugin = yaa_init();
        $plugin->load_assets();
        
        ob_start();
        ?>
        <div class="yaa-grid-container<?php echo $extra_class; ?>" id="<?php echo esc_attr($widget_id); ?>"<?php echo $style; ?>>
            <?php foreach ($items as $index => $item): 
                $source = $item['source'] ?? 'yadore';
                $is_amazon = $source === 'amazon';
                $is_custom = $source === 'custom';
                $url = $item['url'] ?? '#';
                $image_url = $item['image']['url'] ?? '';
                $title = $item['title'] ?? '';
                $description = $item['description'] ?? '';
                $price_amount = $item['price']['amount'] ?? '';
                $price_currency = $item['price']['currency'] ?? 'EUR';
                $price_display = $item['price']['display'] ?? '';
                $merchant_name = $item['merchant']['name'] ?? '';
                $is_prime = !empty($item['is_prime']);
                
                // Button-Text ermitteln
                $custom_button = $item['button_text'] ?? '';
                if ($custom_button !== '') {
                    $button_text = $custom_button;
                } elseif ($is_amazon) {
                    $button_text = $button_amazon;
                } elseif ($is_custom) {
                    $button_text = $button_custom;
                } else {
                    $button_text = $button_yadore;
                }
                
                // CSS-Klasse basierend auf Quelle
                $source_class = 'yaa-' . $source;
            ?>
                <div class="yaa-item <?php echo esc_attr($source_class); ?>">
                    
                    <?php if ($show_prime && $is_prime): ?>
                        <span class="yaa-prime-badge">Prime</span>
                    <?php endif; ?>
                    
                    <?php if ($is_custom): ?>
                        <span class="yaa-custom-badge"><?php esc_html_e('Empfohlen', 'yadore-amazon-api'); ?></span>
                    <?php endif; ?>
                    
                    <div class="yaa-image-wrapper">
                        <?php if ($image_url !== ''): ?>
                            <a href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <img src="<?php echo esc_url($image_url); ?>" 
                                     alt="<?php echo esc_attr($title); ?>" 
                                     loading="lazy"
                                     decoding="async">
                            </a>
                        <?php else: ?>
                            <div class="yaa-no-image">
                                <span>📦</span>
                            </div>
                        <?php endif; ?>
                    </div>

                    <div class="yaa-content">
                        <h3 class="yaa-title">
                            <a href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <?php echo esc_html($title); ?>
                            </a>
                        </h3>

                        <?php if ($show_description && $description !== ''): ?>
                            <div class="yaa-description-wrapper">
                                <div class="yaa-description" id="desc-<?php echo esc_attr($widget_id . '-' . $index); ?>">
                                    <?php echo esc_html($description); ?>
                                </div>
                                <button type="button" class="yaa-read-more" data-target="<?php echo esc_attr($widget_id . '-' . $index); ?>">
                                    <?php esc_html_e('mehr lesen', 'yadore-amazon-api'); ?>
                                </button>
                            </div>
                        <?php elseif ($show_description): ?>
                            <div class="yaa-no-description"><?php esc_html_e('Keine Beschreibung verfügbar', 'yadore-amazon-api'); ?></div>
                        <?php endif; ?>

                        <div class="yaa-meta">
                            <?php if ($price_amount !== '' || $price_display !== ''): ?>
                                <span class="yaa-price">
                                    <?php 
                                    if ($price_display !== '') {
                                        echo esc_html($price_display);
                                    } else {
                                        echo number_format((float) $price_amount, 2, ',', '.') . ' ' . esc_html($price_currency);
                                    }
                                    ?>
                                </span>
                            <?php endif; ?>
                            
                            <?php if ($show_merchant && $merchant_name !== ''): ?>
                                <div class="yaa-merchant">
                                    <?php echo esc_html($merchant_name); ?>
                                </div>
                            <?php endif; ?>
                        </div>

                        <div class="yaa-button-wrapper">
                            <a class="yaa-button" href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <?php echo esc_html($button_text); ?>
                            </a>
                        </div>
                    </div>

                </div>
            <?php endforeach; ?>
        </div>
        <?php
        return ob_get_clean() ?: '';
    }
    
    /**
     * Render error message
     */
    private function render_error(string $message): string {
        return '<div class="yaa-message yaa-error"><span class="yaa-icon">⚠️</span><p>' . 
               esc_html($message) . '</p></div>';
    }
    
    /**
     * Render empty state
     */
    private function render_empty(): string {
        return '<div class="yaa-message yaa-empty"><span class="yaa-icon">📦</span>' .
               '<p>' . esc_html__('Keine Produkte für diese Suche gefunden.', 'yadore-amazon-api') . '</p></div>';
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-yadore-api.php 
 
<?php
/**
 * Yadore API Handler
 * PHP 8.3+ compatible
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Yadore_API {
    
    private const API_BASE = 'https://api.yadore.com/v2/offer';
    
    private YAA_Cache_Handler $cache;
    
    // Yadore supported markets
    private const MARKETS = [
        'de' => 'Deutschland',
        'at' => 'Österreich',
        'ch' => 'Schweiz',
        'fr' => 'Frankreich',
        'it' => 'Italien',
        'es' => 'Spanien',
        'nl' => 'Niederlande',
        'be' => 'Belgien',
        'pl' => 'Polen',
        'uk' => 'Großbritannien',
        'us' => 'USA',
        'se' => 'Schweden',
        'dk' => 'Dänemark',
        'no' => 'Norwegen',
        'fi' => 'Finnland',
    ];
    
    public function __construct(YAA_Cache_Handler $cache) {
        $this->cache = $cache;
    }
    
    /**
     * Check if API is configured
     */
    public function is_configured(): bool {
        return $this->get_api_key() !== '' && yaa_get_option('enable_yadore', 'yes') === 'yes';
    }
    
    /**
     * Get API Key
     */
    private function get_api_key(): string {
        if (defined('YADORE_API_KEY')) {
            return (string) YADORE_API_KEY;
        }
        return (string) yaa_get_option('yadore_api_key', '');
    }
    
    /**
     * Get available markets
     * 
     * @return array<string, string>
     */
    public function get_markets(): array {
        return self::MARKETS;
    }
    
    /**
     * Fetch offers from Yadore API
     * 
     * @param array<string, mixed> $atts
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    public function fetch(array $atts): array|\WP_Error {
        $api_key = $this->get_api_key();
        
        if ($api_key === '') {
            return new \WP_Error('no_api_key', __('Yadore API-Key nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        // Merge with defaults
        $defaults = [
            'keyword'   => '',
            'limit'     => (int) yaa_get_option('yadore_default_limit', 9),
            'market'    => (string) yaa_get_option('yadore_market', 'de'),
            'precision' => (string) yaa_get_option('yadore_precision', 'fuzzy'),
            'sort'      => 'rel_desc',
        ];
        
        $atts = wp_parse_args($atts, $defaults);
        $atts['limit'] = (int) $atts['limit'];
        
        $keyword = trim((string) $atts['keyword']);
        
        if ($keyword === '') {
            return new \WP_Error('no_keyword', __('Kein Suchbegriff angegeben.', 'yadore-amazon-api'));
        }
        
        $cache_key = $this->generate_cache_key($atts);
        $fallback_key = $cache_key . '_fallback';
        
        // Try cache first
        $cached_data = $this->cache->get($cache_key);
        if ($cached_data !== false && is_array($cached_data)) {
            return $cached_data;
        }
        
        // Fetch from API
        $url = add_query_arg([
            'market'    => $atts['market'],
            'keyword'   => urlencode($keyword),
            'limit'     => $atts['limit'],
            'sort'      => $atts['sort'],
            'precision' => $atts['precision'],
        ], self::API_BASE);

        $response = wp_remote_get($url, [
            'headers'   => ['API-Key' => $api_key],
            'timeout'   => 15,
            'sslverify' => true,
        ]);

        if (is_wp_error($response)) {
            error_log('Yadore API Error: ' . $response->get_error_message());
            return $this->get_fallback($fallback_key);
        }

        $status_code = wp_remote_retrieve_response_code($response);
        if ($status_code !== 200) {
            error_log('Yadore API HTTP Error: ' . $status_code);
            return $this->get_fallback($fallback_key);
        }

        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);

        if (!is_array($data) || !isset($data['offers']) || empty($data['offers'])) {
            return $this->get_fallback($fallback_key);
        }

        // Normalize data
        $offers = $this->normalize_offers($data['offers']);
        
        // Cache results
        $this->cache->set($cache_key, $offers, yaa_get_cache_time());
        $this->cache->set($fallback_key, $offers, yaa_get_fallback_time());
        
        // Track keyword
        $this->track_keyword($atts);
        
        return $offers;
    }
    
    /**
     * Normalize offers to standard format
     * 
     * @param array<int, array<string, mixed>> $offers
     * @return array<int, array<string, mixed>>
     */
    private function normalize_offers(array $offers): array {
        $normalized = [];
        
        foreach ($offers as $offer) {
            $normalized[] = [
                'id'          => $offer['id'] ?? uniqid('yadore_'),
                'title'       => $offer['title'] ?? '',
                'description' => $offer['description'] ?? '',
                'url'         => $offer['clickUrl'] ?? '#',
                'image'       => [
                    'url' => $offer['image']['url'] ?? '',
                ],
                'price'       => [
                    'amount'   => $offer['price']['amount'] ?? '',
                    'currency' => $offer['price']['currency'] ?? 'EUR',
                    'display'  => '',
                ],
                'merchant'    => [
                    'name' => $offer['merchant']['name'] ?? '',
                    'logo' => $offer['merchant']['logo'] ?? '',
                ],
                'source'      => 'yadore',
                'is_prime'    => false,
            ];
        }
        
        return $normalized;
    }
    
    /**
     * Generate cache key
     * 
     * @param array<string, mixed> $atts
     */
    private function generate_cache_key(array $atts): string {
        return 'yadore_' . md5(serialize($atts));
    }
    
    /**
     * Get fallback cache
     * 
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    private function get_fallback(string $fallback_key): array|\WP_Error {
        $fallback = $this->cache->get($fallback_key);
        if ($fallback !== false && is_array($fallback)) {
            return $fallback;
        }
        return new \WP_Error('no_data', __('Keine Daten verfügbar.', 'yadore-amazon-api'));
    }
    
    /**
     * Track keywords for cron preload
     * 
     * @param array<string, mixed> $atts
     */
    private function track_keyword(array $atts): void {
        $cached_keywords = get_option('yaa_cached_keywords', []);
        
        if (!is_array($cached_keywords)) {
            $cached_keywords = [];
        }
        
        $new_entry = [
            'keyword' => $atts['keyword'],
            'limit'   => $atts['limit'],
            'market'  => $atts['market'],
            'source'  => 'yadore',
        ];
        
        foreach ($cached_keywords as $entry) {
            if (($entry['keyword'] ?? '') === $new_entry['keyword'] 
                && ($entry['market'] ?? '') === $new_entry['market']
                && ($entry['source'] ?? 'yadore') === 'yadore') {
                return;
            }
        }
        
        $cached_keywords[] = $new_entry;
        $cached_keywords = array_slice($cached_keywords, -30);
        update_option('yaa_cached_keywords', $cached_keywords);
    }
    
    /**
     * Test API connection
     * 
     * @return array{success: bool, message: string}
     */
    public function test_connection(?string $api_key = null): array {
        $api_key ??= $this->get_api_key();
        
        if ($api_key === '') {
            return [
                'success' => false,
                'message' => __('Kein API-Key angegeben.', 'yadore-amazon-api'),
            ];
        }
        
        $url = add_query_arg([
            'market'  => 'de',
            'keyword' => 'test',
            'limit'   => 1,
        ], self::API_BASE);

        $response = wp_remote_get($url, [
            'headers' => ['API-Key' => $api_key],
            'timeout' => 10,
        ]);

        if (is_wp_error($response)) {
            return [
                'success' => false,
                'message' => $response->get_error_message(),
            ];
        }

        $status_code = wp_remote_retrieve_response_code($response);
        
        return match ($status_code) {
            200 => ['success' => true, 'message' => __('Verbindung erfolgreich!', 'yadore-amazon-api')],
            401 => ['success' => false, 'message' => __('Ungültiger API-Key.', 'yadore-amazon-api')],
            default => ['success' => false, 'message' => sprintf(__('HTTP Fehler: %d', 'yadore-amazon-api'), $status_code)],
        };
    }
}
 
