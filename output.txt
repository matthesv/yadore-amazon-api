Projekt:Wordpress Plugin yadore-amazon-api
Deine Rolle: Du hast diese Anwendung für mich programmiert. Bitte unterstütze mich bei der Optimierung und Erweiterung des Codes.
Anforderungen:
1. Vollständige Dateien bereitstellen:
- Wenn Änderungen an einer Datei notwendig sind, gib mir bitte stets die vollständige Datei zurück.
2. Sinnvolle Architektur bedenken:
- Nicht zu viel Code in einer Datei, damit der Code gut gewartet werden kann.
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\yadore-amazon-api.php 
 
<?php
/**
 * Plugin Name: Yadore-Amazon-API
 * Plugin URI: https://github.com/matthesv/yadore-amazon-api
 * Description: Universelles Affiliate-Plugin für Yadore und Amazon PA-API 5.0 mit Redis-Caching, eigenen Produkten und vollständiger Backend-Konfiguration.
 * Version: 1.6.2
 * Author: Matthes Vogel
 * Author URI: https://example.com
 * Text Domain: yadore-amazon-api
 * Domain Path: /languages
 * Requires at least: 6.0
 * Requires PHP: 8.1
 * License: GPL v2 or later
 * GitHub Plugin URI: https://github.com/matthesv/yadore-amazon-api
 * Primary Branch: main
 * 
 * CHANGELOG 1.6.1:
 * - Search Shortcode Komponente hinzugefügt
 * - Shortcode 'yadore_search' zu Asset-Loading hinzugefügt
 * - Dependency Injection für Search Shortcode korrigiert
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

// Plugin Constants
define('YAA_VERSION', '1.6.2');
define('YAA_PLUGIN_PATH', plugin_dir_path(__FILE__));
define('YAA_PLUGIN_URL', plugin_dir_url(__FILE__));
define('YAA_PLUGIN_BASENAME', plugin_basename(__FILE__));
define('YAA_PLUGIN_FILE', __FILE__);

/**
 * Load plugin textdomain
 */
function yaa_load_textdomain(): void {
    load_plugin_textdomain('yadore-amazon-api', false, dirname(YAA_PLUGIN_BASENAME) . '/languages');
}
add_action('plugins_loaded', 'yaa_load_textdomain');

/**
 * Get plugin option with default
 * 
 * @param string $key Option key
 * @param mixed $default Default value
 * @return mixed Option value or default
 */
function yaa_get_option(string $key, mixed $default = ''): mixed {
    $options = get_option('yaa_settings', []);
    return $options[$key] ?? $default;
}

/**
 * Get cache time settings
 */
function yaa_get_cache_time(): int {
    $hours = (int) yaa_get_option('cache_duration', 6);
    return max(1, $hours) * 3600;
}

/**
 * Get fallback cache time
 */
function yaa_get_fallback_time(): int {
    $hours = (int) yaa_get_option('fallback_duration', 24);
    return max(1, $hours) * 3600;
}

// =========================================
// AUTOLOADER
// =========================================

// Autoloader zuerst laden (manuell, da er sich nicht selbst laden kann)
require_once YAA_PLUGIN_PATH . 'includes/class-autoloader.php';

// Autoloader registrieren
YAA_Autoloader::register(YAA_PLUGIN_PATH);

// Admin-Verzeichnis zum Autoloader hinzufügen
YAA_Autoloader::add_directory('includes/admin');

// =========================================
// PLUGIN UPDATE CHECKER (GitHub)
// =========================================
if (file_exists(YAA_PLUGIN_PATH . 'includes/plugin-update-checker/plugin-update-checker.php')) {
    require_once YAA_PLUGIN_PATH . 'includes/plugin-update-checker/plugin-update-checker.php';
    
    $yaaUpdateChecker = \YahnisElsts\PluginUpdateChecker\v5\PucFactory::buildUpdateChecker(
        'https://github.com/matthesv/yadore-amazon-api/',
        YAA_PLUGIN_FILE,
        'yadore-amazon-api'
    );
    
    $yaaUpdateChecker->setBranch('main');
    
    $github_token = defined('YAA_GITHUB_TOKEN') ? YAA_GITHUB_TOKEN : yaa_get_option('github_token', '');
    if (!empty($github_token)) {
        $yaaUpdateChecker->setAuthentication($github_token);
    }
}

/**
 * Main Plugin Class - PHP 8.3+ compatible
 * Version 1.6.0 - Mit Search Shortcode Support
 */
final class Yadore_Amazon_API_Plugin {
    
    /**
     * Singleton instance
     */
    private static ?self $instance = null;
    
    /**
     * Plugin components
     */
    public readonly YAA_Cache_Handler $cache;
    public readonly YAA_Yadore_API $yadore_api;
    public readonly YAA_Amazon_PAAPI $amazon_api;
    public readonly YAA_Custom_Products $custom_products;
    public readonly YAA_Shortcode_Renderer $shortcode;
    public readonly YAA_Admin $admin;
    public readonly YAA_Image_Proxy $image_proxy;
    public readonly YAA_Search_Shortcode $search_shortcode;
    
    /**
     * Get singleton instance
     */
    public static function get_instance(): self {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * Private constructor (Singleton)
     */
    private function __construct() {
        $this->init_components();
        $this->register_hooks();
    }
    
    /**
     * Initialize all plugin components
     */
    private function init_components(): void {
        // Core Components (werden durch Autoloader geladen)
        $this->cache           = new YAA_Cache_Handler();
        $this->yadore_api      = new YAA_Yadore_API($this->cache);
        $this->amazon_api      = new YAA_Amazon_PAAPI($this->cache);
        $this->custom_products = new YAA_Custom_Products();
        $this->shortcode       = new YAA_Shortcode_Renderer(
            $this->yadore_api, 
            $this->amazon_api, 
            $this->cache,
            $this->custom_products
        );
        
        // Image Proxy Component
        $this->image_proxy = new YAA_Image_Proxy();

        // Search Shortcode Component (mit Dependency Injection)
        $this->search_shortcode = new YAA_Search_Shortcode(
            $this->yadore_api,
            $this->amazon_api
        );
        
        // Admin Component (koordiniert alle Admin-Submodule)
        $this->admin = new YAA_Admin($this->cache, $this->yadore_api, $this->amazon_api);
    }
    
    /**
     * Register plugin hooks
     */
    private function register_hooks(): void {
        register_activation_hook(YAA_PLUGIN_FILE, [$this, 'activate']);
        register_deactivation_hook(YAA_PLUGIN_FILE, [$this, 'deactivate']);
        
        add_action('wp_enqueue_scripts', [$this, 'enqueue_frontend_assets']);
        add_action('yaa_cache_refresh_event', [$this, 'preload_cache']);
    }
    
    /**
     * Plugin activation
     */
    public function activate(): void {
        // Default settings
        $defaults = [
            // Yadore Settings
            'enable_yadore'          => 'yes',
            'yadore_api_key'         => '',
            'yadore_market'          => 'de',
            'yadore_precision'       => 'fuzzy',
            'yadore_default_limit'   => 9,
            'yadore_default_sort'    => 'rel_desc',
            
            // Amazon Settings
            'enable_amazon'          => 'yes',
            'amazon_access_key'      => '',
            'amazon_secret_key'      => '',
            'amazon_partner_tag'     => '',
            'amazon_marketplace'     => 'de',
            'amazon_default_category'=> 'All',
            'amazon_language'        => '',
            'amazon_image_size'      => 'Large',
            
            // Cache Settings
            'cache_duration'         => 6,
            'fallback_duration'      => 24,
            'enable_redis'           => 'auto',
            'redis_host'             => '127.0.0.1',
            'redis_port'             => 6379,
            'redis_password'         => '',
            'redis_database'         => 0,
            
            // Local Image Storage
            'enable_local_images'    => 'yes',
            'image_filename_format'  => 'seo',
            'image_resize_enabled'   => 'yes',
            'preferred_image_size'   => 'Large',
            
            // Image Proxy Settings
            'enable_image_proxy'     => 'yes',
            'image_proxy_cache'      => 24, // Stunden
            
            // Fuzzy Search settings
            'enable_fuzzy_search'    => 'yes',
            'fuzzy_auto_mix'         => 'no',
            'fuzzy_threshold'        => 30,
            'fuzzy_weight_title'     => 0.40,
            'fuzzy_weight_description' => 0.25,
            'fuzzy_weight_category'  => 0.20,
            'fuzzy_weight_merchant'  => 0.10,
            'fuzzy_weight_keywords'  => 0.05,
            
            // Display Settings
            'disable_default_css'    => 'no',
            'grid_columns_desktop'   => 3,
            'grid_columns_tablet'    => 2,
            'grid_columns_mobile'    => 1,
            'button_text_yadore'     => 'Zum Angebot',
            'button_text_amazon'     => 'Bei Amazon kaufen',
            'button_text_custom'     => 'Zum Angebot',
            'show_prime_badge'       => 'yes',
            'show_merchant'          => 'yes',
            'show_description'       => 'yes',
            'show_custom_badge'      => 'yes',
            'custom_badge_text'      => 'Empfohlen',
            'color_primary'          => '#ff00cc',
            'color_secondary'        => '#00ffff',
            'color_amazon'           => '#ff9900',
            'color_custom'           => '#4CAF50',
            
            // Search Shortcode Settings (NEU)
            'yadore_featured_keywords' => '',
            
            // Update Settings
            'github_token'           => '',
        ];
        
        $existing = get_option('yaa_settings', []);
        $merged = array_merge($defaults, $existing);
        update_option('yaa_settings', $merged);
        
        // Admin-Verzeichnis erstellen
        $admin_dir = YAA_PLUGIN_PATH . 'includes/admin';
        if (!is_dir($admin_dir)) {
            wp_mkdir_p($admin_dir);
        }
        
        // Bilder-Verzeichnis erstellen
        $upload_dir = wp_upload_dir();
        $image_dir = $upload_dir['basedir'] . '/yadore-amazon-api';
        if (!is_dir($image_dir)) {
            wp_mkdir_p($image_dir);
            // Index-Datei für Sicherheit
            file_put_contents($image_dir . '/index.php', '<?php // Silence is golden');
        }
        
        // Schedule cron
        if (!wp_next_scheduled('yaa_cache_refresh_event')) {
            wp_schedule_event(time(), 'twicedaily', 'yaa_cache_refresh_event');
        }
        
        flush_rewrite_rules();
    }
    
    /**
     * Plugin deactivation
     */
    public function deactivate(): void {
        wp_clear_scheduled_hook('yaa_cache_refresh_event');
        flush_rewrite_rules();
    }
    
    /**
     * Enqueue frontend assets when shortcodes are present
     */
    public function enqueue_frontend_assets(): void {
        global $post;
        
        if (!($post instanceof WP_Post)) {
            return;
        }
        
        // Alle Shortcodes die Assets benötigen (inkl. yadore_search)
        $shortcodes = [
            'yaa_products', 
            'yadore_products', 
            'amazon_products', 
            'combined_products',
            'custom_products',
            'all_products',
            'fuzzy_products',
            'yadore_search', // NEU: Search Shortcode hinzugefügt
        ];
        
        $has_shortcode = false;
        
        foreach ($shortcodes as $shortcode) {
            if (has_shortcode($post->post_content, $shortcode)) {
                $has_shortcode = true;
                break;
            }
        }
        
        if ($has_shortcode) {
            $this->load_assets();
        }
    }
    
    /**
     * Load frontend assets
     */
    public function load_assets(): void {
        $disable_css = yaa_get_option('disable_default_css', 'no') === 'yes';

        if (!$disable_css) {
            wp_enqueue_style(
                'yaa-frontend-grid',
                YAA_PLUGIN_URL . 'assets/css/frontend-grid.css',
                [],
                YAA_VERSION
            );
            
            $primary = esc_attr((string) yaa_get_option('color_primary', '#ff00cc'));
            $secondary = esc_attr((string) yaa_get_option('color_secondary', '#00ffff'));
            $amazon = esc_attr((string) yaa_get_option('color_amazon', '#ff9900'));
            $custom = esc_attr((string) yaa_get_option('color_custom', '#4CAF50'));
            $columns_desktop = (int) yaa_get_option('grid_columns_desktop', 3);
            $columns_tablet = (int) yaa_get_option('grid_columns_tablet', 2);
            $columns_mobile = (int) yaa_get_option('grid_columns_mobile', 1);
            
            $custom_css = "
                .yaa-grid-container {
                    --yaa-primary: {$primary};
                    --yaa-secondary: {$secondary};
                    --yaa-amazon: {$amazon};
                    --yaa-custom: {$custom};
                    --yaa-columns-desktop: {$columns_desktop};
                    --yaa-columns-tablet: {$columns_tablet};
                    --yaa-columns-mobile: {$columns_mobile};
                }
            ";
            wp_add_inline_style('yaa-frontend-grid', $custom_css);
        } else {
            // Minimal CSS wenn Default-CSS deaktiviert
            wp_register_style('yaa-minimal-functional', false, [], YAA_VERSION);
            wp_enqueue_style('yaa-minimal-functional');
            
            $minimal_css = "
                .yaa-description {
                    overflow: hidden;
                    position: relative;
                    max-height: 4.8em; 
                    transition: max-height 0.4s ease-out;
                }
                .yaa-description.expanded {
                    max-height: none !important;
                    -webkit-line-clamp: unset !important;
                    line-clamp: unset !important;
                    display: block !important;
                    overflow: visible !important;
                }
                .yaa-read-more { cursor: pointer; display: inline-block; }
                .yaa-grid-container {
                    display: grid;
                    gap: 20px;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                }
            ";
            wp_add_inline_style('yaa-minimal-functional', $minimal_css);
        }
        
        // Frontend JavaScript
        wp_enqueue_script(
            'yaa-frontend-grid',
            YAA_PLUGIN_URL . 'assets/js/frontend-grid.js',
            [],
            YAA_VERSION,
            true
        );
        
        // Proxy-URL ans Frontend übergeben
        wp_localize_script('yaa-frontend-grid', 'yaaProxy', [
            'enabled'  => yaa_get_option('enable_image_proxy', 'yes') === 'yes',
            'endpoint' => admin_url('admin-ajax.php'),
            'action'   => 'yaa_proxy_image',
        ]);
    }
    
    /**
     * Preload cache via cron
     */
    public function preload_cache(): void {
        $cached_keywords = get_option('yaa_cached_keywords', []);
        
        if (empty($cached_keywords) || !is_array($cached_keywords)) {
            return;
        }
        
        foreach ($cached_keywords as $entry) {
            if (!is_array($entry)) {
                continue;
            }
            
            $source = $entry['source'] ?? 'yadore';
            
            if ($source === 'amazon' && $this->amazon_api->is_configured()) {
                $this->amazon_api->search_items(
                    $entry['keyword'] ?? '',
                    $entry['category'] ?? 'All',
                    $entry['limit'] ?? 10
                );
            } elseif ($this->yadore_api->is_configured()) {
                $this->yadore_api->fetch([
                    'keyword' => $entry['keyword'] ?? '',
                    'limit'   => $entry['limit'] ?? 9,
                    'market'  => $entry['market'] ?? yaa_get_option('yadore_market', 'de'),
                ]);
            }
            
            // Rate-Limiting: 1 Sekunde zwischen Requests
            sleep(1);
        }
    }
}

/**
 * Initialize Plugin
 * 
 * @return Yadore_Amazon_API_Plugin Plugin instance
 */
function yaa_init(): Yadore_Amazon_API_Plugin {
    return Yadore_Amazon_API_Plugin::get_instance();
}
add_action('plugins_loaded', 'yaa_init', 10);

/**
 * Plugin action links (Settings link in plugin list)
 * 
 * @param array<string, string> $links Existing links
 * @return array<string, string> Modified links
 */
function yaa_plugin_action_links(array $links): array {
    $settings_link = '<a href="' . admin_url('admin.php?page=yaa-settings') . '">' . 
                     __('Einstellungen', 'yadore-amazon-api') . '</a>';
    array_unshift($links, $settings_link);
    return $links;
}
add_filter('plugin_action_links_' . YAA_PLUGIN_BASENAME, 'yaa_plugin_action_links');
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\assets\css\frontend-grid.css 
 
/**
 * Yadore-Amazon-API Frontend Grid Styles
 * Version 1.3.0 - PHP 8.3+ compatible
 * 
 * Features:
 * - CSS Custom Properties
 * - Responsive Grid
 * - Glassmorphism Design
 * - VERBESSERTES Image Error Placeholder Design (Anforderung 4)
 * - Accessibility Support
 * - Dark/Light Mode
 */

/* =========================================
 * CSS CUSTOM PROPERTIES
 * ========================================= */
.yaa-grid-container {
    --yaa-primary: #ff00cc;
    --yaa-secondary: #00ffff;
    --yaa-amazon: #ff9900;
    --yaa-custom: #4CAF50;
    --yaa-dark-bg: #0a0a0a;
    --yaa-glass-bg: rgba(255, 255, 255, 0.05);
    --yaa-glass-border: rgba(255, 255, 255, 0.1);
    --yaa-text-main: #ffffff;
    --yaa-text-muted: #aaaaaa;
    --yaa-columns-desktop: 3;
    --yaa-columns-tablet: 2;
    --yaa-columns-mobile: 1;
}

/* =========================================
 * GRID CONTAINER
 * ========================================= */
.yaa-grid-container {
    display: grid;
    grid-template-columns: repeat(var(--yaa-columns-desktop), 1fr);
    gap: 25px;
    padding: 10px 0;
    font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* =========================================
 * PRODUCT CARD
 * ========================================= */
.yaa-item {
    background: var(--yaa-glass-bg);
    border: 1px solid var(--yaa-glass-border);
    border-bottom: 2px solid var(--yaa-primary);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
}

.yaa-item:nth-child(even) {
    border-bottom-color: var(--yaa-secondary);
}

.yaa-item.yaa-amazon {
    border-bottom-color: var(--yaa-amazon);
}

.yaa-item.yaa-custom {
    border-bottom-color: var(--yaa-custom);
}

/* Hover Effects */
.yaa-item:hover {
    transform: translateY(-8px);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-primary), transparent 80%);
}

.yaa-item:nth-child(even):hover {
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-secondary), transparent 80%);
}

.yaa-item.yaa-amazon:hover {
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-amazon), transparent 80%);
}

.yaa-item.yaa-custom:hover {
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 30px color-mix(in srgb, var(--yaa-custom), transparent 80%);
}

/* =========================================
 * PRIME BADGE
 * ========================================= */
.yaa-prime-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--yaa-amazon);
    color: #000;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(255, 153, 0, 0.4);
}

/* =========================================
 * CUSTOM BADGE
 * ========================================= */
.yaa-custom-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--yaa-custom);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
}

/* When Prime AND Custom Badge exist */
.yaa-item.yaa-custom .yaa-prime-badge {
    top: 12px;
    left: auto;
    right: 12px;
}

/* =========================================
 * IMAGE WRAPPER
 * ========================================= */
.yaa-image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%; /* 1:1 Aspect Ratio */
    background: linear-gradient(180deg, 
        rgba(10, 10, 10, 0.3) 0%, 
        rgba(10, 10, 10, 0.6) 100%);
    overflow: hidden;
}

.yaa-image-wrapper a {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}

.yaa-image-wrapper img {
    width: 85%;
    height: 85%;
    object-fit: contain;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    filter: brightness(0.95) saturate(0.95) drop-shadow(0 4px 20px rgba(0, 0, 0, 0.5));
}

/* Image loaded state */
.yaa-image-wrapper img.yaa-img-loaded {
    opacity: 1;
}

/* NEU: Image loading thumbnail state */
.yaa-image-wrapper img.yaa-img-loading {
    opacity: 0.7;
    filter: blur(2px);
}

.yaa-item:hover .yaa-image-wrapper img {
    transform: scale(1.08);
    filter: brightness(1.05) saturate(1.1) drop-shadow(0 8px 30px rgba(255, 0, 204, 0.3));
}

.yaa-item.yaa-amazon:hover .yaa-image-wrapper img {
    filter: brightness(1.05) saturate(1.1) drop-shadow(0 8px 30px rgba(255, 153, 0, 0.3));
}

.yaa-item.yaa-custom:hover .yaa-image-wrapper img {
    filter: brightness(1.05) saturate(1.1) drop-shadow(0 8px 30px rgba(76, 175, 80, 0.3));
}

/* No Image Placeholder (static - when no URL provided) */
.yaa-no-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
}

.yaa-no-image span {
    font-size: 4rem;
    opacity: 0.3;
}

/* =========================================
 * IMAGE ERROR / 404 PLACEHOLDER (JavaScript-generated)
 * VERBESSERTES DESIGN - Version 1.3.0
 * ========================================= */

/* Wrapper with broken image */
.yaa-image-wrapper.yaa-image-error {
    background: linear-gradient(135deg, 
        rgba(25, 25, 30, 0.9) 0%, 
        rgba(15, 15, 20, 0.95) 100%);
}

/* CSS-only Placeholder (inserted by JS) - MODERNISIERT */
.yaa-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(145deg, 
        rgba(30, 30, 35, 0.95) 0%, 
        rgba(20, 20, 25, 0.98) 50%,
        rgba(25, 25, 30, 0.95) 100%);
    border-radius: inherit;
    overflow: hidden;
}

/* Glassmorphism overlay effect */
.yaa-placeholder::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='none'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23666'/%3E%3Cstop offset='100%25' style='stop-color:%23444'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='15' y='20' width='70' height='50' rx='8' stroke='url(%23g)' stroke-width='2' fill='none'/%3E%3Ccircle cx='32' cy='38' r='8' stroke='%23555' stroke-width='1.5' fill='none'/%3E%3Cpath d='M18 58 L35 42 L50 52 L68 32 L82 48 L82 62 L18 62 Z' fill='%23333' fill-opacity='0.6'/%3E%3Cpath d='M50 72 L50 82' stroke='%23555' stroke-width='2' stroke-linecap='round'/%3E%3Cpath d='M42 82 L58 82' stroke='%23555' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    opacity: 0.4;
    transition: all 0.4s ease;
}

/* Subtle shimmer animation */
.yaa-placeholder::after {
    content: "Bild nicht verfügbar";
    position: absolute;
    bottom: 25%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.35);
    text-transform: uppercase;
    letter-spacing: 2px;
    white-space: nowrap;
    font-weight: 500;
    background: linear-gradient(90deg, 
        rgba(255,255,255,0.2) 0%, 
        rgba(255,255,255,0.4) 50%, 
        rgba(255,255,255,0.2) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: yaa-placeholder-shimmer 3s ease-in-out infinite;
}

@keyframes yaa-placeholder-shimmer {
    0% { background-position: 200% center; }
    100% { background-position: -200% center; }
}

/* Decorative corner accents */
.yaa-placeholder .yaa-placeholder-corner {
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: rgba(255, 255, 255, 0.1);
    border-style: solid;
    border-width: 0;
}

/* Hover effect on placeholder */
.yaa-item:hover .yaa-placeholder::before {
    opacity: 0.55;
    transform: translate(-50%, -50%) scale(1.05);
}

.yaa-item:hover .yaa-placeholder::after {
    color: rgba(255, 255, 255, 0.5);
}

/* =========================================
 * SOURCE-SPECIFIC PLACEHOLDER COLORS
 * Verbesserte farbliche Integration
 * ========================================= */

/* Amazon Placeholder - Orange Akzent */
.yaa-placeholder-amazon {
    background: linear-gradient(145deg, 
        rgba(40, 30, 20, 0.95) 0%, 
        rgba(25, 20, 15, 0.98) 50%,
        rgba(35, 25, 18, 0.95) 100%);
    border-bottom: 2px solid rgba(255, 153, 0, 0.3);
}

.yaa-placeholder-amazon::before {
    filter: sepia(50%) saturate(200%) hue-rotate(350deg) brightness(1.1);
}

.yaa-placeholder-amazon::after {
    background: linear-gradient(90deg, 
        rgba(255, 153, 0, 0.3) 0%, 
        rgba(255, 180, 50, 0.5) 50%, 
        rgba(255, 153, 0, 0.3) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

/* Custom Product Placeholder - Grüner Akzent */
.yaa-placeholder-custom {
    background: linear-gradient(145deg, 
        rgba(20, 35, 25, 0.95) 0%, 
        rgba(15, 25, 18, 0.98) 50%,
        rgba(18, 30, 22, 0.95) 100%);
    border-bottom: 2px solid rgba(76, 175, 80, 0.3);
}

.yaa-placeholder-custom::before {
    filter: sepia(50%) saturate(200%) hue-rotate(80deg) brightness(1.1);
}

.yaa-placeholder-custom::after {
    background: linear-gradient(90deg, 
        rgba(76, 175, 80, 0.3) 0%, 
        rgba(129, 199, 132, 0.5) 50%, 
        rgba(76, 175, 80, 0.3) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

/* Yadore Placeholder - Magenta/Cyan Akzent */
.yaa-placeholder-yadore {
    background: linear-gradient(145deg, 
        rgba(30, 20, 35, 0.95) 0%, 
        rgba(20, 15, 25, 0.98) 50%,
        rgba(25, 18, 30, 0.95) 100%);
    border-bottom: 2px solid rgba(255, 0, 204, 0.3);
}

.yaa-placeholder-yadore::before {
    filter: sepia(50%) saturate(250%) hue-rotate(280deg) brightness(1.1);
}

.yaa-placeholder-yadore::after {
    background: linear-gradient(90deg, 
        rgba(255, 0, 204, 0.3) 0%, 
        rgba(0, 255, 255, 0.5) 50%, 
        rgba(255, 0, 204, 0.3) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

/* =========================================
 * CONTENT SECTION
 * ========================================= */
.yaa-content {
    padding: 20px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    border-top: 1px solid var(--yaa-glass-border);
}

/* Title */
.yaa-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.05rem;
    font-weight: 700;
    line-height: 1.4;
    margin: 0 0 12px 0;
    color: var(--yaa-text-main);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.8em;
}

.yaa-title a {
    color: var(--yaa-text-main);
    text-decoration: none;
    transition: all 0.3s ease;
}

.yaa-title a:hover {
    color: var(--yaa-secondary);
    text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}

.yaa-item.yaa-amazon .yaa-title a:hover {
    color: var(--yaa-amazon);
    text-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
}

.yaa-item.yaa-custom .yaa-title a:hover {
    color: var(--yaa-custom);
    text-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
}

/* =========================================
 * DESCRIPTION
 * ========================================= */
.yaa-description-wrapper {
    position: relative;
    margin-bottom: 15px;
}

.yaa-description {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--yaa-text-muted);
    max-height: 4.8em;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
    position: relative;
}

.yaa-description::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2.4em;
    background: linear-gradient(to bottom, transparent 0%, rgba(10, 10, 10, 0.9) 100%);
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.yaa-description.expanded {
    max-height: 500px;
}

.yaa-description.expanded::after {
    opacity: 0;
}

/* Read More Button */
.yaa-read-more {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--yaa-primary);
    cursor: pointer;
    margin-top: 8px;
    padding: 5px 0;
    border: none;
    background: none;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

.yaa-read-more:hover {
    color: var(--yaa-secondary);
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}

.yaa-read-more::after {
    content: "▼";
    font-size: 0.6rem;
    transition: transform 0.3s ease;
}

.yaa-read-more.expanded::after {
    transform: rotate(180deg);
}

.yaa-item.yaa-amazon .yaa-read-more {
    color: var(--yaa-amazon);
}

.yaa-item.yaa-custom .yaa-read-more {
    color: var(--yaa-custom);
}

.yaa-no-description {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.3);
    font-style: italic;
    margin-bottom: 15px;
}

/* =========================================
 * META & PRICE
 * ========================================= */
.yaa-meta {
    margin: 0 0 15px 0;
}

.yaa-price {
    display: block;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.6rem;
    font-weight: 900;
    background: linear-gradient(135deg, 
        var(--yaa-primary) 0%, 
        #ff66dd 50%, 
        var(--yaa-secondary) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: yaa-price-glow 3s ease-in-out infinite;
    margin-bottom: 5px;
}

.yaa-item.yaa-amazon .yaa-price {
    background: linear-gradient(135deg, 
        var(--yaa-amazon) 0%, 
        #ffb84d 50%, 
        var(--yaa-amazon) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

.yaa-item.yaa-custom .yaa-price {
    background: linear-gradient(135deg, 
        var(--yaa-custom) 0%, 
        #81C784 50%, 
        var(--yaa-custom) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

@keyframes yaa-price-glow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
}

.yaa-merchant {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--yaa-text-muted);
    font-weight: 600;
}

.yaa-merchant::before {
    content: "via ";
    color: var(--yaa-secondary);
}

.yaa-item.yaa-amazon .yaa-merchant::before {
    color: var(--yaa-amazon);
}

.yaa-item.yaa-custom .yaa-merchant::before {
    color: var(--yaa-custom);
}

/* =========================================
 * BUTTON
 * ========================================= */
.yaa-button-wrapper {
    margin-top: auto;
}

.yaa-button {
    display: block;
    width: 100%;
    text-align: center;
    background-color: transparent;
    border: 2px solid var(--yaa-primary);
    color: var(--yaa-primary);
    padding: 14px 20px;
    border-radius: 50px;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-sizing: border-box;
}

.yaa-button:hover {
    background-color: var(--yaa-primary);
    color: #000;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-primary), transparent 30%);
    transform: translateY(-2px);
    text-decoration: none;
}

/* Alternating Colors */
.yaa-item:nth-child(even) .yaa-button {
    border-color: var(--yaa-secondary);
    color: var(--yaa-secondary);
}

.yaa-item:nth-child(even) .yaa-button:hover {
    background-color: var(--yaa-secondary);
    color: #000;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-secondary), transparent 30%);
}

/* Amazon Button */
.yaa-item.yaa-amazon .yaa-button {
    border-color: var(--yaa-amazon);
    color: var(--yaa-amazon);
}

.yaa-item.yaa-amazon .yaa-button:hover {
    background-color: var(--yaa-amazon);
    color: #000;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-amazon), transparent 30%);
}

/* Custom Button */
.yaa-item.yaa-custom .yaa-button {
    border-color: var(--yaa-custom);
    color: var(--yaa-custom);
}

.yaa-item.yaa-custom .yaa-button:hover {
    background-color: var(--yaa-custom);
    color: #fff;
    box-shadow: 0 0 30px color-mix(in srgb, var(--yaa-custom), transparent 30%);
}

/* =========================================
 * MESSAGE BOXES (Error, Empty, Loading)
 * ========================================= */
.yaa-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    background: var(--yaa-glass-bg);
    border: 1px solid var(--yaa-glass-border);
    border-radius: 12px;
    text-align: center;
    color: var(--yaa-text-muted);
}

.yaa-message .yaa-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.6;
}

.yaa-message p {
    margin: 0;
    font-size: 1rem;
    line-height: 1.5;
}

.yaa-error {
    border-color: rgba(220, 53, 69, 0.3);
    background: rgba(220, 53, 69, 0.1);
}

.yaa-error .yaa-icon {
    color: #dc3545;
}

.yaa-empty {
    border-color: rgba(255, 193, 7, 0.3);
    background: rgba(255, 193, 7, 0.1);
}

.yaa-empty .yaa-icon {
    color: #ffc107;
}

/* =========================================
 * LOADING STATE
 * ========================================= */
.yaa-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
}

.yaa-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--yaa-glass-border);
    border-top-color: var(--yaa-primary);
    border-radius: 50%;
    animation: yaa-spin 1s linear infinite;
}

@keyframes yaa-spin {
    to { transform: rotate(360deg); }
}

/* =========================================
 * ACCESSIBILITY - Focus States
 * ========================================= */
.yaa-button:focus,
.yaa-read-more:focus,
.yaa-title a:focus {
    outline: 2px solid var(--yaa-primary);
    outline-offset: 2px;
}

.yaa-item.yaa-amazon .yaa-button:focus,
.yaa-item.yaa-amazon .yaa-title a:focus {
    outline-color: var(--yaa-amazon);
}

.yaa-item.yaa-custom .yaa-button:focus,
.yaa-item.yaa-custom .yaa-title a:focus {
    outline-color: var(--yaa-custom);
}

/* Screen Reader Only Text */
.screen-reader-text {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* =========================================
 * RESPONSIVE BREAKPOINTS
 * ========================================= */

/* Tablet (768px - 1023px) */
@media (max-width: 1023px) {
    .yaa-grid-container {
        grid-template-columns: repeat(var(--yaa-columns-tablet), 1fr);
        gap: 20px;
    }
    
    .yaa-title {
        font-size: 0.95rem;
    }
    
    .yaa-price {
        font-size: 1.4rem;
    }
    
    .yaa-button {
        padding: 12px 16px;
        font-size: 0.75rem;
    }
}

/* Mobile (< 768px) */
@media (max-width: 767px) {
    .yaa-grid-container {
        grid-template-columns: repeat(var(--yaa-columns-mobile), 1fr);
        gap: 15px;
    }
    
    .yaa-item:hover {
        transform: translateY(-4px);
    }
    
    .yaa-content {
        padding: 15px;
    }
    
    .yaa-title {
        font-size: 0.9rem;
        min-height: auto;
        -webkit-line-clamp: 3;
    }
    
    .yaa-price {
        font-size: 1.3rem;
    }
    
    .yaa-description {
        font-size: 0.8rem;
    }
    
    .yaa-button {
        padding: 12px 15px;
        font-size: 0.7rem;
        letter-spacing: 1px;
    }
    
    .yaa-prime-badge,
    .yaa-custom-badge {
        font-size: 0.6rem;
        padding: 3px 8px;
    }
    
    .yaa-placeholder::before {
        width: 70px;
        height: 70px;
    }
    
    .yaa-placeholder::after {
        font-size: 0.55rem;
        letter-spacing: 1.5px;
    }
}

/* Small Mobile (< 480px) */
@media (max-width: 479px) {
    .yaa-grid-container {
        gap: 12px;
    }
    
    .yaa-content {
        padding: 12px;
    }
    
    .yaa-title {
        font-size: 0.85rem;
        margin-bottom: 8px;
    }
    
    .yaa-price {
        font-size: 1.2rem;
    }
    
    .yaa-merchant {
        font-size: 0.7rem;
    }
    
    .yaa-button {
        padding: 10px 12px;
        font-size: 0.65rem;
    }
    
    .yaa-placeholder::before {
        width: 60px;
        height: 60px;
    }
    
    .yaa-placeholder::after {
        font-size: 0.5rem;
        bottom: 20%;
    }
}

/* =========================================
 * PRINT STYLES
 * ========================================= */
@media print {
    .yaa-grid-container {
        display: block;
    }
    
    .yaa-item {
        page-break-inside: avoid;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        box-shadow: none;
        backdrop-filter: none;
    }
    
    .yaa-item:hover {
        transform: none;
        box-shadow: none;
    }
    
    .yaa-button {
        background: #000 !important;
        color: #fff !important;
        border: none;
    }
    
    .yaa-price {
        color: #000 !important;
        -webkit-text-fill-color: #000 !important;
    }
    
    .yaa-placeholder {
        background: #f5f5f5 !important;
    }
    
    .yaa-placeholder::after {
        color: #666 !important;
        -webkit-text-fill-color: #666 !important;
    }
}

/* =========================================
 * DARK/LIGHT MODE SUPPORT
 * ========================================= */

/* Light Mode Override (wenn Theme hellen Hintergrund hat) */
@media (prefers-color-scheme: light) {
    .yaa-grid-container.yaa-light-mode {
        --yaa-glass-bg: rgba(0, 0, 0, 0.03);
        --yaa-glass-border: rgba(0, 0, 0, 0.1);
        --yaa-text-main: #1a1a1a;
        --yaa-text-muted: #666666;
    }
    
    .yaa-grid-container.yaa-light-mode .yaa-item {
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .yaa-grid-container.yaa-light-mode .yaa-description::after {
        background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.9) 100%);
    }
}

/* Forced Light Mode Class */
.yaa-grid-container.yaa-theme-light {
    --yaa-glass-bg: rgba(0, 0, 0, 0.03);
    --yaa-glass-border: rgba(0, 0, 0, 0.1);
    --yaa-text-main: #1a1a1a;
    --yaa-text-muted: #666666;
}

.yaa-grid-container.yaa-theme-light .yaa-item {
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.yaa-grid-container.yaa-theme-light .yaa-description::after {
    background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.9) 100%);
}

.yaa-grid-container.yaa-theme-light .yaa-placeholder {
    background: linear-gradient(145deg, 
        rgba(245, 245, 248, 0.98) 0%, 
        rgba(235, 235, 240, 0.98) 50%,
        rgba(240, 240, 245, 0.98) 100%);
}

.yaa-grid-container.yaa-theme-light .yaa-placeholder::before {
    opacity: 0.3;
}

.yaa-grid-container.yaa-theme-light .yaa-placeholder::after {
    background: linear-gradient(90deg, 
        rgba(100, 100, 100, 0.4) 0%, 
        rgba(50, 50, 50, 0.6) 50%, 
        rgba(100, 100, 100, 0.4) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
}

/* =========================================
 * REDUCED MOTION SUPPORT
 * ========================================= */
@media (prefers-reduced-motion: reduce) {
    .yaa-item,
    .yaa-button,
    .yaa-image-wrapper img,
    .yaa-description,
    .yaa-read-more::after,
    .yaa-placeholder::before {
        transition: none;
    }
    
    .yaa-item:hover {
        transform: none;
    }
    
    .yaa-item:hover .yaa-image-wrapper img {
        transform: none;
    }
    
    .yaa-price {
        animation: none;
    }
    
    .yaa-placeholder::after {
        animation: none;
    }
    
    .yaa-spinner {
        animation: none;
        border-top-color: var(--yaa-primary);
        border-right-color: var(--yaa-primary);
    }
}
/* =========================================
 * SHOP LOGO FALLBACK STYLES
 * Version 1.5.1 - Shop-Logo als Bild-Fallback
 * ========================================= */

/* Shop-Logo als Fallback-Bild */
.yaa-image-wrapper img.yaa-shop-logo-fallback {
    width: 60% !important;
    height: 60% !important;
    object-fit: contain !important;
    opacity: 0.9;
    filter: brightness(1) saturate(1) drop-shadow(0 2px 10px rgba(0, 0, 0, 0.3));
    transition: all 0.3s ease;
}

/* Hover-Effekt für Shop-Logo */
.yaa-item:hover .yaa-image-wrapper img.yaa-shop-logo-fallback {
    opacity: 1;
    transform: scale(1.05);
    filter: brightness(1.05) saturate(1.1) drop-shadow(0 4px 15px rgba(0, 0, 0, 0.4));
}

/* Hintergrund für Shop-Logo Container anpassen */
.yaa-image-wrapper:has(img.yaa-shop-logo-fallback) {
    background: linear-gradient(145deg, 
        rgba(40, 40, 45, 0.95) 0%, 
        rgba(30, 30, 35, 0.98) 50%,
        rgba(35, 35, 40, 0.95) 100%);
}

/* Yadore-spezifischer Hintergrund für Shop-Logo */
.yaa-item.yaa-yadore .yaa-image-wrapper:has(img.yaa-shop-logo-fallback) {
    background: linear-gradient(145deg, 
        rgba(35, 25, 40, 0.95) 0%, 
        rgba(25, 18, 30, 0.98) 50%,
        rgba(30, 22, 35, 0.95) 100%);
}

/* Fallback für Browser ohne :has() Support */
@supports not (selector(:has(*))) {
    .yaa-image-wrapper img.yaa-shop-logo-fallback {
        background: linear-gradient(145deg, 
            rgba(40, 40, 45, 0.95) 0%, 
            rgba(30, 30, 35, 0.98) 100%);
        padding: 20%;
        box-sizing: border-box;
    }
}

/* Light Mode Support für Shop-Logo */
.yaa-grid-container.yaa-theme-light .yaa-image-wrapper:has(img.yaa-shop-logo-fallback) {
    background: linear-gradient(145deg, 
        rgba(250, 250, 252, 0.98) 0%, 
        rgba(240, 240, 245, 0.98) 50%,
        rgba(245, 245, 248, 0.98) 100%);
}

.yaa-grid-container.yaa-theme-light .yaa-image-wrapper img.yaa-shop-logo-fallback {
    filter: brightness(1) saturate(1) drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
}

/* Responsive Anpassungen für Shop-Logo */
@media (max-width: 767px) {
    .yaa-image-wrapper img.yaa-shop-logo-fallback {
        width: 50% !important;
        height: 50% !important;
    }
}

@media (max-width: 479px) {
    .yaa-image-wrapper img.yaa-shop-logo-fallback {
        width: 45% !important;
        height: 45% !important;
    }
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    .yaa-image-wrapper img.yaa-shop-logo-fallback {
        transition: none;
    }
    
    .yaa-item:hover .yaa-image-wrapper img.yaa-shop-logo-fallback {
        transform: none;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\assets\css\yaa-search.css 
 
/**
 * Yadore Interaktive Produktsuche - Styles
 * Mit Initial-Produkten Support
 * 
 * @package Yadore_Amazon_API
 * @since 1.6.0
 */

/* Container */
.yadore-search-container {
    --yadore-primary: #2563eb;
    --yadore-primary-hover: #1d4ed8;
    --yadore-text: #1f2937;
    --yadore-text-muted: #6b7280;
    --yadore-border: #e5e7eb;
    --yadore-bg: #ffffff;
    --yadore-bg-hover: #f9fafb;
    --yadore-radius: 8px;
    --yadore-shadow: 0 1px 3px rgba(0,0,0,0.1);
    --yadore-shadow-lg: 0 4px 6px -1px rgba(0,0,0,0.1);
    
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    max-width: 100%;
    margin: 0 auto;
}

/* =====================
   Suchformular
   ===================== */
.yadore-search-form {
    margin-bottom: 1.5rem;
}

.yadore-search-input-wrapper {
    display: flex;
    gap: 0.5rem;
    max-width: 600px;
}

.yadore-search-input {
    flex: 1;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    border: 2px solid var(--yadore-border);
    border-radius: var(--yadore-radius);
    background: var(--yadore-bg);
    color: var(--yadore-text);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.yadore-search-input:focus {
    outline: none;
    border-color: var(--yadore-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.yadore-search-input::placeholder {
    color: var(--yadore-text-muted);
}

.yadore-search-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    background: var(--yadore-primary);
    border: none;
    border-radius: var(--yadore-radius);
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    min-width: 120px;
}

.yadore-search-button:hover:not(:disabled) {
    background: var(--yadore-primary-hover);
}

.yadore-search-button:active:not(:disabled) {
    transform: scale(0.98);
}

.yadore-search-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.yadore-search-spinner {
    display: inline-flex;
}

.yadore-spinner-icon {
    width: 20px;
    height: 20px;
}

/* =====================
   Status-Meldungen
   ===================== */
.yadore-search-status {
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: var(--yadore-radius);
    text-align: center;
}

.yadore-status-loading {
    background: #eff6ff;
    color: #1e40af;
}

.yadore-status-error {
    background: #fef2f2;
    color: #991b1b;
}

.yadore-status-empty {
    background: #fefce8;
    color: #854d0e;
}

.yadore-status-info {
    background: #f3f4f6;
    color: var(--yadore-text-muted);
}

/* =====================
   Initial-Produkte
   ===================== */
.yadore-initial-products {
    margin-bottom: 2rem;
}

.yadore-initial-header {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--yadore-border);
}

.yadore-initial-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--yadore-text);
}

/* =====================
   Such-Ergebnisse Header
   ===================== */
.yadore-search-results-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--yadore-border);
}

.yadore-search-results-info {
    display: flex;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--yadore-text-muted);
}

.yadore-search-results-count {
    font-weight: 600;
    color: var(--yadore-text);
}

/* Reset-Button */
.yadore-reset-button {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--yadore-primary);
    background: transparent;
    border: 1px solid var(--yadore-primary);
    border-radius: var(--yadore-radius);
    cursor: pointer;
    transition: all 0.2s;
}

.yadore-reset-button:hover {
    background: var(--yadore-primary);
    color: #fff;
}

/* =====================
   Produkt-Grid
   ===================== */
.yadore-search-results-grid {
    display: grid;
    gap: 1.5rem;
}

.yadore-columns-2 { grid-template-columns: repeat(2, 1fr); }
.yadore-columns-3 { grid-template-columns: repeat(3, 1fr); }
.yadore-columns-4 { grid-template-columns: repeat(4, 1fr); }

/* =====================
   Produkt-Karte
   ===================== */
.yadore-product-card {
    position: relative;
    background: var(--yadore-bg);
    border: 1px solid var(--yadore-border);
    border-radius: var(--yadore-radius);
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.2s;
}

.yadore-product-card:hover {
    box-shadow: var(--yadore-shadow-lg);
    transform: translateY(-2px);
}

.yadore-product-link {
    display: block;
    text-decoration: none;
    color: inherit;
}

/* Source Badge */
.yadore-product-source {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    z-index: 2;
}

.yadore-source-yadore {
    background: #10b981; /* Grün */
}

.yadore-source-amazon {
    background: #f59e0b; /* Orange/Amazon */
}

/* Produkt-Bild */
.yadore-product-image {
    position: relative;
    padding-top: 100%;
    background: #f9fafb;
    overflow: hidden;
}

.yadore-product-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 1rem;
    transition: transform 0.3s;
}

.yadore-product-card:hover .yadore-product-image img {
    transform: scale(1.05);
}

.yadore-product-image.yadore-no-image,
.yadore-product-image.yadore-image-error {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #d1d5db;
}

.yadore-product-image.yadore-no-image svg,
.yadore-product-image.yadore-image-error svg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 48px;
    height: 48px;
}

.yadore-product-image.yadore-image-error img {
    display: none;
}

/* Produkt-Inhalt */
.yadore-product-content {
    padding: 1rem;
}

.yadore-product-title {
    margin: 0 0 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--yadore-text);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.yadore-product-merchant {
    font-size: 0.8rem;
    color: var(--yadore-text-muted);
    margin-bottom: 0.5rem;
}

.yadore-product-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--yadore-primary);
    margin-bottom: 0.75rem;
}

.yadore-product-cta {
    display: inline-block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--yadore-primary);
    transition: transform 0.2s;
}

.yadore-product-card:hover .yadore-product-cta {
    transform: translateX(4px);
}

/* =====================
   Animationen
   ===================== */
@keyframes yadore-fade-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.yadore-search-results .yadore-product-card {
    animation: yadore-fade-in 0.3s ease forwards;
}

.yadore-search-results .yadore-product-card:nth-child(1) { animation-delay: 0.05s; }
.yadore-search-results .yadore-product-card:nth-child(2) { animation-delay: 0.1s; }
.yadore-search-results .yadore-product-card:nth-child(3) { animation-delay: 0.15s; }
.yadore-search-results .yadore-product-card:nth-child(4) { animation-delay: 0.2s; }
.yadore-search-results .yadore-product-card:nth-child(5) { animation-delay: 0.25s; }
.yadore-search-results .yadore-product-card:nth-child(6) { animation-delay: 0.3s; }

/* =====================
   Responsive
   ===================== */
@media (max-width: 768px) {
    .yadore-search-input-wrapper {
        flex-direction: column;
    }
    
    .yadore-search-button {
        width: 100%;
    }
    
    .yadore-columns-3,
    .yadore-columns-4 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .yadore-search-results-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .yadore-reset-button {
        width: 100%;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .yadore-columns-2,
    .yadore-columns-3,
    .yadore-columns-4 {
        grid-template-columns: 1fr;
    }
    
    .yadore-search-input {
        padding: 0.75rem;
    }
    
    .yadore-search-button {
        padding: 0.75rem 1rem;
    }
    
    .yadore-initial-title {
        font-size: 1.1rem;
    }
}

/* =====================
   Dark Mode Support
   ===================== */
@media (prefers-color-scheme: dark) {
    .yadore-search-container {
        --yadore-text: #f3f4f6;
        --yadore-text-muted: #9ca3af;
        --yadore-border: #374151;
        --yadore-bg: #1f2937;
        --yadore-bg-hover: #374151;
    }
    
    .yadore-product-image {
        background: #374151;
    }
    
    .yadore-status-loading {
        background: #1e3a5f;
        color: #93c5fd;
    }
    
    .yadore-status-error {
        background: #450a0a;
        color: #fca5a5;
    }
    
    .yadore-status-empty {
        background: #422006;
        color: #fcd34d;
    }
    
    .yadore-status-info {
        background: #374151;
        color: #9ca3af;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\assets\js\frontend-grid.js 
 
/**
 * Yadore-Amazon-API Frontend JavaScript
 * Version 1.5.1 - Mit Shop-Logo Fallback
 * PHP 8.3+ compatible
 * 
 * Features:
 * - Read More/Less Toggle
 * - Lazy Load Fallback
 * - Accessibility Enhancements
 * - Image 404 Error Handling with extended Fallback Chain
 * - Server-seitiger Image Proxy
 * - NEU: Shop-Logo als Fallback vor Placeholder
 * - Public API
 * 
 * Fallback-Kette:
 * 1. Original Image → Error
 * 2. Thumbnail (data-thumbnail) → Error
 * 3. Server-seitiger Proxy (data-proxy-src) → Error
 * 4. Shop-Logo (data-shop-logo) → Error (NEU)
 * 5. CSS Placeholder
 */

(function() {
    'use strict';

    /**
     * Initialize when DOM is ready
     */
    document.addEventListener('DOMContentLoaded', function() {
        initReadMoreButtons();
        initLazyLoadImages();
        initAccessibilityEnhancements();
        initImageErrorHandling();
    });

    /**
     * Initialize read more/less toggle buttons
     */
    function initReadMoreButtons() {
        var buttons = document.querySelectorAll('.yaa-read-more');
        
        buttons.forEach(function(button) {
            button.addEventListener('click', handleReadMoreClick);
            button.addEventListener('keydown', handleReadMoreKeydown);
        });
    }

    /**
     * Handle read more button click
     * @param {Event} event
     */
    function handleReadMoreClick(event) {
        event.preventDefault();
        
        var button = event.currentTarget;
        var targetId = button.getAttribute('data-target');
        var description = document.getElementById('desc-' + targetId);
        
        if (!description) {
            return;
        }
        
        toggleDescription(description, button);
    }

    /**
     * Handle keyboard navigation for read more
     * @param {KeyboardEvent} event
     */
    function handleReadMoreKeydown(event) {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            handleReadMoreClick(event);
        }
    }

    /**
     * Toggle description expanded state
     * @param {HTMLElement} description
     * @param {HTMLElement} button
     */
    function toggleDescription(description, button) {
        var isExpanded = description.classList.contains('expanded');
        var expandText = button.getAttribute('data-expand-text') || 'mehr lesen';
        var collapseText = button.getAttribute('data-collapse-text') || 'weniger';
        
        if (isExpanded) {
            description.classList.remove('expanded');
            button.classList.remove('expanded');
            button.textContent = expandText;
            button.setAttribute('aria-expanded', 'false');
        } else {
            description.classList.add('expanded');
            button.classList.add('expanded');
            button.textContent = collapseText;
            button.setAttribute('aria-expanded', 'true');
        }
    }

    /**
     * Initialize lazy loading for images
     * Fallback for browsers without native lazy loading
     */
    function initLazyLoadImages() {
        // Check if native lazy loading is supported
        if ('loading' in HTMLImageElement.prototype) {
            return; // Native support, no need for JS
        }

        // Fallback for older browsers
        var images = document.querySelectorAll('.yaa-image-wrapper img[loading="lazy"]');
        
        if (images.length === 0) {
            return;
        }

        // Use IntersectionObserver if available
        if ('IntersectionObserver' in window) {
            var imageObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        var image = entry.target;
                        if (image.dataset.src) {
                            image.src = image.dataset.src;
                            image.removeAttribute('data-src');
                        }
                        observer.unobserve(image);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });

            images.forEach(function(image) {
                imageObserver.observe(image);
            });
        }
    }

    /**
     * Initialize image error handling for 404/broken images
     */
    function initImageErrorHandling() {
        var images = document.querySelectorAll('.yaa-image-wrapper img');
        
        images.forEach(function(img) {
            // Mark image as not yet processed for fallback
            if (!img.hasAttribute('data-fallback-attempted')) {
                img.setAttribute('data-fallback-attempted', 'false');
            }
            
            // Prüfe auf leeres src mit vorhandener Alternative
            var currentSrc = img.getAttribute('src') || '';
            var proxySrc = img.getAttribute('data-proxy-src') || '';
            var originalSrc = img.getAttribute('data-original-src') || '';
            
            // Wenn src leer ist aber Alternativen existieren, sofort laden
            if (currentSrc === '' || currentSrc === window.location.href) {
                if (proxySrc !== '') {
                    if (window.console) {
                        console.log('YAA: Empty src detected, using proxy:', proxySrc);
                    }
                    img.setAttribute('data-fallback-attempted', 'proxy');
                    img.src = proxySrc;
                    return;
                } else if (originalSrc !== '') {
                    if (window.console) {
                        console.log('YAA: Empty src detected, using original:', originalSrc);
                    }
                    img.setAttribute('data-fallback-attempted', 'original');
                    img.src = originalSrc;
                    return;
                }
            }
            
            // Handle images that are already broken (cached or immediate 404)
            if (img.complete) {
                if (img.naturalWidth === 0 || img.naturalHeight === 0) {
                    attemptImageFallback(img);
                } else {
                    // Image loaded successfully
                    img.classList.add('yaa-img-loaded');
                }
            }
            
            // Handle future load events
            img.addEventListener('load', function() {
                img.classList.add('yaa-img-loaded');
                img.classList.remove('yaa-img-loading');
            });
            
            // Handle future errors (async loading)
            img.addEventListener('error', function() {
                attemptImageFallback(img);
            });
        });
    }

    /**
     * Attempt image fallback chain
     * 
     * Erweiterte Fallback-Reihenfolge (Version 1.5.1):
     * 1. Original image (already failed)
     * 2. Try thumbnail if available (data-thumbnail)
     * 3. Try server-side proxy (data-proxy-src)
     * 4. Try shop logo (data-shop-logo) - NEU
     * 5. Fall back to CSS placeholder
     * 
     * @param {HTMLImageElement} img
     */
    function attemptImageFallback(img) {
        var wrapper = img.closest('.yaa-image-wrapper');
        
        if (!wrapper) {
            return;
        }
        
        // Referrer-Policy setzen um Hotlink-Protection zu umgehen
        if (!img.hasAttribute('referrerpolicy')) {
            img.setAttribute('referrerpolicy', 'no-referrer');
        }
        
        // Get fallback state
        var fallbackAttempted = img.getAttribute('data-fallback-attempted');
        var thumbnailUrl = img.getAttribute('data-thumbnail');
        var originalSrc = img.getAttribute('data-original-src') || img.src;
        var shopLogoUrl = img.getAttribute('data-shop-logo'); // NEU
        
        // Store original src on first attempt
        if (!img.hasAttribute('data-original-src')) {
            img.setAttribute('data-original-src', img.src);
        }
        
        // ========================================
        // ERWEITERTE FALLBACK CHAIN
        // ========================================
        
        // Step 1: If we haven't tried thumbnail yet and it exists, try it
        if (fallbackAttempted === 'false' && thumbnailUrl && thumbnailUrl !== '' && thumbnailUrl !== originalSrc) {
            if (window.console) {
                console.log('YAA: Original image failed, trying thumbnail:', thumbnailUrl);
            }
            
            img.setAttribute('data-fallback-attempted', 'thumbnail');
            img.classList.add('yaa-img-loading');
            
            // Try loading the thumbnail
            img.src = thumbnailUrl;
            return;
        }
        
        // Step 2: If thumbnail failed or doesn't exist, try proxy
        if (fallbackAttempted === 'thumbnail' || (fallbackAttempted === 'false' && !thumbnailUrl)) {
            // Check if proxy is enabled and we have a proxy URL
            if (isProxyEnabled()) {
                var proxyUrl = img.getAttribute('data-proxy-src') || getProxyUrl(originalSrc);
                
                if (proxyUrl && proxyUrl !== '') {
                    if (window.console) {
                        console.log('YAA: Trying server-side proxy for:', originalSrc);
                    }
                    
                    img.setAttribute('data-fallback-attempted', 'proxy');
                    img.classList.add('yaa-img-loading');
                    img.src = proxyUrl;
                    return;
                }
            }
            
            // No proxy available, skip to shop logo
            img.setAttribute('data-fallback-attempted', 'proxy-skipped');
        }
        
        // Step 3: NEU - If proxy failed or not available, try shop logo
        if (fallbackAttempted === 'proxy' || fallbackAttempted === 'proxy-skipped' || 
            (fallbackAttempted === 'false' && !thumbnailUrl && !isProxyEnabled())) {
            
            if (shopLogoUrl && shopLogoUrl !== '') {
                if (window.console) {
                    console.log('YAA: Trying shop logo as fallback:', shopLogoUrl);
                }
                
                img.setAttribute('data-fallback-attempted', 'shop-logo');
                img.classList.add('yaa-img-loading');
                img.classList.add('yaa-shop-logo-fallback');
                img.src = shopLogoUrl;
                return;
            }
        }
        
        // Step 4: All fallbacks failed, show CSS placeholder
        if (fallbackAttempted === 'false' || fallbackAttempted === 'thumbnail' || 
            fallbackAttempted === 'proxy' || fallbackAttempted === 'proxy-skipped' || 
            fallbackAttempted === 'shop-logo') {
            
            if (window.console) {
                var reason = 'Unknown';
                if (fallbackAttempted === 'shop-logo') {
                    reason = 'Shop logo also failed';
                } else if (fallbackAttempted === 'proxy') {
                    reason = 'Proxy failed, no shop logo available';
                } else if (fallbackAttempted === 'thumbnail') {
                    reason = 'Thumbnail failed, no proxy/shop logo available';
                } else {
                    reason = 'No fallbacks available';
                }
                console.warn('YAA: ' + reason + ', showing placeholder for:', originalSrc);
            }
            
            img.setAttribute('data-fallback-attempted', 'complete');
            showCSSPlaceholder(img, wrapper);
        }
    }

    /**
     * Check if image proxy is enabled
     * @returns {boolean}
     */
    function isProxyEnabled() {
        // Check global config from wp_localize_script
        if (typeof window.yaaProxy !== 'undefined' && window.yaaProxy.enabled) {
            return true;
        }
        return false;
    }

    /**
     * Generate proxy URL for an image
     * @param {string} originalUrl - The original image URL
     * @returns {string|null} - Proxy URL or null if not available
     */
    function getProxyUrl(originalUrl) {
        if (!originalUrl || originalUrl === '') {
            return null;
        }
        
        // Don't proxy local URLs
        if (originalUrl.indexOf(window.location.origin) === 0) {
            return null;
        }
        
        // Don't proxy data URLs
        if (originalUrl.indexOf('data:') === 0) {
            return null;
        }
        
        // Don't proxy already proxied URLs
        if (originalUrl.indexOf('action=yaa_proxy_image') !== -1) {
            return null;
        }
        
        // Build proxy URL
        if (typeof window.yaaProxy !== 'undefined' && window.yaaProxy.endpoint) {
            var params = new URLSearchParams();
            params.append('action', window.yaaProxy.action || 'yaa_proxy_image');
            params.append('url', originalUrl);
            
            return window.yaaProxy.endpoint + '?' + params.toString();
        }
        
        return null;
    }

    /**
     * Show CSS placeholder after all fallbacks failed
     * 
     * @param {HTMLImageElement} img
     * @param {HTMLElement} wrapper
     */
    function showCSSPlaceholder(img, wrapper) {
        // Prevent multiple executions
        if (wrapper.classList.contains('yaa-image-error')) {
            return;
        }
        
        // Mark wrapper as having an error
        wrapper.classList.add('yaa-image-error');
        
        // Hide the broken image
        img.style.display = 'none';
        img.style.visibility = 'hidden';
        img.classList.remove('yaa-img-loading');
        img.classList.remove('yaa-shop-logo-fallback');
        
        // Check if placeholder already exists
        if (wrapper.querySelector('.yaa-placeholder')) {
            return;
        }
        
        // Create CSS placeholder element
        var placeholder = document.createElement('div');
        placeholder.className = 'yaa-placeholder';
        placeholder.setAttribute('aria-hidden', 'true');
        placeholder.setAttribute('role', 'img');
        placeholder.setAttribute('aria-label', 'Bild nicht verfügbar');
        
        // Determine source type for colored placeholder
        var item = wrapper.closest('.yaa-item');
        if (item) {
            if (item.classList.contains('yaa-amazon')) {
                placeholder.classList.add('yaa-placeholder-amazon');
            } else if (item.classList.contains('yaa-custom')) {
                placeholder.classList.add('yaa-placeholder-custom');
            } else if (item.classList.contains('yaa-yadore')) {
                placeholder.classList.add('yaa-placeholder-yadore');
            }
        }
        
        // Insert placeholder (inside the link if exists, otherwise directly)
        var link = wrapper.querySelector('a');
        if (link) {
            link.appendChild(placeholder);
        } else {
            wrapper.appendChild(placeholder);
        }
    }

    /**
     * Legacy function for backwards compatibility
     * @deprecated Use attemptImageFallback instead
     * @param {HTMLImageElement} img
     */
    function handleBrokenImage(img) {
        attemptImageFallback(img);
    }

    /**
     * Initialize accessibility enhancements
     */
    function initAccessibilityEnhancements() {
        // Add ARIA labels to read more buttons
        var buttons = document.querySelectorAll('.yaa-read-more');
        buttons.forEach(function(button) {
            if (!button.hasAttribute('aria-expanded')) {
                button.setAttribute('aria-expanded', 'false');
            }
            if (!button.hasAttribute('role')) {
                button.setAttribute('role', 'button');
            }
            if (!button.hasAttribute('tabindex')) {
                button.setAttribute('tabindex', '0');
            }
        });

        // Add ARIA labels to product links
        var productLinks = document.querySelectorAll('.yaa-item .yaa-title a, .yaa-item .yaa-button');
        productLinks.forEach(function(link) {
            if (link.hasAttribute('target') && link.getAttribute('target') === '_blank') {
                if (!link.querySelector('.screen-reader-text')) {
                    var srText = document.createElement('span');
                    srText.className = 'screen-reader-text';
                    srText.textContent = ' (öffnet in neuem Tab)';
                    srText.style.cssText = 'position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;';
                    link.appendChild(srText);
                }
            }
        });
    }

    /**
     * Public API for external access
     */
    window.YAA = window.YAA || {};
    
    /**
     * Toggle description by ID
     * @param {string} id - The description ID (without 'desc-' prefix)
     */
    window.YAA.toggleDescription = function(id) {
        var description = document.getElementById('desc-' + id);
        var button = description ? description.parentElement.querySelector('.yaa-read-more') : null;
        
        if (description && button) {
            toggleDescription(description, button);
        }
    };

    /**
     * Refresh all components (useful after AJAX content load)
     */
    window.YAA.refresh = function() {
        initReadMoreButtons();
        initLazyLoadImages();
        initAccessibilityEnhancements();
        initImageErrorHandling();
    };

    /**
     * Manually check all images for errors
     * Useful after dynamically loading content
     */
    window.YAA.checkImages = function() {
        initImageErrorHandling();
    };

    /**
     * Force re-check of a specific image
     * @param {HTMLImageElement} img - The image element to check
     */
    window.YAA.recheckImage = function(img) {
        if (img && img.tagName === 'IMG') {
            // Reset fallback state
            img.setAttribute('data-fallback-attempted', 'false');
            
            if (img.complete && (img.naturalWidth === 0 || img.naturalHeight === 0)) {
                attemptImageFallback(img);
            }
        }
    };

    /**
     * Manually trigger thumbnail fallback for an image
     * @param {HTMLImageElement} img - The image element
     * @returns {boolean} True if thumbnail was attempted
     */
    window.YAA.tryThumbnail = function(img) {
        if (!img || img.tagName !== 'IMG') {
            return false;
        }
        
        var thumbnailUrl = img.getAttribute('data-thumbnail');
        if (thumbnailUrl && thumbnailUrl !== '') {
            img.setAttribute('data-fallback-attempted', 'false');
            attemptImageFallback(img);
            return true;
        }
        
        return false;
    };

    /**
     * Manually trigger proxy fallback for an image
     * @param {HTMLImageElement} img - The image element
     * @returns {boolean} True if proxy was attempted
     */
    window.YAA.tryProxy = function(img) {
        if (!img || img.tagName !== 'IMG') {
            return false;
        }
        
        if (!isProxyEnabled()) {
            if (window.console) {
                console.warn('YAA: Image proxy is not enabled');
            }
            return false;
        }
        
        var originalSrc = img.getAttribute('data-original-src') || img.src;
        var proxyUrl = getProxyUrl(originalSrc);
        
        if (proxyUrl) {
            img.setAttribute('data-fallback-attempted', 'proxy');
            img.src = proxyUrl;
            return true;
        }
        
        return false;
    };

    /**
     * NEU: Manually trigger shop logo fallback for an image
     * @param {HTMLImageElement} img - The image element
     * @returns {boolean} True if shop logo was attempted
     */
    window.YAA.tryShopLogo = function(img) {
        if (!img || img.tagName !== 'IMG') {
            return false;
        }
        
        var shopLogoUrl = img.getAttribute('data-shop-logo');
        
        if (shopLogoUrl && shopLogoUrl !== '') {
            img.setAttribute('data-fallback-attempted', 'shop-logo');
            img.classList.add('yaa-shop-logo-fallback');
            img.src = shopLogoUrl;
            return true;
        }
        
        if (window.console) {
            console.warn('YAA: No shop logo available for this image');
        }
        return false;
    };

    /**
     * Generate proxy URL for external use
     * @param {string} imageUrl - Original image URL
     * @returns {string|null} Proxy URL or null
     */
    window.YAA.getProxyUrl = function(imageUrl) {
        return getProxyUrl(imageUrl);
    };

    /**
     * Check if proxy is enabled
     * @returns {boolean}
     */
    window.YAA.isProxyEnabled = function() {
        return isProxyEnabled();
    };

    /**
     * Get product data from a grid item
     * @param {HTMLElement} item - The .yaa-item element
     * @returns {Object|null} Product data object
     */
    window.YAA.getProductData = function(item) {
        if (!item || !item.classList.contains('yaa-item')) {
            return null;
        }

        var titleElement = item.querySelector('.yaa-title a');
        var priceElement = item.querySelector('.yaa-price');
        var merchantElement = item.querySelector('.yaa-merchant');
        var imageElement = item.querySelector('.yaa-image-wrapper img');
        var wrapper = item.querySelector('.yaa-image-wrapper');

        return {
            title: titleElement ? titleElement.textContent.trim() : '',
            url: titleElement ? titleElement.href : '',
            price: priceElement ? priceElement.textContent.trim() : '',
            merchant: merchantElement ? merchantElement.textContent.replace('via ', '').trim() : '',
            image: imageElement ? imageElement.src : '',
            originalImage: imageElement ? imageElement.getAttribute('data-original-src') : '',
            thumbnail: imageElement ? imageElement.getAttribute('data-thumbnail') : '',
            shopLogo: imageElement ? imageElement.getAttribute('data-shop-logo') : '', // NEU
            proxyUrl: imageElement ? getProxyUrl(imageElement.getAttribute('data-original-src') || imageElement.src) : '',
            isAmazon: item.classList.contains('yaa-amazon'),
            isCustom: item.classList.contains('yaa-custom'),
            isYadore: item.classList.contains('yaa-yadore'),
            isPrime: item.querySelector('.yaa-prime-badge') !== null,
            hasImageError: wrapper ? wrapper.classList.contains('yaa-image-error') : false,
            imageLoaded: imageElement ? imageElement.classList.contains('yaa-img-loaded') : false,
            isShowingShopLogo: imageElement ? imageElement.classList.contains('yaa-shop-logo-fallback') : false, // NEU
            fallbackAttempted: imageElement ? imageElement.getAttribute('data-fallback-attempted') : null
        };
    };

    /**
     * Get all products in a container
     * @param {string|HTMLElement} container - Container selector or element
     * @returns {Array} Array of product data objects
     */
    window.YAA.getAllProducts = function(container) {
        var containerEl = container;
        
        if (typeof container === 'string') {
            containerEl = document.querySelector(container);
        }
        
        if (!containerEl) {
            containerEl = document;
        }
        
        var items = containerEl.querySelectorAll('.yaa-item');
        var products = [];
        
        items.forEach(function(item) {
            var data = window.YAA.getProductData(item);
            if (data) {
                products.push(data);
            }
        });
        
        return products;
    };

    /**
     * Get count of broken images
     * @returns {number}
     */
    window.YAA.getBrokenImageCount = function() {
        return document.querySelectorAll('.yaa-image-wrapper.yaa-image-error').length;
    };

    /**
     * Get count of images currently loading thumbnails
     * @returns {number}
     */
    window.YAA.getLoadingThumbnailCount = function() {
        return document.querySelectorAll('.yaa-image-wrapper img[data-fallback-attempted="thumbnail"]').length;
    };

    /**
     * Get count of images currently using proxy
     * @returns {number}
     */
    window.YAA.getProxyImageCount = function() {
        return document.querySelectorAll('.yaa-image-wrapper img[data-fallback-attempted="proxy"]').length;
    };

    /**
     * NEU: Get count of images showing shop logo
     * @returns {number}
     */
    window.YAA.getShopLogoCount = function() {
        return document.querySelectorAll('.yaa-image-wrapper img.yaa-shop-logo-fallback').length;
    };

    /**
     * Get detailed image status for debugging
     * @returns {Object}
     */
    window.YAA.getImageStats = function() {
        var images = document.querySelectorAll('.yaa-image-wrapper img');
        var loaded = 0;
        var broken = 0;
        var loadingThumbnail = 0;
        var loadingProxy = 0;
        var showingShopLogo = 0; // NEU
        var hasThumbnail = 0;
        var hasProxy = 0;
        var hasShopLogo = 0; // NEU
        
        images.forEach(function(img) {
            if (img.classList.contains('yaa-img-loaded')) {
                loaded++;
            }
            
            if (img.classList.contains('yaa-shop-logo-fallback')) {
                showingShopLogo++;
            }
            
            var fallbackState = img.getAttribute('data-fallback-attempted');
            if (fallbackState === 'complete') {
                broken++;
            } else if (fallbackState === 'thumbnail') {
                loadingThumbnail++;
            } else if (fallbackState === 'proxy') {
                loadingProxy++;
            }
            
            if (img.getAttribute('data-thumbnail')) {
                hasThumbnail++;
            }
            
            if (img.getAttribute('data-shop-logo')) {
                hasShopLogo++;
            }
            
            var originalSrc = img.getAttribute('data-original-src') || img.src;
            if (getProxyUrl(originalSrc)) {
                hasProxy++;
            }
        });
        
        return {
            total: images.length,
            loaded: loaded,
            broken: broken,
            loadingThumbnail: loadingThumbnail,
            loadingProxy: loadingProxy,
            showingShopLogo: showingShopLogo, // NEU
            withThumbnailFallback: hasThumbnail,
            withProxyAvailable: hasProxy,
            withShopLogoAvailable: hasShopLogo, // NEU
            proxyEnabled: isProxyEnabled()
        };
    };

})();
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\assets\js\yaa-search.js 
 
/**
 * Yadore Interaktive Produktsuche
 * Mit Initial-Produkten und Reset-Funktion
 * 
 * @package Yadore_Amazon_API
 * @since 1.6.0
 */

(function($) {
    'use strict';

    class YadoreProductSearch {
        constructor(container) {
            this.$container = $(container);
            this.$form = this.$container.find('.yadore-search-form');
            this.$input = this.$container.find('.yadore-search-input');
            this.$button = this.$container.find('.yadore-search-button');
            this.$buttonText = this.$container.find('.yadore-search-button-text');
            this.$spinner = this.$container.find('.yadore-search-spinner');
            this.$status = this.$container.find('.yadore-search-status');
            
            // Initial-Produkte Container
            this.$initialProducts = this.$container.find('.yadore-initial-products');
            
            // Such-Ergebnisse Container
            this.$results = this.$container.find('.yadore-search-results');
            this.$resultsGrid = this.$results.find('.yadore-search-results-grid');
            this.$resultsCount = this.$container.find('.yadore-search-results-count');
            this.$resultsQuery = this.$container.find('.yadore-search-results-query');
            this.$resetButton = this.$container.find('.yadore-reset-button');

            // Einstellungen aus data-Attributen
            this.settings = {
                network: this.$container.data('network') || '',
                maxResults: this.$container.data('max-results') || 12,
                columns: this.$container.data('columns') || 3,
                minChars: this.$container.data('min-chars') || 3,
                showPrice: this.$container.data('show-price') === 1,
                showMerchant: this.$container.data('show-merchant') === 1,
                newTab: this.$container.data('new-tab') === 1,
                debounce: this.$container.data('debounce') || 500,
                liveSearch: this.$container.data('live-search') === 1,
                sort: this.$container.data('sort') || 'cpc_desc',
                merchantFilter: this.$container.data('merchant-filter') || '',
                showInitial: this.$container.data('show-initial') === 1,
                showReset: this.$container.data('show-reset') === 1,
                hasInitial: this.$container.data('has-initial') === 1,
            };

            this.debounceTimer = null;
            this.currentRequest = null;
            this.lastQuery = '';
            this.isShowingResults = false;

            this.init();
        }

        init() {
            // Form Submit
            this.$form.on('submit', (e) => {
                e.preventDefault();
                this.search();
            });

            // Live-Suche
            if (this.settings.liveSearch) {
                this.$input.on('input', () => {
                    clearTimeout(this.debounceTimer);
                    
                    const query = this.$input.val().trim();
                    
                    // Bei leerem Input zurück zu Initial-Produkten
                    if (query.length === 0 && this.isShowingResults) {
                        this.resetToInitial();
                        return;
                    }
                    
                    this.debounceTimer = setTimeout(() => {
                        this.search();
                    }, this.settings.debounce);
                });
            }

            // Enter-Taste
            this.$input.on('keypress', (e) => {
                if (e.which === 13) {
                    e.preventDefault();
                    clearTimeout(this.debounceTimer);
                    this.search();
                }
            });

            // Reset-Button
            this.$resetButton.on('click', () => {
                this.resetToInitial();
            });

            // ESC-Taste zum Zurücksetzen
            this.$input.on('keydown', (e) => {
                if (e.which === 27 && this.isShowingResults) { // ESC
                    this.resetToInitial();
                }
            });
        }

        search() {
            const query = this.$input.val().trim();

            // Validierung
            if (query.length < this.settings.minChars) {
                if (query.length > 0) {
                    this.showStatus(
                        yadoreSearch.i18n.min_chars.replace('%d', this.settings.minChars),
                        'info'
                    );
                } else if (this.isShowingResults) {
                    this.resetToInitial();
                }
                return;
            }

            // Gleiche Suche nicht wiederholen
            if (query === this.lastQuery && this.isShowingResults) {
                return;
            }
            this.lastQuery = query;

            // Vorherige Anfrage abbrechen
            if (this.currentRequest) {
                this.currentRequest.abort();
            }

            this.setLoading(true);
            this.showStatus(yadoreSearch.i18n.searching, 'loading');

            this.currentRequest = $.ajax({
                url: yadoreSearch.ajaxurl,
                type: 'POST',
                data: {
                    action: 'yadore_product_search',
                    nonce: yadoreSearch.nonce,
                    query: query,
                    network: this.settings.network,
                    max_results: this.settings.maxResults,
                    sort: this.settings.sort,
                    merchant_filter: this.settings.merchantFilter,
                    show_price: this.settings.showPrice ? '1' : '0',
                    show_merchant: this.settings.showMerchant ? '1' : '0',
                    new_tab: this.settings.newTab ? '1' : '0',
                },
                success: (response) => {
                    this.setLoading(false);
                    
                    if (response.success && response.data.products.length > 0) {
                        this.renderResults(response.data);
                    } else {
                        this.showStatus(yadoreSearch.i18n.no_results, 'empty');
                        // Initial-Produkte ausblenden, leere Ergebnisse zeigen
                        this.$initialProducts.slideUp(200);
                        this.$results.hide();
                        this.isShowingResults = true;
                    }
                },
                error: (xhr, status) => {
                    this.setLoading(false);
                    
                    if (status !== 'abort') {
                        this.showStatus(yadoreSearch.i18n.error, 'error');
                    }
                }
            });
        }

        setLoading(isLoading) {
            this.$button.prop('disabled', isLoading);
            this.$buttonText.toggle(!isLoading);
            this.$spinner.toggle(isLoading);
            this.$container.toggleClass('yadore-loading', isLoading);
        }

        showStatus(message, type) {
            this.$status
                .removeClass('yadore-status-loading yadore-status-error yadore-status-empty yadore-status-info')
                .addClass('yadore-status-' + type)
                .html(message)
                .show();
        }

        renderResults(data) {
            this.$status.hide();
            this.isShowingResults = true;
            
            // Initial-Produkte ausblenden
            this.$initialProducts.slideUp(200);
            
            // Header aktualisieren
            this.$resultsCount.text(data.total + ' Ergebnis' + (data.total !== 1 ? 'se' : ''));
            this.$resultsQuery.text(yadoreSearch.i18n.results_for + ' "' + data.query + '"');

            // Grid leeren und neu befüllen
            this.$resultsGrid.empty();

            data.products.forEach((product) => {
                this.$resultsGrid.append(this.createProductCard(product));
            });

            // Reset-Button nur anzeigen wenn Initial-Produkte vorhanden
            if (this.settings.hasInitial && this.settings.showReset) {
                this.$resetButton.show();
            }

            this.$results.slideDown(300);

            // Scroll zu Ergebnissen
            const containerTop = this.$container.offset().top;
            if (containerTop < $(window).scrollTop() || containerTop > $(window).scrollTop() + $(window).height()) {
                $('html, body').animate({
                    scrollTop: containerTop - 20
                }, 300);
            }
        }

        resetToInitial() {
            this.lastQuery = '';
            this.isShowingResults = false;
            this.$input.val('');
            this.$status.hide();
            
            // Such-Ergebnisse ausblenden
            this.$results.slideUp(200, () => {
                this.$resultsGrid.empty();
            });
            
            // Initial-Produkte wieder einblenden
            if (this.settings.hasInitial) {
                this.$initialProducts.slideDown(300);
            }

            // Focus zurück auf Input
            this.$input.focus();
        }

        createProductCard(product) {
            const target = product.new_tab ? ' target="_blank" rel="noopener noreferrer"' : '';
            
            let imageHtml = '';
            if (product.image) {
                imageHtml = `
                    <div class="yadore-product-image">
                        <img src="${this.escapeHtml(product.image)}" 
                             alt="${this.escapeHtml(product.title)}" 
                             loading="lazy"
                             onerror="this.parentElement.classList.add('yadore-image-error')">
                    </div>
                `;
            } else {
                imageHtml = `
                    <div class="yadore-product-image yadore-no-image">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                    </div>
                `;
            }

            let merchantHtml = '';
            if (product.merchant) {
                merchantHtml = `<div class="yadore-product-merchant">${this.escapeHtml(product.merchant)}</div>`;
            }

            let priceHtml = '';
            if (product.price) {
                priceHtml = `<div class="yadore-product-price">${this.escapeHtml(product.price)}</div>`;
            }

            // Source Badge
            let sourceBadge = '';
            if (product.source) {
                sourceBadge = `<span class="yadore-product-source yadore-source-${this.escapeHtml(product.source)}"></span>`;
            }

            return `
                <div class="yadore-product-card" data-product-id="${this.escapeHtml(product.id)}">
                    <a href="${this.escapeHtml(product.url)}"${target} class="yadore-product-link">
                        ${sourceBadge}
                        ${imageHtml}
                        <div class="yadore-product-content">
                            <h4 class="yadore-product-title">${this.escapeHtml(product.title)}</h4>
                            ${merchantHtml}
                            ${priceHtml}
                            <span class="yadore-product-cta">${yadoreSearch.i18n.view_offer} →</span>
                        </div>
                    </a>
                </div>
            `;
        }

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // Initialisierung
    $(document).ready(function() {
        $('.yadore-search-container').each(function() {
            new YadoreProductSearch(this);
        });
    });

})(jQuery);
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\docs\openapi.yaml 
 
openapi: 3.0.1
info:
  title: Yadore Publisher API
  version: 2.0.0
  description: |
    This is an overview of all the available API endpoints.
    Each API is grouped and you can unfold the different endpoints to get detailed information on how to use them.
    
    You can use this actionable documentation or an application of your choice (e.g. [Postman](https://www.postman.com/)) to browse the API.

    ## Endpoints
    The API servers are available under the URL: `https://api.yadore.com/`. You must use this URL for all API requests.
    For example to search for offers, you must send your request to `https://api.yadore.com/v2/offer`.
    
    This doesn't concern you when you are using this documentation. You can use the endpoints here by clicking on `Try it out`.

    ## Authentication
    You must add your API-Key as header `API-Key` to all requests in the application of your choice.
    
    For authorizing your requests in this actionable documentation, you must use the `Authorize` button below and enter your API-Key.
    
    ## FAQ
    
    1. What Yadore understands as **offer** – for us an offer is a product offer from a specific merchant, example would be a specific washing machine from e.g. _Mediamarkt.de_.
    
    2. What Yadore understands as **deeplink** – for us a deeplink is a specific product landing page from a merchant, so the deep link request must look like `shopdomain.de/category/specific_product.html`.
    
    3. What Yadore understands as **smartlink** – for us a smartlink merchant is a merchant, where the publisher can send the user anywhere, means home page, category page, product page, etc. However, you must specify exactly where you want to send the user (i.e. homepage, category, ..) as the API will not automatically generate this for you.
    
    4. All monetary values are always in **Euro**.
    
    5. All dates returned from any endpoint are in **UTC time**.
    
    6. All API parameters are **case sensitive**.
    
    7. The estimated CPC in all APIs is 100% Yadore, to calculate your revenue you have to adapt your share.
    
    8. We classify publishers in _“no couponing”_, _“couponing”_ and _“mixed”_. This is important as _“mixed”_ publishers need to use a parameter to inform if a click is couponing or not. If you feel wrongly classified just speak to your account manager.
    
    9. If there are any further questions, please contact your account manager or send an email to [mail@yadore.com](mailto:mail@yadore.com).

servers:
  - url: https://api.yadore.com/

tags:
  - name: Offer
    description: The following endpoints are needed to get product offer results from Yadore.

  - name: Deeplink and Smartlink
    description: The following endpoints are needed to get deeplink and smartlink results from Yadore.

  - name: Direct Redirect
    description: The following endpoint is needed to let Yadore redirect the user for you with a fixed link structure. You tell us where to send the user and we do the rest.

  - name: Report
    description: Use following endpoints to get all the necessary reporting data.

  - name: Conversion
    description: The following endpoints support you to receive useful information about the quality of your traffic.

  - name: Markets
    description: Use the following endpoint to check which markets you are allowed to send traffic to.

paths:
  /v2/offer:
    get:
      tags:
        - Offer
      operationId: getOffer
      summary: Search for offers
      description: |
        You can search for offers here, filter by several parameters and precision types to get your desired results.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Market'
        - $ref: '#/components/parameters/Keyword'
        - $ref: '#/components/parameters/EAN'
        - $ref: '#/components/parameters/MerchantId'
        - $ref: '#/components/parameters/OfferId'
        - $ref: '#/components/parameters/PlacementId'
        - $ref: '#/components/parameters/Precision'
        - $ref: '#/components/parameters/Sort'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/IsCouponing'
      responses:
        "200":
          description: Offer Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferResponse'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferErrorResponse'

  /v2/offer/bulk:
    get:
      tags:
        - Offer
      operationId: getOffersByEan
      summary: Search for offers by multiple EANs
      description: |
        You can search for offers by multiple EANs from a specific market here. 
        For each EAN there will be a limit of 50 offer results.
        Access to this endpoint must be enabled for your account, please contact us.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Market'
        - $ref: '#/components/parameters/EANs'
        - $ref: '#/components/parameters/MerchantId'
        - $ref: '#/components/parameters/PlacementId'
        - $ref: '#/components/parameters/IsCouponing'
      responses:
        "200":
          description: Offer Ean Bulk Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferEanBulkResponse'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferBulkErrorResponse'

  /v2/merchant:
    get:
      tags:
        - Offer
      operationId: getMerchant
      summary: Get a list of active merchants
      description: |
        You can search for active merchants here, use this to filter your offer request by a specific `merchantId`
        or use it just to check which merchants are available.
        
        The merchant availability can change every few minutes.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Market'
        - $ref: '#/components/parameters/IsCouponingMerchantFilter'
      responses:
        "200":
          description: Merchant Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerchantResponse'

  /v2/deeplink:
    post:
      tags:
        - Deeplink and Smartlink
      operationId: postDeeplink
      summary: Get click URLs for given deeplinks and smartlinks
      description: |
        You can search for specific deeplinks here by adding the landing pages or smartlink merchant you want to get a click URL for.
        You can send up to 20 URLs at a time. Replace the `string` with your desired input.
        E.g. `"market": "de"` instead of `"market": "string"`.
        
        The optional parameter `placementId` is your own subID for your click-tracking.
        
        The `isCouponing` parameter is required if your project has mixed traffic. You must use this parameter to define if you are sending couponing traffic.
        
        _Each clickUrl is only valid for 14 days._
      security:
        - ApiKeyAuth: []
      requestBody:
        $ref: '#/components/requestBodies/Deeplink'
      responses:
        "200":
          description: Deeplink Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeeplinkResponse'

  /v2/deeplink/merchant:
    get:
      tags:
        - Deeplink and Smartlink
      operationId: getDeeplinkMerchant
      summary: Get a list of active deeplink merchants
      description: |
        You can search for active deeplink and smartlink merchants here.
        You can specify if you want to get both or just smartlink merchants in the response.
        Smartlink means an advertiser where you can link anywhere, including the homepage, category pages, sales pages etc.
        
        Deeplink and smartlink merchant availability can change every few minutes.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Market'
        - $ref: '#/components/parameters/isSmartlink'
        - $ref: '#/components/parameters/hasHomepage'
        - $ref: '#/components/parameters/IsCouponingMerchantFilter'
      responses:
        "200":
          description: Deeplink Merchant Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeeplinkMerchantResponse'

  /v2/d:
    get:
      tags:
        - Direct Redirect
      operationId: doDirectRedirect
      summary: Direct redirect to the URL set in the "url" parameter
      description: |
        Add the URL you want to redirect the user to, the market and projectId of your API key.
        
        If you execute the request in this documentation, you will get the monetizable Yadore URL under `Responses > Request URL`.
        Be aware that the response of the redirect target cannot be shown under `Responses > Server response` (instead an error will be shown).
        But you can call the request URL in your browser as it will redirect you to the target shop website.
        If you call the request URL in an application like Postman and you want to see the response of the redirect target, the application must be able to follow redirects (check the settings).
        If you get a `404` response status, the API could not find a matching shop to redirect to.
        
        The URL structure is always the same, only change URL or market if you want to redirect elsewhere.
        You don't have to get a link for every advertiser by using this documentation.
        
        We recommend to also set a callback URL, so we can send you the user back, if something is wrong with the link or the advertiser.
        The callback URL needs to be whitelisted before you can use it.
        
        If your project has mixed traffic, you must use the `isCouponing` parameter to define if you are sending couponing traffic.
        
        Only works for deeplink and smartlink merchants (`/v2/deeplink/merchant`).
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/SingleUrl'
        - $ref: '#/components/parameters/CallbackUrl'
        - $ref: '#/components/parameters/Market'
        - $ref: '#/components/parameters/MerchantId'
        - $ref: '#/components/parameters/PlacementId'
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/IsCouponing'
      responses:
        "302":
          description: A redirect to the target shop website.
        "404":
          description: An error occured and there was no callbackUrl.

  /v2/report/status:
    get:
      tags:
        - Report
      operationId: getReportStatus
      summary: Shows you if the reports for a given day are completely available
      description: |
        Very useful to understand if data for a specific day is complete or not. Updates are excluded from this.
        When the reports incomplete, you may only receive partial results for your report and should try again later.
        
        We only allow to pull reports for a specific day, so you can't pull "per month" or similar.
        For this you can use your publisher dashboard. Output can be JSON or CSV.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Date'
      responses:
        "200":
          description: Report Status Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportStatusResponse'

  /v2/report/general:
    get:
      tags:
        - Report
      operationId: getReportGeneral
      summary: Grouped report for clicks and revenue for each market
      description: |
        Shows you accumulated numbers for each market you have sent traffic to.
        
        It is important to use the Report Status endpoint before to check if the data is complete.
        To ensure data accuracy go back three days to pull data, as the revenue can change retrospectively.
        
        We only allow to pull reports for a specific day, so you can't pull "per month" or similar.
        For this you can use your publisher dashboard. Output can be JSON or CSV.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Date'
        - $ref: '#/components/parameters/Format'
      responses:
        "200":
          description: Report General Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportGeneralResponse'
            text/csv:
              schema:
                type: string
                example: |
                  "date","market","clicks","revenue","currency"
                  "2018-01-01","de","1000","100.1234","EUR"
                  "2018-01-01","fr","2000","150.5678","EUR"
                  "2018-01-01","it","1500","125.6542","EUR"

  /v2/report/detail:
    get:
      tags:
        - Report
      operationId: getReportDetail
      summary: Detail report for each click
      description: |
        This endpoint generates a click level report. This helps you to track your traffic as granular as possible.
        Makes the most sense to use a `placementId` for each click, so you can allocate all your traffic properly.
        Otherwise, you will just get our Yadore clickId, which might not be very helpful.
        You must specify the market you want the report from, means if you are sending traffic to multiple markets,
        you must call each market separately.
        
        It is important to use the Report Status endpoint before to check if the data is complete.
        To ensure data accuracy go back three days to pull data, as the revenue can change retrospectively.
        
        We only allow to pull reports for a specific day, so you can't pull "per month" or similar.
        For this you can use your publisher dashboard. Output can be JSON or CSV.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Date'
        - $ref: '#/components/parameters/Format'
        - $ref: '#/components/parameters/ReportMarket'
      responses:
        "200":
          description: Report Detail Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportDetailResponse'
            text/csv:
              schema:
                example: |
                  "clickId","date","placementId","market","merchantId","merchantName","revenue","currency"
                  "532f889fd3ba56f628f3234647d9854650534789938b7fdaafddf1d75081fadc","2018-01-01T00:00:01+00:00","your-custom-placement-id-1","de","583c1b14c50391777b40ee033a04cef033271e35307f7276125b2ba760d4b48e","example.com","0.142898","EUR"
                  "ae7facb00d557e7d92e1d2ee31bc05cc9787bc6802e636ccb284cfbaeb6680b8","2018-01-01T00:00:02+00:00","your-custom-placement-id-2","de","583c1b14c50391777b40ee033a04cef033271e35307f7276125b2ba760d4b48e","example.com","0.142825","EUR"
                  "8bc875e7f5260fa14b21797508b9e47ee2df2c2fe0351b88edded847ee59bb1f","2018-01-01T00:00:03+00:00","your-custom-placement-id-3","de","583c1b14c50391777b40ee033a04cef033271e35307f7276125b2ba760d4b48e","example.com","0.120417","EUR"

  /v2/report/modified:
    get:
      tags:
        - Report
      operationId: getReportModifiedDetail
      summary: Daily based list of report modified dates
      description: |
        Endpoint for the dates of the latest changes of a report on a daily basis.
        All dates returned from this endpoint are in UTC time.
        If no market is specified, data for all available markets will be displayed.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: from
          description: Starting date for which to generate list of modified reports dates. This parameter has to be in format `YYYY-mm-dd`
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: to
          description: Ending date for which to generate list of modified reports dates. This parameter has to be in format `YYYY-mm-dd`
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: market
          description: Market to search. You will receive a list with valid Markets along with your account information and keys.
          in: query
          required: false
          schema:
            type: string
            format: ISO 3166 Alpha-2
      responses:
        "200":
          description: Report Modified Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportModifiedResponse'


  /v2/conversion/status:
    get:
      tags:
        - Conversion
      operationId: getConversionStatus
      summary: Shows you if the conversions for a given day are completely available
      description: |
        Very useful to check if data for a specific day is complete or not. When the conversion reports are incomplete,
        you may get only partial results for your conversion report and should try again later.
        
        We recommend going back two days in the past, as sales will often be reported late.
        Hence, we don’t have all the information the next day.
        The number of clicks can differ from the Report API, because just the tracked clicks are included in the conversion reports.
        Output can be JSON or CSV.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Date'
      responses:
        "200":
          description: Conversion Report Status Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversionStatusResponse'

  /v2/conversion/general:
    get:
      tags:
        - Conversion
      operationId: getConversionGeneral
      summary: Grouped conversion report for clicks and revenue for each market
      description: |
        Choose a start and end date and you will get the accumulated number of clicks and sales for each market you are sending traffic to,
        good for a quick overview on how you perform with your traffic.
        
        We recommend going back two days in the past, as sales will often be reported late.
        Hence, we don’t have all the information the next day.
        The number of clicks can differ from the Report API, because just the tracked clicks are included in the conversion reports.
        Output can be JSON or CSV.
      security:
        - ApiKeyAuth: [ ]
      parameters:
        - name: from
          description: Starting date for which to generate the report. This parameter has to be in format `YYYY-mm-dd`
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: to
          description: Ending date for which to generate the report. This parameter has to be in format `YYYY-mm-dd`
          in: query
          required: true
          schema:
            type: string
            format: date
        - $ref: '#/components/parameters/Format'
      responses:
        "200":
          description: Report General Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversionGeneralResponse'
            text/csv:
              schema:
                example: |
                  "market","sales"
                  "de","432"
                  "br","23"

  /v2/conversion/detail:
    get:
      tags:
        - Conversion
      operationId: getConversionDetail
      summary: Conversion report for each click
      description: |
        Similar to the Detail Report, but you can just check one day at a time and must specify a market.
        You get a report for every trackable click that got paid.
        
        We recommend going back two days in the past, as sales will often be reported late.
        Hence, we don’t have all the information the next day.
        The number of clicks can differ from the Report API, because just the tracked clicks are included in the conversion reports.
        Output can be JSON or CSV.
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Date'
        - $ref: '#/components/parameters/Format'
        - $ref: '#/components/parameters/ReportMarket'
      responses:
        "200":
          description: Report Detail Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversionDetailResponse'
            text/csv:
              schema:
                example: |
                  "clickId","date","placementId","market","merchantId","merchantName","sales"
                  "0003a6ba2712bf1eb0bbd1f67846bf70483989b14e9bfe3dfc96596e880d24ec","2022-08-28T11:12:33+00:00","cc3a69ebe06e41ec91c4c60e6de59b604682ca5489464a0ca00ab919497ce8ad","de","ec8408fbcc2f7523b596dec3e9462b50c4511d381780a7c0511e0e603a0c4327","sanicare.de","0"
                  "00193d37300edc9eee8abe91912a214bc5ba5123e17d65ed5ae28c3810cc47ce","2022-08-28T15:56:32+00:00","preisvergleich-de-o-wl","de","ec8408fbcc2f7523b596dec3e9462b50c4511d381780a7c0511e0e603a0c4327","sanicare.de","0"
                  "00358068c1e0a8372cd48445b47652e457b658f22050e5b9b2830b919a569636","2022-08-28T12:24:54+00:00","v03040001006029c697c39f3a4a2c8f3b3c277ed44467","de", "218a1593ddb9bec9b5566a97efd5d9bf98f9eb10781d5aed06f4ebb1749f2ee9","aboutyou.de","0"

  /v2/conversion/detail/merchant:
    get:
      tags:
        - Conversion
      operationId: getConversionDetailMerchant
      summary: Detailed conversion report grouped by merchant
      description: |
        Set a start and end date and specify the market and you will get an overview of the quality by merchant.
        
        We recommend going back two days in the past, as sales will often be reported late.
        Hence, we don’t have all the information the next day.
        The number of clicks can differ from the Report API, because just the tracked clicks are included in the conversion reports.
        Output can be JSON or CSV.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: market
          description: Market to search. You will receive a list with valid Markets along with your account information and keys.
          in: query
          required: false
          schema:
            type: string
            format: ISO 3166 Alpha-2
        - name: from
          description: Starting date for which to generate the report. This parameter has to be in format `YYYY-mm-dd`
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: to
          description: Ending date for which to generate the report. This parameter has to be in format `YYYY-mm-dd`
          in: query
          required: true
          schema:
            type: string
            format: date
        - $ref: '#/components/parameters/Format'
      responses:
        "200":
          description: Conversion Detail Merchant Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversionDetailMerchantResponse'
            text/csv:
              schema:
                example: |
                  merchant_id,merchant_name,sales
                  0000111122223333444455556666777788889999aaaabbbbccccddddeeeeffff,example.com,1337
                  1000111122223333444455556666777788889999aaaabbbbccccddddeeeeffff,example.com,163

  /v2/markets:
    get:
      tags:
        - Markets
      operationId: getMarketsList
      summary: List markets you are allowed to send traffic to
      description: |
        Find out which markets you are approved for, if any market is missing, just ask your account manager if they can activate that market.
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Market List Response
          content:
            application/json:
              schema:
                type: object
                properties:
                  markets:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string

components:
  parameters:
    Market:
      name: market
      description: Market to search. You can get the markets you are activated for with the Markets API.
      in: query
      required: true
      schema:
        type: string

    ReportMarket:
      name: market
      description: Market to search. You can get the markets you are activated for with the Markets API.
      in: query
      required: false
      schema:
        type: string

    ProjectId:
      name: projectId
      description: Your project ID, ask your account manager for your specific project ID.
      in: query
      required: true
      schema:
        type: string

    isSmartlink:
      name: isSmartlink
      description: Set to 1 to limit results to smartlink merchants only. If omitted, you will get results for all merchants.
      in: query
      required: false
      schema:
        type: string

    hasHomepage:
      name: hasHomepage
      description: Set to 1 to limit results to homepage merchants only. If omitted, you will get results for all merchants.
      in: query
      required: false
      schema:
        type: string

    CombinationId:
      name: cmb
      description: Combination ID as given in the `GET /v2/offer` response.
      in: query
      required: true
      schema:
        type: string

    RedirectOfferId:
      name: offerId
      description: Offer ID as given in the `GET /v2/offer` response.
      in: query
      required: true
      schema:
        type: string

    RoutingId:
      name: routingId
      description: All links will be valid without this parameter for backwards compatibility. Althought we encourage you to use the link given in the `GET /v2/offer` response where this parameter has been added. This parameter will be marked as required in future versions.
      in: query
      required: false
      schema:
        type: string

    PlacementId:
      name: placementId
      description: Your own subID for your click-tracking. Must be at most 128 characters long. Only printable ASCII-characters are allowed. Defaults to `null`.
      in: query
      required: false
      schema:
        type: string

    Date:
      name: date
      description: Date for which to generate a report. This date is in the UTC timezone. This parameter has to be in format `YYYY-mm-dd`, for example `2018-01-31`.
      in: query
      required: true
      schema:
        type: string
        format: date

    Format:
      name: format
      description: A format to generate the reports. Available formats are `json` and `csv`.
      in: query
      required: true
      schema:
        type: string
        enum:
          - json
          - csv

    MerchantId:
      name: merchantId
      description: Merchant ID to filter the offers. You can use this parameter to narrow the results. If omitted, you will get offers for all merchants.
      in: query
      required: false
      schema:
        type: string

    Keyword:
      name: keyword
      description: Keyword to search. Must be at least one character long.
      in: query
      required: false
      schema:
        type: string

    EAN:
      name: ean
      description: Filter the results by this EAN. Must be `8`, `13` or `14` characters long. When omitted, you will get offers regardless of an ean.
      in: query
      required: false
      schema:
        type: string

    EANs:
      name: eans
      description: The EANs to search (max. 50). Must be an comma seperated list of valid EANs. Each EAN must be `8`, `13` or `14` characters long.
      in: query
      required: true
      schema:
        type: string
        example: '12345678,87654321'

    OfferId:
      name: offerId
      description: Offer ID to filter the offers. If set you will only get this one offer, if it is found and active.
      in: query
      required: false
      schema:
        type: string

    Sort:
      name: sort
      description: Sort the results by relevance or price. Allowed values are `rel_desc`, `price_asc`, `price_desc`. Defaults to `rel_desc`. It is only possible to sort the results by relevance if you also specify a keyword. Without the keyword, the sort order is undefined.
      in: query
      required: false
      schema:
        type: string
        enum:
          - rel_desc
          - price_asc
          - price_desc
        default: rel_desc

    Limit:
      name: limit
      description: Limit of results, must be between `1` and `100`. Defaults to `20`.
      in: query
      required: false
      schema:
        type: integer

    Precision:
      name: precision
      description: Precision for the fulltext search. `strict` uses a more strict approach to get more relevant results. `fuzzy` uses a less strict approach to get more results.
      in: query
      required: false
      schema:
        type: string
        enum:
          - strict
          - fuzzy
        default: fuzzy

    SingleUrl:
      name: url
      description: URL of shop to redirect to. Please copy & paste the URL in this field exactly how it is displayed in the browser.
      in: query
      required: true
      schema:
        type: string

    CallbackUrl:
      name: callbackUrl
      description: The URL to where requests with errors will be redirected to. The callbackUrl has to be whitelisted. If you want to use a callbackUrl please send your URL to your Yadore contact. Omitting this parameter will result in a 404 for results with errors.
      in: query
      required: false
      schema:
        type: string

    IsCouponing:
      name: isCouponing
      description: >
        If your project has in parts couponing traffic, you must use this parameter to tell the API if the click is a couponing click or not. If you don’t use this parameter when your project is labeled _“mixed”_ your traffic will not get paid. If you want to find out the label, please ask your account manager.
        You only must use this parameter if you have mixed traffic. If you have either couponing or no couponing traffic, this parameter is not important for you.
      in: query
      required: false
      schema:
        type: boolean

    IsCouponingMerchantFilter:
        name: isCouponing
        description: If your project has mixed traffic, you can filter the merchants by using this parameter.
        in: query
        required: false
        schema:
            type: boolean

  requestBodies:

    Deeplink:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Deeplink'

  schemas:
    # Common Values
    Date:
      type: string
      format: date

    DateRange:
      type: object
      properties:
        from:
          $ref: '#/components/schemas/Date'
        to:
          $ref: '#/components/schemas/Date'

    Currency:
      type: string
      format: ISO 4217
      pattern: '[A-Z]{3}'
      example: 'EUR'
      description: Three character form of a currency, in all caps

    Market:
      type: string
      format: ISO 3166 Alpha-2
      pattern: '[A-Z]{2}'
      example: 'de'
      description: Two character form of a country, in all lower-case

    MerchantId:
      type: string
      minLength: 64
      maxLength: 64
      pattern: '[a-z0-9]{64}'
      description: 64 characters, hexadecimal
      example: '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef'

    Merchant:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/MerchantId'
        name:
          type: string
          example: example.com

    Offer:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        promoText:
          type: string
          nullable: true
        brand:
          type: string
          nullable: true
        clickUrl:
          type: string
        availability:
          type: string
          enum:
            - AVAILABLE
            - UNAVAILABLE
            - UNKNOWN
            - SOON
            - PREORDER
            - AVAILABLE ON ORDER
            - STOCK ON ORDER
            - BACKORDER
        eer:
          type: string
          nullable: true
        shippingTime:
          type: object
          properties:
            text:
              type: string
        merchant:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            logo:
              type: object
              properties:
                url:
                  type: string
                exists:
                  type: boolean
        price:
          type: object
          properties:
            amount:
              type: string
            currency:
              type: string
        originalPrice:
          type: object
          properties:
            amount:
              type: string
            currency:
              type: string
        shippingPrice:
          type: object
          properties:
            amount:
              type: string
            currency:
              type: string
        estimatedCpc:
          description: |
            estimatedCPC means the gross revenue per click Yadore gets from its merchants,
            you have to use your revenue share to get your estimatedCPC.
            Be aware, the CPC paid can still differ from the estimated CPC
          type: object
          properties:
            amount:
              type: string
            currency:
              type: string
        unitPrice:
          type: object
          properties:
            text:
              type: string
              nullable: true
        image:
          type: object
          properties:
            url:
              type: string
        thumbnail:
          type: object
          properties:
            url:
              type: string

    #    CostOfSale:
    #      type: string
    #      format: number
    #      example: '0.001234567890'
    #      description: Cost of Sale. Given as a relative value (1.0 ≙ 100%)

    Deeplink:
      type: object
      properties:
        market:
          description: The market to query.
          required: true
          type: string
        placementId:
          description: Your own subID for your click-tracking. Must be at most 128 characters long. Only printable ASCII-characters are allowed. Defaults to null.
          required: false
          type: string
        isCouponing:
          name: isCouponing
          description: >
            If your project has in parts couponing traffic, you must use this parameter to tell the API if the click is a couponing click or not. If you don’t use this parameter when your project is labeled _“mixed”_ your traffic will not get paid. If you want to find out the label, please ask your account manager.
            You only must use this parameter if you have mixed traffic. If you have either couponing or no couponing traffic, this parameter is not important for you.
          required: false
          type: boolean
        urls:
          description: An array of URLs
          required: true
          type: array
          items:
            type: object
            properties:
              url:
                type: string

    # Responses
    DeeplinkResponse:
      type: object
      properties:
        result:
          type: object
          properties:
            found:
              type: integer
            total:
              type: integer
            deeplinks:
              type: array
              items:
                type: object
                properties:
                  url:
                    type: string
                  found:
                    type: boolean
                  clickUrl:
                    type: string
                    nullable: true
                    description: The clickUrl is only valid for 14 days.
                  merchant:
                    type: object
                    nullable: true
                    properties:
                      logo:
                        type: object
                        properties:
                          url:
                            type: string
                          exists:
                            type: boolean
                  estimatedCpc:
                    type: object
                    properties:
                      amount:
                        type: string
                        nullable: true
                      currency:
                        type: string
                        nullable: true

    MerchantResponse:
      type: object
      properties:
        total:
          type: integer
        merchants:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              offerCount:
                type: integer
              logo:
                type: object
                properties:
                  url:
                    type: string
                  exists:
                    type: boolean
              trafficTypes:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    permission:
                      type: string
                      enum:
                        - not_allowed
                        - allowed

    DeeplinkMerchantResponse:
      type: object
      properties:
        total:
          type: integer
        merchants:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              isSmartlink:
                type: boolean
                description: If the merchant has one or more smartlinks.
              hasSmartlinkHomepage:
                type: boolean
                description: If the merchant accept homepage smartlinks.
              hasExternalHomepage:
                type: boolean
                description: If the merchant accept homepage deeplinks.
              deeplinkCount:
                type: integer
                description: Even when a merchant has no deeplinks, it might still have smartlinks.
              logo:
                type: object
                properties:
                  url:
                    type: string
                  exists:
                    type: boolean
              estimatedCpc:
                type: object
                properties:
                  amount:
                    type: string
                    nullable: true
                  currency:
                    type: string
                    nullable: true
              trafficTypes:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    permission:
                      type: string
                      enum:
                        - not_allowed
                        - allowed

    OfferErrorResponse:
      type: object
      properties:
        errors:
          type: object
          properties:
            isCouponing:
              $ref: '#/components/schemas/isCouponingError'
            market:
              $ref: '#/components/schemas/marketError'

    OfferBulkErrorResponse:
      type: object
      properties:
        errors:
          type: object
          properties:
            isCouponing:
              $ref: '#/components/schemas/isCouponingError'
            market:
              $ref: '#/components/schemas/marketError'
            ean:
              $ref: '#/components/schemas/eanError'

    eanError:
        type: array
        items:
          oneOf:
            - type: string
              example: "EAN list cant be empty"
            - type: string
              example: "Cant request offers for more then 50 EANs at once"

    marketError:
      type: array
      items:
        oneOf:
          - type: string
            example: "Field is required"
          - type: string
            example: "Market 'xy' not found"

    isCouponingError:
      type: array
      items:
        oneOf:
          - type: string
            example: "Field is required when mixed traffic is allowed"
          - type: string
            example: "Field must be a boolean"

    OfferResponse:
      type: object
      properties:
        count:
          type: integer
        total:
          type: integer
        offers:
          type: array
          items:
            $ref: '#/components/schemas/Offer'

    OfferEanBulkResponse:
      type: object
      properties:
        ean:
          type: object
          properties:
            count:
              type: integer
            offers:
              type: array
              items:
                $ref: '#/components/schemas/Offer'

    ReportStatusResponse:
      type: object
      properties:
        status:
          type: string
          enum:
            - complete
            - incomplete

    ConversionStatusResponse:
      type: object
      properties:
        status:
          type: string
          enum:
            - complete
            - incomplete

    ReportGeneralResponse:
      type: object
      properties:
        date:
          type: object
          properties:
            from:
              type: string
            to:
              type: string
        total:
          type: object
          properties:
            clicks:
              type: integer
            revenue:
              type: integer
            currency:
              type: string
        market:
          type: object
          properties:
            de:
              type: object
              properties:
                total:
                  type: object
                  properties:
                    clicks:
                      type: integer
                    revenue:
                      type: number
                      example: 0
                    currency:
                      type: string

    ReportDetailResponse:
      type: object
      properties:
        totalClicks:
          type: integer
        clicks:
          type: array
          items:
            type: object
            properties:
              clickId:
                type: string
              date:
                type: string
                format: date-time
              placementId:
                type: string
              market:
                type: string
              merchant:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
              revenue:
                type: number
              currency:
                type: string
                example: EUR

    ReportModifiedResponse:
      type: object
      properties:
        market:
          type: object
          properties:
            date:
              type: string
              format: date
            modifiedDate:
              type: string
              format: date-time

    ConversionDetailResponse:
      type: object
      properties:
        totalClicks:
          type: integer
        clicks:
          type: array
          items:
            type: object
            properties:
              clickId:
                type: string
              date:
                type: string
                format: date-time
              placementId:
                type: string
              market:
                type: string
              merchant:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
              sales:
                type: number
                example: 42
    #              shoppingCart:
    #                type: number
    #                example: 4.20
    #              cos:
    #                $ref: '#/components/schemas/CostOfSale'

    ConversionDetailMerchantResponse:
      type: object
      properties:
        date:
          $ref: '#/components/schemas/DateRange'
        total:
          type: object
          properties:
            sales:
              type: integer
              example: 42
            #            shoppingCart:
            #              type: number
            #              example: 4.20
            #            cos:
            #              $ref: '#/components/schemas/CostOfSale'
            clicks:
              type: integer
              example: 16
        salesByMerchant:
          type: array
          minItems: 0
          items:
            type: object
            properties:
              market:
                $ref: '#/components/schemas/Market'
              merchant:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
              sales:
                type: integer
                example: 42
              #              shoppingCart:
              #                type: number
              #                example: 4.20
              #                description: The worth of the purchase
              #              cos:
              #                $ref: '#/components/schemas/CostOfSale'
              clicks:
                type: integer
                example: 16

    ConversionGeneralResponse:
      type: object
      properties:
        date:
          $ref: '#/components/schemas/DateRange'
        total:
          type: object
          properties:
            sales:
              type: integer
              example: '42'
            clickCount:
              type: integer
              example: '123'
        #            shoppingCart:
        #              type: number
        #              example: 4.20
        #              description: The worth of the purchase
        #            cos:
        #              type: string
        #              format: number
        #              example: '0.000001203940'
        #              description: Cost of Sale
        market:
          type: object
          properties:
            de:
              type: object
              properties:
                total:
                  type: object
                  properties:
                    sales:
                      type: integer
                      example: '42'
                    clickCount:
                      type: integer
                      example: '123'
            #                    shoppingCart:
            #                      type: number
            #                      example: 4.20
            #                      description: The worth of the purchase
            ch:
              type: object
              properties:
                total:
                  type: object
                  properties:
                    sales:
                      type: integer
                      example: '42'
                    clickCount:
                      type: integer
                      example: '123'
  #                    shoppingCart:
  #                      type: number
  #                      example: 4.20
  #                      description: The worth of the purchase

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: API-Key
      description: Your project's API-Key.
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-admin.php 
 
<?php
/**
 * Admin Coordinator Class
 * Koordiniert alle Admin-Submodule
 * PHP 8.3+ compatible
 * Version: 1.4.1
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin {
    
    private YAA_Cache_Handler $cache;
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    
    // Submodule
    private ?YAA_Admin_Settings $settings = null;
    private ?YAA_Admin_Ajax $ajax = null;
    private ?YAA_Admin_Status $status = null;
    private ?YAA_Admin_Docs $docs = null;
    private ?YAA_Admin_Merchants $merchants = null;
    private ?YAA_Admin_Revenue $revenue = null;
    
    public function __construct(
        YAA_Cache_Handler $cache, 
        YAA_Yadore_API $yadore_api, 
        YAA_Amazon_PAAPI $amazon_api
    ) {
        $this->cache = $cache;
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        
        // Submodule initialisieren
        $this->init_submodules();
        
        // Hooks registrieren
        add_action('admin_menu', [$this, 'add_menu']);
        add_action('admin_init', [$this, 'register_settings']);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_assets']);
        add_action('admin_bar_menu', [$this, 'add_admin_bar_button'], 100);
        add_action('admin_post_yaa_clear_cache', [$this, 'handle_clear_cache']);
        add_action('admin_post_yaa_clear_images', [$this, 'handle_clear_images']);
        add_action('admin_notices', [$this, 'admin_notices']);
        add_action('wp_dashboard_setup', [$this, 'add_dashboard_widget']);
    }
    
    /**
     * Initialisiert alle Admin-Submodule
     */
    private function init_submodules(): void {
        // Settings-Modul
        $this->settings = new YAA_Admin_Settings($this->yadore_api, $this->amazon_api, $this->cache);
        
        // AJAX-Modul
        $this->ajax = new YAA_Admin_Ajax($this->cache, $this->yadore_api, $this->amazon_api);
        
        // Status-Modul
        $this->status = new YAA_Admin_Status($this->cache, $this->yadore_api, $this->amazon_api);
        
        // Dokumentation-Modul
        $this->docs = new YAA_Admin_Docs();
        
        // Händler-Modul
        $this->merchants = new YAA_Admin_Merchants($this->yadore_api, $this->cache);
        
        // NEU: Revenue-Kalkulator
        $this->revenue = new YAA_Admin_Revenue($this->yadore_api, $this->cache);
    }
    
    /**
     * Getter für Submodule (falls extern benötigt)
     */
    public function get_settings(): YAA_Admin_Settings {
        return $this->settings;
    }
    
    public function get_ajax(): YAA_Admin_Ajax {
        return $this->ajax;
    }
    
    public function get_status(): YAA_Admin_Status {
        return $this->status;
    }
    
    public function get_merchants(): YAA_Admin_Merchants {
        return $this->merchants;
    }
    
    public function get_revenue(): YAA_Admin_Revenue {
        return $this->revenue;
    }
    
    /**
     * Admin-Menü hinzufügen
     */
    public function add_menu(): void {
        // Hauptmenü
        add_menu_page(
            __('Yadore-Amazon-API', 'yadore-amazon-api'),
            __('Yadore-Amazon', 'yadore-amazon-api'),
            'manage_options',
            'yaa-settings',
            [$this->settings, 'render_page'],
            'dashicons-cart',
            30
        );
        
        // Untermenü: Einstellungen
        add_submenu_page(
            'yaa-settings',
            __('Einstellungen', 'yadore-amazon-api'),
            __('Einstellungen', 'yadore-amazon-api'),
            'manage_options',
            'yaa-settings',
            [$this->settings, 'render_page']
        );
        
        // Untermenü: Revenue-Kalkulator (NEU)
        add_submenu_page(
            'yaa-settings',
            __('Revenue-Kalkulator', 'yadore-amazon-api'),
            __('💰 Revenue-Kalkulator', 'yadore-amazon-api'),
            'manage_options',
            'yaa-revenue',
            [$this->revenue, 'render_page']
        );
        
        // Untermenü: Händlerübersicht
        add_submenu_page(
            'yaa-settings',
            __('Händlerübersicht', 'yadore-amazon-api'),
            __('🏪 Händler', 'yadore-amazon-api'),
            'manage_options',
            'yaa-merchants',
            [$this->merchants, 'render_page']
        );
        
        // Untermenü: Cache & Status
        add_submenu_page(
            'yaa-settings',
            __('Cache & Status', 'yadore-amazon-api'),
            __('Cache & Status', 'yadore-amazon-api'),
            'manage_options',
            'yaa-status',
            [$this->status, 'render_page']
        );
        
        // Untermenü: Dokumentation
        add_submenu_page(
            'yaa-settings',
            __('Dokumentation', 'yadore-amazon-api'),
            __('Dokumentation', 'yadore-amazon-api'),
            'manage_options',
            'yaa-docs',
            [$this->docs, 'render_page']
        );
    }
    
    /**
     * Settings registrieren
     */
    public function register_settings(): void {
        register_setting('yaa_settings', 'yaa_settings', [
            'type'              => 'array',
            'sanitize_callback' => [$this->settings, 'sanitize_settings'],
        ]);
    }
    
    /**
     * Admin Assets laden
     */
    public function enqueue_admin_assets(string $hook): void {
        // Prüfen ob dies eine YAA Admin-Seite ist
        $is_yaa_page = str_contains($hook, 'yaa-') 
                    || str_contains($hook, 'yaa_') 
                    || $hook === 'toplevel_page_yaa-settings';
        
        if (!$is_yaa_page) {
            return;
        }
        
        // Admin CSS
        wp_register_style('yaa-admin', false, [], YAA_VERSION);
        wp_enqueue_style('yaa-admin');
        wp_add_inline_style('yaa-admin', $this->get_admin_css());
        
        // Tab-JavaScript (unabhängig)
        wp_register_script('yaa-admin-tabs', false, ['jquery'], YAA_VERSION, true);
        wp_enqueue_script('yaa-admin-tabs');
        wp_add_inline_script('yaa-admin-tabs', $this->get_tab_js());
        
        // AJAX Localization
        wp_localize_script('yaa-admin-tabs', 'yaaAdmin', [
            'nonce'   => wp_create_nonce('yaa_admin_nonce'),
            'ajaxurl' => admin_url('admin-ajax.php'),
        ]);
        
        // Color Picker auf Settings-Seite
        if ($hook === 'toplevel_page_yaa-settings' || str_ends_with($hook, '_page_yaa-settings')) {
            wp_enqueue_style('wp-color-picker');
            wp_enqueue_script('wp-color-picker');
            
            wp_register_script('yaa-admin-extended', false, ['jquery', 'wp-color-picker', 'yaa-admin-tabs'], YAA_VERSION, true);
            wp_enqueue_script('yaa-admin-extended');
            wp_add_inline_script('yaa-admin-extended', $this->get_extended_admin_js());
        }
        
        // Händler-Seite spezifisches JS
        if (str_ends_with($hook, '_page_yaa-merchants')) {
            wp_register_script('yaa-admin-merchants', false, ['jquery', 'yaa-admin-tabs'], YAA_VERSION, true);
            wp_enqueue_script('yaa-admin-merchants');
            wp_add_inline_script('yaa-admin-merchants', $this->merchants->get_page_js());
        }
        
        // NEU: Revenue-Kalkulator JS
        if (str_ends_with($hook, '_page_yaa-revenue')) {
            wp_register_script('yaa-admin-revenue', false, ['jquery', 'yaa-admin-tabs'], YAA_VERSION, true);
            wp_enqueue_script('yaa-admin-revenue');
            wp_add_inline_script('yaa-admin-revenue', $this->revenue->get_page_js());
        }
    }
    
    /**
     * Admin Bar Button
     */
    public function add_admin_bar_button(\WP_Admin_Bar $admin_bar): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $admin_bar->add_menu([
            'id'    => 'yaa-clear-cache',
            'title' => '🗑️ YAA Cache leeren',
            'href'  => wp_nonce_url(admin_url('admin-post.php?action=yaa_clear_cache'), 'yaa_clear_cache_nonce'),
        ]);
    }
    
    /**
     * Cache leeren Handler
     */
    public function handle_clear_cache(): void {
        if (!current_user_can('manage_options')) {
            wp_die(__('Keine Berechtigung', 'yadore-amazon-api'));
        }
        
        $nonce = $_GET['_wpnonce'] ?? '';
        if (!wp_verify_nonce($nonce, 'yaa_clear_cache_nonce')) {
            wp_die(__('Sicherheitscheck fehlgeschlagen', 'yadore-amazon-api'));
        }
        
        $this->cache->clear_all();
        
        set_transient('yaa_admin_notice', [
            'type'    => 'success', 
            'message' => __('Cache erfolgreich geleert!', 'yadore-amazon-api'),
        ], 30);
        
        $redirect = wp_get_referer() ?: admin_url('admin.php?page=yaa-status');
        wp_safe_redirect($redirect);
        exit;
    }
    
    /**
     * Bilder löschen Handler
     */
    public function handle_clear_images(): void {
        if (!current_user_can('manage_options')) {
            wp_die(__('Keine Berechtigung', 'yadore-amazon-api'));
        }
        
        $nonce = $_GET['_wpnonce'] ?? '';
        if (!wp_verify_nonce($nonce, 'yaa_clear_images_nonce')) {
            wp_die(__('Sicherheitscheck fehlgeschlagen', 'yadore-amazon-api'));
        }
        
        $upload_dir = wp_upload_dir();
        $image_dir = $upload_dir['basedir'] . '/yadore-amazon-api';
        
        $deleted_count = 0;
        
        if (is_dir($image_dir)) {
            $files = glob($image_dir . '/*');
            if ($files !== false) {
                foreach ($files as $file) {
                    if (is_file($file)) {
                        if (unlink($file)) {
                            $deleted_count++;
                        }
                    }
                }
            }
        }
        
        set_transient('yaa_admin_notice', [
            'type'    => 'success', 
            'message' => sprintf(__('%d Bilder erfolgreich gelöscht!', 'yadore-amazon-api'), $deleted_count),
        ], 30);
        
        $redirect = wp_get_referer() ?: admin_url('admin.php?page=yaa-status');
        wp_safe_redirect($redirect);
        exit;
    }
    
    /**
     * Admin Notices
     */
    public function admin_notices(): void {
        $notice = get_transient('yaa_admin_notice');
        
        if ($notice !== false && is_array($notice)) {
            delete_transient('yaa_admin_notice');
            $type = ($notice['type'] ?? '') === 'success' ? 'success' : 'error';
            $message = $notice['message'] ?? '';
            
            echo '<div class="notice notice-' . esc_attr($type) . ' is-dismissible">';
            echo '<p><strong>Yadore-Amazon-API:</strong> ' . esc_html($message) . '</p>';
            echo '</div>';
        }
    }
    
    /**
     * Dashboard Widget hinzufügen
     */
    public function add_dashboard_widget(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        wp_add_dashboard_widget(
            'yaa_status_widget',
            '📦 Yadore-Amazon-API Status',
            [$this->status, 'render_dashboard_widget']
        );
    }
    
    /**
     * Admin CSS
     */
    private function get_admin_css(): string {
        return '
            .yaa-admin-wrap { max-width: 1200px; }
            .yaa-card { background: #fff; border: 1px solid #ccd0d4; border-radius: 4px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 1px rgba(0,0,0,.04); }
            .yaa-card h2 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
            .yaa-card h3 { margin-top: 20px; color: #1d2327; }
            .yaa-card h4 { margin: 15px 0 10px; color: #50575e; }
            .yaa-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
            .yaa-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .yaa-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
            .yaa-status-badge { display: inline-block; padding: 4px 10px; border-radius: 3px; font-size: 12px; font-weight: 600; }
            .yaa-status-success { background: #d4edda; color: #155724; }
            .yaa-status-warning { background: #fff3cd; color: #856404; }
            .yaa-status-error { background: #f8d7da; color: #721c24; }
            .yaa-status-info { background: #cce5ff; color: #004085; }
            .yaa-tabs { display: flex; flex-wrap: wrap; gap: 0; margin-bottom: 0; border-bottom: 1px solid #ccd0d4; background: #f6f7f7; }
            .yaa-tab { padding: 12px 20px; background: transparent; border: 1px solid transparent; border-bottom: none; cursor: pointer; margin-bottom: -1px; transition: all 0.2s; font-weight: 500; }
            .yaa-tab:hover { background: #fff; }
            .yaa-tab.active { background: #fff; border-color: #ccd0d4; border-bottom-color: #fff; font-weight: 600; }
            .yaa-tab-content { display: none; padding-top: 20px; }
            .yaa-tab-content.active { display: block; }
            .yaa-form-row { margin-bottom: 20px; }
            .yaa-form-row label { display: block; font-weight: 600; margin-bottom: 5px; color: #1d2327; }
            .yaa-form-row label.inline { display: inline; font-weight: normal; }
            .yaa-form-row input[type="text"],
            .yaa-form-row input[type="password"],
            .yaa-form-row input[type="number"],
            .yaa-form-row input[type="url"],
            .yaa-form-row select,
            .yaa-form-row textarea { width: 100%; max-width: 400px; padding: 8px 10px; border: 1px solid #8c8f94; border-radius: 4px; }
            .yaa-form-row textarea { min-height: 80px; max-width: 600px; }
            .yaa-form-row .description { color: #646970; font-size: 13px; margin-top: 6px; line-height: 1.5; }
            .yaa-form-row .description code { background: #f0f0f1; padding: 2px 6px; border-radius: 3px; }
            .yaa-shortcode-box { background: #f6f7f7; padding: 12px 15px; border-radius: 4px; font-family: Consolas, Monaco, monospace; font-size: 13px; margin: 10px 0; overflow-x: auto; border: 1px solid #dcdcde; }
            .yaa-test-result { margin-top: 10px; padding: 12px; border-radius: 4px; display: none; }
            .yaa-marketplace-info { background: #f0f6fc; border: 1px solid #c8d9e8; border-radius: 4px; padding: 15px; margin-top: 15px; }
            .yaa-marketplace-info h4 { margin: 0 0 10px 0; color: #1d2327; }
            .yaa-marketplace-info table { margin-top: 10px; }
            .yaa-preview-box { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-top: 15px; }
            .yaa-preview-item { display: inline-block; padding: 15px 20px; margin: 5px; border-radius: 8px; text-align: center; }
            .yaa-code-block { background: #23282d; color: #fff; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; line-height: 1.6; }
            .yaa-code-block code { color: #98c379; }
            .yaa-tip { background: #fff8e5; border-left: 4px solid #ffb900; padding: 12px 15px; margin: 15px 0; }
            .yaa-tip strong { color: #826200; }
            .yaa-columns-2 { column-count: 2; column-gap: 30px; }
            .yaa-columns-3 { column-count: 3; column-gap: 20px; }
            .yaa-feature-box { background: #f0faf0; border: 1px solid #c3e6c3; border-radius: 4px; padding: 15px; margin: 15px 0; }
            .yaa-feature-box.warning { background: #fff8e5; border-color: #ffcc00; }
            .yaa-feature-box.info { background: #f0f6fc; border-color: #c8d9e8; }
            .yaa-stat-box { background: #f6f7f7; padding: 15px; border-radius: 8px; text-align: center; }
            .yaa-stat-number { font-size: 2rem; font-weight: 700; line-height: 1.2; }
            .yaa-stat-label { color: #50575e; font-size: 13px; margin-top: 5px; }
            .yaa-merchant-select { width: 100%; max-width: 400px; min-height: 100px; }
            .yaa-seo-example { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 4px; padding: 10px 15px; margin-top: 10px; font-family: monospace; font-size: 12px; }
            
            /* Merchant Table Styles */
            .yaa-merchant-table { width: 100%; border-collapse: collapse; }
            .yaa-merchant-table th { background: #f6f7f7; text-align: left; padding: 12px; border-bottom: 2px solid #ccd0d4; }
            .yaa-merchant-table td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
            .yaa-merchant-table tr:hover { background: #f9f9f9; }
            .yaa-merchant-logo { width: 40px; height: 40px; object-fit: contain; border-radius: 4px; }
            .yaa-filter-bar { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f6f7f7; border-radius: 4px; }
            .yaa-filter-bar input, .yaa-filter-bar select { padding: 8px 12px; border: 1px solid #ccd0d4; border-radius: 4px; }
            .yaa-pagination { display: flex; gap: 5px; margin-top: 20px; justify-content: center; }
            .yaa-pagination a, .yaa-pagination span { padding: 8px 12px; border: 1px solid #ccd0d4; border-radius: 4px; text-decoration: none; }
            .yaa-pagination a:hover { background: #f0f0f1; }
            .yaa-pagination .current { background: #2271b1; color: #fff; border-color: #2271b1; }
            
            @media (max-width: 782px) { 
                .yaa-grid { grid-template-columns: 1fr; }
                .yaa-grid-3, .yaa-grid-4 { grid-template-columns: 1fr; }
                .yaa-columns-2, .yaa-columns-3 { column-count: 1; }
                .yaa-filter-bar { flex-direction: column; align-items: stretch; }
            }
        ';
    }
    
    /**
     * Tab JavaScript
     */
    private function get_tab_js(): string {
        return '
            jQuery(document).ready(function($) {
                $(".yaa-tab").on("click", function() {
                    var tab = $(this).data("tab");
                    if (!tab) return;
                    
                    $(".yaa-tab").removeClass("active");
                    $(this).addClass("active");
                    $(".yaa-tab-content").removeClass("active");
                    $("#yaa-tab-" + tab).addClass("active");
                    
                    try {
                        localStorage.setItem("yaa_active_tab", tab);
                    } catch(e) {}
                });
                
                try {
                    var savedTab = localStorage.getItem("yaa_active_tab");
                    if (savedTab) {
                        var $savedTabEl = $(".yaa-tab[data-tab=\"" + savedTab + "\"]");
                        if ($savedTabEl.length) {
                            $savedTabEl.trigger("click");
                        }
                    }
                } catch(e) {}
            });
        ';
    }
    
    /**
     * Extended Admin JavaScript
     */
    private function get_extended_admin_js(): string {
        return '
            jQuery(document).ready(function($) {
                if ($.fn.wpColorPicker) {
                    $(".yaa-color-picker").wpColorPicker();
                }
                
                $("select[name=\'yaa_settings[amazon_marketplace]\']").on("change", function() {
                    var marketplace = $(this).val();
                    $(".yaa-marketplace-detail").hide();
                    $("#marketplace-info-" + marketplace.replace(/\\./g, "-")).show();
                });
                
                $(".yaa-test-btn").on("click", function(e) {
                    e.preventDefault();
                    var $btn = $(this);
                    var action = $btn.data("action");
                    var $result = $btn.siblings(".yaa-test-result");
                    
                    $btn.prop("disabled", true);
                    var originalText = $btn.text();
                    $btn.text("Teste...");
                    
                    var data = {
                        action: action,
                        nonce: yaaAdmin.nonce,
                        yadore_api_key: $("input[name=\'yaa_settings[yadore_api_key]\']").val(),
                        amazon_access_key: $("input[name=\'yaa_settings[amazon_access_key]\']").val(),
                        amazon_secret_key: $("input[name=\'yaa_settings[amazon_secret_key]\']").val(),
                        amazon_partner_tag: $("input[name=\'yaa_settings[amazon_partner_tag]\']").val(),
                        amazon_marketplace: $("select[name=\'yaa_settings[amazon_marketplace]\']").val(),
                        redis_host: $("input[name=\'yaa_settings[redis_host]\']").val(),
                        redis_port: $("input[name=\'yaa_settings[redis_port]\']").val(),
                        redis_password: $("input[name=\'yaa_settings[redis_password]\']").val(),
                        redis_database: $("input[name=\'yaa_settings[redis_database]\']").val()
                    };
                    
                    $.post(yaaAdmin.ajaxurl, data, function(response) {
                        $btn.prop("disabled", false).text(originalText);
                        if (response.success) {
                            $result.html("<div class=\'yaa-status-success\' style=\'padding:12px;border-radius:4px;\'>✅ " + response.data.message + "</div>").show();
                        } else {
                            $result.html("<div class=\'yaa-status-error\' style=\'padding:12px;border-radius:4px;\'>❌ " + response.data.message + "</div>").show();
                        }
                    }).fail(function() {
                        $btn.prop("disabled", false).text(originalText);
                        $result.html("<div class=\'yaa-status-error\' style=\'padding:12px;border-radius:4px;\'>❌ Verbindungsfehler</div>").show();
                    });
                });
                
                $("#yaa-refresh-merchants").on("click", function() {
                    var $btn = $(this);
                    var $status = $("#yaa-merchant-refresh-status");
                    
                    $btn.prop("disabled", true).text("Wird geladen...");
                    $status.html("");
                    
                    $.post(yaaAdmin.ajaxurl, {
                        action: "yaa_refresh_merchants",
                        nonce: yaaAdmin.nonce,
                        market: $("select[name=\'yaa_settings[yadore_market]\']").val()
                    }, function(response) {
                        $btn.prop("disabled", false).text("🔄 Händlerliste aktualisieren");
                        
                        if (response.success) {
                            $status.html("<span style=\'color:green;\'>✅ " + response.data.message + "</span>");
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            $status.html("<span style=\'color:red;\'>❌ " + response.data.message + "</span>");
                        }
                    }).fail(function() {
                        $btn.prop("disabled", false).text("🔄 Händlerliste aktualisieren");
                        $status.html("<span style=\'color:red;\'>❌ Verbindungsfehler</span>");
                    });
                });
                
                $("select.yaa-merchant-select").on("change", function() {
                    var $select = $(this);
                    var $input = $select.closest(".yaa-form-row").find("input[type=\'text\']");
                    var values = $select.val() || [];
                    $input.val(values.join(", "));
                });
            });
        ';
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-amazon-paapi.php 
 
<?php
/**
 * Amazon Product Advertising API 5.0 Handler
 * PHP 8.3+ compatible with ALL marketplaces
 * Version: 1.2.7
 * 
 * @see https://webservices.amazon.com/paapi5/documentation/
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Amazon_PAAPI {
    
    private YAA_Cache_Handler $cache;
    
    private string $access_key = '';
    private string $secret_key = '';
    private string $partner_tag = '';
    private string $host = '';
    private string $region = '';
    private string $marketplace = 'de';
    
    /**
     * All Amazon PA-API 5.0 Marketplaces
     * @see https://webservices.amazon.com/paapi5/documentation/locale-reference.html
     */
    private const ENDPOINTS = [
        // Europe
        'de' => [
            'host'        => 'webservices.amazon.de',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.de',
            'name'        => 'Amazon.de (Deutschland)',
            'currency'    => 'EUR',
            'language'    => 'de_DE',
            'languages'   => ['cs_CZ', 'de_DE', 'en_GB', 'nl_NL', 'pl_PL', 'tr_TR'],
        ],
        'fr' => [
            'host'        => 'webservices.amazon.fr',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.fr',
            'name'        => 'Amazon.fr (Frankreich)',
            'currency'    => 'EUR',
            'language'    => 'fr_FR',
            'languages'   => ['de_DE', 'en_GB', 'fr_FR'],
        ],
        'it' => [
            'host'        => 'webservices.amazon.it',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.it',
            'name'        => 'Amazon.it (Italien)',
            'currency'    => 'EUR',
            'language'    => 'it_IT',
            'languages'   => ['de_DE', 'en_GB', 'it_IT'],
        ],
        'es' => [
            'host'        => 'webservices.amazon.es',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.es',
            'name'        => 'Amazon.es (Spanien)',
            'currency'    => 'EUR',
            'language'    => 'es_ES',
            'languages'   => ['de_DE', 'en_GB', 'es_ES'],
        ],
        'co.uk' => [
            'host'        => 'webservices.amazon.co.uk',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.co.uk',
            'name'        => 'Amazon.co.uk (Großbritannien)',
            'currency'    => 'GBP',
            'language'    => 'en_GB',
            'languages'   => ['de_DE', 'en_GB'],
        ],
        'nl' => [
            'host'        => 'webservices.amazon.nl',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.nl',
            'name'        => 'Amazon.nl (Niederlande)',
            'currency'    => 'EUR',
            'language'    => 'nl_NL',
            'languages'   => ['de_DE', 'en_GB', 'nl_NL'],
        ],
        'pl' => [
            'host'        => 'webservices.amazon.pl',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.pl',
            'name'        => 'Amazon.pl (Polen)',
            'currency'    => 'PLN',
            'language'    => 'pl_PL',
            'languages'   => ['de_DE', 'en_GB', 'pl_PL'],
        ],
        'se' => [
            'host'        => 'webservices.amazon.se',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.se',
            'name'        => 'Amazon.se (Schweden)',
            'currency'    => 'SEK',
            'language'    => 'sv_SE',
            'languages'   => ['de_DE', 'en_GB', 'sv_SE'],
        ],
        'be' => [
            'host'        => 'webservices.amazon.com.be',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.com.be',
            'name'        => 'Amazon.com.be (Belgien)',
            'currency'    => 'EUR',
            'language'    => 'fr_BE',
            'languages'   => ['de_DE', 'en_GB', 'fr_BE', 'nl_BE'],
        ],
        'com.tr' => [
            'host'        => 'webservices.amazon.com.tr',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.com.tr',
            'name'        => 'Amazon.com.tr (Türkei)',
            'currency'    => 'TRY',
            'language'    => 'tr_TR',
            'languages'   => ['en_GB', 'tr_TR'],
        ],
        
        // Middle East & Africa
        'ae' => [
            'host'        => 'webservices.amazon.ae',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.ae',
            'name'        => 'Amazon.ae (VAE)',
            'currency'    => 'AED',
            'language'    => 'en_AE',
            'languages'   => ['ar_AE', 'en_AE'],
        ],
        'sa' => [
            'host'        => 'webservices.amazon.sa',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.sa',
            'name'        => 'Amazon.sa (Saudi-Arabien)',
            'currency'    => 'SAR',
            'language'    => 'en_AE',
            'languages'   => ['ar_AE', 'en_AE'],
        ],
        'eg' => [
            'host'        => 'webservices.amazon.eg',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.eg',
            'name'        => 'Amazon.eg (Ägypten)',
            'currency'    => 'EGP',
            'language'    => 'en_AE',
            'languages'   => ['ar_AE', 'en_AE'],
        ],
        
        // North America
        'com' => [
            'host'        => 'webservices.amazon.com',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.com',
            'name'        => 'Amazon.com (USA)',
            'currency'    => 'USD',
            'language'    => 'en_US',
            'languages'   => ['de_DE', 'en_US', 'es_US', 'ko_KR', 'pt_BR', 'zh_CN', 'zh_TW'],
        ],
        'ca' => [
            'host'        => 'webservices.amazon.ca',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.ca',
            'name'        => 'Amazon.ca (Kanada)',
            'currency'    => 'CAD',
            'language'    => 'en_CA',
            'languages'   => ['en_CA', 'fr_CA'],
        ],
        'com.mx' => [
            'host'        => 'webservices.amazon.com.mx',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.com.mx',
            'name'        => 'Amazon.com.mx (Mexiko)',
            'currency'    => 'MXN',
            'language'    => 'es_MX',
            'languages'   => ['en_US', 'es_MX'],
        ],
        'com.br' => [
            'host'        => 'webservices.amazon.com.br',
            'region'      => 'us-east-1',
            'marketplace' => 'www.amazon.com.br',
            'name'        => 'Amazon.com.br (Brasilien)',
            'currency'    => 'BRL',
            'language'    => 'pt_BR',
            'languages'   => ['en_US', 'pt_BR'],
        ],
        
        // Asia Pacific
        'co.jp' => [
            'host'        => 'webservices.amazon.co.jp',
            'region'      => 'us-west-2',
            'marketplace' => 'www.amazon.co.jp',
            'name'        => 'Amazon.co.jp (Japan)',
            'currency'    => 'JPY',
            'language'    => 'ja_JP',
            'languages'   => ['en_US', 'ja_JP', 'zh_CN'],
        ],
        'in' => [
            'host'        => 'webservices.amazon.in',
            'region'      => 'eu-west-1',
            'marketplace' => 'www.amazon.in',
            'name'        => 'Amazon.in (Indien)',
            'currency'    => 'INR',
            'language'    => 'en_IN',
            'languages'   => ['en_IN', 'hi_IN', 'kn_IN', 'ml_IN', 'ta_IN', 'te_IN'],
        ],
        'com.au' => [
            'host'        => 'webservices.amazon.com.au',
            'region'      => 'us-west-2',
            'marketplace' => 'www.amazon.com.au',
            'name'        => 'Amazon.com.au (Australien)',
            'currency'    => 'AUD',
            'language'    => 'en_AU',
            'languages'   => ['en_AU'],
        ],
        'sg' => [
            'host'        => 'webservices.amazon.sg',
            'region'      => 'us-west-2',
            'marketplace' => 'www.amazon.sg',
            'name'        => 'Amazon.sg (Singapur)',
            'currency'    => 'SGD',
            'language'    => 'en_SG',
            'languages'   => ['en_SG', 'zh_CN'],
        ],
    ];
    
    /**
     * Search indexes for DE marketplace
     */
    private const SEARCH_INDEXES_DE = [
        'All'                     => 'Alle Kategorien',
        'AmazonVideo'             => 'Prime Video',
        'Apparel'                 => 'Bekleidung',
        'Appliances'              => 'Elektro-Großgeräte',
        'Automotive'              => 'Auto & Motorrad',
        'Baby'                    => 'Baby',
        'Beauty'                  => 'Beauty',
        'Books'                   => 'Bücher',
        'Classical'               => 'Klassik',
        'Computers'               => 'Computer & Zubehör',
        'DigitalMusic'            => 'Musik-Downloads',
        'Electronics'             => 'Elektronik & Foto',
        'EverythingElse'          => 'Sonstiges',
        'Fashion'                 => 'Fashion',
        'ForeignBooks'            => 'Bücher (Fremdsprachig)',
        'GardenAndOutdoor'        => 'Garten',
        'GiftCards'               => 'Geschenkgutscheine',
        'GroceryAndGourmetFood'   => 'Lebensmittel & Getränke',
        'Handmade'                => 'Handmade',
        'HealthPersonalCare'      => 'Drogerie & Körperpflege',
        'HomeAndKitchen'          => 'Küche, Haushalt & Wohnen',
        'Industrial'              => 'Gewerbe, Industrie & Wissenschaft',
        'Jewelry'                 => 'Schmuck',
        'KindleStore'             => 'Kindle-Shop',
        'Lighting'                => 'Beleuchtung',
        'Luggage'                 => 'Koffer, Rucksäcke & Taschen',
        'LuxuryBeauty'            => 'Luxury Beauty',
        'Magazines'               => 'Zeitschriften',
        'MobileApps'              => 'Apps & Spiele',
        'MoviesAndTV'             => 'DVD & Blu-ray',
        'Music'                   => 'Musik-CDs & Vinyl',
        'MusicalInstruments'      => 'Musikinstrumente & DJ-Equipment',
        'OfficeProducts'          => 'Bürobedarf & Schreibwaren',
        'PetSupplies'             => 'Haustier',
        'Photo'                   => 'Kamera & Foto',
        'Shoes'                   => 'Schuhe & Handtaschen',
        'Software'                => 'Software',
        'SportsAndOutdoors'       => 'Sport & Freizeit',
        'ToolsAndHomeImprovement' => 'Baumarkt',
        'ToysAndGames'            => 'Spielzeug',
        'VHS'                     => 'VHS',
        'VideoGames'              => 'Games',
        'Watches'                 => 'Uhren',
    ];
    
    /**
     * Generic search indexes
     */
    private const SEARCH_INDEXES_GENERIC = [
        'All', 'Apparel', 'Appliances', 'Automotive', 'Baby', 'Beauty', 'Books',
        'Computers', 'Electronics', 'Fashion', 'GardenAndOutdoor', 'GiftCards',
        'GroceryAndGourmetFood', 'HealthPersonalCare', 'HomeAndKitchen', 'Industrial',
        'Jewelry', 'KindleStore', 'Luggage', 'MobileApps', 'MoviesAndTV', 'Music',
        'MusicalInstruments', 'OfficeProducts', 'PetSupplies', 'Shoes', 'Software',
        'SportsAndOutdoors', 'ToolsAndHomeImprovement', 'ToysAndGames', 'VideoGames', 'Watches',
    ];
    
    public function __construct(YAA_Cache_Handler $cache) {
        $this->cache = $cache;
        $this->load_credentials();
    }
    
    /**
     * Load API credentials
     */
    private function load_credentials(): void {
        $this->access_key = defined('AMAZON_PAAPI_ACCESS_KEY') 
            ? (string) AMAZON_PAAPI_ACCESS_KEY 
            : (string) yaa_get_option('amazon_access_key', '');
            
        $this->secret_key = defined('AMAZON_PAAPI_SECRET_KEY') 
            ? (string) AMAZON_PAAPI_SECRET_KEY 
            : (string) yaa_get_option('amazon_secret_key', '');
            
        $this->partner_tag = defined('AMAZON_PAAPI_PARTNER_TAG') 
            ? (string) AMAZON_PAAPI_PARTNER_TAG 
            : (string) yaa_get_option('amazon_partner_tag', '');
            
        $this->marketplace = (string) yaa_get_option('amazon_marketplace', 'de');
        
        $this->set_marketplace($this->marketplace);
    }
    
    /**
     * Set marketplace configuration
     */
    private function set_marketplace(string $marketplace): void {
        if (isset(self::ENDPOINTS[$marketplace])) {
            $this->host = self::ENDPOINTS[$marketplace]['host'];
            $this->region = self::ENDPOINTS[$marketplace]['region'];
            $this->marketplace = $marketplace;
        } else {
            $this->host = self::ENDPOINTS['de']['host'];
            $this->region = self::ENDPOINTS['de']['region'];
            $this->marketplace = 'de';
        }
    }
    
    /**
     * Reload credentials
     */
    public function reload_credentials(): void {
        $this->load_credentials();
    }
    
    /**
     * Check if API is configured
     */
    public function is_configured(): bool {
        return $this->access_key !== '' 
            && $this->secret_key !== '' 
            && $this->partner_tag !== ''
            && yaa_get_option('enable_amazon', 'yes') === 'yes';
    }
    
    /**
     * Get Partner Tag
     */
    public function get_partner_tag(): string {
        return $this->partner_tag;
    }
    
    /**
     * Get current marketplace info
     * 
     * @return array<string, mixed>|null
     */
    public function get_current_marketplace(): ?array {
        return self::ENDPOINTS[$this->marketplace] ?? null;
    }
    
    /**
     * Get all available marketplaces
     * 
     * @return array<string, array<string, mixed>>
     */
    public function get_marketplaces(): array {
        return self::ENDPOINTS;
    }
    
    /**
     * Get marketplaces for select dropdown
     * 
     * @return array<string, string>
     */
    public function get_marketplace_options(): array {
        $options = [];
        foreach (self::ENDPOINTS as $code => $data) {
            $options[$code] = $data['name'];
        }
        return $options;
    }
    
    /**
     * Get languages for current marketplace
     * 
     * @return array<string>
     */
    public function get_available_languages(): array {
        return self::ENDPOINTS[$this->marketplace]['languages'] ?? ['en_US'];
    }
    
    /**
     * Get search indexes for current marketplace
     * 
     * @return array<string, string>
     */
    public function get_search_indexes(): array {
        if ($this->marketplace === 'de') {
            return self::SEARCH_INDEXES_DE;
        }
        
        $indexes = [];
        foreach (self::SEARCH_INDEXES_GENERIC as $index) {
            $indexes[$index] = $index;
        }
        return $indexes;
    }
    
    /**
     * Get search indexes as simple list
     * 
     * @return array<string>
     */
    public function get_search_index_list(): array {
        return array_keys($this->get_search_indexes());
    }
    
    /**
     * Search products
     * 
     * @param array<string, mixed> $additional_params
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    public function search_items(
        string $keyword, 
        string $category = 'All', 
        int $item_count = 10,
        array $additional_params = []
    ): array|\WP_Error {
        if (!$this->is_configured()) {
            return new \WP_Error('not_configured', __('Amazon PA-API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        $keyword = trim($keyword);
        if ($keyword === '') {
            return new \WP_Error('no_keyword', __('Kein Suchbegriff angegeben.', 'yadore-amazon-api'));
        }
        
        // Check cache
        $cache_key = 'amazon_search_' . md5($keyword . $category . $item_count . serialize($additional_params) . $this->marketplace);
        $cached = $this->cache->get($cache_key);
        
        if ($cached !== false && is_array($cached)) {
            return $cached;
        }
        
        // Build payload - Request ALL image sizes for fallback
        $payload = [
            'Keywords'    => $keyword,
            'SearchIndex' => $category,
            'ItemCount'   => min(max(1, $item_count), 10),
            'PartnerTag'  => $this->partner_tag,
            'PartnerType' => 'Associates',
            'Resources'   => [
                // Request all image sizes for fallback chain
                'Images.Primary.Large',
                'Images.Primary.Medium',
                'Images.Primary.Small',
                'Images.Variants.Large',
                'Images.Variants.Medium',
                'Images.Variants.Small',
                'ItemInfo.Title',
                'ItemInfo.Features',
                'ItemInfo.ProductInfo',
                'ItemInfo.ByLineInfo',
                'Offers.Listings.Price',
                'Offers.Listings.DeliveryInfo.IsPrimeEligible',
                'Offers.Listings.Condition',
                'Offers.Listings.MerchantInfo',
            ],
        ];
        
        // Add optional language
        $language = (string) yaa_get_option('amazon_language', '');
        if ($language !== '' && in_array($language, $this->get_available_languages(), true)) {
            $payload['LanguagesOfPreference'] = [$language];
        }
        
        // Add optional parameters
        if (!empty($additional_params['min_price'])) {
            $payload['MinPrice'] = (int) ($additional_params['min_price'] * 100);
        }
        if (!empty($additional_params['max_price'])) {
            $payload['MaxPrice'] = (int) ($additional_params['max_price'] * 100);
        }
        if (!empty($additional_params['brand'])) {
            $payload['Brand'] = (string) $additional_params['brand'];
        }
        if (!empty($additional_params['sort_by'])) {
            $payload['SortBy'] = (string) $additional_params['sort_by'];
        }
        
        $response = $this->send_request('SearchItems', $payload);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $items = $this->parse_search_response($response);
        
        // Cache results
        $this->cache->set($cache_key, $items, yaa_get_cache_time());
        
        // Track for preload
        $this->track_keyword($keyword, $category, $item_count);
        
        return $items;
    }
    
    /**
     * Get items by ASIN
     * 
     * @param string|array<string> $asins
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    public function get_items(string|array $asins): array|\WP_Error {
        if (!$this->is_configured()) {
            return new \WP_Error('not_configured', __('Amazon PA-API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        if (is_string($asins)) {
            $asins = [$asins];
        }
        
        $asins = array_slice(array_filter($asins), 0, 10);
        
        if (empty($asins)) {
            return new \WP_Error('no_asins', __('Keine ASINs angegeben.', 'yadore-amazon-api'));
        }
        
        // Check cache
        $cache_key = 'amazon_items_' . md5(implode(',', $asins) . $this->marketplace);
        $cached = $this->cache->get($cache_key);
        
        if ($cached !== false && is_array($cached)) {
            return $cached;
        }
        
        $payload = [
            'ItemIds'     => $asins,
            'PartnerTag'  => $this->partner_tag,
            'PartnerType' => 'Associates',
            'Resources'   => [
                'Images.Primary.Large',
                'Images.Primary.Medium',
                'Images.Primary.Small',
                'Images.Variants.Large',
                'Images.Variants.Medium',
                'ItemInfo.Title',
                'ItemInfo.Features',
                'ItemInfo.ProductInfo',
                'ItemInfo.ByLineInfo',
                'Offers.Listings.Price',
                'Offers.Listings.DeliveryInfo.IsPrimeEligible',
                'Offers.Listings.MerchantInfo',
            ],
        ];
        
        $response = $this->send_request('GetItems', $payload);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $items = $this->parse_items_response($response);
        
        // Cache results
        $this->cache->set($cache_key, $items, yaa_get_cache_time());
        
        return $items;
    }
    
    /**
     * Send request to Amazon PA-API
     * 
     * @param array<string, mixed> $payload
     * @return array<string, mixed>|\WP_Error
     */
    private function send_request(string $operation, array $payload): array|\WP_Error {
        $path = '/paapi5/' . strtolower($operation);
        $service = 'ProductAdvertisingAPI';
        
        $payload_json = wp_json_encode($payload);
        
        if ($payload_json === false) {
            return new \WP_Error('json_error', __('JSON Encoding fehlgeschlagen.', 'yadore-amazon-api'));
        }
        
        // Create signature
        $headers = $this->create_signed_headers('POST', $path, $payload_json, $service, $operation);
        
        $url = 'https://' . $this->host . $path;
        
        $response = wp_remote_post($url, [
            'headers' => $headers,
            'body'    => $payload_json,
            'timeout' => 15,
        ]);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if (!is_array($data)) {
            $data = [];
        }
        
        if ($status_code !== 200) {
            $error_message = $data['Errors'][0]['Message'] ?? 'HTTP Error ' . $status_code;
            $error_code = $data['Errors'][0]['Code'] ?? 'unknown_error';
            
            error_log('Amazon PA-API Error: ' . $error_code . ' - ' . $error_message);
            return new \WP_Error($error_code, $error_message);
        }
        
        return $data;
    }
    
    /**
     * Create AWS Signature v4 headers
     * 
     * @return array<string, string>
     */
    private function create_signed_headers(
        string $method, 
        string $path, 
        string $payload, 
        string $service, 
        string $operation
    ): array {
        $timestamp = gmdate('Ymd\THis\Z');
        $date = gmdate('Ymd');
        
        $content_type = 'application/json; charset=utf-8';
        $amz_target = 'com.amazon.paapi5.v1.ProductAdvertisingAPIv1.' . $operation;
        
        $canonical_headers = 
            'content-encoding:amz-1.0' . "\n" .
            'content-type:' . $content_type . "\n" .
            'host:' . $this->host . "\n" .
            'x-amz-date:' . $timestamp . "\n" .
            'x-amz-target:' . $amz_target . "\n";
        
        $signed_headers = 'content-encoding;content-type;host;x-amz-date;x-amz-target';
        
        $payload_hash = hash('sha256', $payload);
        $canonical_request = implode("\n", [
            $method,
            $path,
            '',
            $canonical_headers,
            $signed_headers,
            $payload_hash,
        ]);
        
        $algorithm = 'AWS4-HMAC-SHA256';
        $credential_scope = $date . '/' . $this->region . '/' . $service . '/aws4_request';
        $string_to_sign = implode("\n", [
            $algorithm,
            $timestamp,
            $credential_scope,
            hash('sha256', $canonical_request),
        ]);
        
        $signing_key = $this->get_signature_key($date, $service);
        $signature = hash_hmac('sha256', $string_to_sign, $signing_key);
        
        $authorization = $algorithm . ' ' .
            'Credential=' . $this->access_key . '/' . $credential_scope . ', ' .
            'SignedHeaders=' . $signed_headers . ', ' .
            'Signature=' . $signature;
        
        return [
            'Content-Type'     => $content_type,
            'Content-Encoding' => 'amz-1.0',
            'Host'             => $this->host,
            'X-Amz-Date'       => $timestamp,
            'X-Amz-Target'     => $amz_target,
            'Authorization'    => $authorization,
        ];
    }
    
    /**
     * Get AWS4 signing key
     */
    private function get_signature_key(string $date, string $service): string {
        $k_date    = hash_hmac('sha256', $date, 'AWS4' . $this->secret_key, true);
        $k_region  = hash_hmac('sha256', $this->region, $k_date, true);
        $k_service = hash_hmac('sha256', $service, $k_region, true);
        $k_signing = hash_hmac('sha256', 'aws4_request', $k_service, true);
        
        return $k_signing;
    }
    
    /**
     * Parse search response
     * 
     * @param array<string, mixed> $response
     * @return array<int, array<string, mixed>>
     */
    private function parse_search_response(array $response): array {
        $items = [];
        
        $search_items = $response['SearchResult']['Items'] ?? [];
        
        foreach ($search_items as $item) {
            $items[] = $this->normalize_item($item);
        }
        
        return $items;
    }
    
    /**
     * Parse items response
     * 
     * @param array<string, mixed> $response
     * @return array<int, array<string, mixed>>
     */
    private function parse_items_response(array $response): array {
        $items = [];
        
        $result_items = $response['ItemsResult']['Items'] ?? [];
        
        foreach ($result_items as $item) {
            $items[] = $this->normalize_item($item);
        }
        
        return $items;
    }
    
    /**
     * Normalize item to standard format
     * INCLUDES: Fallback image chain (Large → Medium → Small → Variants)
     * 
     * @param array<string, mixed> $item
     * @return array<string, mixed>
     */
    private function normalize_item(array $item): array {
        $marketplace_info = self::ENDPOINTS[$this->marketplace] ?? self::ENDPOINTS['de'];
        
        // === FALLBACK-BILDERKETTE ===
        // Versuche verschiedene Bildgrößen in Reihenfolge
        $image_url = '';
        $image_width = 0;
        $image_height = 0;
        
        // 1. Primary Large
        if (!empty($item['Images']['Primary']['Large']['URL'])) {
            $image_url = $item['Images']['Primary']['Large']['URL'];
            $image_width = $item['Images']['Primary']['Large']['Width'] ?? 0;
            $image_height = $item['Images']['Primary']['Large']['Height'] ?? 0;
        }
        // 2. Primary Medium
        elseif (!empty($item['Images']['Primary']['Medium']['URL'])) {
            $image_url = $item['Images']['Primary']['Medium']['URL'];
            $image_width = $item['Images']['Primary']['Medium']['Width'] ?? 0;
            $image_height = $item['Images']['Primary']['Medium']['Height'] ?? 0;
        }
        // 3. Primary Small
        elseif (!empty($item['Images']['Primary']['Small']['URL'])) {
            $image_url = $item['Images']['Primary']['Small']['URL'];
            $image_width = $item['Images']['Primary']['Small']['Width'] ?? 0;
            $image_height = $item['Images']['Primary']['Small']['Height'] ?? 0;
        }
        // 4. First Variant Large
        elseif (!empty($item['Images']['Variants'][0]['Large']['URL'])) {
            $image_url = $item['Images']['Variants'][0]['Large']['URL'];
            $image_width = $item['Images']['Variants'][0]['Large']['Width'] ?? 0;
            $image_height = $item['Images']['Variants'][0]['Large']['Height'] ?? 0;
        }
        // 5. First Variant Medium
        elseif (!empty($item['Images']['Variants'][0]['Medium']['URL'])) {
            $image_url = $item['Images']['Variants'][0]['Medium']['URL'];
            $image_width = $item['Images']['Variants'][0]['Medium']['Width'] ?? 0;
            $image_height = $item['Images']['Variants'][0]['Medium']['Height'] ?? 0;
        }
        // 6. First Variant Small
        elseif (!empty($item['Images']['Variants'][0]['Small']['URL'])) {
            $image_url = $item['Images']['Variants'][0]['Small']['URL'];
            $image_width = $item['Images']['Variants'][0]['Small']['Width'] ?? 0;
            $image_height = $item['Images']['Variants'][0]['Small']['Height'] ?? 0;
        }
        
        $normalized = [
            'id'          => $item['ASIN'] ?? uniqid('amazon_'),
            'asin'        => $item['ASIN'] ?? '',
            'title'       => $item['ItemInfo']['Title']['DisplayValue'] ?? '',
            'description' => '',
            'url'         => $item['DetailPageURL'] ?? '',
            'image'       => [
                'url'    => $image_url,
                'width'  => $image_width,
                'height' => $image_height,
            ],
            'price'       => [
                'amount'   => '',
                'currency' => $marketplace_info['currency'],
                'display'  => '',
            ],
            'merchant'    => [
                'name' => 'Amazon',
                'logo' => '',
            ],
            'source'      => 'amazon',
            'is_prime'    => false,
            'partner_tag' => $this->partner_tag,
            'marketplace' => $this->marketplace,
        ];
        
        // Extract price
        $listing = $item['Offers']['Listings'][0] ?? null;
        if ($listing !== null && isset($listing['Price'])) {
            $normalized['price']['amount'] = (string) ($listing['Price']['Amount'] ?? '');
            $normalized['price']['currency'] = $listing['Price']['Currency'] ?? $marketplace_info['currency'];
            $normalized['price']['display'] = $listing['Price']['DisplayAmount'] ?? '';
        }
        
        // Extract features as description
        $features = $item['ItemInfo']['Features']['DisplayValues'] ?? [];
        if (!empty($features)) {
            $normalized['description'] = implode(' • ', array_slice($features, 0, 3));
        }
        
        // Prime eligibility
        if (isset($listing['DeliveryInfo']['IsPrimeEligible'])) {
            $normalized['is_prime'] = (bool) $listing['DeliveryInfo']['IsPrimeEligible'];
        }
        
        // Merchant info
        if (isset($listing['MerchantInfo']['Name'])) {
            $normalized['merchant']['name'] = $listing['MerchantInfo']['Name'];
        }
        
        // Brand
        if (isset($item['ItemInfo']['ByLineInfo']['Brand']['DisplayValue'])) {
            $normalized['brand'] = $item['ItemInfo']['ByLineInfo']['Brand']['DisplayValue'];
        }
        
        return $normalized;
    }
    
    /**
     * Track keyword for cron preload
     */
    private function track_keyword(string $keyword, string $category, int $limit): void {
        $cached_keywords = get_option('yaa_cached_keywords', []);
        
        if (!is_array($cached_keywords)) {
            $cached_keywords = [];
        }
        
        $new_entry = [
            'keyword'     => $keyword,
            'category'    => $category,
            'limit'       => $limit,
            'source'      => 'amazon',
            'marketplace' => $this->marketplace,
        ];
        
        foreach ($cached_keywords as $entry) {
            if (($entry['keyword'] ?? '') === $keyword 
                && ($entry['source'] ?? '') === 'amazon'
                && ($entry['category'] ?? 'All') === $category
                && ($entry['marketplace'] ?? 'de') === $this->marketplace) {
                return;
            }
        }
        
        $cached_keywords[] = $new_entry;
        $cached_keywords = array_slice($cached_keywords, -30);
        update_option('yaa_cached_keywords', $cached_keywords);
    }
    
    /**
     * Test API connection
     * 
     * @return array{success: bool, message: string, code?: string}
     */
    public function test_connection(
        ?string $access_key = null, 
        ?string $secret_key = null, 
        ?string $partner_tag = null, 
        ?string $marketplace = null
    ): array {
        // Temporarily override credentials for test
        $orig_access = $this->access_key;
        $orig_secret = $this->secret_key;
        $orig_tag = $this->partner_tag;
        $orig_host = $this->host;
        $orig_region = $this->region;
        $orig_marketplace = $this->marketplace;
        
        if ($access_key !== null) {
            $this->access_key = $access_key;
        }
        if ($secret_key !== null) {
            $this->secret_key = $secret_key;
        }
        if ($partner_tag !== null) {
            $this->partner_tag = $partner_tag;
        }
        if ($marketplace !== null) {
            $this->set_marketplace($marketplace);
        }
        
        // Validation
        if ($this->access_key === '' || $this->secret_key === '' || $this->partner_tag === '') {
            // Restore
            $this->access_key = $orig_access;
            $this->secret_key = $orig_secret;
            $this->partner_tag = $orig_tag;
            $this->host = $orig_host;
            $this->region = $orig_region;
            $this->marketplace = $orig_marketplace;
            
            return [
                'success' => false,
                'message' => __('Bitte alle Felder ausfüllen.', 'yadore-amazon-api'),
            ];
        }
        
        // Simple search test
        $payload = [
            'Keywords'    => 'test',
            'SearchIndex' => 'All',
            'ItemCount'   => 1,
            'PartnerTag'  => $this->partner_tag,
            'PartnerType' => 'Associates',
            'Resources'   => ['ItemInfo.Title'],
        ];
        
        $result = $this->send_request('SearchItems', $payload);
        
        // Restore original credentials
        $this->access_key = $orig_access;
        $this->secret_key = $orig_secret;
        $this->partner_tag = $orig_tag;
        $this->host = $orig_host;
        $this->region = $orig_region;
        $this->marketplace = $orig_marketplace;
        
        if (is_wp_error($result)) {
            return [
                'success' => false,
                'message' => $result->get_error_message(),
                'code'    => $result->get_error_code(),
            ];
        }
        
        return [
            'success' => true,
            'message' => __('Verbindung erfolgreich!', 'yadore-amazon-api'),
        ];
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-autoloader.php 
 
<?php
/**
 * PSR-4 Compatible Autoloader for Yadore-Amazon-API Plugin
 * PHP 8.1+ compatible
 * Version: 1.4.0
 *
 * Lädt Plugin-Klassen automatisch basierend auf Klassennamen.
 * Unterstützt das Namensschema: YAA_Class_Name -> class-class-name.php
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Autoloader {
    
    /**
     * Basis-Verzeichnis für Klassen
     */
    private static string $base_dir = '';
    
    /**
     * Ob der Autoloader bereits registriert wurde
     */
    private static bool $registered = false;
    
    /**
     * Mapping von Klassennamen zu Dateipfaden (für Sonderfälle)
     * @var array<string, string>
     */
    private static array $class_map = [];
    
    /**
     * Verzeichnisse in denen nach Klassen gesucht wird
     * @var array<string>
     */
    private static array $directories = [
        'includes',
        'includes/admin',
    ];
    
    /**
     * Registriert den Autoloader
     *
     * @param string $base_dir Basis-Plugin-Verzeichnis
     * @return bool True wenn erfolgreich registriert
     */
    public static function register(string $base_dir): bool {
        if (self::$registered) {
            return true;
        }
        
        self::$base_dir = rtrim($base_dir, '/\\');
        
        // Admin-Verzeichnis erstellen falls nicht vorhanden
        $admin_dir = self::$base_dir . '/includes/admin';
        if (!is_dir($admin_dir)) {
            wp_mkdir_p($admin_dir);
        }
        
        // Spezielle Klassen-Mappings (falls Dateiname nicht dem Standard entspricht)
        self::$class_map = [
            // Beispiel: 'YAA_Special_Class' => 'includes/special/class-special.php',
        ];
        
        $result = spl_autoload_register([self::class, 'autoload'], true, true);
        
        if ($result) {
            self::$registered = true;
        }
        
        return $result;
    }
    
    /**
     * Deregistriert den Autoloader
     */
    public static function unregister(): bool {
        if (!self::$registered) {
            return true;
        }
        
        $result = spl_autoload_unregister([self::class, 'autoload']);
        
        if ($result) {
            self::$registered = false;
        }
        
        return $result;
    }
    
    /**
     * Autoload-Callback Funktion
     *
     * @param string $class_name Vollständiger Klassenname
     */
    public static function autoload(string $class_name): void {
        // Nur YAA_ Klassen laden
        if (!str_starts_with($class_name, 'YAA_')) {
            return;
        }
        
        // 1. Prüfen ob spezielles Mapping existiert
        if (isset(self::$class_map[$class_name])) {
            $file = self::$base_dir . '/' . self::$class_map[$class_name];
            if (file_exists($file)) {
                require_once $file;
                return;
            }
        }
        
        // 2. Dateinamen aus Klassennamen generieren
        // YAA_Admin_Settings -> class-admin-settings.php
        // YAA_Cache_Handler -> class-cache-handler.php
        $file_name = self::class_to_filename($class_name);
        
        // 3. In allen registrierten Verzeichnissen suchen
        foreach (self::$directories as $directory) {
            $file = self::$base_dir . '/' . $directory . '/' . $file_name;
            
            if (file_exists($file)) {
                require_once $file;
                return;
            }
        }
        
        // 4. Fallback: Direkt im includes Verzeichnis
        $file = self::$base_dir . '/includes/' . $file_name;
        if (file_exists($file)) {
            require_once $file;
        }
    }
    
    /**
     * Konvertiert Klassennamen zu Dateinamen
     *
     * YAA_Admin_Settings -> class-admin-settings.php
     * YAA_Cache_Handler -> class-cache-handler.php
     * YAA_Amazon_PAAPI -> class-amazon-paapi.php
     *
     * @param string $class_name
     * @return string
     */
    private static function class_to_filename(string $class_name): string {
        // Prefix entfernen
        $name = str_replace('YAA_', '', $class_name);
        
        // CamelCase/PascalCase zu kebab-case konvertieren
        // Aber Akronyme wie PAAPI, API zusammenhalten
        $name = preg_replace('/([a-z])([A-Z])/', '$1-$2', $name) ?? $name;
        $name = preg_replace('/([A-Z]+)([A-Z][a-z])/', '$1-$2', $name) ?? $name;
        
        // Unterstriche zu Bindestrichen
        $name = str_replace('_', '-', $name);
        
        // Lowercase
        $name = strtolower($name);
        
        // Doppelte Bindestriche entfernen
        $name = preg_replace('/-+/', '-', $name) ?? $name;
        
        return 'class-' . trim($name, '-') . '.php';
    }
    
    /**
     * Fügt ein Verzeichnis zur Suche hinzu
     *
     * @param string $directory Relativ zum Base-Dir
     */
    public static function add_directory(string $directory): void {
        $directory = trim($directory, '/\\');
        
        if (!in_array($directory, self::$directories, true)) {
            self::$directories[] = $directory;
        }
    }
    
    /**
     * Fügt ein Klassen-Mapping hinzu
     *
     * @param string $class_name Vollständiger Klassenname
     * @param string $file_path Relativer Pfad zur Datei
     */
    public static function add_class_map(string $class_name, string $file_path): void {
        self::$class_map[$class_name] = $file_path;
    }
    
    /**
     * Prüft ob eine Klasse durch den Autoloader geladen werden kann
     *
     * @param string $class_name
     * @return bool
     */
    public static function can_load(string $class_name): bool {
        if (!str_starts_with($class_name, 'YAA_')) {
            return false;
        }
        
        // Spezielles Mapping prüfen
        if (isset(self::$class_map[$class_name])) {
            return file_exists(self::$base_dir . '/' . self::$class_map[$class_name]);
        }
        
        // Dateinamen generieren und prüfen
        $file_name = self::class_to_filename($class_name);
        
        foreach (self::$directories as $directory) {
            $file = self::$base_dir . '/' . $directory . '/' . $file_name;
            if (file_exists($file)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * Gibt alle registrierten Verzeichnisse zurück
     *
     * @return array<string>
     */
    public static function get_directories(): array {
        return self::$directories;
    }
    
    /**
     * Debug: Zeigt welche Datei für eine Klasse geladen würde
     *
     * @param string $class_name
     * @return string|null Dateipfad oder null
     */
    public static function resolve_class(string $class_name): ?string {
        if (!str_starts_with($class_name, 'YAA_')) {
            return null;
        }
        
        if (isset(self::$class_map[$class_name])) {
            $file = self::$base_dir . '/' . self::$class_map[$class_name];
            return file_exists($file) ? $file : null;
        }
        
        $file_name = self::class_to_filename($class_name);
        
        foreach (self::$directories as $directory) {
            $file = self::$base_dir . '/' . $directory . '/' . $file_name;
            if (file_exists($file)) {
                return $file;
            }
        }
        
        return null;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-cache-handler.php 
 
<?php
/**
 * Cache Handler - Redis detection and caching logic
 * PHP 8.3+ compatible
 * 
 * @package Yadore_Amazon_API
 * @since 1.6.0
 * 
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Cache_Handler {
    
    private bool $redis_available = false;
    private ?\Redis $redis_client = null;
    private bool $using_object_cache = false;
    private ?object $predis_client = null;
    
    /**
     * Redis Ping Timeout in Sekunden
     */
    private const REDIS_TIMEOUT = 2.0;
    
    /**
     * Redis Read Timeout in Sekunden
     */
    private const REDIS_READ_TIMEOUT = 2.0;
    
    public function __construct() {
        $this->detect_redis();
    }
    
    /**
     * Detect if Redis is available
     */
    private function detect_redis(): void {
        $enable_redis = (string) yaa_get_option('enable_redis', 'auto');
        
        if ($enable_redis === 'no') {
            $this->redis_available = false;
            return;
        }
        
        // Method 1: Check WordPress object cache
        if (wp_using_ext_object_cache()) {
            global $wp_object_cache;
            
            $redis_detected = (defined('WP_REDIS_DISABLED') && !WP_REDIS_DISABLED)
                || (class_exists('Redis') && is_object($wp_object_cache) && property_exists($wp_object_cache, 'redis'))
                || defined('WP_REDIS_CLIENT');
            
            if ($redis_detected) {
                $this->redis_available = true;
                $this->using_object_cache = true;
                return;
            }
        }
        
        // Method 2: Direct Redis connection
        if ($enable_redis === 'yes' || $enable_redis === 'auto') {
            $this->try_direct_redis_connection();
        }
    }
    
    /**
     * Try direct Redis connection
     */
    private function try_direct_redis_connection(): void {
        $host = $this->get_redis_config('host', '127.0.0.1');
        $port = (int) $this->get_redis_config('port', 6379);
        $password = $this->get_redis_config('password', '');
        $database = (int) $this->get_redis_config('database', 0);
        
        // Try native Redis extension
        if (extension_loaded('redis') && class_exists('Redis')) {
            try {
                $redis = new \Redis();
                
                // PHP 8.3+ compatible connection mit Timeout
                $connected = @$redis->connect(
                    $host, 
                    $port, 
                    self::REDIS_TIMEOUT,
                    null,
                    0,
                    self::REDIS_READ_TIMEOUT
                );
                
                if (!$connected) {
                    throw new \RedisException('Connection failed');
                }
                
                // Authentifizierung (kann Exception werfen)
                if ($password !== '') {
                    $auth_result = $redis->auth($password);
                    if ($auth_result !== true) {
                        throw new \RedisException('Authentication failed');
                    }
                }
                
                // Datenbank auswählen (kann Exception werfen)
                if ($database > 0) {
                    $select_result = $redis->select($database);
                    if ($select_result !== true) {
                        throw new \RedisException('Database selection failed');
                    }
                }
                
                // Test connection mit robustem ping() Handling
                if ($this->verify_redis_connection($redis)) {
                    $this->redis_client = $redis;
                    $this->redis_available = true;
                    return;
                }
                
                // Verbindung fehlgeschlagen - aufräumen
                $this->safe_redis_close($redis);
                
            } catch (\RedisException $e) {
                error_log('YAA Redis Error (RedisException): ' . $e->getMessage());
            } catch (\Exception $e) {
                error_log('YAA Redis Error (Exception): ' . $e->getMessage());
            } catch (\Throwable $e) {
                // PHP 8.x kann auch Error werfen
                error_log('YAA Redis Error (Throwable): ' . $e->getMessage());
            }
        }
        
        // Try Predis (if available)
        if (!$this->redis_available && class_exists('Predis\Client')) {
            $this->try_predis_connection($host, $port, $password, $database);
        }
    }
    
    /**
     * Verify Redis connection with robust ping handling
     * 
     * Handles verschiedene Rückgabetypen von ping():
     * - PHP-Redis 4.x: string "+PONG" oder "PONG"
     * - PHP-Redis 5.x: string "+PONG", "PONG" oder bool true
     * - PHP-Redis 6.x: bool true oder Redis (bei Pipelining)
     * 
     * @param \Redis $redis Redis instance
     * @return bool True wenn Verbindung verifiziert
     */
    private function verify_redis_connection(\Redis $redis): bool {
        try {
            // Suppress warnings für den Fall dass ping() fehlschlägt
            $pong = @$redis->ping();
            
            // Typ-sichere Prüfung aller möglichen Rückgabewerte
            if ($pong === true) {
                return true;
            }
            
            if (is_string($pong)) {
                $pong_upper = strtoupper(trim($pong, '+ '));
                if ($pong_upper === 'PONG') {
                    return true;
                }
            }
            
            // PHP-Redis 6.x kann bei bestimmten Konfigurationen 
            // das Redis-Objekt selbst zurückgeben (Fluent Interface)
            if ($pong instanceof \Redis) {
                return true;
            }
            
            // Fallback: Wenn wir hier ankommen, war ping() nicht erfolgreich
            error_log('YAA Redis: Unexpected ping response type: ' . gettype($pong));
            return false;
            
        } catch (\RedisException $e) {
            error_log('YAA Redis ping() Exception: ' . $e->getMessage());
            return false;
        } catch (\Throwable $e) {
            error_log('YAA Redis ping() Error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Safely close Redis connection
     * 
     * @param \Redis $redis Redis instance
     */
    private function safe_redis_close(\Redis $redis): void {
        try {
            @$redis->close();
        } catch (\Throwable $e) {
            // Ignore close errors
        }
    }
    
    /**
     * Try Predis connection
     * 
     * @param string $host Redis host
     * @param int $port Redis port
     * @param string $password Redis password
     * @param int $database Redis database
     */
    private function try_predis_connection(string $host, int $port, string $password, int $database): void {
        try {
            $config = [
                'scheme'  => 'tcp',
                'host'    => $host,
                'port'    => $port,
                'timeout' => self::REDIS_TIMEOUT,
            ];
            
            if ($password !== '') {
                $config['password'] = $password;
            }
            if ($database > 0) {
                $config['database'] = $database;
            }
            
            /** @var \Predis\Client $predis */
            $predis = new \Predis\Client($config);
            
            // Predis ping() wirft Exception bei Fehlern
            $pong = $predis->ping();
            
            // Predis gibt "PONG" als String zurück
            if ($pong === 'PONG' || $pong === true) {
                $this->predis_client = $predis;
                $this->redis_available = true;
            }
            
        } catch (\Exception $e) {
            error_log('YAA Predis Error: ' . $e->getMessage());
        }
    }
    
    /**
     * Get Redis configuration value
     * 
     * @param string $key Configuration key
     * @param mixed $default Default value
     * @return mixed Configuration value
     */
    private function get_redis_config(string $key, mixed $default): mixed {
        // Constants take priority
        $constant_map = [
            'host'     => 'WP_REDIS_HOST',
            'port'     => 'WP_REDIS_PORT',
            'password' => 'WP_REDIS_PASSWORD',
            'database' => 'WP_REDIS_DATABASE',
        ];
        
        if (isset($constant_map[$key]) && defined($constant_map[$key])) {
            return constant($constant_map[$key]);
        }
        
        return yaa_get_option('redis_' . $key, $default);
    }
    
    /**
     * Check if Redis is available
     */
    public function is_redis_available(): bool {
        return $this->redis_available;
    }
    
    /**
     * Get cached data
     * 
     * @param string $key Cache key
     * @return mixed Cached data or false
     */
    public function get(string $key): mixed {
        $prefixed_key = 'yaa_' . $key;
        
        if ($this->redis_available) {
            if ($this->using_object_cache) {
                $data = wp_cache_get($prefixed_key, 'yaa');
                if ($data !== false) {
                    return $data;
                }
            } elseif ($this->redis_client instanceof \Redis) {
                try {
                    $data = @$this->redis_client->get($prefixed_key);
                    if ($data !== false && $data !== null) {
                        return maybe_unserialize($data);
                    }
                } catch (\RedisException $e) {
                    error_log('YAA Redis GET Error (RedisException): ' . $e->getMessage());
                    $this->handle_connection_loss();
                } catch (\Throwable $e) {
                    error_log('YAA Redis GET Error: ' . $e->getMessage());
                }
            } elseif ($this->predis_client !== null) {
                try {
                    $data = $this->predis_client->get($prefixed_key);
                    if ($data !== null) {
                        return maybe_unserialize($data);
                    }
                } catch (\Exception $e) {
                    error_log('YAA Predis GET Error: ' . $e->getMessage());
                }
            }
        }
        
        return get_transient($prefixed_key);
    }
    
    /**
     * Set cached data
     * 
     * @param string $key Cache key
     * @param mixed $data Data to cache
     * @param int|null $expiration Expiration in seconds
     * @return bool Success
     */
    public function set(string $key, mixed $data, ?int $expiration = null): bool {
        $expiration ??= yaa_get_cache_time();
        $prefixed_key = 'yaa_' . $key;
        
        if ($this->redis_available) {
            if ($this->using_object_cache) {
                wp_cache_set($prefixed_key, $data, 'yaa', $expiration);
            } elseif ($this->redis_client instanceof \Redis) {
                try {
                    $serialized = maybe_serialize($data);
                    @$this->redis_client->setex($prefixed_key, $expiration, $serialized);
                } catch (\RedisException $e) {
                    error_log('YAA Redis SET Error (RedisException): ' . $e->getMessage());
                    $this->handle_connection_loss();
                } catch (\Throwable $e) {
                    error_log('YAA Redis SET Error: ' . $e->getMessage());
                }
            } elseif ($this->predis_client !== null) {
                try {
                    $serialized = maybe_serialize($data);
                    $this->predis_client->setex($prefixed_key, $expiration, $serialized);
                } catch (\Exception $e) {
                    error_log('YAA Predis SET Error: ' . $e->getMessage());
                }
            }
        }
        
        return set_transient($prefixed_key, $data, $expiration);
    }
    
    /**
     * Delete cached data
     * 
     * @param string $key Cache key
     */
    public function delete(string $key): void {
        $prefixed_key = 'yaa_' . $key;
        
        if ($this->redis_available) {
            if ($this->using_object_cache) {
                wp_cache_delete($prefixed_key, 'yaa');
            } elseif ($this->redis_client instanceof \Redis) {
                try {
                    @$this->redis_client->del($prefixed_key);
                } catch (\RedisException $e) {
                    error_log('YAA Redis DEL Error (RedisException): ' . $e->getMessage());
                    $this->handle_connection_loss();
                } catch (\Throwable $e) {
                    error_log('YAA Redis DEL Error: ' . $e->getMessage());
                }
            } elseif ($this->predis_client !== null) {
                try {
                    $this->predis_client->del([$prefixed_key]);
                } catch (\Exception $e) {
                    error_log('YAA Predis DEL Error: ' . $e->getMessage());
                }
            }
        }
        
        delete_transient($prefixed_key);
    }
    
    /**
     * Handle Redis connection loss
     * 
     * Bei Verbindungsverlust: Fallback auf Transients
     */
    private function handle_connection_loss(): void {
        $this->redis_available = false;
        $this->redis_client = null;
        error_log('YAA: Redis connection lost, falling back to transients');
    }
    
    /**
     * Clear all YAA cache entries
     * 
     * @return bool Success
     */
    public function clear_all(): bool {
        global $wpdb;
        
        // Clear Redis
        if ($this->redis_available && !$this->using_object_cache) {
            try {
                if ($this->redis_client instanceof \Redis) {
                    $keys = @$this->redis_client->keys('yaa_*');
                    if (!empty($keys) && is_array($keys)) {
                        @$this->redis_client->del($keys);
                    }
                } elseif ($this->predis_client !== null) {
                    $keys = $this->predis_client->keys('yaa_*');
                    if (!empty($keys) && is_array($keys)) {
                        $this->predis_client->del($keys);
                    }
                }
            } catch (\RedisException $e) {
                error_log('YAA Redis CLEAR Error (RedisException): ' . $e->getMessage());
            } catch (\Throwable $e) {
                error_log('YAA Redis CLEAR Error: ' . $e->getMessage());
            }
        }
        
        // Clear object cache group
        if (function_exists('wp_cache_flush_group')) {
            wp_cache_flush_group('yaa');
        }
        
        // Clear transients (escaped query)
        $wpdb->query(
            $wpdb->prepare(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                '_transient_yaa_%'
            )
        );
        $wpdb->query(
            $wpdb->prepare(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                '_transient_timeout_yaa_%'
            )
        );
        
        return true;
    }
    
    /**
     * Get detailed cache status
     * 
     * @return array<string, mixed> Cache status
     */
    public function get_status(): array {
        $status = [
            'redis_available'    => $this->redis_available,
            'using_object_cache' => $this->using_object_cache,
            'cache_backend'      => 'WordPress Transients',
            'redis_info'         => null,
            'php_redis_version'  => null,
        ];
        
        // PHP Redis Extension Version
        if (extension_loaded('redis')) {
            $status['php_redis_version'] = phpversion('redis') ?: 'Unknown';
        }
        
        if ($this->redis_available) {
            $status['cache_backend'] = $this->using_object_cache 
                ? 'WordPress Object Cache (Redis)' 
                : 'Direct Redis Connection';
            
            if ($this->redis_client instanceof \Redis) {
                try {
                    $info = @$this->redis_client->info();
                    if (is_array($info)) {
                        $status['redis_info'] = [
                            'version'           => $info['redis_version'] ?? 'Unknown',
                            'used_memory'       => $info['used_memory_human'] ?? 'Unknown',
                            'connected_clients' => $info['connected_clients'] ?? 'Unknown',
                            'uptime_days'       => isset($info['uptime_in_days']) 
                                ? (int) $info['uptime_in_days'] 
                                : null,
                        ];
                    }
                } catch (\Throwable $e) {
                    $status['redis_info'] = ['error' => $e->getMessage()];
                }
            }
        }
        
        return $status;
    }
    
    /**
     * Test Redis connection with custom settings
     * 
     * @param string $host Redis host
     * @param int $port Redis port
     * @param string $password Redis password
     * @param int $database Redis database
     * @return array{success: bool, message: string, details?: array<string, mixed>}
     */
    public function test_connection(string $host, int $port, string $password = '', int $database = 0): array {
        // Check extension
        if (!extension_loaded('redis') || !class_exists('Redis')) {
            return [
                'success' => false,
                'message' => __('PHP Redis Extension nicht installiert.', 'yadore-amazon-api'),
            ];
        }
        
        $redis = null;
        
        try {
            $redis = new \Redis();
            
            // Connection mit Timeout
            $connected = @$redis->connect(
                $host, 
                $port, 
                self::REDIS_TIMEOUT,
                null,
                0,
                self::REDIS_READ_TIMEOUT
            );
            
            if (!$connected) {
                return [
                    'success' => false,
                    'message' => sprintf(
                        __('Verbindung zu Redis fehlgeschlagen (%s:%d).', 'yadore-amazon-api'),
                        $host,
                        $port
                    ),
                ];
            }
            
            // Authentication
            if ($password !== '') {
                try {
                    $auth_result = @$redis->auth($password);
                    if ($auth_result !== true) {
                        $this->safe_redis_close($redis);
                        return [
                            'success' => false,
                            'message' => __('Redis-Authentifizierung fehlgeschlagen.', 'yadore-amazon-api'),
                        ];
                    }
                } catch (\RedisException $e) {
                    $this->safe_redis_close($redis);
                    return [
                        'success' => false,
                        'message' => __('Redis-Authentifizierung fehlgeschlagen: ', 'yadore-amazon-api') . $e->getMessage(),
                    ];
                }
            }
            
            // Database selection
            if ($database > 0) {
                try {
                    $select_result = @$redis->select($database);
                    if ($select_result !== true) {
                        $this->safe_redis_close($redis);
                        return [
                            'success' => false,
                            'message' => sprintf(
                                __('Redis-Datenbank %d konnte nicht ausgewählt werden.', 'yadore-amazon-api'),
                                $database
                            ),
                        ];
                    }
                } catch (\RedisException $e) {
                    $this->safe_redis_close($redis);
                    return [
                        'success' => false,
                        'message' => __('Redis-Datenbank Auswahl fehlgeschlagen: ', 'yadore-amazon-api') . $e->getMessage(),
                    ];
                }
            }
            
            // Ping Test mit robustem Handling
            if (!$this->verify_redis_connection($redis)) {
                $this->safe_redis_close($redis);
                return [
                    'success' => false,
                    'message' => __('Redis-Ping fehlgeschlagen.', 'yadore-amazon-api'),
                ];
            }
            
            // Hole Server-Info für Details
            $details = [];
            try {
                $info = @$redis->info();
                if (is_array($info)) {
                    $details = [
                        'redis_version' => $info['redis_version'] ?? 'Unknown',
                        'os'            => $info['os'] ?? 'Unknown',
                        'used_memory'   => $info['used_memory_human'] ?? 'Unknown',
                    ];
                }
            } catch (\Throwable $e) {
                // Info ist optional, ignoriere Fehler
            }
            
            $this->safe_redis_close($redis);
            
            return [
                'success' => true,
                'message' => __('Redis-Verbindung erfolgreich!', 'yadore-amazon-api'),
                'details' => $details,
            ];
            
        } catch (\RedisException $e) {
            if ($redis instanceof \Redis) {
                $this->safe_redis_close($redis);
            }
            return [
                'success' => false,
                'message' => 'RedisException: ' . $e->getMessage(),
            ];
        } catch (\Throwable $e) {
            if ($redis instanceof \Redis) {
                $this->safe_redis_close($redis);
            }
            return [
                'success' => false,
                'message' => 'Fehler: ' . $e->getMessage(),
            ];
        }
    }
    
    /**
     * Check if Redis connection is still alive
     * 
     * @return bool True if connected
     */
    public function is_connected(): bool {
        if (!$this->redis_available) {
            return false;
        }
        
        if ($this->using_object_cache) {
            return true; // Object cache handles this
        }
        
        if ($this->redis_client instanceof \Redis) {
            return $this->verify_redis_connection($this->redis_client);
        }
        
        if ($this->predis_client !== null) {
            try {
                $pong = $this->predis_client->ping();
                return $pong === 'PONG' || $pong === true;
            } catch (\Exception $e) {
                return false;
            }
        }
        
        return false;
    }
    
    /**
     * Reconnect to Redis if connection was lost
     * 
     * @return bool Success
     */
    public function reconnect(): bool {
        $this->redis_available = false;
        $this->redis_client = null;
        $this->predis_client = null;
        $this->using_object_cache = false;
        
        $this->detect_redis();
        
        return $this->redis_available;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-custom-products.php 
 
<?php
/**
 * Custom Products - Eigene Produkte verwalten mit Fuzzy-Suche
 * PHP 8.3+ compatible
 * Version: 1.2.6
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Custom_Products {
    
    private const POST_TYPE = 'yaa_product';
    private const TAXONOMY = 'yaa_product_category';
    
    private ?YAA_Fuzzy_Matcher $fuzzy_matcher = null;
    
    public function __construct() {
        add_action('init', [$this, 'register_post_type']);
        add_action('init', [$this, 'register_taxonomy']);
        add_action('add_meta_boxes', [$this, 'add_meta_boxes']);
        add_action('save_post_' . self::POST_TYPE, [$this, 'save_meta_data']);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_scripts']);
        add_filter('manage_' . self::POST_TYPE . '_posts_columns', [$this, 'add_admin_columns']);
        add_action('manage_' . self::POST_TYPE . '_posts_custom_column', [$this, 'render_admin_columns'], 10, 2);
    }
    
    /**
     * Get Fuzzy Matcher instance (lazy loading)
     */
    private function get_fuzzy_matcher(): YAA_Fuzzy_Matcher {
        if ($this->fuzzy_matcher === null) {
            $this->fuzzy_matcher = new YAA_Fuzzy_Matcher();
        }
        return $this->fuzzy_matcher;
    }
    
    /**
     * Register Custom Post Type
     */
    public function register_post_type(): void {
        $labels = [
            'name'                  => __('Eigene Produkte', 'yadore-amazon-api'),
            'singular_name'         => __('Produkt', 'yadore-amazon-api'),
            'menu_name'             => __('Eigene Produkte', 'yadore-amazon-api'),
            'add_new'               => __('Neues Produkt', 'yadore-amazon-api'),
            'add_new_item'          => __('Neues Produkt hinzufügen', 'yadore-amazon-api'),
            'edit_item'             => __('Produkt bearbeiten', 'yadore-amazon-api'),
            'new_item'              => __('Neues Produkt', 'yadore-amazon-api'),
            'view_item'             => __('Produkt ansehen', 'yadore-amazon-api'),
            'search_items'          => __('Produkte suchen', 'yadore-amazon-api'),
            'not_found'             => __('Keine Produkte gefunden', 'yadore-amazon-api'),
            'not_found_in_trash'    => __('Keine Produkte im Papierkorb', 'yadore-amazon-api'),
            'all_items'             => __('Alle Produkte', 'yadore-amazon-api'),
            'featured_image'        => __('Produktbild', 'yadore-amazon-api'),
            'set_featured_image'    => __('Produktbild festlegen', 'yadore-amazon-api'),
            'remove_featured_image' => __('Produktbild entfernen', 'yadore-amazon-api'),
            'use_featured_image'    => __('Als Produktbild verwenden', 'yadore-amazon-api'),
        ];
        
        $args = [
            'labels'              => $labels,
            'public'              => false,
            'publicly_queryable'  => false,
            'show_ui'             => true,
            'show_in_menu'        => 'yaa-settings',
            'query_var'           => false,
            'rewrite'             => false,
            'capability_type'     => 'post',
            'has_archive'         => false,
            'hierarchical'        => false,
            'menu_position'       => null,
            'menu_icon'           => 'dashicons-products',
            'supports'            => ['title', 'thumbnail'],
            'show_in_rest'        => true,
        ];
        
        register_post_type(self::POST_TYPE, $args);
    }
    
    /**
     * Register Taxonomy for Product Categories
     */
    public function register_taxonomy(): void {
        $labels = [
            'name'              => __('Produkt-Kategorien', 'yadore-amazon-api'),
            'singular_name'     => __('Kategorie', 'yadore-amazon-api'),
            'search_items'      => __('Kategorien suchen', 'yadore-amazon-api'),
            'all_items'         => __('Alle Kategorien', 'yadore-amazon-api'),
            'parent_item'       => __('Übergeordnete Kategorie', 'yadore-amazon-api'),
            'parent_item_colon' => __('Übergeordnete Kategorie:', 'yadore-amazon-api'),
            'edit_item'         => __('Kategorie bearbeiten', 'yadore-amazon-api'),
            'update_item'       => __('Kategorie aktualisieren', 'yadore-amazon-api'),
            'add_new_item'      => __('Neue Kategorie hinzufügen', 'yadore-amazon-api'),
            'new_item_name'     => __('Neuer Kategorie-Name', 'yadore-amazon-api'),
            'menu_name'         => __('Kategorien', 'yadore-amazon-api'),
        ];
        
        $args = [
            'hierarchical'      => true,
            'labels'            => $labels,
            'show_ui'           => true,
            'show_admin_column' => true,
            'query_var'         => false,
            'rewrite'           => false,
            'show_in_rest'      => true,
        ];
        
        register_taxonomy(self::TAXONOMY, self::POST_TYPE, $args);
    }
    
    /**
     * Add Meta Boxes
     */
    public function add_meta_boxes(): void {
        add_meta_box(
            'yaa_product_details',
            __('Produkt-Details', 'yadore-amazon-api'),
            [$this, 'render_meta_box'],
            self::POST_TYPE,
            'normal',
            'high'
        );
    }
    
    /**
     * Render Meta Box
     */
    public function render_meta_box(\WP_Post $post): void {
        wp_nonce_field('yaa_product_meta', 'yaa_product_meta_nonce');
        
        // Bestehende Werte laden
        $url = get_post_meta($post->ID, '_yaa_product_url', true);
        $price = get_post_meta($post->ID, '_yaa_product_price', true);
        $currency = get_post_meta($post->ID, '_yaa_product_currency', true) ?: 'EUR';
        $merchant = get_post_meta($post->ID, '_yaa_product_merchant', true);
        $description = get_post_meta($post->ID, '_yaa_product_description', true);
        $button_text = get_post_meta($post->ID, '_yaa_product_button_text', true);
        $is_prime = get_post_meta($post->ID, '_yaa_product_is_prime', true);
        $external_image = get_post_meta($post->ID, '_yaa_product_external_image', true);
        $sort_order = get_post_meta($post->ID, '_yaa_product_sort_order', true) ?: 0;
        $fuzzy_keywords = get_post_meta($post->ID, '_yaa_product_fuzzy_keywords', true); // NEU
        
        ?>
        <style>
            .yaa-meta-row { margin-bottom: 15px; }
            .yaa-meta-row label { display: block; font-weight: 600; margin-bottom: 5px; }
            .yaa-meta-row input[type="text"],
            .yaa-meta-row input[type="url"],
            .yaa-meta-row input[type="number"],
            .yaa-meta-row select,
            .yaa-meta-row textarea { width: 100%; max-width: 600px; }
            .yaa-meta-row textarea { min-height: 100px; }
            .yaa-meta-row .description { color: #666; font-size: 12px; margin-top: 4px; }
            .yaa-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            @media (max-width: 782px) { .yaa-meta-grid { grid-template-columns: 1fr; } }
            .yaa-required { color: #dc3232; }
            .yaa-fuzzy-box { background: #f0f6fc; border: 1px solid #c8d9e8; border-radius: 4px; padding: 15px; margin-top: 20px; }
        </style>
        
        <div class="yaa-meta-grid">
            <div>
                <div class="yaa-meta-row">
                    <label for="yaa_product_url">
                        <?php esc_html_e('Produkt-URL / Affiliate-Link', 'yadore-amazon-api'); ?>
                        <span class="yaa-required">*</span>
                    </label>
                    <input type="url" id="yaa_product_url" name="yaa_product_url" 
                           value="<?php echo esc_attr($url); ?>" required>
                    <p class="description"><?php esc_html_e('Der Link zum Produkt oder Affiliate-Link.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_price"><?php esc_html_e('Preis', 'yadore-amazon-api'); ?></label>
                    <input type="text" id="yaa_product_price" name="yaa_product_price" 
                           value="<?php echo esc_attr($price); ?>" placeholder="29.99">
                    <p class="description"><?php esc_html_e('Numerischer Preis ohne Währungszeichen.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_currency"><?php esc_html_e('Währung', 'yadore-amazon-api'); ?></label>
                    <select id="yaa_product_currency" name="yaa_product_currency">
                        <?php
                        $currencies = ['EUR' => '€ Euro', 'USD' => '$ US-Dollar', 'GBP' => '£ Pfund', 'CHF' => 'CHF Franken', 'PLN' => 'zł Zloty'];
                        foreach ($currencies as $code => $label):
                        ?>
                            <option value="<?php echo esc_attr($code); ?>" <?php selected($currency, $code); ?>>
                                <?php echo esc_html($label); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_merchant"><?php esc_html_e('Händler / Shop', 'yadore-amazon-api'); ?></label>
                    <input type="text" id="yaa_product_merchant" name="yaa_product_merchant" 
                           value="<?php echo esc_attr($merchant); ?>" placeholder="Amazon, eBay, ...">
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_button_text"><?php esc_html_e('Button-Text (optional)', 'yadore-amazon-api'); ?></label>
                    <input type="text" id="yaa_product_button_text" name="yaa_product_button_text" 
                           value="<?php echo esc_attr($button_text); ?>" placeholder="Zum Angebot">
                    <p class="description"><?php esc_html_e('Überschreibt den Standard-Button-Text.', 'yadore-amazon-api'); ?></p>
                </div>
            </div>
            
            <div>
                <div class="yaa-meta-row">
                    <label for="yaa_product_description"><?php esc_html_e('Beschreibung', 'yadore-amazon-api'); ?></label>
                    <textarea id="yaa_product_description" name="yaa_product_description"><?php echo esc_textarea($description); ?></textarea>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_external_image"><?php esc_html_e('Externes Bild (URL)', 'yadore-amazon-api'); ?></label>
                    <input type="url" id="yaa_product_external_image" name="yaa_product_external_image" 
                           value="<?php echo esc_attr($external_image); ?>">
                    <p class="description"><?php esc_html_e('Optional: Externe Bild-URL. Hat Vorrang vor dem Beitragsbild.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label for="yaa_product_sort_order"><?php esc_html_e('Sortierung', 'yadore-amazon-api'); ?></label>
                    <input type="number" id="yaa_product_sort_order" name="yaa_product_sort_order" 
                           value="<?php echo esc_attr($sort_order); ?>" min="0" step="1">
                    <p class="description"><?php esc_html_e('Kleinere Zahlen werden zuerst angezeigt.', 'yadore-amazon-api'); ?></p>
                </div>
                
                <div class="yaa-meta-row">
                    <label>
                        <input type="checkbox" name="yaa_product_is_prime" value="1" <?php checked($is_prime, '1'); ?>>
                        <?php esc_html_e('Prime-Badge anzeigen', 'yadore-amazon-api'); ?>
                    </label>
                    <p class="description"><?php esc_html_e('Zeigt ein Prime-Badge wie bei Amazon-Produkten.', 'yadore-amazon-api'); ?></p>
                </div>
            </div>
        </div>
        
        <!-- NEU: Fuzzy-Keywords -->
        <div class="yaa-fuzzy-box">
            <h4 style="margin-top: 0;">🔍 <?php esc_html_e('Fuzzy-Suche Keywords', 'yadore-amazon-api'); ?></h4>
            <div class="yaa-meta-row">
                <label for="yaa_product_fuzzy_keywords"><?php esc_html_e('Zusätzliche Suchbegriffe', 'yadore-amazon-api'); ?></label>
                <input type="text" id="yaa_product_fuzzy_keywords" name="yaa_product_fuzzy_keywords" 
                       value="<?php echo esc_attr($fuzzy_keywords); ?>" 
                       placeholder="Keyword1, Keyword2, Synonym, Alternative">
                <p class="description">
                    <?php esc_html_e('Komma-separierte Keywords, die dieses Produkt bei der Fuzzy-Suche finden. Beispiel: "Kopfhörer, Headphones, Over-Ear, Bluetooth Audio"', 'yadore-amazon-api'); ?>
                </p>
            </div>
        </div>
        
        <hr style="margin: 20px 0;">
        
        <h4><?php esc_html_e('Shortcode-Verwendung', 'yadore-amazon-api'); ?></h4>
        <p>
            <code>[custom_products ids="<?php echo $post->ID; ?>"]</code> – 
            <?php esc_html_e('Dieses Produkt einzeln anzeigen', 'yadore-amazon-api'); ?>
        </p>
        <?php
    }
    
    /**
     * Save Meta Data
     */
    public function save_meta_data(int $post_id): void {
        // Nonce check
        if (!isset($_POST['yaa_product_meta_nonce']) || 
            !wp_verify_nonce($_POST['yaa_product_meta_nonce'], 'yaa_product_meta')) {
            return;
        }
        
        // Auto-save check
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        
        // Permission check
        if (!current_user_can('edit_post', $post_id)) {
            return;
        }
        
        // Felder speichern
        $fields = [
            '_yaa_product_url'            => 'esc_url_raw',
            '_yaa_product_price'          => 'sanitize_text_field',
            '_yaa_product_currency'       => 'sanitize_text_field',
            '_yaa_product_merchant'       => 'sanitize_text_field',
            '_yaa_product_description'    => 'sanitize_textarea_field',
            '_yaa_product_button_text'    => 'sanitize_text_field',
            '_yaa_product_external_image' => 'esc_url_raw',
            '_yaa_product_sort_order'     => 'absint',
            '_yaa_product_fuzzy_keywords' => 'sanitize_text_field', // NEU
        ];
        
        foreach ($fields as $meta_key => $sanitize_callback) {
            $field_name = str_replace('_yaa_product_', 'yaa_product_', $meta_key);
            
            if (isset($_POST[$field_name])) {
                $value = call_user_func($sanitize_callback, $_POST[$field_name]);
                update_post_meta($post_id, $meta_key, $value);
            }
        }
        
        // Checkbox
        $is_prime = isset($_POST['yaa_product_is_prime']) ? '1' : '';
        update_post_meta($post_id, '_yaa_product_is_prime', $is_prime);
    }
    
    /**
     * Enqueue admin scripts
     */
    public function enqueue_admin_scripts(string $hook): void {
        global $post_type;
        
        if ($post_type !== self::POST_TYPE) {
            return;
        }
        
        wp_enqueue_media();
    }
    
    /**
     * Add admin columns
     * 
     * @param array<string, string> $columns
     * @return array<string, string>
     */
    public function add_admin_columns(array $columns): array {
        $new_columns = [];
        
        foreach ($columns as $key => $value) {
            $new_columns[$key] = $value;
            
            if ($key === 'title') {
                $new_columns['yaa_image'] = __('Bild', 'yadore-amazon-api');
                $new_columns['yaa_price'] = __('Preis', 'yadore-amazon-api');
                $new_columns['yaa_merchant'] = __('Händler', 'yadore-amazon-api');
            }
        }
        
        $new_columns['yaa_shortcode'] = __('Shortcode', 'yadore-amazon-api');
        
        return $new_columns;
    }
    
    /**
     * Render admin columns
     */
    public function render_admin_columns(string $column, int $post_id): void {
        switch ($column) {
            case 'yaa_image':
                $external_image = get_post_meta($post_id, '_yaa_product_external_image', true);
                if ($external_image) {
                    echo '<img src="' . esc_url($external_image) . '" style="width:50px;height:50px;object-fit:contain;">';
                } elseif (has_post_thumbnail($post_id)) {
                    echo get_the_post_thumbnail($post_id, [50, 50], ['style' => 'object-fit:contain;']);
                } else {
                    echo '—';
                }
                break;
                
            case 'yaa_price':
                $price = get_post_meta($post_id, '_yaa_product_price', true);
                $currency = get_post_meta($post_id, '_yaa_product_currency', true) ?: 'EUR';
                echo $price ? esc_html($price . ' ' . $currency) : '—';
                break;
                
            case 'yaa_merchant':
                $merchant = get_post_meta($post_id, '_yaa_product_merchant', true);
                echo $merchant ? esc_html($merchant) : '—';
                break;
                
            case 'yaa_shortcode':
                echo '<code style="font-size:11px;">[custom_products ids="' . $post_id . '"]</code>';
                break;
        }
    }
    
    /**
     * Get products by IDs
     * 
     * @param array<int> $ids
     * @return array<int, array<string, mixed>>
     */
    public function get_products_by_ids(array $ids): array {
        if (empty($ids)) {
            return [];
        }
        
        $args = [
            'post_type'      => self::POST_TYPE,
            'post__in'       => $ids,
            'posts_per_page' => count($ids),
            'orderby'        => 'post__in',
            'post_status'    => 'publish',
        ];
        
        $query = new \WP_Query($args);
        
        return $this->format_products($query->posts);
    }
    
    /**
     * Get products by category
     * 
     * @return array<int, array<string, mixed>>
     */
    public function get_products_by_category(string $category, int $limit = 10): array {
        $args = [
            'post_type'      => self::POST_TYPE,
            'posts_per_page' => $limit,
            'post_status'    => 'publish',
            'meta_key'       => '_yaa_product_sort_order',
            'orderby'        => 'meta_value_num',
            'order'          => 'ASC',
            'tax_query'      => [
                [
                    'taxonomy' => self::TAXONOMY,
                    'field'    => 'slug',
                    'terms'    => $category,
                ],
            ],
        ];
        
        $query = new \WP_Query($args);
        
        return $this->format_products($query->posts);
    }
    
    /**
     * Get all products
     * 
     * @return array<int, array<string, mixed>>
     */
    public function get_all_products(int $limit = -1): array {
        $args = [
            'post_type'      => self::POST_TYPE,
            'posts_per_page' => $limit,
            'post_status'    => 'publish',
            'meta_key'       => '_yaa_product_sort_order',
            'orderby'        => 'meta_value_num',
            'order'          => 'ASC',
        ];
        
        $query = new \WP_Query($args);
        
        return $this->format_products($query->posts);
    }
    
    /**
     * ===== NEU: Fuzzy Search für eigene Produkte =====
     * Findet ähnliche Produkte basierend auf Keyword-Matching
     * 
     * @param string $keyword Suchbegriff
     * @param int $limit Max. Anzahl Ergebnisse
     * @param int|null $threshold Min. Score (0-100), null = Plugin-Standard
     * @return array<int, array<string, mixed>> Sortiert nach Relevanz
     */
    public function search_products_fuzzy(string $keyword, int $limit = 10, ?int $threshold = null): array {
        $keyword = trim($keyword);
        
        if ($keyword === '') {
            return [];
        }
        
        // Fuzzy Matcher initialisieren
        $matcher = $this->get_fuzzy_matcher();
        
        if ($threshold !== null) {
            $matcher->set_threshold($threshold);
        }
        
        // Alle eigenen Produkte laden
        $all_products = $this->get_all_products(-1);
        
        if (empty($all_products)) {
            return [];
        }
        
        // Score für jedes Produkt berechnen
        $scored_products = [];
        
        foreach ($all_products as $product) {
            // Zusätzliche Fuzzy-Keywords aus Meta laden
            $post_id = $product['post_id'] ?? 0;
            $fuzzy_keywords = '';
            if ($post_id > 0) {
                $fuzzy_keywords = get_post_meta($post_id, '_yaa_product_fuzzy_keywords', true) ?: '';
            }
            
            // Keywords als Array hinzufügen
            if ($fuzzy_keywords !== '') {
                $product['keywords'] = array_map('trim', explode(',', $fuzzy_keywords));
            }
            
            // Kategorien laden
            if ($post_id > 0) {
                $terms = wp_get_post_terms($post_id, self::TAXONOMY, ['fields' => 'names']);
                if (!is_wp_error($terms) && !empty($terms)) {
                    $product['categories'] = $terms;
                }
            }
            
            // Score berechnen
            $result = $matcher->calculate_score($keyword, $product);
            
            // Nur Produkte über Threshold behalten
            if ($matcher->meets_threshold($result['score'])) {
                $scored_products[] = [
                    'product' => $product,
                    'score'   => $result['score'],
                    'matches' => $result['matches'],
                ];
            }
        }
        
        // Nach Score sortieren
        $scored_products = $matcher->sort_by_score($scored_products);
        
        // Limit anwenden
        $scored_products = array_slice($scored_products, 0, $limit);
        
        // Nur Produkte zurückgeben (Score als Meta hinzufügen)
        $results = [];
        foreach ($scored_products as $item) {
            $product = $item['product'];
            $product['_fuzzy_score'] = $item['score'];
            $product['_fuzzy_matches'] = $item['matches'];
            $results[] = $product;
        }
        
        return $results;
    }
    
    /**
     * NEU: Suche eigene Produkte die zu externen Produkten passen
     * Nützlich um eigene Alternativen zu Amazon/Yadore Produkten zu finden
     * 
     * @param array<string, mixed> $external_product Ein Produkt von Amazon/Yadore
     * @param int $limit Max. ähnliche eigene Produkte
     * @return array<int, array<string, mixed>>
     */
    public function find_similar_own_products(array $external_product, int $limit = 3): array {
        $title = $external_product['title'] ?? '';
        
        if ($title === '') {
            return [];
        }
        
        // Fuzzy-Suche basierend auf dem Titel
        return $this->search_products_fuzzy($title, $limit, 25); // Etwas niedrigerer Threshold
    }
    
    /**
     * NEU: Prüft ob ein eigenes Produkt zu einem Keyword passt
     * 
     * @param int $product_id Post-ID
     * @param string $keyword Suchbegriff
     * @return array{matches: bool, score: float}
     */
    public function product_matches_keyword(int $product_id, string $keyword): array {
        $products = $this->get_products_by_ids([$product_id]);
        
        if (empty($products)) {
            return ['matches' => false, 'score' => 0.0];
        }
        
        $product = $products[0];
        
        // Fuzzy Keywords laden
        $fuzzy_keywords = get_post_meta($product_id, '_yaa_product_fuzzy_keywords', true) ?: '';
        if ($fuzzy_keywords !== '') {
            $product['keywords'] = array_map('trim', explode(',', $fuzzy_keywords));
        }
        
        // Kategorien laden
        $terms = wp_get_post_terms($product_id, self::TAXONOMY, ['fields' => 'names']);
        if (!is_wp_error($terms) && !empty($terms)) {
            $product['categories'] = $terms;
        }
        
        $matcher = $this->get_fuzzy_matcher();
        $result = $matcher->calculate_score($keyword, $product);
        
        return [
            'matches' => $matcher->meets_threshold($result['score']),
            'score'   => $result['score'],
        ];
    }
    
    /**
     * Format products to standard array format
     * 
     * @param array<\WP_Post> $posts
     * @return array<int, array<string, mixed>>
     */
    private function format_products(array $posts): array {
        $products = [];
        
        foreach ($posts as $post) {
            $external_image = get_post_meta($post->ID, '_yaa_product_external_image', true);
            $image_url = '';
            
            if (!empty($external_image)) {
                $image_url = $external_image;
            } elseif (has_post_thumbnail($post->ID)) {
                $image_url = get_the_post_thumbnail_url($post->ID, 'large');
            }
            
            $products[] = [
                'id'          => 'custom_' . $post->ID,
                'post_id'     => $post->ID,
                'title'       => $post->post_title,
                'description' => get_post_meta($post->ID, '_yaa_product_description', true) ?: '',
                'url'         => get_post_meta($post->ID, '_yaa_product_url', true) ?: '#',
                'image'       => [
                    'url' => $image_url,
                ],
                'price'       => [
                    'amount'   => get_post_meta($post->ID, '_yaa_product_price', true) ?: '',
                    'currency' => get_post_meta($post->ID, '_yaa_product_currency', true) ?: 'EUR',
                    'display'  => '',
                ],
                'merchant'    => [
                    'name' => get_post_meta($post->ID, '_yaa_product_merchant', true) ?: '',
                ],
                'source'      => 'custom',
                'is_prime'    => get_post_meta($post->ID, '_yaa_product_is_prime', true) === '1',
                'button_text' => get_post_meta($post->ID, '_yaa_product_button_text', true) ?: '',
            ];
        }
        
        return $products;
    }
    
    /**
     * Get post type name
     */
    public static function get_post_type(): string {
        return self::POST_TYPE;
    }
    
    /**
     * Get taxonomy name
     */
    public static function get_taxonomy(): string {
        return self::TAXONOMY;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-fuzzy-matcher.php 
 
<?php
/**
 * Fuzzy Matcher - Unscharfe Produktsuche für eigene Produkte
 * PHP 8.3+ compatible
 * 
 * Implementiert verschiedene Matching-Algorithmen:
 * - Levenshtein-Distanz
 * - Similar Text
 * - Wort-basiertes Matching
 * - Kategorie-Matching
 * - N-Gram Matching
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Fuzzy_Matcher {
    
    /**
     * Standard-Gewichtungen für verschiedene Matching-Faktoren
     */
    private const DEFAULT_WEIGHTS = [
        'title'       => 0.40,  // 40% - Titel ist am wichtigsten
        'description' => 0.25,  // 25% - Beschreibung
        'category'    => 0.20,  // 20% - Kategorie-Übereinstimmung
        'merchant'    => 0.10,  // 10% - Händler-Name
        'keywords'    => 0.05,  // 5% - Zusätzliche Keywords (Meta)
    ];
    
    /**
     * Standard-Schwellenwert für Mindest-Übereinstimmung (0-100)
     */
    private const DEFAULT_THRESHOLD = 30;
    
    /**
     * Deutsche Stoppwörter die beim Matching ignoriert werden
     */
    private const STOPWORDS_DE = [
        'der', 'die', 'das', 'den', 'dem', 'des', 'ein', 'eine', 'einer', 'einem', 'einen',
        'und', 'oder', 'aber', 'wenn', 'weil', 'dass', 'als', 'auch', 'nur', 'noch',
        'für', 'mit', 'von', 'bei', 'nach', 'aus', 'zum', 'zur', 'im', 'am', 'um',
        'ist', 'sind', 'war', 'hat', 'haben', 'wird', 'werden', 'kann', 'können',
        'auf', 'an', 'in', 'zu', 'so', 'wie', 'was', 'wer', 'wo', 'sehr', 'mehr',
        'nicht', 'kein', 'keine', 'keinen', 'keiner', 'ohne', 'bis', 'über', 'unter',
    ];
    
    /**
     * Englische Stoppwörter
     */
    private const STOPWORDS_EN = [
        'the', 'a', 'an', 'and', 'or', 'but', 'if', 'then', 'else', 'when', 'at', 'from',
        'by', 'on', 'off', 'for', 'in', 'out', 'over', 'to', 'into', 'with', 'is', 'are',
        'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did',
        'will', 'would', 'could', 'should', 'may', 'might', 'must', 'shall', 'can',
        'of', 'up', 'down', 'no', 'not', 'only', 'own', 'same', 'so', 'than', 'too',
        'very', 's', 't', 'just', 'don', 'now', 'new', 'old', 'all', 'any', 'both',
    ];
    
    /** @var array<string, float> */
    private array $weights;
    
    /** @var int */
    private int $threshold;
    
    /** @var array<string> */
    private array $stopwords;
    
    /**
     * Constructor
     * 
     * @param array<string, float>|null $weights Custom weights
     * @param int|null $threshold Minimum match score (0-100)
     */
    public function __construct(?array $weights = null, ?int $threshold = null) {
        $this->weights = $weights ?? $this->get_configured_weights();
        $this->threshold = $threshold ?? $this->get_configured_threshold();
        $this->stopwords = array_merge(self::STOPWORDS_DE, self::STOPWORDS_EN);
    }
    
    /**
     * Get configured weights from plugin settings
     * 
     * @return array<string, float>
     */
    private function get_configured_weights(): array {
        $weights = [];
        
        $weights['title'] = (float) yaa_get_option('fuzzy_weight_title', self::DEFAULT_WEIGHTS['title']);
        $weights['description'] = (float) yaa_get_option('fuzzy_weight_description', self::DEFAULT_WEIGHTS['description']);
        $weights['category'] = (float) yaa_get_option('fuzzy_weight_category', self::DEFAULT_WEIGHTS['category']);
        $weights['merchant'] = (float) yaa_get_option('fuzzy_weight_merchant', self::DEFAULT_WEIGHTS['merchant']);
        $weights['keywords'] = (float) yaa_get_option('fuzzy_weight_keywords', self::DEFAULT_WEIGHTS['keywords']);
        
        // Normalize weights to sum to 1.0
        $sum = array_sum($weights);
        if ($sum > 0 && $sum !== 1.0) {
            foreach ($weights as $key => $value) {
                $weights[$key] = $value / $sum;
            }
        }
        
        return $weights;
    }
    
    /**
     * Get configured threshold from plugin settings
     */
    private function get_configured_threshold(): int {
        return (int) yaa_get_option('fuzzy_threshold', self::DEFAULT_THRESHOLD);
    }
    
    /**
     * Calculate fuzzy match score between a keyword and a product
     * 
     * @param string $keyword Search keyword(s)
     * @param array<string, mixed> $product Product data array
     * @return array{score: float, matches: array<string, float>}
     */
    public function calculate_score(string $keyword, array $product): array {
        $keyword = $this->normalize_text($keyword);
        
        if ($keyword === '') {
            return ['score' => 0.0, 'matches' => []];
        }
        
        $matches = [];
        $total_score = 0.0;
        
        // 1. Title matching
        $title = $this->normalize_text($product['title'] ?? '');
        if ($title !== '') {
            $matches['title'] = $this->calculate_text_similarity($keyword, $title);
            $total_score += $matches['title'] * $this->weights['title'];
        }
        
        // 2. Description matching
        $description = $this->normalize_text($product['description'] ?? '');
        if ($description !== '') {
            $matches['description'] = $this->calculate_text_similarity($keyword, $description);
            $total_score += $matches['description'] * $this->weights['description'];
        }
        
        // 3. Category matching
        $categories = $product['categories'] ?? [];
        if (!empty($categories)) {
            $matches['category'] = $this->calculate_category_similarity($keyword, $categories);
            $total_score += $matches['category'] * $this->weights['category'];
        }
        
        // 4. Merchant matching
        $merchant = $this->normalize_text($product['merchant']['name'] ?? '');
        if ($merchant !== '') {
            $matches['merchant'] = $this->calculate_text_similarity($keyword, $merchant);
            $total_score += $matches['merchant'] * $this->weights['merchant'];
        }
        
        // 5. Additional keywords/tags matching
        $product_keywords = $product['keywords'] ?? $product['tags'] ?? [];
        if (!empty($product_keywords)) {
            if (is_string($product_keywords)) {
                $product_keywords = explode(',', $product_keywords);
            }
            $matches['keywords'] = $this->calculate_keywords_similarity($keyword, $product_keywords);
            $total_score += $matches['keywords'] * $this->weights['keywords'];
        }
        
        // Round to 2 decimal places
        $total_score = round($total_score * 100, 2);
        
        return [
            'score'   => $total_score,
            'matches' => $matches,
        ];
    }
    
    /**
     * Calculate text similarity using multiple algorithms
     * Returns a value between 0 and 1
     */
    private function calculate_text_similarity(string $search, string $target): float {
        if ($search === '' || $target === '') {
            return 0.0;
        }
        
        // Direct match bonus
        if ($target === $search) {
            return 1.0;
        }
        
        // Contains exact phrase bonus
        if (str_contains($target, $search)) {
            return 0.95;
        }
        
        $scores = [];
        
        // 1. Word-based matching (most important for product search)
        $scores[] = $this->word_match_score($search, $target) * 1.5; // Weight 1.5x
        
        // 2. Similar text percentage
        $similar_text_score = 0.0;
        similar_text($search, $target, $similar_text_score);
        $scores[] = $similar_text_score / 100;
        
        // 3. N-Gram matching (catches typos and partial matches)
        $scores[] = $this->ngram_similarity($search, $target, 2);
        
        // 4. Levenshtein for short strings (good for typo detection)
        if (strlen($search) <= 20 && strlen($target) <= 50) {
            $max_len = max(strlen($search), strlen($target));
            if ($max_len > 0) {
                $lev_distance = levenshtein(
                    substr($search, 0, 255), 
                    substr($target, 0, 255)
                );
                $scores[] = 1 - ($lev_distance / $max_len);
            }
        }
        
        // Weighted average (word matching is most important)
        $avg_score = count($scores) > 0 ? array_sum($scores) / count($scores) : 0.0;
        
        return min(1.0, max(0.0, $avg_score));
    }
    
    /**
     * Word-based matching score
     * Counts how many search words appear in the target
     */
    private function word_match_score(string $search, string $target): float {
        $search_words = $this->tokenize($search);
        $target_words = $this->tokenize($target);
        
        if (empty($search_words) || empty($target_words)) {
            return 0.0;
        }
        
        $matched_words = 0;
        $partial_matches = 0;
        
        foreach ($search_words as $search_word) {
            if (in_array($search_word, $target_words, true)) {
                // Exact word match
                $matched_words++;
            } else {
                // Check for partial matches (word starts with or contains)
                foreach ($target_words as $target_word) {
                    if (str_starts_with($target_word, $search_word) || 
                        str_starts_with($search_word, $target_word)) {
                        $partial_matches += 0.7;
                        break;
                    } elseif (str_contains($target_word, $search_word) || 
                              str_contains($search_word, $target_word)) {
                        $partial_matches += 0.4;
                        break;
                    }
                }
            }
        }
        
        $total_matches = $matched_words + $partial_matches;
        
        return $total_matches / count($search_words);
    }
    
    /**
     * N-Gram similarity (character-based)
     * Good for detecting typos and partial matches
     */
    private function ngram_similarity(string $a, string $b, int $n = 2): float {
        $ngrams_a = $this->get_ngrams($a, $n);
        $ngrams_b = $this->get_ngrams($b, $n);
        
        if (empty($ngrams_a) || empty($ngrams_b)) {
            return 0.0;
        }
        
        $intersection = array_intersect($ngrams_a, $ngrams_b);
        $union = array_unique(array_merge($ngrams_a, $ngrams_b));
        
        if (count($union) === 0) {
            return 0.0;
        }
        
        // Jaccard similarity
        return count($intersection) / count($union);
    }
    
    /**
     * Get n-grams from a string
     * 
     * @return array<string>
     */
    private function get_ngrams(string $text, int $n): array {
        $text = preg_replace('/\s+/', '', $text) ?? $text;
        $length = strlen($text);
        
        if ($length < $n) {
            return [$text];
        }
        
        $ngrams = [];
        for ($i = 0; $i <= $length - $n; $i++) {
            $ngrams[] = substr($text, $i, $n);
        }
        
        return $ngrams;
    }
    
    /**
     * Calculate category similarity
     * 
     * @param array<string> $categories
     */
    private function calculate_category_similarity(string $keyword, array $categories): float {
        if (empty($categories)) {
            return 0.0;
        }
        
        $keyword_normalized = $this->normalize_text($keyword);
        $keyword_words = $this->tokenize($keyword_normalized);
        
        $best_score = 0.0;
        
        foreach ($categories as $category) {
            $cat_normalized = $this->normalize_text($category);
            
            // Direct match
            if ($cat_normalized === $keyword_normalized) {
                return 1.0;
            }
            
            // Contains check
            if (str_contains($cat_normalized, $keyword_normalized)) {
                $best_score = max($best_score, 0.9);
                continue;
            }
            
            // Word match in category
            $cat_words = $this->tokenize($cat_normalized);
            foreach ($keyword_words as $kw) {
                if (in_array($kw, $cat_words, true)) {
                    $best_score = max($best_score, 0.8);
                }
            }
            
            // Partial similarity
            $similarity = $this->calculate_text_similarity($keyword_normalized, $cat_normalized);
            $best_score = max($best_score, $similarity * 0.7);
        }
        
        return $best_score;
    }
    
    /**
     * Calculate keywords/tags similarity
     * 
     * @param array<string> $product_keywords
     */
    private function calculate_keywords_similarity(string $search, array $product_keywords): float {
        if (empty($product_keywords)) {
            return 0.0;
        }
        
        $search_normalized = $this->normalize_text($search);
        $search_words = $this->tokenize($search_normalized);
        
        $matched = 0;
        $total = count($product_keywords);
        
        foreach ($product_keywords as $tag) {
            $tag_normalized = $this->normalize_text(trim($tag));
            
            // Direct match
            if ($tag_normalized === $search_normalized) {
                return 1.0;
            }
            
            // Word contains
            foreach ($search_words as $word) {
                if ($tag_normalized === $word || str_contains($tag_normalized, $word)) {
                    $matched++;
                    break;
                }
            }
        }
        
        return $total > 0 ? $matched / $total : 0.0;
    }
    
    /**
     * Normalize text for comparison
     */
    private function normalize_text(string $text): string {
        // Lowercase
        $text = mb_strtolower($text, 'UTF-8');
        
        // Remove special characters but keep umlauts
        $text = preg_replace('/[^\p{L}\p{N}\s]/u', ' ', $text) ?? $text;
        
        // Replace umlauts for better matching
        $text = str_replace(
            ['ä', 'ö', 'ü', 'ß'],
            ['ae', 'oe', 'ue', 'ss'],
            $text
        );
        
        // Normalize whitespace
        $text = preg_replace('/\s+/', ' ', $text) ?? $text;
        
        return trim($text);
    }
    
    /**
     * Tokenize text into words (removing stopwords)
     * 
     * @return array<string>
     */
    private function tokenize(string $text): array {
        $words = explode(' ', $text);
        $words = array_filter($words, fn($word) => strlen($word) >= 2);
        
        // Remove stopwords
        $words = array_diff($words, $this->stopwords);
        
        return array_values($words);
    }
    
    /**
     * Check if score meets threshold
     */
    public function meets_threshold(float $score): bool {
        return $score >= $this->threshold;
    }
    
    /**
     * Get current threshold
     */
    public function get_threshold(): int {
        return $this->threshold;
    }
    
    /**
     * Set threshold
     */
    public function set_threshold(int $threshold): self {
        $this->threshold = max(0, min(100, $threshold));
        return $this;
    }
    
    /**
     * Get current weights
     * 
     * @return array<string, float>
     */
    public function get_weights(): array {
        return $this->weights;
    }
    
    /**
     * Sort products by score descending
     * 
     * @param array<array{product: array<string, mixed>, score: float}> $scored_products
     * @return array<array{product: array<string, mixed>, score: float}>
     */
    public function sort_by_score(array $scored_products): array {
        usort($scored_products, fn($a, $b) => $b['score'] <=> $a['score']);
        return $scored_products;
    }
    
    /**
     * Static helper: Quick similarity check
     */
    public static function quick_match(string $search, string $target): float {
        $matcher = new self();
        return $matcher->calculate_text_similarity(
            $matcher->normalize_text($search),
            $matcher->normalize_text($target)
        );
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-image-handler.php 
 
<?php
/**
 * Image Handler Class
 * Version: 1.5.1
 * PHP 8.3+ compatible
 * 
 * FIX 1.5.1: TLS-Fingerprinting Problem behoben
 *            - Keine Browser-spezifischen Headers mehr (Sec-Ch-Ua etc.)
 *            - Einfacher, konsistenter User-Agent
 *            - Funktioniert mit CDNs die JA3-Fingerprinting nutzen
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

class YAA_Image_Handler {

    private const MAX_RETRIES = 3;
    private const RETRY_COOLDOWN_HOURS = 1;
    private const MAX_LOG_ENTRIES = 100;
    private const SEO_NAME_MAX_LENGTH = 30;
    
    private const IMAGE_SIZES = [
        'Large'  => 500,
        'Medium' => 160,
        'Small'  => 75,
    ];

    public static function can_resize_images(): bool {
        return self::get_image_library() !== 'None';
    }

    public static function get_image_library(): string {
        if (extension_loaded('imagick') && class_exists('Imagick')) {
            return 'Imagick';
        }
        if (extension_loaded('gd') && function_exists('imagecreatetruecolor')) {
            return 'GD';
        }
        return 'None';
    }

    public static function get_max_dimension(string $size = 'Large'): int {
        return self::IMAGE_SIZES[$size] ?? self::IMAGE_SIZES['Large'];
    }

    /**
     * Process an image: Download if not exists, return local URL.
     */
    public static function process(
        ?string $remote_url, 
        string $id, 
        string $product_name = '',
        string $source = ''
    ): string {
        if (empty($remote_url)) {
            return self::get_placeholder_url();
        }

        if (self::should_skip_retry($remote_url)) {
            self::debug_log('Skipping retry for URL (too many failures): ' . $remote_url);
            return self::get_placeholder_url();
        }

        $upload_dir = wp_upload_dir();
        if (isset($upload_dir['error']) && $upload_dir['error'] !== false) {
            return $remote_url;
        }

        $base_dir = $upload_dir['basedir'] . '/yadore-amazon-api';
        $base_url = $upload_dir['baseurl'] . '/yadore-amazon-api';

        if (!file_exists($base_dir)) {
            if (!wp_mkdir_p($base_dir)) {
                return $remote_url;
            }
            file_put_contents($base_dir . '/index.php', '<?php // Silence is golden');
        }

        $path_parts = pathinfo(parse_url($remote_url, PHP_URL_PATH) ?? '');
        $ext = isset($path_parts['extension']) ? strtolower($path_parts['extension']) : 'jpg';
        
        $ext = match($ext) {
            'jpeg' => 'jpg',
            'webp', 'png', 'gif', 'jpg' => $ext,
            default => 'jpg',
        };
        
        $filename = self::generate_filename($id, $product_name, $source, $ext);
        $file_path = $base_dir . '/' . $filename;
        $file_url = $base_url . '/' . $filename;

        $existing_file = self::find_existing_file($base_dir, $base_url, $id, $source, $ext);
        if ($existing_file !== null) {
            return $existing_file;
        }

        if (file_exists($file_path)) {
            if (filesize($file_path) > 100 && self::is_valid_image_file($file_path)) {
                return $file_url;
            }
            @unlink($file_path);
        }

        // Download mit verbesserter Methode
        self::debug_log('Starting download for: ' . $remote_url);
        
        $download_result = self::download_image_smart($remote_url);
        
        if ($download_result === false || $download_result === '') {
            self::log_failed_image($remote_url, $id, 'Download failed (all methods)');
            self::increment_retry_counter($remote_url);
            return self::get_placeholder_url();
        }

        if (!self::is_valid_image_data($download_result)) {
            self::log_failed_image($remote_url, $id, 'Invalid image data');
            self::increment_retry_counter($remote_url);
            return self::get_placeholder_url();
        }

        if (strlen($download_result) < 500) {
            self::log_failed_image($remote_url, $id, 'Image too small (likely tracking pixel)');
            self::increment_retry_counter($remote_url);
            return self::get_placeholder_url();
        }

        if (file_put_contents($file_path, $download_result) === false) {
            self::log_failed_image($remote_url, $id, 'Could not save file');
            return self::get_placeholder_url();
        }

        $resize_enabled = function_exists('yaa_get_option') 
            ? yaa_get_option('image_resize_enabled', 'yes') === 'yes' 
            : false;
        
        if ($resize_enabled && self::can_resize_images()) {
            $preferred_size = function_exists('yaa_get_option') 
                ? yaa_get_option('preferred_image_size', 'Large') 
                : 'Large';
            
            self::resize_image($file_path, $preferred_size);
        }

        self::clear_retry_counter($remote_url);
        
        self::debug_log('Successfully downloaded: ' . $remote_url . ' -> ' . $file_path);

        return $file_url;
    }

    private static function debug_log(string $message): void {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('YAA Image Handler: ' . $message);
        }
    }

    /**
     * FIX 1.5.1: Smart Download mit mehreren Methoden
     * 
     * Reihenfolge:
     * 1. curl MINIMAL (keine verdächtigen Headers) - BESTE METHODE
     * 2. curl mit einfachem User-Agent
     * 3. wp_remote_get 
     * 4. file_get_contents
     */
    public static function download_image_smart(string $url): string|false {
        // Methode 1: curl MINIMAL - wie auf der Konsole
        $result = self::download_with_curl_minimal($url);
        if ($result !== false && strlen($result) > 500) {
            self::debug_log('curl MINIMAL succeeded for: ' . $url);
            return $result;
        }
        self::debug_log('curl MINIMAL failed for: ' . $url);
        
        // Methode 2: curl mit einfachem User-Agent
        $result = self::download_with_curl_simple($url);
        if ($result !== false && strlen($result) > 500) {
            self::debug_log('curl SIMPLE succeeded for: ' . $url);
            return $result;
        }
        
        // Methode 3: wp_remote_get
        $result = self::download_with_wp_remote($url);
        if ($result !== false && strlen($result) > 500) {
            self::debug_log('wp_remote_get succeeded for: ' . $url);
            return $result;
        }
        
        // Methode 4: file_get_contents
        $result = self::download_with_stream_context($url);
        if ($result !== false && strlen($result) > 500) {
            self::debug_log('stream_context succeeded for: ' . $url);
            return $result;
        }
        
        self::debug_log('All download methods failed for: ' . $url);
        return false;
    }

    /**
     * FIX 1.5.1: MINIMALER curl Request - wie auf der Konsole
     * 
     * Keine zusätzlichen Headers!
     * Der Befehl `curl -I URL` funktioniert - also machen wir genau das.
     */
    private static function download_with_curl_minimal(string $url): string|false {
        if (!function_exists('curl_init')) {
            return false;
        }
        
        $ch = curl_init();
        
        curl_setopt_array($ch, [
            CURLOPT_URL            => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_MAXREDIRS      => 5,
            CURLOPT_TIMEOUT        => 30,
            CURLOPT_CONNECTTIMEOUT => 10,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => 0,
            // KEINE zusätzlichen Headers!
            // KEIN User-Agent!
            // KEIN Referer!
            // Genau wie: curl -o file.jpg URL
            CURLOPT_ENCODING       => '', // Akzeptiert gzip automatisch
        ]);
        
        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $error = curl_error($ch);
        
        curl_close($ch);
        
        if ($response === false) {
            self::debug_log('curl MINIMAL error: ' . $error . ' - URL: ' . $url);
            return false;
        }
        
        if ($http_code !== 200) {
            self::debug_log('curl MINIMAL HTTP ' . $http_code . ' - URL: ' . $url);
            return false;
        }
        
        return $response;
    }

    /**
     * FIX 1.5.1: Einfacher curl mit generischem User-Agent
     * 
     * WICHTIG: Keine Browser-spezifischen Headers (Sec-Ch-Ua etc.)
     * Diese verraten, dass wir Chrome nachahmen, aber der TLS-Fingerprint
     * zeigt PHP/OpenSSL - das führt zu Blocking!
     */
    private static function download_with_curl_simple(string $url): string|false {
        if (!function_exists('curl_init')) {
            return false;
        }
        
        $ch = curl_init();
        
        // Generischer, ehrlicher User-Agent
        // NICHT Chrome vortäuschen - das führt zu TLS-Fingerprint Mismatch!
        $user_agent = 'Mozilla/5.0 (compatible; WordPress/' . get_bloginfo('version') . ')';
        
        curl_setopt_array($ch, [
            CURLOPT_URL            => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_MAXREDIRS      => 5,
            CURLOPT_TIMEOUT        => 30,
            CURLOPT_CONNECTTIMEOUT => 10,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => 0,
            CURLOPT_USERAGENT      => $user_agent,
            CURLOPT_ENCODING       => '',
            // NUR einfache, nicht-verdächtige Headers
            CURLOPT_HTTPHEADER     => [
                'Accept: image/*,*/*;q=0.8',
                'Accept-Language: de-DE,de;q=0.9,en;q=0.8',
            ],
        ]);
        
        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $error = curl_error($ch);
        
        curl_close($ch);
        
        if ($response === false) {
            self::debug_log('curl SIMPLE error: ' . $error . ' - URL: ' . $url);
            return false;
        }
        
        if ($http_code !== 200) {
            self::debug_log('curl SIMPLE HTTP ' . $http_code . ' - URL: ' . $url);
            return false;
        }
        
        return $response;
    }

    /**
     * Download mit wp_remote_get (WordPress native)
     */
    private static function download_with_wp_remote(string $url): string|false {
        $response = wp_remote_get($url, [
            'timeout'    => 30,
            'sslverify'  => false,
            // WordPress Standard User-Agent verwenden
            'headers'    => [
                'Accept' => 'image/*,*/*;q=0.8',
            ],
        ]);

        if (is_wp_error($response)) {
            self::debug_log('wp_remote error: ' . $response->get_error_message() . ' - URL: ' . $url);
            return false;
        }

        $status_code = wp_remote_retrieve_response_code($response);
        if ($status_code !== 200) {
            self::debug_log('wp_remote HTTP ' . $status_code . ' - URL: ' . $url);
            return false;
        }

        return wp_remote_retrieve_body($response);
    }

    /**
     * Download mit file_get_contents und Stream Context (Fallback)
     */
    private static function download_with_stream_context(string $url): string|false {
        if (!ini_get('allow_url_fopen')) {
            return false;
        }
        
        $opts = [
            'http' => [
                'method'           => 'GET',
                'timeout'          => 30,
                'follow_location'  => true,
                'max_redirects'    => 5,
                'ignore_errors'    => true,
                // Minimale Headers
                'header'           => 'Accept: image/*,*/*',
            ],
            'ssl' => [
                'verify_peer'      => false,
                'verify_peer_name' => false,
            ],
        ];
        
        $context = stream_context_create($opts);
        
        $result = @file_get_contents($url, false, $context);
        
        if ($result === false) {
            self::debug_log('stream error - URL: ' . $url);
            return false;
        }
        
        return $result;
    }

    // ========================================
    // Ab hier: Unveränderte Methoden
    // ========================================

    public static function resize_image(string $file_path, string $size_setting = 'Large'): bool {
        if (!file_exists($file_path)) {
            return false;
        }

        $max_dimension = self::get_max_dimension($size_setting);
        $library = self::get_image_library();

        if ($library === 'None') {
            return false;
        }

        $image_info = @getimagesize($file_path);
        if ($image_info === false) {
            return false;
        }

        $width = $image_info[0];
        $height = $image_info[1];
        $mime = $image_info['mime'] ?? '';

        if ($width <= $max_dimension && $height <= $max_dimension) {
            return true;
        }

        if ($width > $height) {
            $new_width = $max_dimension;
            $new_height = (int) round(($height / $width) * $max_dimension);
        } else {
            $new_height = $max_dimension;
            $new_width = (int) round(($width / $height) * $max_dimension);
        }

        if ($library === 'Imagick') {
            return self::resize_with_imagick($file_path, $new_width, $new_height);
        } else {
            return self::resize_with_gd($file_path, $new_width, $new_height, $mime);
        }
    }

    private static function resize_with_imagick(string $file_path, int $width, int $height): bool {
        try {
            $imagick = new \Imagick($file_path);
            $imagick->resizeImage($width, $height, \Imagick::FILTER_LANCZOS, 1);
            $imagick->setImageCompressionQuality(85);
            $imagick->stripImage();
            $result = $imagick->writeImage($file_path);
            $imagick->destroy();
            return $result;
        } catch (\Exception $e) {
            error_log('YAA Imagick resize error: ' . $e->getMessage());
            return false;
        }
    }

    private static function resize_with_gd(string $file_path, int $width, int $height, string $mime): bool {
        try {
            $source = match($mime) {
                'image/jpeg' => @imagecreatefromjpeg($file_path),
                'image/png'  => @imagecreatefrompng($file_path),
                'image/gif'  => @imagecreatefromgif($file_path),
                'image/webp' => function_exists('imagecreatefromwebp') ? @imagecreatefromwebp($file_path) : false,
                default      => false,
            };

            if ($source === false) {
                return false;
            }

            $source_width = imagesx($source);
            $source_height = imagesy($source);

            $dest = imagecreatetruecolor($width, $height);
            
            if ($dest === false) {
                imagedestroy($source);
                return false;
            }

            if ($mime === 'image/png' || $mime === 'image/gif') {
                imagealphablending($dest, false);
                imagesavealpha($dest, true);
                $transparent = imagecolorallocatealpha($dest, 0, 0, 0, 127);
                imagefill($dest, 0, 0, $transparent);
            }

            imagecopyresampled(
                $dest, $source,
                0, 0, 0, 0,
                $width, $height,
                $source_width, $source_height
            );

            $result = match($mime) {
                'image/jpeg' => imagejpeg($dest, $file_path, 85),
                'image/png'  => imagepng($dest, $file_path, 6),
                'image/gif'  => imagegif($dest, $file_path),
                'image/webp' => function_exists('imagewebp') ? imagewebp($dest, $file_path, 85) : false,
                default      => false,
            };

            imagedestroy($source);
            imagedestroy($dest);

            return $result;
        } catch (\Exception $e) {
            error_log('YAA GD resize error: ' . $e->getMessage());
            return false;
        }
    }

    public static function generate_filename(
        string $id, 
        string $product_name = '', 
        string $source = '',
        string $ext = 'jpg'
    ): string {
        $format = function_exists('yaa_get_option') 
            ? yaa_get_option('image_filename_format', 'seo') 
            : 'seo';
        
        $ext = preg_replace('/[^a-z0-9]/i', '', strtolower($ext)) ?: 'jpg';
        
        if ($format === 'seo' && $product_name !== '') {
            return self::generate_seo_filename($product_name, $ext);
        }
        
        return self::generate_id_filename($id, $source, $ext);
    }

    private static function generate_seo_filename(string $product_name, string $ext): string {
        $name = self::sanitize_for_filename($product_name);
        
        if (mb_strlen($name, 'UTF-8') > self::SEO_NAME_MAX_LENGTH) {
            $name = mb_substr($name, 0, self::SEO_NAME_MAX_LENGTH, 'UTF-8');
            $name = rtrim($name, '-');
        }
        
        if ($name === '') {
            $name = 'product';
        }
        
        $timestamp = time();
        
        return $name . '_' . $timestamp . '.' . $ext;
    }

    private static function generate_id_filename(string $id, string $source, string $ext): string {
        $prefix = '';
        
        if ($source !== '') {
            $prefix = sanitize_file_name($source) . '_';
        }
        
        $safe_id = sanitize_file_name($id);
        
        if ($safe_id === '') {
            $safe_id = uniqid('img_');
        }
        
        return $prefix . $safe_id . '.' . $ext;
    }

    private static function sanitize_for_filename(string $text): string {
        $text = mb_strtolower($text, 'UTF-8');
        
        $text = str_replace(
            ['ä', 'ö', 'ü', 'ß', 'Ä', 'Ö', 'Ü'],
            ['ae', 'oe', 'ue', 'ss', 'ae', 'oe', 'ue'],
            $text
        );
        
        $text = str_replace(
            ['&', '+', '@', '#', '$', '%', '/', '\\', '|', ':', ';', '"', "'", '<', '>', '?', '*'],
            '-',
            $text
        );
        
        $text = preg_replace('/[^a-z0-9\-]/u', '-', $text) ?? $text;
        $text = preg_replace('/-+/', '-', $text) ?? $text;
        $text = trim($text, '-');
        
        return $text;
    }

    private static function find_existing_file(
        string $base_dir, 
        string $base_url, 
        string $id, 
        string $source,
        string $ext
    ): ?string {
        $id_filename = self::generate_id_filename($id, $source, $ext);
        $id_path = $base_dir . '/' . $id_filename;
        
        if (file_exists($id_path) && filesize($id_path) > 100 && self::is_valid_image_file($id_path)) {
            return $base_url . '/' . $id_filename;
        }
        
        if ($source !== '') {
            $simple_filename = sanitize_file_name($id) . '.' . $ext;
            $simple_path = $base_dir . '/' . $simple_filename;
            
            if (file_exists($simple_path) && filesize($simple_path) > 100 && self::is_valid_image_file($simple_path)) {
                return $base_url . '/' . $simple_filename;
            }
        }
        
        return null;
    }

    public static function process_with_retry(
        ?string $remote_url, 
        string $id, 
        string $product_name = '',
        string $source = ''
    ): string {
        return self::process($remote_url, $id, $product_name, $source);
    }

    public static function is_remote_url_accessible(string $url): bool {
        if (empty($url)) {
            return false;
        }

        // HEAD-Checks bei bekannten Domains überspringen
        $skip_domains = ['proshop.de', 'amazon.', 'ebay.', 'otto.de', 'mediamarkt.', 'saturn.', 'office-partner.de', 'keycdn'];
        
        $url_host = parse_url($url, PHP_URL_HOST) ?? '';
        foreach ($skip_domains as $domain) {
            if (str_contains($url_host, $domain)) {
                return true;
            }
        }

        return true; // Immer versuchen zu laden
    }

    public static function is_valid_image_data(string $data): bool {
        if (strlen($data) < 8) {
            return false;
        }

        $signatures = [
            "\xFF\xD8\xFF" => 'jpeg',
            "\x89PNG" => 'png',
            "GIF87a" => 'gif',
            "GIF89a" => 'gif',
            "RIFF" => 'webp_check',
        ];

        foreach ($signatures as $sig => $type) {
            if (str_starts_with($data, $sig)) {
                if ($type === 'webp_check') {
                    if (strlen($data) >= 12 && substr($data, 8, 4) === 'WEBP') {
                        return true;
                    }
                    continue;
                }
                return true;
            }
        }

        if (str_starts_with($data, "BM")) {
            return true;
        }

        return false;
    }

    public static function is_valid_image_file(string $file_path): bool {
        if (!file_exists($file_path) || !is_readable($file_path)) {
            return false;
        }

        $handle = fopen($file_path, 'rb');
        if ($handle === false) {
            return false;
        }

        $header = fread($handle, 12);
        fclose($handle);

        if ($header === false) {
            return false;
        }

        return self::is_valid_image_data($header);
    }

    private static function should_skip_retry(string $url): bool {
        $retry_key = 'yaa_img_retry_' . md5($url);
        $retry_data = get_transient($retry_key);

        if ($retry_data === false) {
            return false;
        }

        if (!is_array($retry_data)) {
            return false;
        }

        return ($retry_data['count'] ?? 0) >= self::MAX_RETRIES;
    }

    private static function increment_retry_counter(string $url): void {
        $retry_key = 'yaa_img_retry_' . md5($url);
        $retry_data = get_transient($retry_key);

        $count = 1;
        if (is_array($retry_data)) {
            $count = ($retry_data['count'] ?? 0) + 1;
        }

        $expiration = $count * self::RETRY_COOLDOWN_HOURS * HOUR_IN_SECONDS;

        set_transient($retry_key, [
            'count'      => $count,
            'last_try'   => time(),
            'url'        => $url,
        ], $expiration);
    }

    private static function clear_retry_counter(string $url): void {
        $retry_key = 'yaa_img_retry_' . md5($url);
        delete_transient($retry_key);
    }

    public static function reset_all_retry_counters(): int {
        global $wpdb;
        
        $deleted = $wpdb->query(
            "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_yaa_img_retry_%'"
        );
        
        $wpdb->query(
            "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_yaa_img_retry_%'"
        );
        
        return (int) $deleted;
    }

    public static function log_failed_image(string $url, string $product_id, string $reason): void {
        $log = get_option('yaa_failed_images_log', []);

        if (!is_array($log)) {
            $log = [];
        }

        $url_hash = md5($url);
        $one_hour_ago = time() - HOUR_IN_SECONDS;

        foreach ($log as $entry) {
            if (md5($entry['url'] ?? '') === $url_hash && ($entry['timestamp'] ?? 0) > $one_hour_ago) {
                return;
            }
        }

        $log[] = [
            'url'        => $url,
            'product_id' => $product_id,
            'reason'     => $reason,
            'timestamp'  => time(),
            'time'       => current_time('mysql'),
        ];

        $log = array_slice($log, -self::MAX_LOG_ENTRIES);

        update_option('yaa_failed_images_log', $log, false);
    }

    public static function get_failed_images_log(): array {
        $log = get_option('yaa_failed_images_log', []);
        return is_array($log) ? $log : [];
    }

    public static function clear_failed_images_log(): void {
        delete_option('yaa_failed_images_log');
    }

    public static function get_recent_failures_count(): int {
        $log = self::get_failed_images_log();
        $one_day_ago = time() - DAY_IN_SECONDS;

        $count = 0;
        foreach ($log as $entry) {
            if (($entry['timestamp'] ?? 0) > $one_day_ago) {
                $count++;
            }
        }

        return $count;
    }

    public static function get_placeholder_url(): string {
        $svg = '<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
            <defs>
                <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#1a1a1a"/>
                    <stop offset="100%" style="stop-color:#2d2d2d"/>
                </linearGradient>
            </defs>
            <rect width="400" height="400" fill="url(#bg)"/>
            <g transform="translate(200,180)" fill="none" stroke="#444" stroke-width="3">
                <rect x="-60" y="-40" width="120" height="80" rx="8"/>
                <circle cx="-30" cy="-15" r="12"/>
                <path d="M-50 30 L-20 0 L10 20 L40 -20 L60 10 L60 35 L-60 35 Z" fill="#333"/>
                <line x1="0" y1="45" x2="0" y2="65"/>
                <line x1="-20" y1="65" x2="20" y2="65"/>
            </g>
            <text x="200" y="280" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" fill="#555" letter-spacing="2">BILD NICHT VERFÜGBAR</text>
        </svg>';

        return 'data:image/svg+xml;base64,' . base64_encode($svg);
    }

    public static function get_placeholder_url_colored(string $source = ''): string {
        $color = match($source) {
            'amazon' => '#ff9900',
            'custom' => '#4CAF50',
            'yadore' => '#ff00cc',
            default  => '#666666',
        };

        $svg = '<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
            <rect width="400" height="400" fill="#1a1a1a"/>
            <rect x="0" y="395" width="400" height="5" fill="' . $color . '"/>
            <g transform="translate(200,180)" fill="none" stroke="#444" stroke-width="3">
                <rect x="-60" y="-40" width="120" height="80" rx="8"/>
                <circle cx="-30" cy="-15" r="12"/>
                <path d="M-50 30 L-20 0 L10 20 L40 -20 L60 10 L60 35 L-60 35 Z" fill="#333"/>
            </g>
            <text x="200" y="280" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" fill="#555">Bild nicht verfügbar</text>
        </svg>';

        return 'data:image/svg+xml;base64,' . base64_encode($svg);
    }

    public static function cleanup_old_images(int $days_old = 90): int {
        $upload_dir = wp_upload_dir();
        $image_dir = $upload_dir['basedir'] . '/yadore-amazon-api';

        if (!is_dir($image_dir)) {
            return 0;
        }

        $deleted = 0;
        $threshold = time() - ($days_old * DAY_IN_SECONDS);

        $files = glob($image_dir . '/*');
        if ($files === false) {
            return 0;
        }

        foreach ($files as $file) {
            if (is_file($file) && filemtime($file) < $threshold) {
                if (@unlink($file)) {
                    $deleted++;
                }
            }
        }

        return $deleted;
    }

    public static function get_statistics(): array {
        $upload_dir = wp_upload_dir();
        $image_dir = $upload_dir['basedir'] . '/yadore-amazon-api';

        $stats = [
            'count'          => 0,
            'size'           => 0,
            'size_formatted' => '0 B',
            'oldest'         => null,
            'newest'         => null,
        ];

        if (!is_dir($image_dir)) {
            return $stats;
        }

        $files = glob($image_dir . '/*');
        if ($files === false || empty($files)) {
            return $stats;
        }

        foreach ($files as $file) {
            if (is_file($file) && basename($file) !== 'index.php') {
                $stats['count']++;
                $stats['size'] += filesize($file);
                
                $mtime = filemtime($file);
                if ($stats['oldest'] === null || $mtime < $stats['oldest']) {
                    $stats['oldest'] = $mtime;
                }
                if ($stats['newest'] === null || $mtime > $stats['newest']) {
                    $stats['newest'] = $mtime;
                }
            }
        }

        $size = $stats['size'];
        if ($size < 1024) {
            $stats['size_formatted'] = $size . ' B';
        } elseif ($size < 1024 * 1024) {
            $stats['size_formatted'] = round($size / 1024, 1) . ' KB';
        } else {
            $stats['size_formatted'] = round($size / (1024 * 1024), 2) . ' MB';
        }

        return $stats;
    }

    public static function preview_seo_filename(string $product_name): string {
        return self::generate_seo_filename($product_name, 'jpg');
    }

    /**
     * Test download methods for debugging
     */
    public static function test_download_methods(string $test_url = ''): array {
        $results = [
            'curl_available'        => function_exists('curl_init'),
            'curl_version'          => function_exists('curl_version') ? curl_version()['version'] ?? 'unknown' : null,
            'allow_url_fopen'       => (bool) ini_get('allow_url_fopen'),
            'openssl_available'     => extension_loaded('openssl'),
            'image_library'         => self::get_image_library(),
        ];
        
        if ($test_url !== '') {
            $results['test_url'] = $test_url;
            
            // Test curl MINIMAL
            $start = microtime(true);
            $curl_minimal = self::download_with_curl_minimal($test_url);
            $results['curl_minimal_test'] = [
                'success'  => $curl_minimal !== false && strlen($curl_minimal) > 500,
                'size'     => $curl_minimal !== false ? strlen($curl_minimal) : 0,
                'time_ms'  => round((microtime(true) - $start) * 1000),
                'is_image' => $curl_minimal !== false ? self::is_valid_image_data($curl_minimal) : false,
            ];
            
            // Test curl SIMPLE
            $start = microtime(true);
            $curl_simple = self::download_with_curl_simple($test_url);
            $results['curl_simple_test'] = [
                'success'  => $curl_simple !== false && strlen($curl_simple) > 500,
                'size'     => $curl_simple !== false ? strlen($curl_simple) : 0,
                'time_ms'  => round((microtime(true) - $start) * 1000),
                'is_image' => $curl_simple !== false ? self::is_valid_image_data($curl_simple) : false,
            ];
            
            // Test wp_remote
            $start = microtime(true);
            $wp_result = self::download_with_wp_remote($test_url);
            $results['wp_remote_test'] = [
                'success'  => $wp_result !== false && strlen($wp_result) > 500,
                'size'     => $wp_result !== false ? strlen($wp_result) : 0,
                'time_ms'  => round((microtime(true) - $start) * 1000),
                'is_image' => $wp_result !== false ? self::is_valid_image_data($wp_result) : false,
            ];
        }
        
        return $results;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-image-proxy.php 
 
<?php
/**
 * Image Proxy Handler
 * Server-seitiger Proxy für externe Bilder
 * Umgeht Hotlink-Protection und CORS-Probleme
 * 
 * PHP 8.3+ compatible
 * Version: 1.0.0
 * 
 * @see Anforderung: Option C - Server-seitiger Bild-Proxy
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Image_Proxy {
    
    /**
     * Cache-Dauer für Proxy-Bilder (24 Stunden)
     */
    private const CACHE_DURATION = DAY_IN_SECONDS;
    
    /**
     * Maximale Bildgröße die gecacht wird (5 MB)
     */
    private const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
    
    /**
     * Timeout für Remote-Requests (Sekunden)
     */
    private const REQUEST_TIMEOUT = 15;
    
    /**
     * Erlaubte MIME-Types
     */
    private const ALLOWED_MIME_TYPES = [
        'image/jpeg',
        'image/png',
        'image/gif',
        'image/webp',
        'image/svg+xml',
    ];
    
    /**
     * Erlaubte Hosts (leer = alle erlaubt)
     * Kann über Filter erweitert werden
     * 
     * @var array<string>
     */
    private array $allowed_hosts = [];
    
    /**
     * Constructor
     */
    public function __construct() {
        // AJAX Actions registrieren (für eingeloggte und nicht-eingeloggte User)
        add_action('wp_ajax_yaa_proxy_image', [$this, 'handle_proxy_request']);
        add_action('wp_ajax_nopriv_yaa_proxy_image', [$this, 'handle_proxy_request']);
        
        // REST API Endpoint (Alternative zu AJAX)
        add_action('rest_api_init', [$this, 'register_rest_route']);
        
        // Erlaubte Hosts über Filter laden
        $this->allowed_hosts = apply_filters('yaa_proxy_allowed_hosts', [
            // Standard: Bekannte Produkt-Bild-Hosts
            'images-na.ssl-images-amazon.com',
            'images-eu.ssl-images-amazon.com',
            'm.media-amazon.com',
            'images.yadore.com',
            'cdn.yadore.com',
        ]);
    }
    
    /**
     * Generiert die Proxy-URL für ein Bild
     * 
     * @param string $image_url Original-Bild-URL
     * @param string $source Quelle (amazon, yadore, custom)
     * @return string Proxy-URL
     */
    public static function get_proxy_url(string $image_url, string $source = ''): string {
        if ($image_url === '') {
            return '';
        }
        
        // Bereits lokale URL? Kein Proxy nötig
        $site_url = get_site_url();
        if (str_starts_with($image_url, $site_url)) {
            return $image_url;
        }
        
        // Data-URLs brauchen keinen Proxy
        if (str_starts_with($image_url, 'data:')) {
            return $image_url;
        }
        
        // Proxy-URL generieren
        $params = [
            'action' => 'yaa_proxy_image',
            'url'    => $image_url,
        ];
        
        // Source für Logging/Debugging
        if ($source !== '') {
            $params['source'] = $source;
        }
        
        // Nonce für Sicherheit (optional, da öffentlich zugänglich)
        // $params['_wpnonce'] = wp_create_nonce('yaa_proxy_image');
        
        return admin_url('admin-ajax.php') . '?' . http_build_query($params);
    }
    
    /**
     * Generiert REST API Proxy-URL (Alternative)
     * 
     * @param string $image_url Original-Bild-URL
     * @return string REST API Proxy-URL
     */
    public static function get_rest_proxy_url(string $image_url): string {
        if ($image_url === '') {
            return '';
        }
        
        return rest_url('yaa/v1/image-proxy') . '?' . http_build_query([
            'url' => $image_url,
        ]);
    }
    
    /**
     * REST API Route registrieren
     */
    public function register_rest_route(): void {
        register_rest_route('yaa/v1', '/image-proxy', [
            'methods'             => 'GET',
            'callback'            => [$this, 'handle_rest_request'],
            'permission_callback' => '__return_true', // Öffentlich zugänglich
            'args'                => [
                'url' => [
                    'required'          => true,
                    'type'              => 'string',
                    'sanitize_callback' => 'esc_url_raw',
                ],
            ],
        ]);
    }
    
    /**
     * AJAX Handler für Proxy-Requests
     */
    public function handle_proxy_request(): void {
        // URL aus Request holen
        $url = isset($_GET['url']) ? esc_url_raw(wp_unslash($_GET['url'])) : '';
        
        if ($url === '') {
            $this->send_error_response('No URL provided', 400);
            return;
        }
        
        // Bild laden und ausgeben
        $this->proxy_image($url);
    }
    
    /**
     * REST API Handler für Proxy-Requests
     * 
     * @param \WP_REST_Request $request
     * @return \WP_REST_Response|\WP_Error
     */
    public function handle_rest_request(\WP_REST_Request $request): \WP_REST_Response|\WP_Error {
        $url = $request->get_param('url');
        
        if (empty($url)) {
            return new \WP_Error('no_url', 'No URL provided', ['status' => 400]);
        }
        
        // Bild laden und als Response zurückgeben
        $result = $this->fetch_image($url);
        
        if (is_wp_error($result)) {
            return $result;
        }
        
        // Bei REST API: Bild direkt ausgeben mit korrekten Headern
        $this->output_image($result['body'], $result['type']);
        exit; // Nach Bildausgabe beenden
    }
    
    /**
     * Hauptfunktion: Bild proxyen
     * 
     * @param string $url Externe Bild-URL
     */
    private function proxy_image(string $url): void {
        // URL validieren
        if (!$this->is_valid_url($url)) {
            $this->send_error_response('Invalid URL', 400);
            return;
        }
        
        // Host-Whitelist prüfen (wenn aktiviert)
        if (!$this->is_host_allowed($url)) {
            $this->send_error_response('Host not allowed', 403);
            return;
        }
        
        // Cache prüfen
        $cache_key = 'yaa_proxy_' . md5($url);
        $cached = get_transient($cache_key);
        
        if ($cached !== false && is_array($cached)) {
            // Aus Cache laden
            $this->output_image($cached['body'], $cached['type'], true);
            return;
        }
        
        // Bild von externer URL laden
        $result = $this->fetch_image($url);
        
        if (is_wp_error($result)) {
            $this->send_error_response($result->get_error_message(), 502);
            return;
        }
        
        // In Cache speichern (wenn nicht zu groß)
        if (strlen($result['body']) <= self::MAX_IMAGE_SIZE) {
            set_transient($cache_key, $result, self::CACHE_DURATION);
        }
        
        // Bild ausgeben
        $this->output_image($result['body'], $result['type'], false);
    }
    
    /**
     * Bild von externer URL laden
     * 
     * @param string $url Externe URL
     * @return array{body: string, type: string}|\WP_Error
     */
    private function fetch_image(string $url): array|\WP_Error {
        // HTTP Request mit angepassten Headern
        $response = wp_remote_get($url, [
            'timeout'    => self::REQUEST_TIMEOUT,
            'sslverify'  => false, // Manche CDNs haben ungültige Zertifikate
            'user-agent' => $this->get_user_agent(),
            'headers'    => [
                'Accept'          => 'image/webp,image/apng,image/*,*/*;q=0.8',
                'Accept-Language' => 'de-DE,de;q=0.9,en;q=0.8',
                'Cache-Control'   => 'no-cache',
                'Referer'         => home_url(), // Manche Server prüfen den Referer
            ],
        ]);
        
        if (is_wp_error($response)) {
            error_log('YAA Image Proxy Error: ' . $response->get_error_message() . ' - URL: ' . $url);
            return $response;
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        
        if ($status_code !== 200) {
            error_log('YAA Image Proxy HTTP Error: ' . $status_code . ' - URL: ' . $url);
            return new \WP_Error(
                'http_error',
                sprintf('HTTP Error %d', $status_code),
                ['status' => $status_code]
            );
        }
        
        $body = wp_remote_retrieve_body($response);
        $content_type = wp_remote_retrieve_header($response, 'content-type');
        
        // Content-Type validieren
        if (!$this->is_valid_content_type($content_type)) {
            // Versuche Content-Type aus Magic Bytes zu ermitteln
            $detected_type = $this->detect_image_type($body);
            
            if ($detected_type === null) {
                error_log('YAA Image Proxy: Invalid content type - URL: ' . $url);
                return new \WP_Error('invalid_type', 'Not a valid image');
            }
            
            $content_type = $detected_type;
        }
        
        // Mindestgröße prüfen (Tracking-Pixel filtern)
        if (strlen($body) < 100) {
            error_log('YAA Image Proxy: Image too small (tracking pixel?) - URL: ' . $url);
            return new \WP_Error('too_small', 'Image too small');
        }
        
        return [
            'body' => $body,
            'type' => $content_type,
        ];
    }
    
    /**
     * Bild mit korrekten Headern ausgeben
     * 
     * @param string $body Bild-Daten
     * @param string $content_type MIME-Type
     * @param bool $from_cache Ob aus Cache geladen
     */
    private function output_image(string $body, string $content_type, bool $from_cache = false): void {
        // Status Code
        http_response_code(200);
        
        // Content-Type Header
        header('Content-Type: ' . $content_type);
        
        // Caching Header
        header('Cache-Control: public, max-age=86400'); // 24 Stunden
        header('Expires: ' . gmdate('D, d M Y H:i:s', time() + 86400) . ' GMT');
        
        // ETag für Browser-Caching
        $etag = '"' . md5($body) . '"';
        header('ETag: ' . $etag);
        
        // If-None-Match prüfen (304 Not Modified)
        $if_none_match = $_SERVER['HTTP_IF_NONE_MATCH'] ?? '';
        if ($if_none_match === $etag) {
            http_response_code(304);
            exit;
        }
        
        // Content-Length
        header('Content-Length: ' . strlen($body));
        
        // Debug-Header (optional)
        if (defined('WP_DEBUG') && WP_DEBUG) {
            header('X-YAA-Proxy: ' . ($from_cache ? 'cache' : 'fetch'));
        }
        
        // CORS Header (erlaubt Zugriff von überall)
        header('Access-Control-Allow-Origin: *');
        
        // Bild ausgeben
        echo $body;
        exit;
    }
    
    /**
     * Fehler-Response senden
     * 
     * @param string $message Fehlermeldung
     * @param int $status_code HTTP Status Code
     */
    private function send_error_response(string $message, int $status_code = 400): void {
        http_response_code($status_code);
        
        // Placeholder-Bild als Fallback
        $placeholder = $this->generate_error_placeholder($message);
        
        header('Content-Type: image/svg+xml');
        header('Cache-Control: no-cache, no-store, must-revalidate');
        header('X-YAA-Proxy-Error: ' . $message);
        
        echo $placeholder;
        exit;
    }
    
    /**
     * URL validieren
     */
    private function is_valid_url(string $url): bool {
        if ($url === '') {
            return false;
        }
        
        // Nur HTTP(S) URLs erlauben
        if (!preg_match('/^https?:\/\//i', $url)) {
            return false;
        }
        
        // URL-Validierung
        $parsed = wp_parse_url($url);
        
        if ($parsed === false || empty($parsed['host'])) {
            return false;
        }
        
        // Keine lokalen IPs
        $host = $parsed['host'];
        $ip = gethostbyname($host);
        
        if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE) === false) {
            // Erlaube dennoch, falls es sich um einen gültigen Hostnamen handelt
            // (manche CDNs resolven zu privaten IPs)
            if ($ip === $host) {
                return false; // Konnte nicht aufgelöst werden
            }
        }
        
        return true;
    }
    
    /**
     * Prüft ob Host in Whitelist ist
     */
    private function is_host_allowed(string $url): bool {
        // Wenn keine Whitelist definiert, alle erlauben
        if (empty($this->allowed_hosts)) {
            return true;
        }
        
        $parsed = wp_parse_url($url);
        $host = $parsed['host'] ?? '';
        
        if ($host === '') {
            return false;
        }
        
        // Exakter Match oder Subdomain-Match
        foreach ($this->allowed_hosts as $allowed) {
            if ($host === $allowed) {
                return true;
            }
            
            // Subdomain-Match (z.B. "*.amazon.com")
            if (str_ends_with($host, '.' . $allowed)) {
                return true;
            }
        }
        
        // Filter für dynamische Erweiterung
        return apply_filters('yaa_proxy_is_host_allowed', false, $host, $url);
    }
    
    /**
     * Content-Type validieren
     */
    private function is_valid_content_type(?string $content_type): bool {
        if ($content_type === null || $content_type === '') {
            return false;
        }
        
        // Nur den MIME-Type extrahieren (charset etc. ignorieren)
        $parts = explode(';', $content_type);
        $mime = strtolower(trim($parts[0]));
        
        return in_array($mime, self::ALLOWED_MIME_TYPES, true);
    }
    
    /**
     * Bildtyp aus Magic Bytes erkennen
     */
    private function detect_image_type(string $data): ?string {
        if (strlen($data) < 12) {
            return null;
        }
        
        // Magic Bytes prüfen
        if (str_starts_with($data, "\xFF\xD8\xFF")) {
            return 'image/jpeg';
        }
        
        if (str_starts_with($data, "\x89PNG\r\n\x1A\n")) {
            return 'image/png';
        }
        
        if (str_starts_with($data, "GIF87a") || str_starts_with($data, "GIF89a")) {
            return 'image/gif';
        }
        
        if (str_starts_with($data, "RIFF") && substr($data, 8, 4) === "WEBP") {
            return 'image/webp';
        }
        
        // SVG (Text-basiert)
        if (str_contains(substr($data, 0, 500), '<svg')) {
            return 'image/svg+xml';
        }
        
        return null;
    }
    
    /**
     * User-Agent für Requests
     */
    private function get_user_agent(): string {
        // Realistischer Browser User-Agent
        return 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';
    }
    
    /**
     * Error-Placeholder SVG generieren
     */
    private function generate_error_placeholder(string $message): string {
        $escaped_message = htmlspecialchars($message, ENT_QUOTES, 'UTF-8');
        
        return <<<SVG
<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
    <defs>
        <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#2d2d2d"/>
            <stop offset="100%" style="stop-color:#1a1a1a"/>
        </linearGradient>
    </defs>
    <rect width="400" height="400" fill="url(#bg)"/>
    <g transform="translate(200,160)" fill="none" stroke="#666" stroke-width="2">
        <circle cx="0" cy="0" r="50"/>
        <line x1="-20" y1="-20" x2="20" y2="20"/>
        <line x1="20" y1="-20" x2="-20" y2="20"/>
    </g>
    <text x="200" y="260" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" fill="#888">
        Bild nicht verfügbar
    </text>
    <text x="200" y="285" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#555">
        {$escaped_message}
    </text>
</svg>
SVG;
    }
    
    /**
     * Cache für eine URL löschen
     * 
     * @param string $url Original-Bild-URL
     */
    public static function clear_cache(string $url): void {
        $cache_key = 'yaa_proxy_' . md5($url);
        delete_transient($cache_key);
    }
    
    /**
     * Alle Proxy-Caches löschen
     */
    public static function clear_all_cache(): int {
        global $wpdb;
        
        $deleted = $wpdb->query(
            "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_yaa_proxy_%'"
        );
        
        $wpdb->query(
            "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_yaa_proxy_%'"
        );
        
        return (int) $deleted;
    }
    
    /**
     * Statistiken über gecachte Proxy-Bilder
     * 
     * @return array{count: int, estimated_size: string}
     */
    public static function get_cache_stats(): array {
        global $wpdb;
        
        $count = (int) $wpdb->get_var(
            "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '_transient_yaa_proxy_%' AND option_name NOT LIKE '_transient_timeout_%'"
        );
        
        // Geschätzte Größe (können wir nicht exakt bestimmen ohne alle zu laden)
        $estimated_size = $count > 0 ? '~' . size_format($count * 50000) : '0 B';
        
        return [
            'count'          => $count,
            'estimated_size' => $estimated_size,
        ];
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-merchant-filter.php 
 
<?php
/**
 * Merchant Filter - Whitelist/Blacklist für Yadore Händler
 * PHP 8.3+ compatible
 * Version: 1.3.0
 * 
 * Features:
 * - Whitelist (hat Vorrang)
 * - Blacklist
 * - Matching auf Händlername (case-insensitive, partial match)
 * - Shortcode Override
 * - Händlerliste via /v2/merchant API
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Merchant_Filter {
    
    /**
     * Cache key für Merchant-Liste
     */
    private const MERCHANT_CACHE_KEY = 'yadore_merchants_list';
    
    /**
     * Cache duration für Merchant-Liste (4 Stunden)
     */
    private const MERCHANT_CACHE_DURATION = 4 * HOUR_IN_SECONDS;
    
    /**
     * Filtert Produkte basierend auf Whitelist/Blacklist
     * Whitelist hat IMMER Vorrang vor Blacklist
     * 
     * @param array<int, array<string, mixed>> $products Produkte von der API
     * @param array<string, mixed> $filter_config Filter-Konfiguration
     * @return array<int, array<string, mixed>> Gefilterte Produkte
     */
    public static function filter_products(array $products, array $filter_config): array {
        $whitelist = $filter_config['whitelist'] ?? [];
        $blacklist = $filter_config['blacklist'] ?? [];
        
        // Normalisieren
        $whitelist = self::normalize_merchant_list($whitelist);
        $blacklist = self::normalize_merchant_list($blacklist);
        
        // Wenn weder Whitelist noch Blacklist, alle zurückgeben
        if (empty($whitelist) && empty($blacklist)) {
            return $products;
        }
        
        return array_values(array_filter($products, function($product) use ($whitelist, $blacklist) {
            $merchant_name = $product['merchant']['name'] ?? '';
            
            if ($merchant_name === '') {
                // Produkte ohne Händlernamen: Nur durchlassen wenn keine Whitelist aktiv
                return empty($whitelist);
            }
            
            // Whitelist hat Vorrang
            if (!empty($whitelist)) {
                return self::matches_any($merchant_name, $whitelist);
            }
            
            // Blacklist prüfen
            if (!empty($blacklist)) {
                return !self::matches_any($merchant_name, $blacklist);
            }
            
            return true;
        }));
    }
    
    /**
     * Prüft ob ein Händlername mit einem der Filter-Einträge übereinstimmt
     * Case-insensitive, partial match
     * 
     * @param string $merchant_name Der zu prüfende Händlername
     * @param array<string> $filter_list Liste der Filter-Einträge
     * @return bool True wenn Match gefunden
     */
    public static function matches_any(string $merchant_name, array $filter_list): bool {
        $merchant_lower = mb_strtolower($merchant_name, 'UTF-8');
        
        foreach ($filter_list as $filter) {
            $filter_lower = mb_strtolower(trim($filter), 'UTF-8');
            
            if ($filter_lower === '') {
                continue;
            }
            
            // Exakter Match
            if ($merchant_lower === $filter_lower) {
                return true;
            }
            
            // Partial Match (Händlername enthält Filter oder umgekehrt)
            if (str_contains($merchant_lower, $filter_lower) || str_contains($filter_lower, $merchant_lower)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * Normalisiert eine Händlerliste (String oder Array)
     * 
     * @param string|array<string> $list
     * @return array<string>
     */
    public static function normalize_merchant_list(string|array $list): array {
        if (is_string($list)) {
            if ($list === '') {
                return [];
            }
            $list = explode(',', $list);
        }
        
        // Trimmen und leere Einträge entfernen
        $list = array_map('trim', $list);
        $list = array_filter($list, fn($item) => $item !== '');
        
        return array_values($list);
    }
    
    /**
     * Erstellt Filter-Konfiguration aus Shortcode-Attributen und globalen Einstellungen
     * Shortcode-Attribute haben Vorrang
     * 
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return array{whitelist: array<string>, blacklist: array<string>}
     */
    public static function build_filter_config(array $atts): array {
        // Shortcode-Attribute prüfen
        $shortcode_whitelist = $atts['merchant_whitelist'] ?? $atts['merchants'] ?? '';
        $shortcode_blacklist = $atts['merchant_blacklist'] ?? $atts['exclude_merchants'] ?? '';
        
        // Wenn Shortcode-Attribute gesetzt sind, haben diese Vorrang
        if ($shortcode_whitelist !== '' || $shortcode_blacklist !== '') {
            return [
                'whitelist' => self::normalize_merchant_list($shortcode_whitelist),
                'blacklist' => self::normalize_merchant_list($shortcode_blacklist),
            ];
        }
        
        // Globale Einstellungen laden
        $global_whitelist = yaa_get_option('yadore_merchant_whitelist', '');
        $global_blacklist = yaa_get_option('yadore_merchant_blacklist', '');
        
        return [
            'whitelist' => self::normalize_merchant_list($global_whitelist),
            'blacklist' => self::normalize_merchant_list($global_blacklist),
        ];
    }
    
    /**
     * Holt die Händlerliste von der Yadore API
     * 
     * @param string $api_key Yadore API Key
     * @param string $market Markt (de, at, ch, etc.)
     * @param bool $force_refresh Cache ignorieren
     * @return array{success: bool, merchants: array<array{id: string, name: string, offerCount: int}>, error?: string}
     */
    public static function fetch_merchants(string $api_key, string $market = 'de', bool $force_refresh = false): array {
        if ($api_key === '') {
            return [
                'success' => false,
                'merchants' => [],
                'error' => __('Kein API-Key konfiguriert.', 'yadore-amazon-api'),
            ];
        }
        
        // Cache prüfen
        $cache_key = self::MERCHANT_CACHE_KEY . '_' . $market;
        
        if (!$force_refresh) {
            $cached = get_transient($cache_key);
            if ($cached !== false && is_array($cached)) {
                return [
                    'success' => true,
                    'merchants' => $cached,
                    'from_cache' => true,
                ];
            }
        }
        
        // API Request
        $url = 'https://api.yadore.com/v2/merchant?' . http_build_query([
            'market' => $market,
        ]);
        
        $response = wp_remote_get($url, [
            'timeout' => 30,
            'headers' => [
                'API-Key' => $api_key,
                'Accept'  => 'application/json',
            ],
        ]);
        
        if (is_wp_error($response)) {
            return [
                'success' => false,
                'merchants' => [],
                'error' => $response->get_error_message(),
            ];
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code !== 200 || !is_array($data)) {
            return [
                'success' => false,
                'merchants' => [],
                'error' => sprintf(__('API Fehler: HTTP %d', 'yadore-amazon-api'), $status_code),
            ];
        }
        
        // Händler extrahieren und normalisieren
        $merchants = [];
        $raw_merchants = $data['merchants'] ?? [];
        
        foreach ($raw_merchants as $merchant) {
            $merchants[] = [
                'id'         => $merchant['id'] ?? '',
                'name'       => $merchant['name'] ?? '',
                'offerCount' => (int) ($merchant['offerCount'] ?? 0),
                'logo'       => $merchant['logo']['url'] ?? '',
                'hasLogo'    => (bool) ($merchant['logo']['exists'] ?? false),
            ];
        }
        
        // Nach Name sortieren
        usort($merchants, fn($a, $b) => strcasecmp($a['name'], $b['name']));
        
        // Cache speichern
        set_transient($cache_key, $merchants, self::MERCHANT_CACHE_DURATION);
        
        // Auch in Option speichern für Offline-Nutzung
        update_option('yaa_yadore_merchants_' . $market, $merchants, false);
        update_option('yaa_yadore_merchants_updated_' . $market, time(), false);
        
        return [
            'success' => true,
            'merchants' => $merchants,
            'total' => $data['total'] ?? count($merchants),
            'from_cache' => false,
        ];
    }
    
    /**
     * Holt die gespeicherte Händlerliste (für Admin-Bereich)
     * 
     * @param string $market Markt
     * @return array<array{id: string, name: string, offerCount: int}>
     */
    public static function get_stored_merchants(string $market = 'de'): array {
        $merchants = get_option('yaa_yadore_merchants_' . $market, []);
        return is_array($merchants) ? $merchants : [];
    }
    
    /**
     * Gibt das letzte Update-Datum zurück
     * 
     * @param string $market Markt
     * @return int|null Unix Timestamp oder null
     */
    public static function get_last_update(string $market = 'de'): ?int {
        $timestamp = get_option('yaa_yadore_merchants_updated_' . $market, null);
        return $timestamp !== null ? (int) $timestamp : null;
    }
    
    /**
     * Löscht den Merchant-Cache
     * 
     * @param string|null $market Markt oder null für alle
     */
    public static function clear_cache(?string $market = null): void {
        if ($market !== null) {
            delete_transient(self::MERCHANT_CACHE_KEY . '_' . $market);
        } else {
            // Alle Märkte löschen
            global $wpdb;
            $wpdb->query(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_" . self::MERCHANT_CACHE_KEY . "_%'"
            );
        }
    }
    
    /**
     * Prüft ob ein Händler in der Whitelist ist
     * 
     * @param string $merchant_name Händlername
     * @return bool
     */
    public static function is_whitelisted(string $merchant_name): bool {
        $whitelist = self::normalize_merchant_list(yaa_get_option('yadore_merchant_whitelist', ''));
        
        if (empty($whitelist)) {
            return true; // Keine Whitelist = alle erlaubt
        }
        
        return self::matches_any($merchant_name, $whitelist);
    }
    
    /**
     * Prüft ob ein Händler in der Blacklist ist
     * 
     * @param string $merchant_name Händlername
     * @return bool
     */
    public static function is_blacklisted(string $merchant_name): bool {
        $blacklist = self::normalize_merchant_list(yaa_get_option('yadore_merchant_blacklist', ''));
        
        if (empty($blacklist)) {
            return false; // Keine Blacklist = keiner geblockt
        }
        
        return self::matches_any($merchant_name, $blacklist);
    }
    
    /**
     * Generiert ein HTML-Select für Händlerauswahl (Admin)
     * 
     * @param string $name Input name
     * @param array<string> $selected Ausgewählte Händler
     * @param string $market Markt
     * @param string $placeholder Placeholder-Text
     * @return string HTML
     */
    public static function render_merchant_select(
        string $name, 
        array $selected, 
        string $market = 'de',
        string $placeholder = ''
    ): string {
        $merchants = self::get_stored_merchants($market);
        $selected_lower = array_map(fn($s) => mb_strtolower(trim($s), 'UTF-8'), $selected);
        
        $html = '<select name="' . esc_attr($name) . '[]" multiple class="yaa-merchant-select" ';
        $html .= 'data-placeholder="' . esc_attr($placeholder ?: __('Händler auswählen...', 'yadore-amazon-api')) . '">';
        
        foreach ($merchants as $merchant) {
            $name_lower = mb_strtolower($merchant['name'], 'UTF-8');
            $is_selected = in_array($name_lower, $selected_lower, true) || in_array($merchant['name'], $selected, true);
            
            $html .= '<option value="' . esc_attr($merchant['name']) . '"';
            $html .= $is_selected ? ' selected' : '';
            $html .= '>';
            $html .= esc_html($merchant['name']);
            if ($merchant['offerCount'] > 0) {
                $html .= ' (' . number_format($merchant['offerCount'], 0, ',', '.') . ' Angebote)';
            }
            $html .= '</option>';
        }
        
        $html .= '</select>';
        
        return $html;
    }
    
    /**
     * Validiert und bereinigt eine Händlerliste für die Speicherung
     * 
     * @param string|array<string> $input
     * @return string Komma-separierte Liste
     */
    public static function sanitize_merchant_list(string|array $input): string {
        $list = self::normalize_merchant_list($input);
        return implode(', ', $list);
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-search-shortcode.php 
 
<?php
/**
 * Interaktive Produktsuche für Besucher
 * Mit Initial-Produkten vor der Suche
 * 
 * @package Yadore_Amazon_API
 * @since 1.6.1
 * 
 * FIX 1.6.1:
 * - fetch_yadore_products korrigiert: market und precision Parameter hinzugefügt
 * - Cache-Bypass für Initial-Produkte optional
 * - Bessere Fehlerbehandlung bei API-Aufrufen
 * - Debug-Logging hinzugefügt
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

class YAA_Search_Shortcode {

    /**
     * Yadore API instance
     */
    private YAA_Yadore_API $yadore_api;

    /**
     * Amazon PA-API instance
     */
    private YAA_Amazon_PAAPI $amazon_api;

    /**
     * Shortcode wurde bereits gerendert (für Asset-Loading)
     */
    private static bool $shortcode_rendered = false;

    /**
     * Standard-Einstellungen
     * 
     * @var array<string, mixed>
     */
    private array $defaults = [
        // Suchformular
        'placeholder'       => 'Produkt suchen...',
        'button_text'       => 'Suchen',
        'min_chars'         => 3,
        'debounce'          => 500,
        'live_search'       => true,
        
        // Initial-Produkte
        'show_initial'      => true,
        'initial_keyword'   => '',
        'initial_keywords'  => '',
        'initial_count'     => 6,
        'initial_title'     => 'Empfohlene Produkte',
        'initial_source'    => 'yadore',
        
        // Anzeige-Optionen
        'network'           => '',
        'max_results'       => 12,
        'columns'           => 3,
        'show_price'        => true,
        'show_merchant'     => true,
        'new_tab'           => true,
        'sort'              => 'rel_desc', // Geändert von cpc_desc zu rel_desc für stabilere Ergebnisse
        'merchant_filter'   => '',
        
        // API-Optionen (NEU)
        'market'            => '', // Leer = Plugin-Standard verwenden
        'precision'         => '', // Leer = Plugin-Standard verwenden
        
        // UI-Optionen
        'show_reset'        => true,
        'hide_form'         => false,
        'debug'             => false, // NEU: Debug-Modus
    ];

    /**
     * Constructor - akzeptiert Dependency Injection
     * 
     * @param YAA_Yadore_API $yadore_api Yadore API instance
     * @param YAA_Amazon_PAAPI $amazon_api Amazon API instance
     */
    public function __construct(YAA_Yadore_API $yadore_api, YAA_Amazon_PAAPI $amazon_api) {
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        
        add_shortcode('yadore_search', [$this, 'render_shortcode']);
        add_action('wp_ajax_yadore_product_search', [$this, 'ajax_search']);
        add_action('wp_ajax_nopriv_yadore_product_search', [$this, 'ajax_search']);
        add_action('wp_enqueue_scripts', [$this, 'register_assets']);
    }

    /**
     * Assets registrieren
     */
    public function register_assets(): void {
        wp_register_style(
            'yadore-search',
            YAA_PLUGIN_URL . 'assets/css/yaa-search.css',
            [],
            YAA_VERSION
        );

        wp_register_script(
            'yadore-search',
            YAA_PLUGIN_URL . 'assets/js/yaa-search.js',
            ['jquery'],
            YAA_VERSION,
            true
        );

        wp_localize_script('yadore-search', 'yadoreSearch', [
            'ajaxurl'   => admin_url('admin-ajax.php'),
            'nonce'     => wp_create_nonce('yadore_search_nonce'),
            'i18n'      => [
                'searching'      => __('Suche läuft...', 'yadore-amazon-api'),
                'no_results'     => __('Keine Produkte gefunden.', 'yadore-amazon-api'),
                'error'          => __('Fehler bei der Suche. Bitte erneut versuchen.', 'yadore-amazon-api'),
                'min_chars'      => __('Bitte mindestens %d Zeichen eingeben.', 'yadore-amazon-api'),
                'view_offer'     => __('Zum Angebot', 'yadore-amazon-api'),
                'reset'          => __('← Zurück zu Empfehlungen', 'yadore-amazon-api'),
                'results_for'    => __('Ergebnisse für', 'yadore-amazon-api'),
            ],
        ]);
    }

    /**
     * Shortcode rendern
     * 
     * @param array<string, mixed>|string $atts Shortcode-Attribute
     * @return string HTML-Output
     */
    public function render_shortcode(array|string $atts = []): string {
        $atts = shortcode_atts($this->defaults, $atts, 'yadore_search');

        // Booleans normalisieren
        $atts['show_initial'] = filter_var($atts['show_initial'], FILTER_VALIDATE_BOOLEAN);
        $atts['live_search'] = filter_var($atts['live_search'], FILTER_VALIDATE_BOOLEAN);
        $atts['show_price'] = filter_var($atts['show_price'], FILTER_VALIDATE_BOOLEAN);
        $atts['show_merchant'] = filter_var($atts['show_merchant'], FILTER_VALIDATE_BOOLEAN);
        $atts['new_tab'] = filter_var($atts['new_tab'], FILTER_VALIDATE_BOOLEAN);
        $atts['show_reset'] = filter_var($atts['show_reset'], FILTER_VALIDATE_BOOLEAN);
        $atts['hide_form'] = filter_var($atts['hide_form'], FILTER_VALIDATE_BOOLEAN);
        $atts['debug'] = filter_var($atts['debug'], FILTER_VALIDATE_BOOLEAN);
        
        // Numerische Werte sicherstellen
        $atts['initial_count'] = max(1, (int) $atts['initial_count']);
        $atts['max_results'] = max(1, (int) $atts['max_results']);
        $atts['columns'] = max(1, min(6, (int) $atts['columns']));

        // Assets nur einmal laden
        if (!self::$shortcode_rendered) {
            wp_enqueue_style('yadore-search');
            wp_enqueue_script('yadore-search');
            self::$shortcode_rendered = true;
        }

        // Unique ID für mehrere Instanzen auf einer Seite
        $instance_id = 'yadore-search-' . wp_unique_id();

        // Initial-Produkte laden (serverseitig)
        $initial_products = [];
        $initial_html = '';
        $debug_output = '';
        
        if ($atts['show_initial']) {
            $initial_products = $this->get_initial_products($atts);
            
            // Debug-Ausgabe
            if ($atts['debug']) {
                $debug_output = sprintf(
                    '<!-- YAA Debug: initial_count=%d, products_loaded=%d, keywords=%s -->',
                    $atts['initial_count'],
                    count($initial_products),
                    esc_html($atts['initial_keywords'] ?: $atts['initial_keyword'])
                );
            }
            
            $initial_html = $this->render_product_grid($initial_products, $atts);
        }

        // Data-Attribute für JS
        $data_attrs = [
            'data-network'         => esc_attr((string) $atts['network']),
            'data-max-results'     => (int) $atts['max_results'],
            'data-columns'         => (int) $atts['columns'],
            'data-min-chars'       => (int) $atts['min_chars'],
            'data-show-price'      => $atts['show_price'] ? '1' : '0',
            'data-show-merchant'   => $atts['show_merchant'] ? '1' : '0',
            'data-new-tab'         => $atts['new_tab'] ? '1' : '0',
            'data-debounce'        => (int) $atts['debounce'],
            'data-live-search'     => $atts['live_search'] ? '1' : '0',
            'data-sort'            => esc_attr((string) $atts['sort']),
            'data-merchant-filter' => esc_attr((string) $atts['merchant_filter']),
            'data-show-initial'    => $atts['show_initial'] ? '1' : '0',
            'data-show-reset'      => $atts['show_reset'] ? '1' : '0',
            'data-has-initial'     => !empty($initial_products) ? '1' : '0',
        ];

        $data_string = '';
        foreach ($data_attrs as $key => $value) {
            $data_string .= sprintf(' %s="%s"', $key, $value);
        }

        ob_start();
        echo $debug_output;
        ?>
        <div id="<?php echo esc_attr($instance_id); ?>" class="yadore-search-container"<?php echo $data_string; ?>>
            
            <?php if (!$atts['hide_form']): ?>
            <!-- Suchformular -->
            <form class="yadore-search-form" autocomplete="off">
                <div class="yadore-search-input-wrapper">
                    <input 
                        type="text" 
                        class="yadore-search-input" 
                        placeholder="<?php echo esc_attr((string) $atts['placeholder']); ?>"
                        aria-label="<?php echo esc_attr((string) $atts['placeholder']); ?>"
                    >
                    <button type="submit" class="yadore-search-button">
                        <span class="yadore-search-button-text"><?php echo esc_html((string) $atts['button_text']); ?></span>
                        <span class="yadore-search-spinner" style="display: none;">
                            <svg class="yadore-spinner-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="31.4 31.4">
                                    <animateTransform attributeName="transform" type="rotate" dur="1s" from="0 12 12" to="360 12 12" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
            <?php endif; ?>

            <!-- Status-Meldungen -->
            <div class="yadore-search-status" style="display: none;"></div>

            <!-- Initial-Produkte (Server-gerendert) -->
            <?php if ($atts['show_initial'] && !empty($initial_products)): ?>
            <div class="yadore-initial-products">
                <div class="yadore-initial-header">
                    <h3 class="yadore-initial-title"><?php echo esc_html((string) $atts['initial_title']); ?></h3>
                </div>
                <div class="yadore-search-results-grid yadore-columns-<?php echo (int) $atts['columns']; ?>">
                    <?php echo $initial_html; ?>
                </div>
            </div>
            <?php elseif ($atts['show_initial'] && empty($initial_products) && $atts['debug']): ?>
            <div class="yadore-initial-products">
                <p style="color: #999; font-style: italic;">Debug: Keine Initial-Produkte geladen. Prüfe API-Konfiguration und Keywords.</p>
            </div>
            <?php endif; ?>

            <!-- Such-Ergebnisse (wird via JS befüllt) -->
            <div class="yadore-search-results" style="display: none;">
                <div class="yadore-search-results-header">
                    <?php if ($atts['show_reset']): ?>
                    <button type="button" class="yadore-reset-button">
                        <?php echo esc_html__('← Zurück zu Empfehlungen', 'yadore-amazon-api'); ?>
                    </button>
                    <?php endif; ?>
                    <div class="yadore-search-results-info">
                        <span class="yadore-search-results-count"></span>
                        <span class="yadore-search-results-query"></span>
                    </div>
                </div>
                <div class="yadore-search-results-grid yadore-columns-<?php echo (int) $atts['columns']; ?>"></div>
            </div>

        </div>
        <?php
        return ob_get_clean() ?: '';
    }

    /**
     * Initial-Produkte laden
     * 
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return array<int, array<string, mixed>> Produkte
     */
    private function get_initial_products(array $atts): array {
        $products = [];
        $count = (int) $atts['initial_count'];
        $source = (string) $atts['initial_source'];
        
        // Keywords verarbeiten
        $keywords = [];
        if (!empty($atts['initial_keywords'])) {
            $keywords = array_map('trim', explode(',', (string) $atts['initial_keywords']));
            $keywords = array_filter($keywords);
        } elseif (!empty($atts['initial_keyword'])) {
            $keywords = [trim((string) $atts['initial_keyword'])];
        }

        // Debug-Log
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'YAA Search: get_initial_products called - count=%d, source=%s, keywords=%s',
                $count,
                $source,
                implode(',', $keywords)
            ));
        }

        // Wenn keine Keywords, versuche Featured/Trending zu laden
        if (empty($keywords)) {
            $keywords = $this->get_default_keywords();
        }

        // Produkte von Yadore laden
        if (in_array($source, ['yadore', 'both'], true)) {
            $yadore_products = $this->fetch_yadore_products($keywords, $count, $atts);
            $products = array_merge($products, $yadore_products);
            
            // Debug-Log
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'YAA Search: Yadore returned %d products',
                    count($yadore_products)
                ));
            }
        }

        // Produkte von Amazon laden
        if (in_array($source, ['amazon', 'both'], true)) {
            $remaining = $count - count($products);
            if ($remaining > 0) {
                $amazon_products = $this->fetch_amazon_products($keywords, $remaining, $atts);
                $products = array_merge($products, $amazon_products);
            }
        }

        // Auf gewünschte Anzahl begrenzen
        return array_slice($products, 0, $count);
    }

    /**
     * Default-Keywords für Initial-Produkte
     * 
     * @return array<string> Keywords
     */
    private function get_default_keywords(): array {
        // Option 1: Aus Plugin-Einstellungen
        $saved_keywords = yaa_get_option('yadore_featured_keywords', '');
        if (!empty($saved_keywords) && is_string($saved_keywords)) {
            return array_map('trim', explode(',', $saved_keywords));
        }

        // Option 2: Hardcoded Fallbacks (anpassbar)
        return ['Bestseller', 'Angebote', 'Beliebt'];
    }

    /**
     * Produkte von Yadore API laden
     * 
     * FIX 1.6.1: market und precision Parameter hinzugefügt
     * 
     * @param array<string> $keywords Suchbegriffe
     * @param int $count Anzahl
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return array<int, array<string, mixed>> Produkte
     */
    private function fetch_yadore_products(array $keywords, int $count, array $atts): array {
        if (!$this->yadore_api->is_configured()) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('YAA Search: Yadore API not configured');
            }
            return [];
        }

        $products = [];
        $keyword_count = count($keywords);
        
        if ($keyword_count === 0) {
            return [];
        }
        
        // FIX: Bei nur einem Keyword das volle Limit verwenden
        $per_keyword = $keyword_count === 1 ? $count : max(1, (int) ceil($count / $keyword_count));

        // Debug-Log
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'YAA Search: fetch_yadore_products - keywords=%d, count=%d, per_keyword=%d',
                $keyword_count,
                $count,
                $per_keyword
            ));
        }

        foreach ($keywords as $keyword) {
            if (count($products) >= $count) {
                break;
            }

            // FIX 1.6.1: Vollständige API-Parameter übergeben
            $api_params = [
                'keyword'   => $keyword,
                'limit'     => $per_keyword,
                'sort'      => (string) ($atts['sort'] ?: 'rel_desc'),
                // NEU: market und precision aus Shortcode oder Plugin-Standard
                'market'    => !empty($atts['market']) ? (string) $atts['market'] : yaa_get_option('yadore_market', 'de'),
                'precision' => !empty($atts['precision']) ? (string) $atts['precision'] : yaa_get_option('yadore_precision', 'fuzzy'),
            ];

            if (!empty($atts['network'])) {
                $api_params['network'] = (string) $atts['network'];
            }

            if (!empty($atts['merchant_filter'])) {
                $api_params['merchant_whitelist'] = (string) $atts['merchant_filter'];
            }

            // Debug-Log
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'YAA Search: API call for keyword "%s" with limit=%d',
                    $keyword,
                    $api_params['limit']
                ));
            }

            $results = $this->yadore_api->fetch($api_params);

            if (is_wp_error($results)) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('YAA Search: API error - ' . $results->get_error_message());
                }
                continue;
            }
            
            if (!empty($results)) {
                // Debug-Log
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log(sprintf(
                        'YAA Search: API returned %d results for "%s"',
                        count($results),
                        $keyword
                    ));
                }
                
                foreach ($results as $offer) {
                    $products[] = $this->format_yadore_product($offer, $atts);
                    if (count($products) >= $count) {
                        break;
                    }
                }
            } else {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log(sprintf(
                        'YAA Search: API returned 0 results for "%s"',
                        $keyword
                    ));
                }
            }
        }

        return $products;
    }

    /**
     * Produkte von Amazon PA-API laden
     * 
     * @param array<string> $keywords Suchbegriffe
     * @param int $count Anzahl
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return array<int, array<string, mixed>> Produkte
     */
    private function fetch_amazon_products(array $keywords, int $count, array $atts): array {
        if (!$this->amazon_api->is_configured()) {
            return [];
        }

        $products = [];
        $keyword_count = count($keywords);
        
        if ($keyword_count === 0) {
            return [];
        }
        
        $per_keyword = $keyword_count === 1 ? $count : max(1, (int) ceil($count / $keyword_count));

        foreach ($keywords as $keyword) {
            if (count($products) >= $count) {
                break;
            }

            $results = $this->amazon_api->search_items(
                $keyword,
                'All',
                min($per_keyword, 10) // Amazon max 10 pro Request
            );

            if (!is_wp_error($results) && !empty($results)) {
                foreach ($results as $item) {
                    $products[] = $this->format_amazon_product($item, $atts);
                    if (count($products) >= $count) {
                        break;
                    }
                }
            }
        }

        return $products;
    }

    /**
     * Yadore-Produkt formatieren
     * 
     * @param array<string, mixed> $offer API-Offer
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return array<string, mixed> Formatiertes Produkt
     */
    private function format_yadore_product(array $offer, array $atts): array {
        // Bild verarbeiten
        $image_url = $offer['image']['url'] ?? '';
        
        // Lokale Bildverarbeitung wenn aktiviert
        if (!empty($image_url) && yaa_get_option('enable_local_images', 'yes') === 'yes') {
            $image_url = YAA_Image_Handler::process(
                $image_url,
                $offer['id'] ?? uniqid('ydr_'),
                $offer['title'] ?? 'product',
                'yadore'
            );
        }

        // Fallback auf Shop-Logo
        if (empty($image_url) && !empty($offer['merchant']['logo'])) {
            $image_url = $offer['merchant']['logo'];
        }

        // Preis formatieren
        $price_display = '';
        $show_price = $atts['show_price'] ?? true;
        if ($show_price && !empty($offer['price']['amount'])) {
            $currency = $offer['price']['currency'] ?? 'EUR';
            $amount = (float) $offer['price']['amount'];
            $price_display = number_format($amount, 2, ',', '.') . ' ' . $currency;
        }

        $show_merchant = $atts['show_merchant'] ?? true;

        return [
            'id'            => $offer['id'] ?? uniqid(),
            'title'         => $offer['title'] ?? '',
            'description'   => $this->truncate_text($offer['description'] ?? '', 120),
            'price'         => $price_display,
            'price_raw'     => $offer['price']['amount'] ?? 0,
            'image'         => $image_url,
            'url'           => $offer['url'] ?? '#',
            'merchant'      => $show_merchant ? ($offer['merchant']['name'] ?? '') : '',
            'merchant_logo' => $offer['merchant']['logo'] ?? '',
            'new_tab'       => (bool) ($atts['new_tab'] ?? true),
            'source'        => 'yadore',
        ];
    }

    /**
     * Amazon-Produkt formatieren
     * 
     * @param array<string, mixed> $item Amazon-Item
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return array<string, mixed> Formatiertes Produkt
     */
    private function format_amazon_product(array $item, array $atts): array {
        $image_url = $item['image']['url'] ?? '';
        
        // Lokale Bildverarbeitung wenn aktiviert
        if (!empty($image_url) && yaa_get_option('enable_local_images', 'yes') === 'yes') {
            $image_url = YAA_Image_Handler::process(
                $image_url,
                $item['asin'] ?? $item['id'] ?? uniqid('amz_'),
                $item['title'] ?? 'product',
                'amazon'
            );
        }

        $show_price = $atts['show_price'] ?? true;
        $price_display = '';
        if ($show_price && !empty($item['price']['display'])) {
            $price_display = $item['price']['display'];
        } elseif ($show_price && !empty($item['price']['amount'])) {
            $currency = $item['price']['currency'] ?? 'EUR';
            $amount = (float) $item['price']['amount'];
            $price_display = number_format($amount, 2, ',', '.') . ' ' . $currency;
        }

        $show_merchant = $atts['show_merchant'] ?? true;

        return [
            'id'            => $item['asin'] ?? $item['id'] ?? uniqid(),
            'title'         => $item['title'] ?? '',
            'description'   => $this->truncate_text($item['description'] ?? '', 120),
            'price'         => $price_display,
            'price_raw'     => $item['price']['amount'] ?? 0,
            'image'         => $image_url,
            'url'           => $item['url'] ?? '#',
            'merchant'      => $show_merchant ? 'Amazon' : '',
            'merchant_logo' => '',
            'new_tab'       => (bool) ($atts['new_tab'] ?? true),
            'source'        => 'amazon',
        ];
    }

    /**
     * Produkt-Grid HTML rendern (für Initial-Produkte)
     * 
     * @param array<int, array<string, mixed>> $products Produkte
     * @param array<string, mixed> $atts Shortcode-Attribute
     * @return string HTML
     */
    private function render_product_grid(array $products, array $atts): string {
        if (empty($products)) {
            return '';
        }

        $html = '';
        foreach ($products as $product) {
            $html .= $this->render_product_card($product);
        }
        return $html;
    }

    /**
     * Einzelne Produkt-Karte rendern
     * 
     * @param array<string, mixed> $product Produkt-Daten
     * @return string HTML
     */
    private function render_product_card(array $product): string {
        $target = !empty($product['new_tab']) ? ' target="_blank" rel="noopener noreferrer"' : '';
        
        // Bild HTML
        if (!empty($product['image'])) {
            $image_html = sprintf(
                '<div class="yadore-product-image">
                    <img src="%s" alt="%s" loading="lazy" onerror="this.parentElement.classList.add(\'yadore-image-error\')">
                </div>',
                esc_url($product['image']),
                esc_attr($product['title'] ?? '')
            );
        } else {
            $image_html = '<div class="yadore-product-image yadore-no-image">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
            </div>';
        }

        // Händler HTML
        $merchant_html = '';
        if (!empty($product['merchant'])) {
            $merchant_html = sprintf(
                '<div class="yadore-product-merchant">%s</div>',
                esc_html($product['merchant'])
            );
        }

        // Preis HTML
        $price_html = '';
        if (!empty($product['price'])) {
            $price_html = sprintf(
                '<div class="yadore-product-price">%s</div>',
                esc_html($product['price'])
            );
        }

        // Source Badge
        $source_badge = '';
        if (!empty($product['source'])) {
            $source_class = 'yadore-source-' . esc_attr($product['source']);
            $source_badge = sprintf(
                '<span class="yadore-product-source %s"></span>',
                $source_class
            );
        }

        return sprintf(
            '<div class="yadore-product-card" data-product-id="%s">
                <a href="%s"%s class="yadore-product-link">
                    %s
                    %s
                    <div class="yadore-product-content">
                        <h4 class="yadore-product-title">%s</h4>
                        %s
                        %s
                        <span class="yadore-product-cta">%s →</span>
                    </div>
                </a>
            </div>',
            esc_attr($product['id'] ?? ''),
            esc_url($product['url'] ?? '#'),
            $target,
            $source_badge,
            $image_html,
            esc_html($product['title'] ?? ''),
            $merchant_html,
            $price_html,
            esc_html__('Zum Angebot', 'yadore-amazon-api')
        );
    }

    /**
     * AJAX-Handler für Produktsuche
     */
    public function ajax_search(): void {
        // Nonce prüfen
        if (!check_ajax_referer('yadore_search_nonce', 'nonce', false)) {
            wp_send_json_error(['message' => __('Sicherheitsprüfung fehlgeschlagen.', 'yadore-amazon-api')], 403);
        }

        // Parameter validieren
        $query = isset($_POST['query']) ? sanitize_text_field(wp_unslash($_POST['query'])) : '';
        $network = isset($_POST['network']) ? sanitize_text_field(wp_unslash($_POST['network'])) : '';
        $max_results = isset($_POST['max_results']) ? (int) $_POST['max_results'] : 12;
        $sort = isset($_POST['sort']) ? sanitize_text_field(wp_unslash($_POST['sort'])) : 'rel_desc';
        $merchant_filter = isset($_POST['merchant_filter']) ? sanitize_text_field(wp_unslash($_POST['merchant_filter'])) : '';
        $show_price = isset($_POST['show_price']) && $_POST['show_price'] === '1';
        $show_merchant = isset($_POST['show_merchant']) && $_POST['show_merchant'] === '1';
        $new_tab = isset($_POST['new_tab']) && $_POST['new_tab'] === '1';

        if (empty($query) || strlen($query) < 2) {
            wp_send_json_error(['message' => __('Suchbegriff zu kurz.', 'yadore-amazon-api')], 400);
        }

        // Rate-Limiting
        $rate_limit_key = 'yadore_search_' . md5($_SERVER['REMOTE_ADDR'] ?? '');
        $rate_count = get_transient($rate_limit_key);
        
        if ($rate_count !== false && (int) $rate_count > 30) {
            wp_send_json_error(['message' => __('Zu viele Anfragen. Bitte warten.', 'yadore-amazon-api')], 429);
        }
        
        set_transient($rate_limit_key, ($rate_count ? (int) $rate_count + 1 : 1), 60);

        // Yadore API aufrufen
        $api_params = [
            'keyword' => $query,
            'limit'   => min($max_results, 50),
            'sort'    => $sort,
            'market'  => yaa_get_option('yadore_market', 'de'),
            'precision' => yaa_get_option('yadore_precision', 'fuzzy'),
        ];

        if (!empty($network)) {
            $api_params['network'] = $network;
        }

        if (!empty($merchant_filter)) {
            $api_params['merchant_whitelist'] = $merchant_filter;
        }

        $results = $this->yadore_api->fetch($api_params);

        if (is_wp_error($results)) {
            wp_send_json_error([
                'message' => $results->get_error_message(),
            ], 500);
        }

        // Ergebnisse aufbereiten
        $atts = [
            'show_price'    => $show_price,
            'show_merchant' => $show_merchant,
            'new_tab'       => $new_tab,
        ];

        $products = [];
        if (!empty($results)) {
            foreach ($results as $offer) {
                $products[] = $this->format_yadore_product($offer, $atts);
            }
        }

        wp_send_json_success([
            'products' => $products,
            'total'    => count($products),
            'query'    => $query,
        ]);
    }

    /**
     * Text kürzen
     * 
     * @param string $text Text
     * @param int $length Max Länge
     * @return string Gekürzter Text
     */
    private function truncate_text(string $text, int $length = 120): string {
        $text = wp_strip_all_tags($text);
        if (strlen($text) <= $length) {
            return $text;
        }
        return substr($text, 0, $length) . '...';
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-shortcode-renderer.php 
 
<?php
/**
 * Shortcode Renderer - Vollständige Version mit allen Features
 * PHP 8.3+ compatible
 * Version: 1.5.1
 * 
 * Features:
 * - Yadore, Amazon, Custom Products Shortcodes
 * - Fuzzy-Suche für eigene Produkte
 * - Automatisches Einmischen eigener Produkte
 * - Lokale Bilderspeicherung mit SEO-Dateinamen
 * - Bildgrößen-Auswahl
 * - Merchant Filter (Whitelist/Blacklist) für Yadore
 * - hide_no_image Option zum Ausfiltern
 * - Multi-Keyword Support
 * - Sortierung nach Preis/CPC
 * - NEU: Shop-Logo als Bild-Fallback
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Shortcode_Renderer {
    
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    private YAA_Cache_Handler $cache;
    private YAA_Custom_Products $custom_products;
    
    /** @var bool Ob Bilder lokal gespeichert werden sollen */
    private bool $use_local_images;
    
    /** @var bool Ob Fuzzy-Suche global aktiviert ist */
    private bool $fuzzy_enabled;
    
    public function __construct(
        YAA_Yadore_API $yadore_api, 
        YAA_Amazon_PAAPI $amazon_api, 
        YAA_Cache_Handler $cache,
        YAA_Custom_Products $custom_products
    ) {
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        $this->cache = $cache;
        $this->custom_products = $custom_products;
        
        $this->use_local_images = (yaa_get_option('enable_local_images', 'yes') === 'yes');
        $this->fuzzy_enabled = (yaa_get_option('enable_fuzzy_search', 'yes') === 'yes');
        
        // Register shortcodes
        add_shortcode('yaa_products', [$this, 'render_combined']);
        add_shortcode('yadore_products', [$this, 'render_yadore']);
        add_shortcode('amazon_products', [$this, 'render_amazon']);
        add_shortcode('combined_products', [$this, 'render_combined']);
        add_shortcode('custom_products', [$this, 'render_custom']);
        add_shortcode('all_products', [$this, 'render_all_sources']);
        add_shortcode('fuzzy_products', [$this, 'render_fuzzy']);
    }
    
    /**
     * Render fuzzy search results from custom products
     */
    public function render_fuzzy(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'       => '',
            'keywords'      => '',
            'limit'         => 10,
            'threshold'     => '',
            'columns'       => '',
            'class'         => '',
            'local_images'  => '',
            'hide_no_image' => 'no',
            'show_score'    => 'no',
        ], $atts, 'fuzzy_products');
        
        $keywords = [];
        
        if (!empty($atts['keywords'])) {
            $keywords = array_map('trim', explode(',', (string) $atts['keywords']));
            $keywords = array_filter($keywords);
        } elseif (!empty($atts['keyword'])) {
            $keywords = [trim((string) $atts['keyword'])];
        }
        
        if (empty($keywords)) {
            return $this->render_error(__('Bitte keyword oder keywords angeben.', 'yadore-amazon-api'));
        }
        
        $total_limit = (int) $atts['limit'];
        $threshold = (string) $atts['threshold'] !== '' ? (int) $atts['threshold'] : null;
        
        $all_items = [];
        
        if (count($keywords) === 1) {
            $all_items = $this->custom_products->search_products_fuzzy(
                $keywords[0],
                $total_limit,
                $threshold
            );
        } else {
            $per_keyword = (int) ceil($total_limit / count($keywords));
            $collected = [];
            
            foreach ($keywords as $keyword) {
                $results = $this->custom_products->search_products_fuzzy(
                    $keyword,
                    $per_keyword,
                    $threshold
                );
                
                foreach ($results as $item) {
                    $pid = $item['post_id'] ?? 0;
                    if (!isset($collected[$pid])) {
                        $collected[$pid] = $item;
                    } else {
                        if (($item['_fuzzy_score'] ?? 0) > ($collected[$pid]['_fuzzy_score'] ?? 0)) {
                            $collected[$pid] = $item;
                        }
                    }
                }
            }
            
            $all_items = array_values($collected);
            usort($all_items, fn($a, $b) => ($b['_fuzzy_score'] ?? 0) <=> ($a['_fuzzy_score'] ?? 0));
            $all_items = array_slice($all_items, 0, $total_limit);
        }
        
        $all_items = $this->filter_items_without_image($all_items, $atts);
        
        if (empty($all_items)) {
            return $this->render_empty();
        }
        
        if ((string) $atts['show_score'] === 'yes') {
            foreach ($all_items as &$item) {
                $score = $item['_fuzzy_score'] ?? 0;
                $item['description'] = sprintf(
                    '[Score: %.1f%%] %s',
                    $score,
                    $item['description'] ?? ''
                );
            }
            unset($item);
        }
        
        return $this->render_grid($all_items, $atts);
    }
    
    /**
     * Render Yadore products - Mit Merchant Filter und Sortierung
     */
    public function render_yadore(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'            => '',
            'keywords'           => '',
            'limit'              => (int) yaa_get_option('yadore_default_limit', 9),
            'market'             => (string) yaa_get_option('yadore_market', 'de'),
            'precision'          => (string) yaa_get_option('yadore_precision', 'fuzzy'),
            'sort'               => (string) yaa_get_option('yadore_default_sort', 'rel_desc'),
            'columns'            => '',
            'class'              => '',
            'local_images'       => '',
            'hide_no_image'      => 'no',
            'mix_custom'         => '',
            'custom_position'    => 'start',
            'custom_limit'       => 2,
            // Merchant Filter
            'merchant_whitelist' => '',
            'merchant_blacklist' => '',
            'merchants'          => '',
            'exclude_merchants'  => '',
        ], $atts, 'yadore_products');
        
        if (!$this->yadore_api->is_configured()) {
            return $this->render_error(__('Yadore API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        $keywords = [];
        
        if (!empty($atts['keywords'])) {
            $keywords = array_map('trim', explode(',', (string) $atts['keywords']));
            $keywords = array_filter($keywords);
        } elseif (!empty($atts['keyword'])) {
            $keywords = [trim((string) $atts['keyword'])];
        }
        
        if (empty($keywords)) {
            return $this->render_error(__('Bitte keyword oder keywords angeben.', 'yadore-amazon-api'));
        }
        
        $total_limit = (int) $atts['limit'];
        $items = [];
        
        // Merchant Filter ermitteln (Shortcode hat Vorrang)
        $merchant_whitelist = $atts['merchant_whitelist'] ?: $atts['merchants'];
        $merchant_blacklist = $atts['merchant_blacklist'] ?: $atts['exclude_merchants'];
        
        if (count($keywords) === 1) {
            $result = $this->yadore_api->fetch([
                'keyword'            => $keywords[0],
                'limit'              => $total_limit,
                'market'             => (string) $atts['market'],
                'precision'          => (string) $atts['precision'],
                'sort'               => (string) $atts['sort'],
                'merchant_whitelist' => $merchant_whitelist,
                'merchant_blacklist' => $merchant_blacklist,
            ]);
            
            if (!is_wp_error($result)) {
                $items = $result;
            }
        } else {
            $items = $this->fetch_multi_keywords_with_filter(
                $keywords, 
                $total_limit, 
                $atts, 
                $merchant_whitelist, 
                $merchant_blacklist
            );
        }
        
        // Fuzzy Custom Products einmischen
        $items = $this->maybe_mix_fuzzy_products($items, $keywords, $atts);
        
        // Produkte ohne Bild ausfiltern
        $items = $this->filter_items_without_image($items, $atts);
        
        if (empty($items)) {
            return $this->render_empty();
        }
        
        return $this->render_grid($items, $atts);
    }
    
    /**
     * Render Amazon products - Mit optionalem Fuzzy-Mixing
     */
    public function render_amazon(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'         => '',
            'category'        => (string) yaa_get_option('amazon_default_category', 'All'),
            'limit'           => 10,
            'min_price'       => '',
            'max_price'       => '',
            'brand'           => '',
            'sort'            => '',
            'asins'           => '',
            'columns'         => '',
            'class'           => '',
            'local_images'    => '',
            'hide_no_image'   => 'no',
            'mix_custom'      => '',
            'custom_position' => 'start',
            'custom_limit'    => 2,
        ], $atts, 'amazon_products');
        
        if (!$this->amazon_api->is_configured()) {
            return $this->render_error(__('Amazon PA-API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        $asins = trim((string) $atts['asins']);
        if ($asins !== '') {
            $asin_array = array_map('trim', explode(',', $asins));
            $items = $this->amazon_api->get_items($asin_array);
        } else {
            $keyword = trim((string) $atts['keyword']);
            if ($keyword === '') {
                return $this->render_error(__('Bitte keyword oder asins angeben.', 'yadore-amazon-api'));
            }
            
            $additional = [];
            if ((string) $atts['min_price'] !== '') {
                $additional['min_price'] = (float) $atts['min_price'];
            }
            if ((string) $atts['max_price'] !== '') {
                $additional['max_price'] = (float) $atts['max_price'];
            }
            if ((string) $atts['brand'] !== '') {
                $additional['brand'] = (string) $atts['brand'];
            }
            if ((string) $atts['sort'] !== '') {
                $additional['sort_by'] = (string) $atts['sort'];
            }
            
            $items = $this->amazon_api->search_items(
                $keyword,
                (string) $atts['category'],
                (int) $atts['limit'],
                $additional
            );
        }
        
        if (is_wp_error($items)) {
            return $this->render_error($items->get_error_message());
        }
        
        // Fuzzy Custom Products einmischen
        $keyword = trim((string) $atts['keyword']);
        if ($keyword !== '') {
            $items = $this->maybe_mix_fuzzy_products($items, [$keyword], $atts);
        }
        
        // Produkte ohne Bild ausfiltern
        $items = $this->filter_items_without_image($items, $atts);
        
        if (empty($items)) {
            return $this->render_empty();
        }
        
        return $this->render_grid($items, $atts);
    }
    
    /**
     * Render custom products
     */
    public function render_custom(array|string $atts = []): string {
        $atts = shortcode_atts([
            'ids'           => '',
            'category'      => '',
            'keyword'       => '',
            'limit'         => 10,
            'columns'       => '',
            'class'         => '',
            'local_images'  => '',
            'hide_no_image' => 'no',
            'fuzzy'         => '',
            'threshold'     => '',
        ], $atts, 'custom_products');
        
        $items = [];
        
        if (!empty($atts['ids'])) {
            $ids = array_map('intval', explode(',', (string) $atts['ids']));
            $ids = array_filter($ids);
            $items = $this->custom_products->get_products_by_ids($ids);
        }
        elseif (!empty($atts['keyword']) && ($atts['fuzzy'] === 'yes' || $this->fuzzy_enabled)) {
            $threshold = (string) $atts['threshold'] !== '' ? (int) $atts['threshold'] : null;
            $items = $this->custom_products->search_products_fuzzy(
                (string) $atts['keyword'],
                (int) $atts['limit'],
                $threshold
            );
        }
        elseif (!empty($atts['category'])) {
            $items = $this->custom_products->get_products_by_category(
                (string) $atts['category'],
                (int) $atts['limit']
            );
        }
        else {
            $items = $this->custom_products->get_all_products((int) $atts['limit']);
        }
        
        $items = $this->filter_items_without_image($items, $atts);
        
        if (empty($items)) {
            return $this->render_empty();
        }
        
        return $this->render_grid($items, $atts);
    }
    
    /**
     * Render combined products (Yadore + Amazon + Custom)
     */
    public function render_combined(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'            => '',
            'keywords'           => '',
            'yadore_limit'       => 6,
            'amazon_limit'       => 4,
            'custom_ids'         => '',
            'custom_category'    => '',
            'custom_limit'       => 0,
            'custom_fuzzy'       => 'no',
            'market'             => (string) yaa_get_option('yadore_market', 'de'),
            'category'           => (string) yaa_get_option('amazon_default_category', 'All'),
            'sort'               => (string) yaa_get_option('yadore_default_sort', 'rel_desc'),
            'shuffle'            => 'yes',
            'columns'            => '',
            'class'              => '',
            'local_images'       => '',
            'hide_no_image'      => 'no',
            // Merchant Filter für Yadore
            'merchant_whitelist' => '',
            'merchant_blacklist' => '',
            'merchants'          => '',
            'exclude_merchants'  => '',
        ], $atts, 'combined_products');
        
        $combined = [];
        $yadore_limit = (int) $atts['yadore_limit'];
        $amazon_limit = (int) $atts['amazon_limit'];
        $custom_limit = (int) $atts['custom_limit'];
        
        $keyword = trim((string) $atts['keyword']);
        $keywords_string = trim((string) $atts['keywords']);
        
        // Merchant Filter
        $merchant_whitelist = $atts['merchant_whitelist'] ?: $atts['merchants'];
        $merchant_blacklist = $atts['merchant_blacklist'] ?: $atts['exclude_merchants'];
        
        // 1. Eigene Produkte laden
        if (!empty($atts['custom_ids'])) {
            $ids = array_map('intval', explode(',', (string) $atts['custom_ids']));
            $ids = array_filter($ids);
            $custom_items = $this->custom_products->get_products_by_ids($ids);
            $combined = array_merge($combined, $custom_items);
        } elseif (!empty($atts['custom_category'])) {
            $custom_items = $this->custom_products->get_products_by_category(
                (string) $atts['custom_category'],
                $custom_limit > 0 ? $custom_limit : 5
            );
            $combined = array_merge($combined, $custom_items);
        } elseif ($atts['custom_fuzzy'] === 'yes' && ($keyword !== '' || $keywords_string !== '')) {
            $search_term = $keyword !== '' ? $keyword : explode(',', $keywords_string)[0];
            $custom_items = $this->custom_products->search_products_fuzzy(
                trim($search_term),
                $custom_limit > 0 ? $custom_limit : 3
            );
            $combined = array_merge($combined, $custom_items);
        } elseif ($custom_limit > 0) {
            $custom_items = $this->custom_products->get_all_products($custom_limit);
            $combined = array_merge($combined, $custom_items);
        }
        
        // 2. Yadore Produkte laden
        if ($this->yadore_api->is_configured() && $yadore_limit > 0 && ($keyword !== '' || $keywords_string !== '')) {
            if ($keywords_string !== '') {
                $keywords = array_map('trim', explode(',', $keywords_string));
                $keywords = array_filter($keywords);
                $yadore_items = $this->fetch_multi_keywords_with_filter(
                    $keywords, 
                    $yadore_limit, 
                    ['market' => (string) $atts['market'], 'precision' => (string) yaa_get_option('yadore_precision', 'fuzzy'), 'sort' => (string) $atts['sort']],
                    $merchant_whitelist,
                    $merchant_blacklist
                );
            } else {
                $yadore_items = $this->yadore_api->fetch([
                    'keyword'            => $keyword,
                    'limit'              => $yadore_limit,
                    'market'             => (string) $atts['market'],
                    'sort'               => (string) $atts['sort'],
                    'merchant_whitelist' => $merchant_whitelist,
                    'merchant_blacklist' => $merchant_blacklist,
                ]);
                
                if (is_wp_error($yadore_items)) {
                    $yadore_items = [];
                }
            }
            
            if (!empty($yadore_items)) {
                $combined = array_merge($combined, $yadore_items);
            }
        }
        
        // 3. Amazon Produkte laden
        if ($this->amazon_api->is_configured() && $amazon_limit > 0 && $keyword !== '') {
            $amazon_items = $this->amazon_api->search_items(
                $keyword,
                (string) $atts['category'],
                $amazon_limit
            );
            
            if (!is_wp_error($amazon_items) && !empty($amazon_items)) {
                $combined = array_merge($combined, $amazon_items);
            }
        }
        
        $combined = $this->filter_items_without_image($combined, $atts);
        
        if (empty($combined)) {
            return $this->render_empty();
        }
        
        if ((string) $atts['shuffle'] === 'yes') {
            shuffle($combined);
        }
        
        return $this->render_grid($combined, $atts);
    }
    
    /**
     * Render all sources combined
     */
    public function render_all_sources(array|string $atts = []): string {
        $atts = shortcode_atts([
            'keyword'            => '',
            'keywords'           => '',
            'total_limit'        => 12,
            'custom_ids'         => '',
            'custom_category'    => '',
            'custom_fuzzy'       => 'no',
            'market'             => (string) yaa_get_option('yadore_market', 'de'),
            'category'           => (string) yaa_get_option('amazon_default_category', 'All'),
            'sort'               => (string) yaa_get_option('yadore_default_sort', 'rel_desc'),
            'priority'           => 'custom,yadore,amazon',
            'shuffle'            => 'no',
            'columns'            => '',
            'class'              => '',
            'local_images'       => '',
            'hide_no_image'      => 'no',
            // Merchant Filter
            'merchant_whitelist' => '',
            'merchant_blacklist' => '',
            'merchants'          => '',
            'exclude_merchants'  => '',
        ], $atts, 'all_products');
        
        $total_limit = (int) $atts['total_limit'];
        $combined = [];
        $remaining = $total_limit;
        
        $priorities = array_map('trim', explode(',', (string) $atts['priority']));
        
        // Merchant Filter
        $merchant_whitelist = $atts['merchant_whitelist'] ?: $atts['merchants'];
        $merchant_blacklist = $atts['merchant_blacklist'] ?: $atts['exclude_merchants'];
        
        foreach ($priorities as $source) {
            if ($remaining <= 0) {
                break;
            }
            
            $items = [];
            
            switch ($source) {
                case 'custom':
                    if (!empty($atts['custom_ids'])) {
                        $ids = array_map('intval', explode(',', (string) $atts['custom_ids']));
                        $items = $this->custom_products->get_products_by_ids($ids);
                    } elseif (!empty($atts['custom_category'])) {
                        $items = $this->custom_products->get_products_by_category(
                            (string) $atts['custom_category'],
                            $remaining
                        );
                    } elseif ($atts['custom_fuzzy'] === 'yes') {
                        $keyword = trim((string) $atts['keyword']);
                        if ($keyword !== '') {
                            $items = $this->custom_products->search_products_fuzzy($keyword, $remaining);
                        }
                    } else {
                        $items = $this->custom_products->get_all_products($remaining);
                    }
                    break;
                    
                case 'yadore':
                    if ($this->yadore_api->is_configured()) {
                        $keyword = trim((string) $atts['keyword']);
                        $keywords_string = trim((string) $atts['keywords']);
                        
                        if ($keywords_string !== '') {
                            $keywords = array_map('trim', explode(',', $keywords_string));
                            $items = $this->fetch_multi_keywords_with_filter(
                                $keywords, 
                                $remaining, 
                                ['market' => (string) $atts['market'], 'precision' => (string) yaa_get_option('yadore_precision', 'fuzzy'), 'sort' => (string) $atts['sort']],
                                $merchant_whitelist,
                                $merchant_blacklist
                            );
                        } elseif ($keyword !== '') {
                            $result = $this->yadore_api->fetch([
                                'keyword'            => $keyword,
                                'limit'              => $remaining,
                                'market'             => (string) $atts['market'],
                                'sort'               => (string) $atts['sort'],
                                'merchant_whitelist' => $merchant_whitelist,
                                'merchant_blacklist' => $merchant_blacklist,
                            ]);
                            if (!is_wp_error($result)) {
                                $items = $result;
                            }
                        }
                    }
                    break;
                    
                case 'amazon':
                    if ($this->amazon_api->is_configured()) {
                        $keyword = trim((string) $atts['keyword']);
                        if ($keyword !== '') {
                            $result = $this->amazon_api->search_items(
                                $keyword,
                                (string) $atts['category'],
                                min($remaining, 10)
                            );
                            if (!is_wp_error($result)) {
                                $items = $result;
                            }
                        }
                    }
                    break;
            }
            
            if (!empty($items)) {
                $to_add = array_slice($items, 0, $remaining);
                $combined = array_merge($combined, $to_add);
                $remaining -= count($to_add);
            }
        }
        
        $combined = $this->filter_items_without_image($combined, $atts);
        
        if (empty($combined)) {
            return $this->render_empty();
        }
        
        if ((string) $atts['shuffle'] === 'yes') {
            shuffle($combined);
        }
        
        return $this->render_grid($combined, $atts);
    }
    
    /**
     * Produkte ohne Bild ausfiltern
     * 
     * @param array<int, array<string, mixed>> $items
     * @param array<string, mixed> $atts
     * @return array<int, array<string, mixed>>
     */
    private function filter_items_without_image(array $items, array $atts): array {
        $hide_no_image = ($atts['hide_no_image'] ?? 'no') === 'yes';
        
        if (!$hide_no_image) {
            return $items;
        }
        
        $filtered = array_filter($items, function($item) {
            $image_url = $item['image']['url'] ?? '';
            return !empty($image_url);
        });
        
        return array_values($filtered);
    }
    
    /**
     * Optionales Einmischen von Fuzzy-Produkten
     * 
     * @param array<int, array<string, mixed>> $items
     * @param array<string> $keywords
     * @param array<string, mixed> $atts
     * @return array<int, array<string, mixed>>
     */
    private function maybe_mix_fuzzy_products(array $items, array $keywords, array $atts): array {
        $mix_custom = $atts['mix_custom'] ?? '';
        
        $should_mix = ($mix_custom === 'yes') || 
                      ($mix_custom === '' && $this->fuzzy_enabled && yaa_get_option('fuzzy_auto_mix', 'no') === 'yes');
        
        if (!$should_mix || empty($keywords)) {
            return $items;
        }
        
        $custom_limit = (int) ($atts['custom_limit'] ?? 2);
        $position = $atts['custom_position'] ?? 'start';
        
        $fuzzy_items = [];
        $per_keyword = (int) ceil($custom_limit / count($keywords));
        
        foreach ($keywords as $keyword) {
            $results = $this->custom_products->search_products_fuzzy($keyword, $per_keyword);
            $fuzzy_items = array_merge($fuzzy_items, $results);
        }
        
        $unique_fuzzy = [];
        $seen_ids = [];
        foreach ($fuzzy_items as $item) {
            $pid = $item['post_id'] ?? 0;
            if (!in_array($pid, $seen_ids, true)) {
                $unique_fuzzy[] = $item;
                $seen_ids[] = $pid;
            }
        }
        
        $unique_fuzzy = array_slice($unique_fuzzy, 0, $custom_limit);
        
        if (empty($unique_fuzzy)) {
            return $items;
        }
        
        switch ($position) {
            case 'start':
                $items = array_merge($unique_fuzzy, $items);
                break;
            case 'end':
                $items = array_merge($items, $unique_fuzzy);
                break;
            case 'shuffle':
                $items = array_merge($items, $unique_fuzzy);
                shuffle($items);
                break;
            case 'alternate':
                $result = [];
                $fuzzy_index = 0;
                $interval = max(1, (int) floor(count($items) / (count($unique_fuzzy) + 1)));
                
                foreach ($items as $i => $item) {
                    if ($fuzzy_index < count($unique_fuzzy) && $i > 0 && $i % $interval === 0) {
                        $result[] = $unique_fuzzy[$fuzzy_index];
                        $fuzzy_index++;
                    }
                    $result[] = $item;
                }
                
                while ($fuzzy_index < count($unique_fuzzy)) {
                    $result[] = $unique_fuzzy[$fuzzy_index];
                    $fuzzy_index++;
                }
                
                $items = $result;
                break;
        }
        
        return $items;
    }
    
    /**
     * Fetch products for multiple keywords with merchant filter
     * 
     * @param array<string> $keywords
     * @param int $total_limit
     * @param array<string, mixed> $atts
     * @param string $merchant_whitelist
     * @param string $merchant_blacklist
     * @return array<int, array<string, mixed>>
     */
    private function fetch_multi_keywords_with_filter(
        array $keywords, 
        int $total_limit, 
        array $atts,
        string $merchant_whitelist = '',
        string $merchant_blacklist = ''
    ): array {
        $keyword_count = count($keywords);
        $base_per_keyword = (int) floor($total_limit / $keyword_count);
        $remainder = $total_limit % $keyword_count;
        
        $all_items = [];
        $items_per_keyword = [];
        
        foreach ($keywords as $index => $keyword) {
            $limit_for_this = $base_per_keyword;
            
            if ($index < $remainder) {
                $limit_for_this++;
            }
            
            if ($limit_for_this <= 0) {
                continue;
            }
            
            $result = $this->yadore_api->fetch([
                'keyword'            => $keyword,
                'limit'              => $limit_for_this,
                'market'             => (string) ($atts['market'] ?? yaa_get_option('yadore_market', 'de')),
                'precision'          => (string) ($atts['precision'] ?? yaa_get_option('yadore_precision', 'fuzzy')),
                'sort'               => (string) ($atts['sort'] ?? yaa_get_option('yadore_default_sort', 'rel_desc')),
                'merchant_whitelist' => $merchant_whitelist,
                'merchant_blacklist' => $merchant_blacklist,
            ]);
            
            if (!is_wp_error($result) && !empty($result)) {
                $items_per_keyword[$keyword] = $result;
            }
            
            if ($index < $keyword_count - 1) {
                usleep(200000);
            }
        }
        
        $collected = 0;
        
        foreach ($items_per_keyword as $keyword => $items) {
            $remaining_slots = $total_limit - $collected;
            $to_add = min(count($items), $remaining_slots);
            
            for ($i = 0; $i < $to_add; $i++) {
                $all_items[] = $items[$i];
                $collected++;
            }
            
            if ($collected >= $total_limit) {
                break;
            }
        }
        
        return $all_items;
    }
    
    /**
     * Process image URL - Mit SEO-Dateinamen Support
     * 
     * @param string $remote_url Remote image URL
     * @param string $unique_id Unique identifier (ASIN, EAN, post_id)
     * @param string $source Source (amazon, yadore, custom)
     * @param string $product_name Product name for SEO filename
     * @param array<string, mixed> $atts Shortcode attributes
     * @return string Local or remote URL
     */
    private function process_image_url(
        string $remote_url, 
        string $unique_id, 
        string $source, 
        string $product_name = '',
        array $atts = []
    ): string {
        if ($remote_url === '') {
            return '';
        }
        
        $local_images_override = $atts['local_images'] ?? '';
        
        $use_local = $this->use_local_images;
        
        if ($local_images_override === 'yes') {
            $use_local = true;
        } elseif ($local_images_override === 'no') {
            $use_local = false;
        }
        
        // Eigene Produkte: Lokale Bilder nicht erneut herunterladen
        if ($source === 'custom') {
            $upload_dir = wp_upload_dir();
            $site_url = get_site_url();
            
            if (str_starts_with($remote_url, $upload_dir['baseurl']) || str_starts_with($remote_url, $site_url)) {
                return $remote_url;
            }
        }
        
        if (!$use_local) {
            return $remote_url;
        }
        
        // Nutze den Image Handler mit SEO-Dateinamen
        return YAA_Image_Handler::process($remote_url, $unique_id, $product_name, $source);
    }
    
    /**
     * Render the product grid
     * Version 1.5.1: Mit Shop-Logo als Fallback in der Bilderkette
     * 
     * Fallback-Kette:
     * 1. Original/Lokales Bild
     * 2. Thumbnail (data-thumbnail)
     * 3. Proxy (data-proxy-src)
     * 4. Shop-Logo (data-shop-logo) - NEU
     * 5. CSS Placeholder
     * 
     * @param array<int, array<string, mixed>> $items
     * @param array<string, mixed> $atts
     */
    private function render_grid(array $items, array $atts): string {
        $widget_id = 'yaa-' . uniqid();
        $extra_class = isset($atts['class']) && (string) $atts['class'] !== '' 
            ? ' ' . esc_attr((string) $atts['class']) 
            : '';
        
        $style = '';
        if (isset($atts['columns']) && (string) $atts['columns'] !== '') {
            $cols = (int) $atts['columns'];
            if ($cols >= 1 && $cols <= 6) {
                $style = ' style="--yaa-columns-desktop: ' . $cols . ';"';
            }
        }
        
        // Settings
        $show_prime = yaa_get_option('show_prime_badge', 'yes') === 'yes';
        $show_merchant = yaa_get_option('show_merchant', 'yes') === 'yes';
        $show_description = yaa_get_option('show_description', 'yes') === 'yes';
        $show_custom_badge = yaa_get_option('show_custom_badge', 'yes') === 'yes';
        $custom_badge_text = (string) yaa_get_option('custom_badge_text', 'Empfohlen');
        $button_yadore = (string) yaa_get_option('button_text_yadore', 'Zum Angebot');
        $button_amazon = (string) yaa_get_option('button_text_amazon', 'Bei Amazon kaufen');
        $button_custom = (string) yaa_get_option('button_text_custom', 'Zum Angebot');
        
        // Ensure assets are loaded
        $plugin = yaa_init();
        $plugin->load_assets();
        
        ob_start();
        ?>
        <div class="yaa-grid-container<?php echo $extra_class; ?>" id="<?php echo esc_attr($widget_id); ?>"<?php echo $style; ?>>
            <?php foreach ($items as $index => $item): 
                $source = $item['source'] ?? 'yadore';
                $is_amazon = $source === 'amazon';
                $is_custom = $source === 'custom';
                $url = $item['url'] ?? '#';
                $title = $item['title'] ?? '';
                
                // === BILD-VERARBEITUNG MIT ERWEITERTER FALLBACK-KETTE ===
                
                // Haupt-Bild URL
                $raw_image_url = $item['image']['url'] ?? '';
                
                // Thumbnail URL für Fallback
                $thumbnail_url = '';
                if ($source === 'yadore') {
                    $thumbnail_url = $item['image']['thumbnail_url'] ?? '';
                }
                if ($source === 'amazon' && isset($item['image']['medium_url'])) {
                    $thumbnail_url = $item['image']['medium_url'];
                }
                
                // NEU: Shop-Logo als Fallback (aus Yadore API)
                $shop_logo_url = '';
                if (isset($item['merchant']['logo']) && !empty($item['merchant']['logo'])) {
                    $shop_logo_url = $item['merchant']['logo'];
                }
                
                // Unique ID für Bild-Verarbeitung
                $image_unique_id = match($source) {
                    'amazon' => $item['asin'] ?? $item['id'] ?? uniqid('amz_'),
                    'custom' => (string) ($item['post_id'] ?? $item['id'] ?? uniqid('cst_')),
                    'yadore' => $item['id'] ?? uniqid('ydr_'),
                    default  => $item['id'] ?? uniqid('img_'),
                };
                
                // Produktname für SEO-Dateinamen übergeben
                $image_url = $this->process_image_url(
                    $raw_image_url, 
                    $image_unique_id, 
                    $source, 
                    $title,
                    $atts
                );
                
                // Auch Thumbnail lokal speichern wenn aktiviert (aber nur wenn unterschiedlich)
                $processed_thumbnail_url = '';
                if ($thumbnail_url !== '' && $thumbnail_url !== $raw_image_url) {
                    $processed_thumbnail_url = $this->process_image_url(
                        $thumbnail_url,
                        $image_unique_id . '_thumb',
                        $source,
                        $title . ' Thumbnail',
                        $atts
                    );
                }
                
                $description = $item['description'] ?? '';
                $price_amount = $item['price']['amount'] ?? '';
                $price_currency = $item['price']['currency'] ?? 'EUR';
                $price_display = $item['price']['display'] ?? '';
                $merchant_name = $item['merchant']['name'] ?? '';
                $is_prime = !empty($item['is_prime']);
                
                $custom_button = $item['button_text'] ?? '';
                if ($custom_button !== '') {
                    $button_text = $custom_button;
                } elseif ($is_amazon) {
                    $button_text = $button_amazon;
                } elseif ($is_custom) {
                    $button_text = $button_custom;
                } else {
                    $button_text = $button_yadore;
                }
                
                $source_class = 'yaa-' . $source;
            ?>
                <div class="yaa-item <?php echo esc_attr($source_class); ?>">
                    
                    <?php if ($show_prime && $is_prime): ?>
                        <span class="yaa-prime-badge">Prime</span>
                    <?php endif; ?>
                    
                    <?php if ($is_custom && $show_custom_badge): ?>
                        <span class="yaa-custom-badge"><?php echo esc_html($custom_badge_text); ?></span>
                    <?php endif; ?>
                    
                    <div class="yaa-image-wrapper">
                        <?php 
                        // Proxy-URL generieren falls Proxy aktiviert
                        $proxy_enabled = yaa_get_option('enable_image_proxy', 'yes') === 'yes';
                        $proxy_url = '';
                        
                        if ($proxy_enabled && $raw_image_url !== '') {
                            $proxy_url = admin_url('admin-ajax.php') . '?' . http_build_query([
                                'action' => 'yaa_proxy_image',
                                'url'    => $raw_image_url,
                            ]);
                        }
                        
                        // Finale Bild-URL bestimmen:
                        // 1. Lokales/verarbeitetes Bild wenn verfügbar
                        // 2. Proxy-URL als Fallback
                        // 3. Original-URL als letzter Fallback
                        $final_src = $image_url;
                        
                        // Fix: esc_url() filtert data: URLs - also prüfen ob leer
                        if ($final_src === '' || str_starts_with($final_src, 'data:')) {
                            // Proxy als primäre Quelle verwenden
                            $final_src = $proxy_url !== '' ? $proxy_url : $raw_image_url;
                        }
                        ?>
                        
                        <?php if ($final_src !== ''): ?>
                            <a href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <img src="<?php echo esc_url($final_src); ?>" 
                                    alt="<?php echo esc_attr($title); ?>" 
                                    loading="lazy"
                                    decoding="async"
                                    referrerpolicy="no-referrer"
                                    data-fallback-attempted="false"
                                    <?php if ($processed_thumbnail_url !== ''): ?>
                                    data-thumbnail="<?php echo esc_url($processed_thumbnail_url); ?>"
                                    <?php endif; ?>
                                    <?php if ($raw_image_url !== '' && $raw_image_url !== $final_src): ?>
                                    data-original-src="<?php echo esc_url($raw_image_url); ?>"
                                    <?php endif; ?>
                                    <?php if ($proxy_url !== '' && $proxy_url !== $final_src): ?>
                                    data-proxy-src="<?php echo esc_url($proxy_url); ?>"
                                    <?php endif; ?>
                                    <?php // NEU: Shop-Logo als Fallback ?>
                                    <?php if ($shop_logo_url !== ''): ?>
                                    data-shop-logo="<?php echo esc_url($shop_logo_url); ?>"
                                    <?php endif; ?>
                                    data-source="<?php echo esc_attr($source); ?>"
                                    data-merchant="<?php echo esc_attr($merchant_name); ?>">
                            </a>
                        <?php else: ?>
                            <!-- Kein Bild verfügbar - Shop-Logo als erste Option, dann Placeholder -->
                            <a href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <?php if ($shop_logo_url !== ''): ?>
                                    <img src="<?php echo esc_url($shop_logo_url); ?>" 
                                        alt="<?php echo esc_attr($merchant_name); ?>" 
                                        loading="lazy"
                                        decoding="async"
                                        referrerpolicy="no-referrer"
                                        class="yaa-shop-logo-fallback"
                                        data-fallback-attempted="shop-logo"
                                        data-source="<?php echo esc_attr($source); ?>"
                                        data-merchant="<?php echo esc_attr($merchant_name); ?>">
                                <?php else: ?>
                                    <div class="yaa-placeholder yaa-placeholder-<?php echo esc_attr($source); ?>" 
                                        aria-hidden="true" 
                                        role="img" 
                                        aria-label="<?php esc_attr_e('Bild nicht verfügbar', 'yadore-amazon-api'); ?>">
                                    </div>
                                <?php endif; ?>
                            </a>
                        <?php endif; ?>
                    </div>

                    <div class="yaa-content">
                        <h3 class="yaa-title">
                            <a href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <?php echo esc_html($title); ?>
                            </a>
                        </h3>

                        <?php if ($show_description && $description !== ''): ?>
                            <div class="yaa-description-wrapper">
                                <div class="yaa-description" id="desc-<?php echo esc_attr($widget_id . '-' . $index); ?>">
                                    <?php echo esc_html($description); ?>
                                </div>
                                <button type="button" class="yaa-read-more" 
                                        data-target="<?php echo esc_attr($widget_id . '-' . $index); ?>"
                                        data-expand-text="<?php esc_attr_e('mehr lesen', 'yadore-amazon-api'); ?>"
                                        data-collapse-text="<?php esc_attr_e('weniger', 'yadore-amazon-api'); ?>"
                                        aria-expanded="false"
                                        role="button"
                                        tabindex="0">
                                    <?php esc_html_e('mehr lesen', 'yadore-amazon-api'); ?>
                                </button>
                            </div>
                        <?php elseif ($show_description): ?>
                            <div class="yaa-no-description"><?php esc_html_e('Keine Beschreibung verfügbar', 'yadore-amazon-api'); ?></div>
                        <?php endif; ?>

                        <div class="yaa-meta">
                            <?php if ($price_amount !== '' || $price_display !== ''): ?>
                                <span class="yaa-price">
                                    <?php 
                                    if ($price_display !== '') {
                                        echo esc_html($price_display);
                                    } else {
                                        echo esc_html(number_format((float) $price_amount, 2, ',', '.') . ' ' . $price_currency);
                                    }
                                    ?>
                                </span>
                            <?php endif; ?>
                            
                            <?php if ($show_merchant && $merchant_name !== ''): ?>
                                <div class="yaa-merchant">
                                    <?php echo esc_html($merchant_name); ?>
                                </div>
                            <?php endif; ?>
                        </div>

                        <div class="yaa-button-wrapper">
                            <a class="yaa-button" href="<?php echo esc_url($url); ?>" target="_blank" rel="nofollow sponsored noopener">
                                <?php echo esc_html($button_text); ?>
                            </a>
                        </div>
                    </div>

                </div>
            <?php endforeach; ?>
        </div>
        <?php
        return ob_get_clean() ?: '';
    }

    /**
     * Render error message
     */
    private function render_error(string $message): string {
        return '<div class="yaa-message yaa-error"><span class="yaa-icon">⚠️</span><p>' . 
               esc_html($message) . '</p></div>';
    }
    
    /**
     * Render empty state
     */
    private function render_empty(): string {
        return '<div class="yaa-message yaa-empty"><span class="yaa-icon">📦</span>' .
               '<p>' . esc_html__('Keine Produkte für diese Suche gefunden.', 'yadore-amazon-api') . '</p></div>';
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\class-yadore-api.php 
 
<?php
/**
 * Yadore API Handler
 * PHP 8.3+ compatible
 * Version: 1.5.0
 * 
 * Features:
 * - Offer API (/v2/offer)
 * - Merchant API (/v2/merchant)
 * - Deeplink Merchant API (/v2/deeplink/merchant) mit CPC-Daten
 * - Merchant Filter (Whitelist/Blacklist)
 * - NEU: Sortierung (Preis/CPC/Relevanz)
 * - NEU: Thumbnail Fallback
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Yadore_API {
    
    private const API_URL = 'https://api.yadore.com/v2/offer';
    private const MERCHANT_API_URL = 'https://api.yadore.com/v2/merchant';
    private const DEEPLINK_MERCHANT_API_URL = 'https://api.yadore.com/v2/deeplink/merchant';
    
    private YAA_Cache_Handler $cache;
    private string $api_key = '';
    
    /**
     * Verfügbare Märkte
     * @var array<string, string>
     */
    private const MARKETS = [
        'de' => 'Deutschland',
        'at' => 'Österreich',
        'ch' => 'Schweiz',
        'fr' => 'Frankreich',
        'it' => 'Italien',
        'es' => 'Spanien',
        'nl' => 'Niederlande',
        'be' => 'Belgien',
        'pl' => 'Polen',
        'se' => 'Schweden',
        'uk' => 'Großbritannien',
        'us' => 'USA',
        'br' => 'Brasilien',
        'mx' => 'Mexiko',
        'au' => 'Australien',
    ];
    
    /**
     * Verfügbare Sortieroptionen
     * @var array<string, string>
     */
    public const SORT_OPTIONS = [
        'rel_desc'   => 'Relevanz (Standard)',
        'price_asc'  => 'Preis aufsteigend (günstigste zuerst)',
        'price_desc' => 'Preis absteigend (teuerste zuerst)',
        'cpc_desc'   => 'CPC absteigend (höchste Vergütung zuerst)',
        'cpc_asc'    => 'CPC aufsteigend (niedrigste Vergütung zuerst)',
    ];
    
    public function __construct(YAA_Cache_Handler $cache) {
        $this->cache = $cache;
        $this->load_api_key();
    }
    
    /**
     * Load API key from config or options
     */
    private function load_api_key(): void {
        $this->api_key = defined('YADORE_API_KEY') 
            ? (string) YADORE_API_KEY 
            : (string) yaa_get_option('yadore_api_key', '');
    }
    
    /**
     * Reload API key (nach Einstellungsänderung)
     */
    public function reload_api_key(): void {
        $this->load_api_key();
    }
    
    /**
     * Check if API is configured
     */
    public function is_configured(): bool {
        return $this->api_key !== '' && yaa_get_option('enable_yadore', 'yes') === 'yes';
    }
    
    /**
     * Get API key (für Merchant Filter)
     */
    public function get_api_key(): string {
        return $this->api_key;
    }
    
    /**
     * Get available markets
     * 
     * @return array<string, string>
     */
    public function get_markets(): array {
        return self::MARKETS;
    }
    
    /**
     * Get available sort options
     * 
     * @return array<string, string>
     */
    public function get_sort_options(): array {
        return self::SORT_OPTIONS;
    }
    
    /**
     * Fetch products from Yadore API
     * 
     * @param array<string, mixed> $params
     * @return array<int, array<string, mixed>>|\WP_Error
     */
    public function fetch(array $params): array|\WP_Error {
        if (!$this->is_configured()) {
            return new \WP_Error('not_configured', __('Yadore API nicht konfiguriert.', 'yadore-amazon-api'));
        }
        
        $keyword = trim($params['keyword'] ?? '');
        $limit = (int) ($params['limit'] ?? 9);
        $market = $params['market'] ?? yaa_get_option('yadore_market', 'de');
        $precision = $params['precision'] ?? yaa_get_option('yadore_precision', 'fuzzy');
        $ean = $params['ean'] ?? '';
        $merchant_id = $params['merchant_id'] ?? '';
        
        // NEU: Sortierung - Standard aus Einstellungen oder Parameter
        $sort = $params['sort'] ?? yaa_get_option('yadore_default_sort', 'rel_desc');
        
        // Filter-Konfiguration aus Parametern extrahieren
        $filter_config = [
            'whitelist' => $params['merchant_whitelist'] ?? '',
            'blacklist' => $params['merchant_blacklist'] ?? '',
        ];
        
        // Prüfen ob CPC-Sortierung gewünscht ist (wird nach dem API-Abruf durchgeführt)
        $sort_by_cpc = in_array($sort, ['cpc_desc', 'cpc_asc'], true);
        $cpc_sort_direction = $sort === 'cpc_desc' ? 'desc' : 'asc';
        
        // API-Sortierung (nur price/relevance wird von der API unterstützt)
        $api_sort = $sort_by_cpc ? 'rel_desc' : $sort;
        
        // Build cache key (inkl. Filter und Sortierung)
        $filter_hash = md5(serialize($filter_config));
        $cache_key = 'yadore_' . md5($keyword . $ean . $market . $precision . $limit . $merchant_id . $filter_hash . $sort);
        
        // Check cache
        $cached = $this->cache->get($cache_key);
        if ($cached !== false && is_array($cached)) {
            return $cached;
        }
        
        // Bei CPC-Sortierung mehr Ergebnisse laden für bessere Sortierung
        $api_limit = $sort_by_cpc ? min(100, $limit + 50) : min(100, max(1, $limit + 20));
        
        // Build query params
        $query_params = [
            'market'    => $market,
            'precision' => $precision,
            'limit'     => $api_limit,
        ];
        
        if ($keyword !== '') {
            $query_params['keyword'] = $keyword;
        }
        
        if ($ean !== '') {
            $query_params['ean'] = $ean;
        }
        
        if ($merchant_id !== '') {
            $query_params['merchantId'] = $merchant_id;
        }
        
        // API-Sortierung hinzufügen (nur wenn nicht CPC-Sortierung)
        if (!$sort_by_cpc && in_array($api_sort, ['rel_desc', 'price_asc', 'price_desc'], true)) {
            $query_params['sort'] = $api_sort;
        }
        
        // Make API request
        $url = self::API_URL . '?' . http_build_query($query_params);
        
        $response = wp_remote_get($url, [
            'timeout' => 15,
            'headers' => [
                'API-Key' => $this->api_key,
                'Accept'  => 'application/json',
            ],
        ]);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code !== 200) {
            $error_message = $data['errors']['market'][0] 
                ?? $data['errors']['keyword'][0] 
                ?? 'HTTP Error ' . $status_code;
            return new \WP_Error('api_error', $error_message);
        }
        
        if (!is_array($data)) {
            return new \WP_Error('invalid_response', __('Ungültige API-Antwort.', 'yadore-amazon-api'));
        }
        
        // Normalize products (inkl. Thumbnail Fallback)
        $products = $this->normalize_response($data);
        
        // Händlerfilter anwenden
        $products = $this->apply_merchant_filter($products, $filter_config, $params);
        
        // NEU: CPC-Sortierung durchführen (wenn gewünscht)
        if ($sort_by_cpc) {
            $products = $this->sort_by_cpc($products, $cpc_sort_direction);
        }
        
        // Auf gewünschtes Limit kürzen
        $products = array_slice($products, 0, $limit);
        
        // Cache results
        $this->cache->set($cache_key, $products, yaa_get_cache_time());
        
        // Track keyword
        $this->track_keyword($keyword, $market, $limit);
        
        return $products;
    }
    
    /**
     * NEU: Sortiert Produkte nach CPC
     * 
     * @param array<int, array<string, mixed>> $products
     * @param string $direction 'asc' oder 'desc'
     * @return array<int, array<string, mixed>>
     */
    private function sort_by_cpc(array $products, string $direction = 'desc'): array {
        usort($products, function($a, $b) use ($direction) {
            $cpc_a = (float) ($a['estimated_cpc']['amount'] ?? 0);
            $cpc_b = (float) ($b['estimated_cpc']['amount'] ?? 0);
            
            if ($direction === 'desc') {
                return $cpc_b <=> $cpc_a; // Höchste zuerst
            }
            return $cpc_a <=> $cpc_b; // Niedrigste zuerst
        });
        
        return $products;
    }
    
    /**
     * Wendet den Händlerfilter auf Produkte an
     * 
     * @param array<int, array<string, mixed>> $products
     * @param array<string, mixed> $filter_config Shortcode-Filter
     * @param array<string, mixed> $params Original-Parameter
     * @return array<int, array<string, mixed>>
     */
    private function apply_merchant_filter(array $products, array $filter_config, array $params): array {
        // Filter-Konfiguration erstellen (Shortcode hat Vorrang)
        $shortcode_whitelist = $filter_config['whitelist'] ?? '';
        $shortcode_blacklist = $filter_config['blacklist'] ?? '';
        
        // Wenn Shortcode-Parameter leer sind, globale Einstellungen laden
        if ($shortcode_whitelist === '' && $shortcode_blacklist === '') {
            $final_config = [
                'whitelist' => YAA_Merchant_Filter::normalize_merchant_list(
                    yaa_get_option('yadore_merchant_whitelist', '')
                ),
                'blacklist' => YAA_Merchant_Filter::normalize_merchant_list(
                    yaa_get_option('yadore_merchant_blacklist', '')
                ),
            ];
        } else {
            // Shortcode-Parameter verwenden
            $final_config = [
                'whitelist' => YAA_Merchant_Filter::normalize_merchant_list($shortcode_whitelist),
                'blacklist' => YAA_Merchant_Filter::normalize_merchant_list($shortcode_blacklist),
            ];
        }
        
        return YAA_Merchant_Filter::filter_products($products, $final_config);
    }
    
    /**
     * Holt die Händlerliste von der Offer-API (/v2/merchant)
     * Diese Händler haben Produkt-Angebote
     * 
     * @param string $market Markt
     * @param bool $force_refresh Cache ignorieren
     * @return array{success: bool, merchants: array<int, array<string, mixed>>, error?: string, from_cache?: bool}
     */
    public function fetch_merchants(string $market = 'de', bool $force_refresh = false): array {
        return YAA_Merchant_Filter::fetch_merchants($this->api_key, $market, $force_refresh);
    }
    
    /**
     * Holt Deeplink-Händler von der API (/v2/deeplink/merchant)
     * Diese Händler haben CPC-Daten!
     * 
     * @param string $market Markt (z.B. 'de', 'at', 'ch')
     * @param bool $smartlink_only Nur Smartlink-Händler zurückgeben
     * @param bool $force_refresh Cache ignorieren
     * @return array{success: bool, merchants: array<int, array<string, mixed>>, error?: string, total?: int, from_cache?: bool}
     */
    public function fetch_deeplink_merchants(
        string $market = 'de', 
        bool $smartlink_only = false,
        bool $force_refresh = false
    ): array {
        if ($this->api_key === '') {
            return [
                'success' => false,
                'merchants' => [],
                'error' => __('Kein API-Key konfiguriert.', 'yadore-amazon-api'),
            ];
        }
        
        // Cache-Key erstellen
        $cache_key = 'yadore_deeplink_merchants_' . $market . ($smartlink_only ? '_smartlink' : '_all');
        
        // Cache prüfen
        if (!$force_refresh) {
            $cached = get_transient($cache_key);
            if ($cached !== false && is_array($cached)) {
                return [
                    'success' => true,
                    'merchants' => $cached,
                    'total' => count($cached),
                    'from_cache' => true,
                ];
            }
        }
        
        // Query-Parameter aufbauen
        $query_params = ['market' => $market];
        
        if ($smartlink_only) {
            $query_params['isSmartlink'] = '1';
        }
        
        // API Request
        $url = self::DEEPLINK_MERCHANT_API_URL . '?' . http_build_query($query_params);
        
        $response = wp_remote_get($url, [
            'timeout' => 30,
            'headers' => [
                'API-Key' => $this->api_key,
                'Accept'  => 'application/json',
            ],
        ]);
        
        if (is_wp_error($response)) {
            return [
                'success' => false,
                'merchants' => [],
                'error' => $response->get_error_message(),
            ];
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code !== 200 || !is_array($data)) {
            $error_message = 'HTTP Error ' . $status_code;
            
            if (is_array($data) && isset($data['errors'])) {
                $first_error = reset($data['errors']);
                if (is_array($first_error)) {
                    $error_message = $first_error[0] ?? $error_message;
                }
            }
            
            return [
                'success' => false,
                'merchants' => [],
                'error' => sprintf(__('API Fehler: %s', 'yadore-amazon-api'), $error_message),
            ];
        }
        
        // Händler extrahieren und normalisieren
        $merchants = $data['merchants'] ?? [];
        
        // Händler mit CPC-Daten anreichern
        $normalized_merchants = [];
        
        foreach ($merchants as $merchant) {
            $normalized = [
                'id'                    => $merchant['id'] ?? '',
                'name'                  => $merchant['name'] ?? '',
                'isSmartlink'           => (bool) ($merchant['isSmartlink'] ?? false),
                'hasSmartlinkHomepage'  => (bool) ($merchant['hasSmartlinkHomepage'] ?? false),
                'hasExternalHomepage'   => (bool) ($merchant['hasExternalHomepage'] ?? false),
                'deeplinkCount'         => (int) ($merchant['deeplinkCount'] ?? 0),
                'logo'                  => [
                    'url'    => $merchant['logo']['url'] ?? '',
                    'exists' => (bool) ($merchant['logo']['exists'] ?? false),
                ],
                'trafficTypes'          => $merchant['trafficTypes'] ?? [],
                // CPC-Daten
                'estimatedCpc'          => [
                    'amount'   => $merchant['estimatedCpc']['amount'] ?? null,
                    'currency' => $merchant['estimatedCpc']['currency'] ?? 'EUR',
                ],
            ];
            
            $normalized_merchants[] = $normalized;
        }
        
        // Nach Name sortieren
        usort($normalized_merchants, fn($a, $b) => strcasecmp($a['name'] ?? '', $b['name'] ?? ''));
        
        // Cache speichern (4 Stunden)
        set_transient($cache_key, $normalized_merchants, 4 * HOUR_IN_SECONDS);
        
        // Auch in Option speichern für Offline-Nutzung in Admin
        update_option('yaa_yadore_deeplink_merchants_' . $market, $normalized_merchants, false);
        update_option('yaa_yadore_deeplink_merchants_updated_' . $market, time(), false);
        
        return [
            'success' => true,
            'merchants' => $normalized_merchants,
            'total' => $data['total'] ?? count($normalized_merchants),
            'from_cache' => false,
        ];
    }
    
    /**
     * Holt gespeicherte Deeplink-Händler aus der Datenbank
     * 
     * @param string $market Markt
     * @return array<int, array<string, mixed>>
     */
    public function get_stored_deeplink_merchants(string $market = 'de'): array {
        $merchants = get_option('yaa_yadore_deeplink_merchants_' . $market, []);
        return is_array($merchants) ? $merchants : [];
    }
    
    /**
     * Gibt das letzte Update-Datum der Deeplink-Händler zurück
     * 
     * @param string $market Markt
     * @return int|null Unix Timestamp oder null
     */
    public function get_deeplink_merchants_last_update(string $market = 'de'): ?int {
        $timestamp = get_option('yaa_yadore_deeplink_merchants_updated_' . $market, null);
        return $timestamp !== null ? (int) $timestamp : null;
    }
    
    /**
     * Holt CPC für einen bestimmten Händler
     * 
     * @param string $merchant_id Händler-ID (64 Zeichen Hex)
     * @param string $market Markt
     * @return array{amount: float|null, currency: string}
     */
    public function get_merchant_cpc(string $merchant_id, string $market = 'de'): array {
        $merchants = $this->get_stored_deeplink_merchants($market);
        
        foreach ($merchants as $merchant) {
            if (($merchant['id'] ?? '') === $merchant_id) {
                $amount = $merchant['estimatedCpc']['amount'] ?? null;
                
                return [
                    'amount'   => $amount !== null ? (float) $amount : null,
                    'currency' => $merchant['estimatedCpc']['currency'] ?? 'EUR',
                ];
            }
        }
        
        return [
            'amount'   => null,
            'currency' => 'EUR',
        ];
    }
    
    /**
     * Holt CPC für einen Händler nach Namen
     * 
     * @param string $merchant_name Händlername
     * @param string $market Markt
     * @return array{amount: float|null, currency: string, merchant_id: string|null}
     */
    public function get_merchant_cpc_by_name(string $merchant_name, string $market = 'de'): array {
        $merchants = $this->get_stored_deeplink_merchants($market);
        $merchant_name_lower = mb_strtolower($merchant_name, 'UTF-8');
        
        foreach ($merchants as $merchant) {
            $name = mb_strtolower($merchant['name'] ?? '', 'UTF-8');
            
            // Exakter Match oder enthält
            if ($name === $merchant_name_lower || str_contains($name, $merchant_name_lower)) {
                $amount = $merchant['estimatedCpc']['amount'] ?? null;
                
                return [
                    'amount'      => $amount !== null ? (float) $amount : null,
                    'currency'    => $merchant['estimatedCpc']['currency'] ?? 'EUR',
                    'merchant_id' => $merchant['id'] ?? null,
                ];
            }
        }
        
        return [
            'amount'      => null,
            'currency'    => 'EUR',
            'merchant_id' => null,
        ];
    }
    
    /**
     * Holt alle Händler mit CPC sortiert nach CPC (absteigend)
     * 
     * @param string $market Markt
     * @param int $limit Max. Anzahl (0 = alle)
     * @return array<int, array{id: string, name: string, cpc_amount: float, cpc_currency: string, is_smartlink: bool}>
     */
    public function get_merchants_by_cpc(string $market = 'de', int $limit = 0): array {
        $merchants = $this->get_stored_deeplink_merchants($market);
        
        // Nur Händler mit CPC
        $with_cpc = array_filter($merchants, function($m) {
            $amount = $m['estimatedCpc']['amount'] ?? null;
            return $amount !== null && (float) $amount > 0;
        });
        
        // Nach CPC sortieren (höchster zuerst)
        usort($with_cpc, function($a, $b) {
            $cpc_a = (float) ($a['estimatedCpc']['amount'] ?? 0);
            $cpc_b = (float) ($b['estimatedCpc']['amount'] ?? 0);
            return $cpc_b <=> $cpc_a;
        });
        
        // Limit anwenden
        if ($limit > 0) {
            $with_cpc = array_slice($with_cpc, 0, $limit);
        }
        
        // Vereinfachtes Format zurückgeben
        $result = [];
        foreach ($with_cpc as $merchant) {
            $result[] = [
                'id'           => $merchant['id'] ?? '',
                'name'         => $merchant['name'] ?? '',
                'cpc_amount'   => (float) ($merchant['estimatedCpc']['amount'] ?? 0),
                'cpc_currency' => $merchant['estimatedCpc']['currency'] ?? 'EUR',
                'is_smartlink' => (bool) ($merchant['isSmartlink'] ?? false),
            ];
        }
        
        return $result;
    }
    
    /**
     * Berechnet Statistiken über CPC-Daten
     * 
     * @param string $market Markt
     * @return array{total: int, with_cpc: int, avg_cpc: float, min_cpc: float, max_cpc: float, currency: string}
     */
    public function get_cpc_statistics(string $market = 'de'): array {
        $merchants = $this->get_stored_deeplink_merchants($market);
        
        $stats = [
            'total'    => count($merchants),
            'with_cpc' => 0,
            'avg_cpc'  => 0.0,
            'min_cpc'  => 0.0,
            'max_cpc'  => 0.0,
            'currency' => 'EUR',
        ];
        
        $cpc_values = [];
        
        foreach ($merchants as $merchant) {
            $amount = $merchant['estimatedCpc']['amount'] ?? null;
            
            if ($amount !== null && (float) $amount > 0) {
                $cpc_values[] = (float) $amount;
                $stats['currency'] = $merchant['estimatedCpc']['currency'] ?? 'EUR';
            }
        }
        
        if (!empty($cpc_values)) {
            $stats['with_cpc'] = count($cpc_values);
            $stats['avg_cpc'] = round(array_sum($cpc_values) / count($cpc_values), 4);
            $stats['min_cpc'] = min($cpc_values);
            $stats['max_cpc'] = max($cpc_values);
        }
        
        return $stats;
    }
    
    /**
     * Kombiniert Offer-Händler und Deeplink-Händler
     * Gibt eine einheitliche Liste mit allen verfügbaren Daten zurück
     * 
     * @param string $market Markt
     * @return array<int, array<string, mixed>>
     */
    public function get_all_merchants_combined(string $market = 'de'): array {
        // Offer-Händler laden
        $offer_merchants = YAA_Merchant_Filter::get_stored_merchants($market);
        
        // Deeplink-Händler laden
        $deeplink_merchants = $this->get_stored_deeplink_merchants($market);
        
        // Index für Deeplink-Händler erstellen (nach ID)
        $deeplink_index = [];
        foreach ($deeplink_merchants as $dm) {
            $deeplink_index[$dm['id'] ?? ''] = $dm;
        }
        
        // Kombinierte Liste erstellen
        $combined = [];
        $seen_ids = [];
        
        // Zuerst Offer-Händler verarbeiten
        foreach ($offer_merchants as $om) {
            $id = $om['id'] ?? '';
            $seen_ids[$id] = true;
            
            $entry = [
                'id'           => $id,
                'name'         => $om['name'] ?? '',
                'offer_count'  => (int) ($om['offerCount'] ?? 0),
                'logo_url'     => $om['logo'] ?? '',
                'has_logo'     => (bool) ($om['hasLogo'] ?? false),
                'type'         => 'offer',
                'is_deeplink'  => false,
                'is_smartlink' => false,
                'cpc_amount'   => null,
                'cpc_currency' => 'EUR',
            ];
            
            // Mit Deeplink-Daten anreichern falls vorhanden
            if (isset($deeplink_index[$id])) {
                $dm = $deeplink_index[$id];
                $entry['is_deeplink'] = true;
                $entry['is_smartlink'] = (bool) ($dm['isSmartlink'] ?? false);
                $entry['deeplink_count'] = (int) ($dm['deeplinkCount'] ?? 0);
                
                $cpc = $dm['estimatedCpc']['amount'] ?? null;
                if ($cpc !== null) {
                    $entry['cpc_amount'] = (float) $cpc;
                    $entry['cpc_currency'] = $dm['estimatedCpc']['currency'] ?? 'EUR';
                }
            }
            
            $combined[] = $entry;
        }
        
        // Dann Deeplink-only Händler hinzufügen
        foreach ($deeplink_merchants as $dm) {
            $id = $dm['id'] ?? '';
            
            if (isset($seen_ids[$id])) {
                continue; // Bereits verarbeitet
            }
            
            $cpc = $dm['estimatedCpc']['amount'] ?? null;
            
            $combined[] = [
                'id'             => $id,
                'name'           => $dm['name'] ?? '',
                'offer_count'    => 0,
                'deeplink_count' => (int) ($dm['deeplinkCount'] ?? 0),
                'logo_url'       => $dm['logo']['url'] ?? '',
                'has_logo'       => (bool) ($dm['logo']['exists'] ?? false),
                'type'           => 'deeplink',
                'is_deeplink'    => true,
                'is_smartlink'   => (bool) ($dm['isSmartlink'] ?? false),
                'cpc_amount'     => $cpc !== null ? (float) $cpc : null,
                'cpc_currency'   => $dm['estimatedCpc']['currency'] ?? 'EUR',
            ];
        }
        
        // Nach Name sortieren
        usort($combined, fn($a, $b) => strcasecmp($a['name'] ?? '', $b['name'] ?? ''));
        
        return $combined;
    }
    
    /**
     * Normalize API response to standard format
     * NEU: Thumbnail als Fallback für Image
     * 
     * @param array<string, mixed> $data
     * @return array<int, array<string, mixed>>
     */
    private function normalize_response(array $data): array {
        $products = [];
        $offers = $data['offers'] ?? [];
        
        foreach ($offers as $offer) {
            // NEU: Bild-URL mit Thumbnail-Fallback
            $image_url = $offer['image']['url'] ?? '';
            $thumbnail_url = $offer['thumbnail']['url'] ?? '';
            
            // Fallback-Kette: image -> thumbnail -> leer
            $final_image_url = $image_url;
            if ($final_image_url === '' && $thumbnail_url !== '') {
                $final_image_url = $thumbnail_url;
            }
            
            $products[] = [
                'id'          => $offer['id'] ?? uniqid('yadore_'),
                'title'       => $offer['title'] ?? '',
                'description' => $offer['description'] ?? '',
                'url'         => $offer['clickUrl'] ?? '',
                'image'       => [
                    'url'           => $final_image_url,
                    'original_url'  => $image_url,      // NEU: Original-Bild URL
                    'thumbnail_url' => $thumbnail_url,  // NEU: Thumbnail URL
                ],
                'price'       => [
                    'amount'   => $offer['price']['amount'] ?? '',
                    'currency' => $offer['price']['currency'] ?? 'EUR',
                    'display'  => '',
                ],
                'merchant'    => [
                    'id'   => $offer['merchant']['id'] ?? '',
                    'name' => $offer['merchant']['name'] ?? '',
                    'logo' => $offer['merchant']['logo']['url'] ?? '',
                ],
                'source'       => 'yadore',
                'availability' => $offer['availability'] ?? 'UNKNOWN',
                'is_prime'     => false,
                'ean'          => $offer['ean'] ?? '',
                'brand'        => $offer['brand'] ?? '',
                // CPC aus Offer (falls vorhanden)
                'estimated_cpc' => [
                    'amount'   => $offer['estimatedCpc']['amount'] ?? null,
                    'currency' => $offer['estimatedCpc']['currency'] ?? 'EUR',
                ],
            ];
        }
        
        return $products;
    }
    
    /**
     * Track keyword for cron preload
     */
    private function track_keyword(string $keyword, string $market, int $limit): void {
        if ($keyword === '') {
            return;
        }
        
        $cached_keywords = get_option('yaa_cached_keywords', []);
        
        if (!is_array($cached_keywords)) {
            $cached_keywords = [];
        }
        
        $new_entry = [
            'keyword' => $keyword,
            'market'  => $market,
            'limit'   => $limit,
            'source'  => 'yadore',
        ];
        
        // Check for duplicates
        foreach ($cached_keywords as $entry) {
            if (($entry['keyword'] ?? '') === $keyword 
                && ($entry['source'] ?? '') === 'yadore'
                && ($entry['market'] ?? 'de') === $market) {
                return;
            }
        }
        
        $cached_keywords[] = $new_entry;
        $cached_keywords = array_slice($cached_keywords, -30);
        update_option('yaa_cached_keywords', $cached_keywords);
    }
    
    /**
     * Test API connection
     * 
     * @return array{success: bool, message: string}
     */
    public function test_connection(?string $api_key = null): array {
        $key = $api_key ?? $this->api_key;
        
        if ($key === '') {
            return [
                'success' => false,
                'message' => __('Kein API-Key konfiguriert.', 'yadore-amazon-api'),
            ];
        }
        
        $url = self::API_URL . '?' . http_build_query([
            'market'  => 'de',
            'keyword' => 'test',
            'limit'   => 1,
        ]);
        
        $response = wp_remote_get($url, [
            'timeout' => 10,
            'headers' => [
                'API-Key' => $key,
                'Accept'  => 'application/json',
            ],
        ]);
        
        if (is_wp_error($response)) {
            return [
                'success' => false,
                'message' => $response->get_error_message(),
            ];
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        
        if ($status_code === 200) {
            return [
                'success' => true,
                'message' => __('Verbindung erfolgreich!', 'yadore-amazon-api'),
            ];
        }
        
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        $error = $data['errors']['market'][0] ?? 'HTTP Error ' . $status_code;
        
        return [
            'success' => false,
            'message' => $error,
        ];
    }
    
    /**
     * Test Deeplink API connection
     * 
     * @return array{success: bool, message: string, merchant_count?: int}
     */
    public function test_deeplink_connection(?string $api_key = null): array {
        $key = $api_key ?? $this->api_key;
        
        if ($key === '') {
            return [
                'success' => false,
                'message' => __('Kein API-Key konfiguriert.', 'yadore-amazon-api'),
            ];
        }
        
        $url = self::DEEPLINK_MERCHANT_API_URL . '?' . http_build_query([
            'market' => 'de',
        ]);
        
        $response = wp_remote_get($url, [
            'timeout' => 15,
            'headers' => [
                'API-Key' => $key,
                'Accept'  => 'application/json',
            ],
        ]);
        
        if (is_wp_error($response)) {
            return [
                'success' => false,
                'message' => $response->get_error_message(),
            ];
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code === 200 && is_array($data)) {
            $total = $data['total'] ?? count($data['merchants'] ?? []);
            
            return [
                'success' => true,
                'message' => sprintf(
                    __('Deeplink API erfolgreich! %d Händler gefunden.', 'yadore-amazon-api'),
                    $total
                ),
                'merchant_count' => $total,
            ];
        }
        
        $error = 'HTTP Error ' . $status_code;
        if (is_array($data) && isset($data['errors'])) {
            $first_error = reset($data['errors']);
            if (is_array($first_error)) {
                $error = $first_error[0] ?? $error;
            }
        }
        
        return [
            'success' => false,
            'message' => $error,
        ];
    }
    
    /**
     * Löscht alle Merchant-Caches
     * 
     * @param string|null $market Spezifischer Markt oder null für alle
     */
    public function clear_merchant_cache(?string $market = null): void {
        if ($market !== null) {
            // Spezifischen Markt löschen
            delete_transient('yadore_merchants_list_' . $market);
            delete_transient('yadore_deeplink_merchants_' . $market . '_all');
            delete_transient('yadore_deeplink_merchants_' . $market . '_smartlink');
        } else {
            // Alle Märkte löschen
            global $wpdb;
            
            $wpdb->query(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_yadore_merchants_list_%'"
            );
            $wpdb->query(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_yadore_deeplink_merchants_%'"
            );
            $wpdb->query(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_yadore_merchants_list_%'"
            );
            $wpdb->query(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_yadore_deeplink_merchants_%'"
            );
        }
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\admin\class-admin-ajax.php 
 
<?php
/**
 * Admin AJAX Handler
 * PHP 8.3+ compatible
 * Version: 1.4.1
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin_Ajax {
    
    private YAA_Cache_Handler $cache;
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    
    public function __construct(
        YAA_Cache_Handler $cache,
        YAA_Yadore_API $yadore_api,
        YAA_Amazon_PAAPI $amazon_api
    ) {
        $this->cache = $cache;
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        
        // AJAX Actions registrieren
        add_action('wp_ajax_yaa_test_yadore', [$this, 'test_yadore']);
        add_action('wp_ajax_yaa_test_amazon', [$this, 'test_amazon']);
        add_action('wp_ajax_yaa_test_redis', [$this, 'test_redis']);
        add_action('wp_ajax_yaa_refresh_merchants', [$this, 'refresh_merchants']);
        add_action('wp_ajax_yaa_fetch_deeplink_merchants', [$this, 'fetch_deeplink_merchants']);
        add_action('wp_ajax_yaa_fetch_offers_with_cpc', [$this, 'fetch_offers_with_cpc']);
    }
    
    /**
     * Test Yadore API connection
     */
    public function test_yadore(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $api_key = sanitize_text_field($_POST['yadore_api_key'] ?? '');
        $result = $this->yadore_api->test_connection($api_key !== '' ? $api_key : null);
        
        if ($result['success']) {
            wp_send_json_success($result);
        } else {
            wp_send_json_error($result);
        }
    }
    
    /**
     * Test Amazon API connection
     */
    public function test_amazon(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $access_key = sanitize_text_field($_POST['amazon_access_key'] ?? '');
        $secret_key = $_POST['amazon_secret_key'] ?? '';
        $partner_tag = sanitize_text_field($_POST['amazon_partner_tag'] ?? '');
        $marketplace = sanitize_text_field($_POST['amazon_marketplace'] ?? 'de');
        
        $result = $this->amazon_api->test_connection(
            $access_key !== '' ? $access_key : null,
            $secret_key !== '' ? $secret_key : null,
            $partner_tag !== '' ? $partner_tag : null,
            $marketplace
        );
        
        if ($result['success']) {
            wp_send_json_success($result);
        } else {
            wp_send_json_error($result);
        }
    }
    
    /**
     * Test Redis connection
     */
    public function test_redis(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $host = sanitize_text_field($_POST['redis_host'] ?? '127.0.0.1');
        $port = (int) ($_POST['redis_port'] ?? 6379);
        $password = $_POST['redis_password'] ?? '';
        $database = (int) ($_POST['redis_database'] ?? 0);
        
        $result = $this->cache->test_connection($host, $port, $password, $database);
        
        if ($result['success']) {
            wp_send_json_success($result);
        } else {
            wp_send_json_error($result);
        }
    }
    
    /**
     * Refresh merchant list (Offer Merchants)
     */
    public function refresh_merchants(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $market = sanitize_text_field($_POST['market'] ?? 'de');
        
        $result = $this->yadore_api->fetch_merchants($market, true);
        
        if ($result['success']) {
            wp_send_json_success([
                'message' => sprintf(
                    __('%d Händler geladen!', 'yadore-amazon-api'),
                    count($result['merchants'])
                ),
                'count' => count($result['merchants']),
            ]);
        } else {
            wp_send_json_error([
                'message' => $result['error'] ?? __('Unbekannter Fehler', 'yadore-amazon-api'),
            ]);
        }
    }
    
    /**
     * Fetch Deeplink Merchants (mit CPC)
     */
    public function fetch_deeplink_merchants(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $market = sanitize_text_field($_POST['market'] ?? 'de');
        $smartlink_only = isset($_POST['smartlink_only']) && $_POST['smartlink_only'] === '1';
        
        $result = $this->yadore_api->fetch_deeplink_merchants($market, $smartlink_only, true);
        
        if ($result['success']) {
            wp_send_json_success([
                'message' => sprintf(
                    __('%d Deeplink-Händler geladen!', 'yadore-amazon-api'),
                    count($result['merchants'])
                ),
                'merchants' => $result['merchants'],
                'count' => count($result['merchants']),
            ]);
        } else {
            wp_send_json_error([
                'message' => $result['error'] ?? __('Unbekannter Fehler', 'yadore-amazon-api'),
            ]);
        }
    }
    
    /**
     * NEU: Fetch Offers mit CPC-Daten für Revenue-Kalkulator
     * Ruft die /v2/offer API auf und gibt CPC pro Angebot zurück
     */
    public function fetch_offers_with_cpc(): void {
        check_ajax_referer('yaa_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(['message' => __('Keine Berechtigung', 'yadore-amazon-api')]);
        }
        
        $keyword = sanitize_text_field($_POST['keyword'] ?? '');
        $market = sanitize_text_field($_POST['market'] ?? 'de');
        $limit = max(1, min(100, (int) ($_POST['limit'] ?? 9)));
        
        if ($keyword === '') {
            wp_send_json_error(['message' => __('Kein Keyword angegeben.', 'yadore-amazon-api')]);
        }
        
        // Direkte API-Abfrage (ohne Merchant-Filter, um alle CPC zu sehen)
        $api_key = $this->yadore_api->get_api_key();
        
        if ($api_key === '') {
            wp_send_json_error(['message' => __('Kein API-Key konfiguriert.', 'yadore-amazon-api')]);
        }
        
        $url = 'https://api.yadore.com/v2/offer?' . http_build_query([
            'market'    => $market,
            'keyword'   => $keyword,
            'limit'     => $limit,
            'precision' => 'fuzzy',
        ]);
        
        $response = wp_remote_get($url, [
            'timeout' => 30,
            'headers' => [
                'API-Key' => $api_key,
                'Accept'  => 'application/json',
            ],
        ]);
        
        if (is_wp_error($response)) {
            wp_send_json_error(['message' => $response->get_error_message()]);
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code !== 200 || !is_array($data)) {
            $error = $data['errors']['market'][0] ?? $data['errors']['keyword'][0] ?? 'HTTP Error ' . $status_code;
            wp_send_json_error(['message' => $error]);
        }
        
        // Angebote mit CPC extrahieren
        $offers = [];
        $raw_offers = $data['offers'] ?? [];
        
        foreach ($raw_offers as $offer) {
            $cpc_amount = null;
            $cpc_currency = 'EUR';
            
            // CPC aus estimatedCpc extrahieren
            if (isset($offer['estimatedCpc']['amount'])) {
                $cpc_amount = (float) $offer['estimatedCpc']['amount'];
                $cpc_currency = $offer['estimatedCpc']['currency'] ?? 'EUR';
            }
            
            $offers[] = [
                'id'             => $offer['id'] ?? '',
                'title'          => $offer['title'] ?? '',
                'merchant_name'  => $offer['merchant']['name'] ?? '',
                'merchant_id'    => $offer['merchant']['id'] ?? '',
                'price_amount'   => $offer['price']['amount'] ?? '',
                'price_currency' => $offer['price']['currency'] ?? 'EUR',
                'price_display'  => '', // Yadore liefert kein display
                'image_url'      => $offer['image']['url'] ?? '',
                'cpc_amount'     => $cpc_amount,
                'cpc_currency'   => $cpc_currency,
                'availability'   => $offer['availability'] ?? 'UNKNOWN',
            ];
        }
        
        wp_send_json_success([
            'offers' => $offers,
            'count'  => count($offers),
            'total'  => $data['total'] ?? count($offers),
        ]);
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\admin\class-admin-docs.php 
 
<?php
/**
 * Admin Documentation Page
 * Dokumentation und Shortcode-Referenz
 * PHP 8.3+ compatible
 * Version: 1.4.0
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin_Docs {
    
    public function __construct() {
        // Keine Abhängigkeiten benötigt
    }
    
    /**
     * Render documentation page
     */
    public function render_page(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1><?php esc_html_e('Dokumentation', 'yadore-amazon-api'); ?></h1>
            
            <!-- Quick Navigation -->
            <div class="yaa-card" style="background: #f0f6fc;">
                <h2 style="margin-top: 0;">🧭 Schnellnavigation</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <a href="#shortcodes" class="button">📝 Shortcodes</a>
                    <a href="#css-classes" class="button">🎨 CSS Klassen</a>
                    <a href="#wp-config" class="button">⚙️ wp-config.php</a>
                    <a href="#cpc-info" class="button">💰 CPC-Informationen</a>
                    <a href="#merchant-filter" class="button">🏪 Händler-Filter</a>
                    <a href="#links" class="button">🔗 Links</a>
                </div>
            </div>
            
            <div id="shortcodes" class="yaa-card">
                <h2>📝 Shortcodes</h2>
                
                <h3>Yadore Produkte</h3>
                <div class="yaa-shortcode-box">[yadore_products keyword="Smartphone" limit="9"]</div>
                <div class="yaa-shortcode-box">[yadore_products keywords="Smartphone,Tablet,Laptop" limit="9"]</div>
                <div class="yaa-shortcode-box">[yadore_products keyword="Kopfhörer" local_images="yes"]</div>
                <div class="yaa-shortcode-box">[yadore_products keyword="Gaming" hide_no_image="yes"]</div>
                
                <h3>Yadore mit Händler-Filter</h3>
                <div class="yaa-shortcode-box">[yadore_products keyword="Laptop" merchant_whitelist="amazon,otto"]</div>
                <div class="yaa-shortcode-box">[yadore_products keyword="Handy" merchant_blacklist="aliexpress,wish"]</div>
                <div class="yaa-shortcode-box">[yadore_products keyword="Tablet" merchants="mediamarkt,saturn"]</div>
                
                <h3>Amazon Produkte</h3>
                <div class="yaa-shortcode-box">[amazon_products keyword="Laptop" category="Computers" limit="10"]</div>
                <div class="yaa-shortcode-box">[amazon_products asins="B08N5WRWNW,B09V3KXJPB"]</div>
                <div class="yaa-shortcode-box">[amazon_products keyword="Kopfhörer" min_price="50" max_price="200"]</div>
                
                <h3>Eigene Produkte</h3>
                <div class="yaa-shortcode-box">[custom_products ids="123,456,789"]</div>
                <div class="yaa-shortcode-box">[custom_products category="elektronik" limit="6"]</div>
                <div class="yaa-shortcode-box">[fuzzy_products keyword="Kopfhörer" limit="6"]</div>
                
                <h3>Kombiniert</h3>
                <div class="yaa-shortcode-box">[combined_products keyword="Kopfhörer" yadore_limit="6" amazon_limit="4"]</div>
                <div class="yaa-shortcode-box">[all_products keyword="Smartphone" total_limit="12" priority="custom,yadore,amazon"]</div>
                
                <h3>Mit eigenen Produkten mischen</h3>
                <div class="yaa-shortcode-box">[yadore_products keyword="Monitor" mix_custom="yes" custom_limit="2"]</div>
                <div class="yaa-shortcode-box">[amazon_products keyword="Tablet" mix_custom="yes" custom_position="alternate"]</div>
                
                <div class="yaa-tip">
                    <strong>Tipp:</strong> <code>custom_position</code> akzeptiert: <code>start</code>, <code>end</code>, <code>shuffle</code>, <code>alternate</code>
                </div>
            </div>
            
            <div id="merchant-filter" class="yaa-card">
                <h2>🏪 Händler-Filter Dokumentation</h2>
                
                <h3>Globale Einstellungen</h3>
                <p>Unter <strong>Yadore API → Händler-Filter</strong> kannst du globale Whitelist/Blacklist definieren.</p>
                
                <h3>Shortcode-Attribute</h3>
                <table class="widefat" style="margin: 15px 0;">
                    <thead>
                        <tr>
                            <th>Attribut</th>
                            <th>Alias</th>
                            <th>Beschreibung</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>merchant_whitelist</code></td>
                            <td><code>merchants</code></td>
                            <td>NUR diese Händler anzeigen (Komma-separiert)</td>
                        </tr>
                        <tr>
                            <td><code>merchant_blacklist</code></td>
                            <td><code>exclude_merchants</code></td>
                            <td>Diese Händler ausschließen (Komma-separiert)</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="yaa-feature-box warning">
                    <h4 style="margin-top: 0;">⚠️ Wichtig: Whitelist hat IMMER Vorrang</h4>
                    <p>Wenn eine Whitelist (global oder per Shortcode) gesetzt ist, wird die Blacklist komplett ignoriert.</p>
                </div>
                
                <h3>Matching-Regeln</h3>
                <ul style="list-style: disc; margin-left: 20px;">
                    <li><strong>Case-insensitive:</strong> "Amazon" = "amazon" = "AMAZON"</li>
                    <li><strong>Partial Match:</strong> "amazon" findet auch "Amazon Marketplace"</li>
                    <li><strong>Priorität:</strong> Shortcode-Parameter > Globale Einstellungen</li>
                </ul>
            </div>
            
            <div id="cpc-info" class="yaa-card">
                <h2>💰 CPC-Informationen (Cost Per Click)</h2>
                
                <p>Das Plugin kann CPC-Daten von der Yadore Deeplink-API abrufen und anzeigen.</p>
                
                <h3>Was ist der CPC?</h3>
                <p>Der <strong>estimatedCpc</strong> ist der <strong>Brutto-CPC</strong>, den Yadore vom Händler erhält. 
                   Dein tatsächlicher Verdienst hängt von deinem Revenue-Share ab.</p>
                
                <h3>CPC-Quellen</h3>
                <table class="widefat" style="margin: 15px 0;">
                    <thead>
                        <tr>
                            <th>API Endpoint</th>
                            <th>CPC verfügbar</th>
                            <th>Beschreibung</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>/v2/offer</code></td>
                            <td>✅ Ja (pro Angebot)</td>
                            <td>CPC für das spezifische Produkt/Angebot</td>
                        </tr>
                        <tr>
                            <td><code>/v2/deeplink/merchant</code></td>
                            <td>✅ Ja (pro Händler)</td>
                            <td>Durchschnittlicher CPC des Händlers</td>
                        </tr>
                        <tr>
                            <td><code>/v2/merchant</code></td>
                            <td>❌ Nein</td>
                            <td>Nur Händlerliste für Offer-API</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>Händlerübersicht</h3>
                <p>Die neue <strong>Händlerübersicht</strong> (Menü: Yadore-Amazon → 🏪 Händler & CPC) zeigt:</p>
                <ul style="list-style: disc; margin-left: 20px;">
                    <li>Alle Offer-Händler aus <code>/v2/merchant</code></li>
                    <li>Alle Deeplink-Händler aus <code>/v2/deeplink/merchant</code> mit CPC</li>
                    <li>Kombinierte Ansicht mit Filteroptionen</li>
                    <li>Export als CSV</li>
                </ul>
                
                <div class="yaa-feature-box info">
                    <h4 style="margin-top: 0;">💡 Hinweis zur Revenue-Berechnung</h4>
                    <p>Um deinen tatsächlichen Verdienst zu berechnen:</p>
                    <p><strong>Dein CPC = Angezeigter CPC × Dein Revenue-Share</strong></p>
                    <p>Beispiel: 0.15€ × 70% = 0.105€ pro Klick</p>
                </div>
            </div>
            
            <div id="css-classes" class="yaa-card">
                <h2>🎨 CSS Klassen Referenz</h2>
                <p>Nutzen Sie diese Klassen, um das Design über <strong>Custom CSS</strong> in Ihrem Theme anzupassen.</p>
                
                <div class="yaa-code-block">
                    <pre>
/* Haupt-Container */
.yaa-grid-container { }

/* Einzelnes Produkt-Element */
.yaa-item { }
.yaa-item.yaa-amazon { }  /* Nur Amazon */
.yaa-item.yaa-custom { }  /* Nur Eigene */
.yaa-item.yaa-yadore { }  /* Nur Yadore */

/* Badges */
.yaa-prime-badge { }
.yaa-custom-badge { }

/* Bild-Bereich */
.yaa-image-wrapper { }
.yaa-image-wrapper img { }
.yaa-image-wrapper.yaa-image-error { }
.yaa-placeholder { }
.yaa-no-image { }

/* Inhalt */
.yaa-content { }
.yaa-title { }
.yaa-title a { }

/* Beschreibung */
.yaa-description-wrapper { }
.yaa-description { }
.yaa-description.expanded { }
.yaa-read-more { }

/* Preis & Meta */
.yaa-meta { }
.yaa-price { }
.yaa-merchant { }

/* Buttons */
.yaa-button-wrapper { }
.yaa-button { }

/* Status Meldungen */
.yaa-message { }
.yaa-error { }
.yaa-empty { }
                    </pre>
                </div>
                
                <h3>CSS Custom Properties (Variablen)</h3>
                <div class="yaa-code-block">
                    <pre>
.yaa-grid-container {
    --yaa-primary: #ff00cc;
    --yaa-secondary: #00ffff;
    --yaa-amazon: #ff9900;
    --yaa-custom: #4CAF50;
    --yaa-columns-desktop: 3;
    --yaa-columns-tablet: 2;
    --yaa-columns-mobile: 1;
}
                    </pre>
                </div>
            </div>
            
            <div id="wp-config" class="yaa-card">
                <h2>⚙️ wp-config.php Konstanten</h2>
                <p>API-Keys können sicher in der <code>wp-config.php</code> definiert werden:</p>
                
                <div class="yaa-code-block">
                    <pre>
// Yadore API
define('YADORE_API_KEY', 'dein-api-key');

// Amazon PA-API 5.0
define('AMAZON_PAAPI_ACCESS_KEY', 'AKIAXXXXXXXXXX');
define('AMAZON_PAAPI_SECRET_KEY', 'dein-secret-key');
define('AMAZON_PAAPI_PARTNER_TAG', 'deinshop-21');

// Redis (optional)
define('WP_REDIS_HOST', '127.0.0.1');
define('WP_REDIS_PORT', 6379);
define('WP_REDIS_PASSWORD', ''); // Optional
define('WP_REDIS_DATABASE', 0);  // 0-15

// GitHub Token für Plugin-Updates (optional)
define('YAA_GITHUB_TOKEN', 'ghp_xxxxxxxxxxxx');
                    </pre>
                </div>
                
                <div class="yaa-tip">
                    <strong>Sicherheitshinweis:</strong> Wenn Konstanten in <code>wp-config.php</code> definiert sind, 
                    werden die Eingabefelder im Admin-Bereich deaktiviert und die Werte dort nicht angezeigt.
                </div>
            </div>
            
            <div class="yaa-card">
                <h2>📊 Shortcode-Attribute Übersicht</h2>
                
                <h3>Allgemeine Attribute (alle Shortcodes)</h3>
                <table class="widefat striped">
                    <thead>
                        <tr>
                            <th>Attribut</th>
                            <th>Standard</th>
                            <th>Beschreibung</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>limit</code></td>
                            <td>9/10</td>
                            <td>Max. Anzahl der Produkte</td>
                        </tr>
                        <tr>
                            <td><code>columns</code></td>
                            <td>3</td>
                            <td>Spalten im Grid (1-6)</td>
                        </tr>
                        <tr>
                            <td><code>class</code></td>
                            <td>—</td>
                            <td>Zusätzliche CSS-Klasse</td>
                        </tr>
                        <tr>
                            <td><code>local_images</code></td>
                            <td>Einstellung</td>
                            <td><code>yes</code>/<code>no</code> - Bilder lokal speichern</td>
                        </tr>
                        <tr>
                            <td><code>hide_no_image</code></td>
                            <td>no</td>
                            <td><code>yes</code> - Produkte ohne Bild ausblenden</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>Yadore-spezifische Attribute</h3>
                <table class="widefat striped">
                    <thead>
                        <tr>
                            <th>Attribut</th>
                            <th>Standard</th>
                            <th>Beschreibung</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>keyword</code> / <code>keywords</code></td>
                            <td>—</td>
                            <td>Suchbegriff(e), Komma-separiert</td>
                        </tr>
                        <tr>
                            <td><code>market</code></td>
                            <td>de</td>
                            <td>Markt (de, at, ch, fr, it, es, nl, be, pl, uk, us, br)</td>
                        </tr>
                        <tr>
                            <td><code>precision</code></td>
                            <td>fuzzy</td>
                            <td><code>fuzzy</code>/<code>strict</code></td>
                        </tr>
                        <tr>
                            <td><code>merchant_whitelist</code></td>
                            <td>—</td>
                            <td>Nur diese Händler (Komma-separiert)</td>
                        </tr>
                        <tr>
                            <td><code>merchant_blacklist</code></td>
                            <td>—</td>
                            <td>Diese Händler ausschließen</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>Amazon-spezifische Attribute</h3>
                <table class="widefat striped">
                    <thead>
                        <tr>
                            <th>Attribut</th>
                            <th>Standard</th>
                            <th>Beschreibung</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>keyword</code></td>
                            <td>—</td>
                            <td>Suchbegriff</td>
                        </tr>
                        <tr>
                            <td><code>asins</code></td>
                            <td>—</td>
                            <td>ASINs Komma-separiert (max. 10)</td>
                        </tr>
                        <tr>
                            <td><code>category</code></td>
                            <td>All</td>
                            <td>Amazon SearchIndex</td>
                        </tr>
                        <tr>
                            <td><code>min_price</code> / <code>max_price</code></td>
                            <td>—</td>
                            <td>Preisfilter in Euro</td>
                        </tr>
                        <tr>
                            <td><code>brand</code></td>
                            <td>—</td>
                            <td>Nach Marke filtern</td>
                        </tr>
                        <tr>
                            <td><code>sort</code></td>
                            <td>—</td>
                            <td>Sortierung (Price:LowToHigh, etc.)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="links" class="yaa-card">
                <h2>🔗 Nützliche Links</h2>
                <ul style="list-style: disc; margin-left: 20px; line-height: 2;">
                    <li><a href="https://www.yadore.com/publisher" target="_blank" rel="noopener">Yadore Publisher Portal</a></li>
                    <li><a href="https://api.yadore.com/docs" target="_blank" rel="noopener">Yadore API Dokumentation</a></li>
                    <li><a href="https://webservices.amazon.com/paapi5/documentation/" target="_blank" rel="noopener">Amazon PA-API 5.0 Dokumentation</a></li>
                    <li><a href="https://affiliate-program.amazon.de/" target="_blank" rel="noopener">Amazon PartnerNet (DE)</a></li>
                    <li><a href="https://github.com/matthesv/yadore-amazon-api" target="_blank" rel="noopener">Plugin GitHub Repository</a></li>
                </ul>
            </div>
            
            <div class="yaa-card">
                <h2>📧 Support</h2>
                <p>Bei Fragen oder Problemen:</p>
                <ul style="list-style: disc; margin-left: 20px;">
                    <li>GitHub Issues: <a href="https://github.com/matthesv/yadore-amazon-api/issues" target="_blank">github.com/matthesv/yadore-amazon-api/issues</a></li>
                    <li>Plugin Version: <strong><?php echo esc_html(YAA_VERSION); ?></strong></li>
                </ul>
            </div>
        </div>
        <?php
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\admin\class-admin-merchants.php 
 
<?php
/**
 * Admin Merchants Page - Händlerübersicht
 * PHP 8.3+ compatible
 * Version: 1.4.1
 * 
 * Zeigt alle Händler aus beiden Yadore APIs:
 * - /v2/merchant (Offer-Händler)
 * - /v2/deeplink/merchant (Deeplink-Händler)
 * 
 * HINWEIS: CPC wird pro Produkt berechnet, nicht pro Händler.
 * Für CPC-Daten nutze den Revenue-Kalkulator.
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin_Merchants {
    
    private YAA_Yadore_API $yadore_api;
    private YAA_Cache_Handler $cache;
    
    /**
     * Items pro Seite
     */
    private const PER_PAGE = 50;
    
    public function __construct(YAA_Yadore_API $yadore_api, YAA_Cache_Handler $cache) {
        $this->yadore_api = $yadore_api;
        $this->cache = $cache;
    }
    
    /**
     * Render der Händlerübersicht
     */
    public function render_page(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $market = sanitize_text_field($_GET['market'] ?? yaa_get_option('yadore_market', 'de'));
        $view = sanitize_text_field($_GET['view'] ?? 'all');
        $search = sanitize_text_field($_GET['s'] ?? '');
        $paged = max(1, (int) ($_GET['paged'] ?? 1));
        $sort = sanitize_text_field($_GET['sort'] ?? 'name');
        $order = strtoupper(sanitize_text_field($_GET['order'] ?? 'ASC')) === 'DESC' ? 'DESC' : 'ASC';
        
        // Händler laden
        $all_merchants = $this->get_combined_merchants($market, $view);
        
        // Suche anwenden
        if ($search !== '') {
            $all_merchants = array_filter($all_merchants, function($m) use ($search) {
                return stripos($m['name'] ?? '', $search) !== false;
            });
            $all_merchants = array_values($all_merchants);
        }
        
        // Sortieren
        $all_merchants = $this->sort_merchants($all_merchants, $sort, $order);
        
        // Paginierung
        $total = count($all_merchants);
        $total_pages = (int) ceil($total / self::PER_PAGE);
        $offset = ($paged - 1) * self::PER_PAGE;
        $merchants = array_slice($all_merchants, $offset, self::PER_PAGE);
        
        // Statistiken
        $stats = $this->get_stats($all_merchants);
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1>🏪 <?php esc_html_e('Händlerübersicht', 'yadore-amazon-api'); ?></h1>
            
            <?php if (!$this->yadore_api->is_configured()): ?>
                <div class="notice notice-error">
                    <p><?php esc_html_e('Yadore API ist nicht konfiguriert. Bitte API-Key in den Einstellungen hinterlegen.', 'yadore-amazon-api'); ?></p>
                </div>
                <?php return; ?>
            <?php endif; ?>
            
            <!-- Statistik-Karten -->
            <div class="yaa-grid-4" style="margin-bottom: 20px;">
                <div class="yaa-stat-box">
                    <div class="yaa-stat-number" style="color: #2271b1;"><?php echo (int) $stats['total']; ?></div>
                    <div class="yaa-stat-label"><?php esc_html_e('Händler gesamt', 'yadore-amazon-api'); ?></div>
                </div>
                <div class="yaa-stat-box">
                    <div class="yaa-stat-number" style="color: #00a32a;"><?php echo (int) $stats['offer']; ?></div>
                    <div class="yaa-stat-label"><?php esc_html_e('Offer-Händler', 'yadore-amazon-api'); ?></div>
                </div>
                <div class="yaa-stat-box">
                    <div class="yaa-stat-number" style="color: #dba617;"><?php echo (int) $stats['deeplink']; ?></div>
                    <div class="yaa-stat-label"><?php esc_html_e('Deeplink-Händler', 'yadore-amazon-api'); ?></div>
                </div>
                <div class="yaa-stat-box">
                    <div class="yaa-stat-number" style="color: #135e96;"><?php echo (int) $stats['smartlink']; ?></div>
                    <div class="yaa-stat-label"><?php esc_html_e('Smartlink-Händler', 'yadore-amazon-api'); ?></div>
                </div>
            </div>
            
            <!-- Filter-Leiste -->
            <div class="yaa-card" style="margin-bottom: 20px;">
                <form method="get" action="">
                    <input type="hidden" name="page" value="yaa-merchants">
                    
                    <div class="yaa-filter-bar">
                        <label>
                            <strong><?php esc_html_e('Markt:', 'yadore-amazon-api'); ?></strong>
                            <select name="market" onchange="this.form.submit()">
                                <?php foreach ($this->yadore_api->get_markets() as $code => $name): ?>
                                    <option value="<?php echo esc_attr($code); ?>" <?php selected($market, $code); ?>>
                                        <?php echo esc_html($name); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </label>
                        
                        <label>
                            <strong><?php esc_html_e('Ansicht:', 'yadore-amazon-api'); ?></strong>
                            <select name="view" onchange="this.form.submit()">
                                <option value="all" <?php selected($view, 'all'); ?>><?php esc_html_e('Alle Händler', 'yadore-amazon-api'); ?></option>
                                <option value="offer" <?php selected($view, 'offer'); ?>><?php esc_html_e('Nur Offer-Händler', 'yadore-amazon-api'); ?></option>
                                <option value="deeplink" <?php selected($view, 'deeplink'); ?>><?php esc_html_e('Nur Deeplink-Händler', 'yadore-amazon-api'); ?></option>
                                <option value="smartlink" <?php selected($view, 'smartlink'); ?>><?php esc_html_e('Nur Smartlink-Händler', 'yadore-amazon-api'); ?></option>
                            </select>
                        </label>
                        
                        <label>
                            <strong><?php esc_html_e('Suche:', 'yadore-amazon-api'); ?></strong>
                            <input type="text" name="s" value="<?php echo esc_attr($search); ?>" placeholder="<?php esc_attr_e('Händlername...', 'yadore-amazon-api'); ?>">
                        </label>
                        
                        <button type="submit" class="button"><?php esc_html_e('Filtern', 'yadore-amazon-api'); ?></button>
                        
                        <button type="button" class="button" id="yaa-refresh-all-merchants">
                            🔄 <?php esc_html_e('Daten aktualisieren', 'yadore-amazon-api'); ?>
                        </button>
                        
                        <span id="yaa-refresh-status" style="margin-left: 10px;"></span>
                    </div>
                </form>
            </div>
            
            <!-- Info-Box -->
            <div class="yaa-feature-box info" style="margin-bottom: 20px;">
                <h4 style="margin-top: 0;">💡 <?php esc_html_e('Hinweis zu CPC-Daten', 'yadore-amazon-api'); ?></h4>
                <p>
                    <?php esc_html_e('Der CPC (Cost per Click) wird pro Produkt/Angebot berechnet, nicht pro Händler.', 'yadore-amazon-api'); ?>
                    <br>
                    <?php esc_html_e('Um CPC-Daten für konkrete Produkte zu sehen, nutze den', 'yadore-amazon-api'); ?>
                    <a href="<?php echo esc_url(admin_url('admin.php?page=yaa-revenue')); ?>"><strong><?php esc_html_e('Revenue-Kalkulator', 'yadore-amazon-api'); ?></strong></a>.
                </p>
            </div>
            
            <!-- Händler-Tabelle -->
            <div class="yaa-card">
                <h2 style="margin-bottom: 15px;">
                    📋 <?php esc_html_e('Händlerliste', 'yadore-amazon-api'); ?>
                    <span style="font-size: 14px; font-weight: normal; color: #666;">
                        (<?php echo $total; ?> <?php esc_html_e('Ergebnisse', 'yadore-amazon-api'); ?>)
                    </span>
                </h2>
                
                <?php if (empty($merchants)): ?>
                    <p><?php esc_html_e('Keine Händler gefunden. Bitte Daten aktualisieren.', 'yadore-amazon-api'); ?></p>
                <?php else: ?>
                    <table class="yaa-merchant-table widefat">
                        <thead>
                            <tr>
                                <th width="50"><?php esc_html_e('Logo', 'yadore-amazon-api'); ?></th>
                                <th>
                                    <?php echo $this->sortable_header('name', __('Händler', 'yadore-amazon-api'), $sort, $order); ?>
                                </th>
                                <th>
                                    <?php echo $this->sortable_header('type', __('Typ', 'yadore-amazon-api'), $sort, $order); ?>
                                </th>
                                <th>
                                    <?php echo $this->sortable_header('offers', __('Angebote', 'yadore-amazon-api'), $sort, $order); ?>
                                </th>
                                <th><?php esc_html_e('Features', 'yadore-amazon-api'); ?></th>
                                <th><?php esc_html_e('ID', 'yadore-amazon-api'); ?></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($merchants as $merchant): ?>
                                <tr>
                                    <td>
                                        <?php if (!empty($merchant['logo_url']) && !empty($merchant['has_logo'])): ?>
                                            <img src="<?php echo esc_url($merchant['logo_url']); ?>" 
                                                 alt="<?php echo esc_attr($merchant['name']); ?>" 
                                                 class="yaa-merchant-logo">
                                        <?php else: ?>
                                            <span style="font-size: 24px;">🏪</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <strong><?php echo esc_html($merchant['name']); ?></strong>
                                    </td>
                                    <td>
                                        <?php echo $this->render_type_badges($merchant); ?>
                                    </td>
                                    <td>
                                        <?php 
                                        $offers = (int) ($merchant['offer_count'] ?? 0);
                                        echo $offers > 0 ? number_format($offers, 0, ',', '.') : '—';
                                        ?>
                                    </td>
                                    <td>
                                        <?php echo $this->render_feature_badges($merchant); ?>
                                    </td>
                                    <td>
                                        <code style="font-size: 10px; word-break: break-all;">
                                            <?php echo esc_html($merchant['id'] ?? ''); ?>
                                        </code>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                    
                    <!-- Paginierung -->
                    <?php if ($total_pages > 1): ?>
                        <div class="yaa-pagination">
                            <?php
                            $base_url = add_query_arg([
                                'page' => 'yaa-merchants',
                                'market' => $market,
                                'view' => $view,
                                's' => $search,
                                'sort' => $sort,
                                'order' => $order,
                            ], admin_url('admin.php'));
                            
                            // Previous
                            if ($paged > 1) {
                                echo '<a href="' . esc_url(add_query_arg('paged', $paged - 1, $base_url)) . '">« ' . esc_html__('Zurück', 'yadore-amazon-api') . '</a>';
                            }
                            
                            // Page numbers
                            $range = 2;
                            for ($i = max(1, $paged - $range); $i <= min($total_pages, $paged + $range); $i++) {
                                if ($i === $paged) {
                                    echo '<span class="current">' . $i . '</span>';
                                } else {
                                    echo '<a href="' . esc_url(add_query_arg('paged', $i, $base_url)) . '">' . $i . '</a>';
                                }
                            }
                            
                            // Next
                            if ($paged < $total_pages) {
                                echo '<a href="' . esc_url(add_query_arg('paged', $paged + 1, $base_url)) . '">' . esc_html__('Weiter', 'yadore-amazon-api') . ' »</a>';
                            }
                            ?>
                        </div>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
            
            <!-- Export-Optionen -->
            <div class="yaa-card">
                <h2>📥 <?php esc_html_e('Export', 'yadore-amazon-api'); ?></h2>
                <p>
                    <button type="button" class="button" id="yaa-export-csv">
                        📄 <?php esc_html_e('Als CSV exportieren', 'yadore-amazon-api'); ?>
                    </button>
                    <button type="button" class="button" id="yaa-copy-merchant-ids">
                        📋 <?php esc_html_e('Händler-IDs kopieren', 'yadore-amazon-api'); ?>
                    </button>
                </p>
            </div>
        </div>
        <?php
    }
    
    /**
     * Kombiniert Händler aus beiden APIs
     * 
     * @param string $market
     * @param string $view
     * @return array<int, array<string, mixed>>
     */
    private function get_combined_merchants(string $market, string $view): array {
        $offer_merchants = [];
        $deeplink_merchants = [];
        
        // Offer-Händler laden (wenn nicht nur Deeplink-Ansicht)
        if ($view !== 'deeplink' && $view !== 'smartlink') {
            $offer_result = YAA_Merchant_Filter::get_stored_merchants($market);
            foreach ($offer_result as $m) {
                $offer_merchants[$m['id']] = [
                    'id'           => $m['id'],
                    'name'         => $m['name'],
                    'logo_url'     => $m['logo'] ?? '',
                    'has_logo'     => $m['hasLogo'] ?? false,
                    'offer_count'  => $m['offerCount'] ?? 0,
                    'type'         => 'offer',
                    'is_smartlink' => false,
                    'is_deeplink'  => false,
                    'has_homepage' => false,
                ];
            }
        }
        
        // Deeplink-Händler laden (wenn nicht nur Offer-Ansicht)
        if ($view !== 'offer') {
            $smartlink_only = ($view === 'smartlink');
            $deeplink_result = $this->get_stored_deeplink_merchants($market);
            
            foreach ($deeplink_result as $m) {
                $is_smartlink = !empty($m['isSmartlink']);
                
                // Bei Smartlink-Filter nur Smartlinks zeigen
                if ($smartlink_only && !$is_smartlink) {
                    continue;
                }
                
                $id = $m['id'];
                
                // Existiert bereits als Offer-Händler?
                if (isset($offer_merchants[$id])) {
                    // Merge: Deeplink-Info hinzufügen
                    $offer_merchants[$id]['is_deeplink'] = true;
                    $offer_merchants[$id]['is_smartlink'] = $is_smartlink;
                    $offer_merchants[$id]['has_homepage'] = !empty($m['hasSmartlinkHomepage']) || !empty($m['hasExternalHomepage']);
                    $offer_merchants[$id]['deeplink_count'] = $m['deeplinkCount'] ?? 0;
                } else {
                    // Neuer Händler (nur Deeplink)
                    $deeplink_merchants[$id] = [
                        'id'             => $id,
                        'name'           => $m['name'],
                        'logo_url'       => $m['logo']['url'] ?? '',
                        'has_logo'       => $m['logo']['exists'] ?? false,
                        'offer_count'    => 0,
                        'deeplink_count' => $m['deeplinkCount'] ?? 0,
                        'type'           => 'deeplink',
                        'is_smartlink'   => $is_smartlink,
                        'is_deeplink'    => true,
                        'has_homepage'   => !empty($m['hasSmartlinkHomepage']) || !empty($m['hasExternalHomepage']),
                    ];
                }
            }
        }
        
        // Zusammenführen
        $all = array_merge(array_values($offer_merchants), array_values($deeplink_merchants));
        
        return $all;
    }
    
    /**
     * Holt gespeicherte Deeplink-Händler
     * 
     * @return array<int, array<string, mixed>>
     */
    private function get_stored_deeplink_merchants(string $market): array {
        $merchants = get_option('yaa_yadore_deeplink_merchants_' . $market, []);
        return is_array($merchants) ? $merchants : [];
    }
    
    /**
     * Sortiert Händler
     * 
     * @param array<int, array<string, mixed>> $merchants
     * @return array<int, array<string, mixed>>
     */
    private function sort_merchants(array $merchants, string $sort, string $order): array {
        usort($merchants, function($a, $b) use ($sort, $order) {
            $val_a = match($sort) {
                'offers' => (int) ($a['offer_count'] ?? 0),
                'type' => $a['type'] ?? '',
                default => strtolower($a['name'] ?? ''),
            };
            
            $val_b = match($sort) {
                'offers' => (int) ($b['offer_count'] ?? 0),
                'type' => $b['type'] ?? '',
                default => strtolower($b['name'] ?? ''),
            };
            
            if (is_numeric($val_a) && is_numeric($val_b)) {
                $cmp = $val_a <=> $val_b;
            } else {
                $cmp = strcmp((string) $val_a, (string) $val_b);
            }
            
            return $order === 'DESC' ? -$cmp : $cmp;
        });
        
        return $merchants;
    }
    
    /**
     * Statistiken berechnen
     * 
     * @param array<int, array<string, mixed>> $merchants
     * @return array<string, mixed>
     */
    private function get_stats(array $merchants): array {
        $total = count($merchants);
        $offer = 0;
        $deeplink = 0;
        $smartlink = 0;
        
        foreach ($merchants as $m) {
            if (($m['type'] ?? '') === 'offer' || ($m['offer_count'] ?? 0) > 0) {
                $offer++;
            }
            if (!empty($m['is_deeplink'])) {
                $deeplink++;
            }
            if (!empty($m['is_smartlink'])) {
                $smartlink++;
            }
        }
        
        return [
            'total'    => $total,
            'offer'    => $offer,
            'deeplink' => $deeplink,
            'smartlink' => $smartlink,
        ];
    }
    
    /**
     * Sortierbare Spaltenüberschrift
     */
    private function sortable_header(string $column, string $label, string $current_sort, string $current_order): string {
        $new_order = ($current_sort === $column && $current_order === 'ASC') ? 'DESC' : 'ASC';
        $arrow = '';
        
        if ($current_sort === $column) {
            $arrow = $current_order === 'ASC' ? ' ↑' : ' ↓';
        }
        
        $url = add_query_arg([
            'sort' => $column,
            'order' => $new_order,
        ]);
        
        return '<a href="' . esc_url($url) . '">' . esc_html($label) . $arrow . '</a>';
    }
    
    /**
     * Typ-Badges rendern
     */
    private function render_type_badges(array $merchant): string {
        $badges = [];
        
        if ($merchant['type'] === 'offer' || !empty($merchant['offer_count'])) {
            $badges[] = '<span class="yaa-status-badge yaa-status-info">Offer</span>';
        }
        
        if (!empty($merchant['is_deeplink'])) {
            $badges[] = '<span class="yaa-status-badge yaa-status-warning">Deeplink</span>';
        }
        
        if (!empty($merchant['is_smartlink'])) {
            $badges[] = '<span class="yaa-status-badge yaa-status-success">Smartlink</span>';
        }
        
        return implode(' ', $badges);
    }
    
    /**
     * Feature-Badges rendern
     */
    private function render_feature_badges(array $merchant): string {
        $badges = [];
        
        if (!empty($merchant['has_homepage'])) {
            $badges[] = '<span title="' . esc_attr__('Homepage-Link möglich', 'yadore-amazon-api') . '">🏠</span>';
        }
        
        if (!empty($merchant['deeplink_count']) && $merchant['deeplink_count'] > 0) {
            $badges[] = '<span title="' . esc_attr(sprintf(__('%d Deeplinks', 'yadore-amazon-api'), $merchant['deeplink_count'])) . '">🔗</span>';
        }
        
        return implode(' ', $badges) ?: '—';
    }
    
    /**
     * JavaScript für die Seite
     */
    public function get_page_js(): string {
        $copy_text = esc_js(__('IDs in Zwischenablage kopiert!', 'yadore-amazon-api'));
        
        return <<<JS
jQuery(document).ready(function($) {
    // Alle Händler aktualisieren
    $("#yaa-refresh-all-merchants").on("click", function() {
        var \$btn = $(this);
        var \$status = $("#yaa-refresh-status");
        var market = $("select[name='market']").val();
        
        \$btn.prop("disabled", true).text("Wird geladen...");
        \$status.html("");
        
        // 1. Offer-Händler laden
        $.post(yaaAdmin.ajaxurl, {
            action: "yaa_refresh_merchants",
            nonce: yaaAdmin.nonce,
            market: market
        }).then(function(response1) {
            \$status.html("<span style='color:blue;'>⏳ Offer-Händler geladen, lade Deeplinks...</span>");
            
            // 2. Deeplink-Händler laden
            return $.post(yaaAdmin.ajaxurl, {
                action: "yaa_fetch_deeplink_merchants",
                nonce: yaaAdmin.nonce,
                market: market
            });
        }).then(function(response2) {
            \$btn.prop("disabled", false).text("🔄 Daten aktualisieren");
            \$status.html("<span style='color:green;'>✅ Alle Händler aktualisiert!</span>");
            setTimeout(function() { location.reload(); }, 1500);
        }).fail(function() {
            \$btn.prop("disabled", false).text("🔄 Daten aktualisieren");
            \$status.html("<span style='color:red;'>❌ Fehler beim Laden</span>");
        });
    });
    
    // CSV Export
    $("#yaa-export-csv").on("click", function() {
        var rows = [];
        rows.push(["Name", "Typ", "Angebote", "ID"]);
        
        $(".yaa-merchant-table tbody tr").each(function() {
            var \$row = $(this);
            rows.push([
                \$row.find("td:eq(1)").text().trim(),
                \$row.find("td:eq(2)").text().trim(),
                \$row.find("td:eq(3)").text().trim(),
                \$row.find("td:eq(5) code").text().trim()
            ]);
        });
        
        var csv = rows.map(function(row) {
            return row.map(function(cell) {
                return '"' + String(cell).replace(/"/g, '""') + '"';
            }).join(";");
        }).join("\\n");
        
        var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "yadore-merchants-" + new Date().toISOString().slice(0,10) + ".csv";
        link.click();
    });
    
    // IDs kopieren
    $("#yaa-copy-merchant-ids").on("click", function() {
        var ids = [];
        $(".yaa-merchant-table tbody tr").each(function() {
            var id = $(this).find("td:eq(5) code").text().trim();
            if (id) ids.push(id);
        });
        
        navigator.clipboard.writeText(ids.join("\\n")).then(function() {
            alert("{$copy_text}");
        });
    });
});
JS;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\admin\class-admin-revenue.php 
 
<?php
/**
 * Admin Revenue Calculator Page
 * Berechnet den geschätzten Revenue basierend auf Shortcode-Parametern
 * PHP 8.3+ compatible
 * Version: 1.4.0
 * 
 * Nutzt die /v2/offer API, die CPC pro Produkt/Angebot liefert
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin_Revenue {
    
    private YAA_Yadore_API $yadore_api;
    private YAA_Cache_Handler $cache;
    
    public function __construct(YAA_Yadore_API $yadore_api, YAA_Cache_Handler $cache) {
        $this->yadore_api = $yadore_api;
        $this->cache = $cache;
    }
    
    /**
     * Render der Revenue-Kalkulator Seite
     */
    public function render_page(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $markets = $this->yadore_api->get_markets();
        $default_market = yaa_get_option('yadore_market', 'de');
        $default_limit = (int) yaa_get_option('yadore_default_limit', 9);
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1>💰 <?php esc_html_e('Revenue-Kalkulator', 'yadore-amazon-api'); ?></h1>
            
            <?php if (!$this->yadore_api->is_configured()): ?>
                <div class="notice notice-error">
                    <p><?php esc_html_e('Yadore API ist nicht konfiguriert. Bitte API-Key in den Einstellungen hinterlegen.', 'yadore-amazon-api'); ?></p>
                </div>
                <?php return; ?>
            <?php endif; ?>
            
            <!-- Info-Box -->
            <div class="yaa-feature-box info" style="margin-bottom: 20px;">
                <h4 style="margin-top: 0;">💡 <?php esc_html_e('So funktioniert der Revenue-Kalkulator', 'yadore-amazon-api'); ?></h4>
                <p>
                    <?php esc_html_e('Dieser Kalkulator simuliert einen Shortcode-Aufruf und zeigt die CPC-Werte der gefundenen Produkte.', 'yadore-amazon-api'); ?>
                </p>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong><?php esc_html_e('Brutto-CPC:', 'yadore-amazon-api'); ?></strong> <?php esc_html_e('Der CPC, den Yadore vom Händler erhält', 'yadore-amazon-api'); ?></li>
                    <li><strong><?php esc_html_e('Dein CPC:', 'yadore-amazon-api'); ?></strong> <?php esc_html_e('Brutto-CPC × Dein Revenue-Share', 'yadore-amazon-api'); ?></li>
                    <li><strong><?php esc_html_e('Quelle:', 'yadore-amazon-api'); ?></strong> <code>/v2/offer</code> API - <?php esc_html_e('CPC wird pro Produkt/Angebot berechnet', 'yadore-amazon-api'); ?></li>
                </ul>
            </div>
            
            <!-- Eingabe-Formular -->
            <div class="yaa-card">
                <h2>🔍 <?php esc_html_e('Shortcode-Parameter eingeben', 'yadore-amazon-api'); ?></h2>
                
                <div class="yaa-revenue-form">
                    <div class="yaa-grid">
                        <div class="yaa-form-row">
                            <label for="yaa-revenue-keyword">
                                <strong><?php esc_html_e('Keyword', 'yadore-amazon-api'); ?></strong> <span style="color: red;">*</span>
                            </label>
                            <input type="text" id="yaa-revenue-keyword" 
                                   placeholder="<?php esc_attr_e('z.B. Smartphone, Laptop, Kopfhörer', 'yadore-amazon-api'); ?>"
                                   style="width: 100%; max-width: 400px;">
                            <p class="description"><?php esc_html_e('Der Suchbegriff für die Produktsuche.', 'yadore-amazon-api'); ?></p>
                        </div>
                        
                        <div class="yaa-form-row">
                            <label for="yaa-revenue-market">
                                <strong><?php esc_html_e('Markt', 'yadore-amazon-api'); ?></strong>
                            </label>
                            <select id="yaa-revenue-market" style="width: 100%; max-width: 200px;">
                                <?php foreach ($markets as $code => $name): ?>
                                    <option value="<?php echo esc_attr($code); ?>" <?php selected($default_market, $code); ?>>
                                        <?php echo esc_html($name . ' (' . strtoupper($code) . ')'); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        
                        <div class="yaa-form-row">
                            <label for="yaa-revenue-limit">
                                <strong><?php esc_html_e('Limit', 'yadore-amazon-api'); ?></strong>
                            </label>
                            <input type="number" id="yaa-revenue-limit" 
                                   value="<?php echo esc_attr($default_limit); ?>"
                                   min="1" max="100"
                                   style="width: 100px;">
                            <p class="description"><?php esc_html_e('Anzahl der Produkte (1-100).', 'yadore-amazon-api'); ?></p>
                        </div>
                        
                        <div class="yaa-form-row">
                            <label for="yaa-revenue-share">
                                <strong><?php esc_html_e('Dein Revenue-Share (%)', 'yadore-amazon-api'); ?></strong>
                            </label>
                            <input type="number" id="yaa-revenue-share" 
                                   value="70"
                                   min="0" max="100" step="1"
                                   style="width: 100px;">
                            <p class="description"><?php esc_html_e('Dein Anteil am CPC (frag deinen Account Manager).', 'yadore-amazon-api'); ?></p>
                        </div>
                    </div>
                    
                    <div class="yaa-form-row" style="margin-top: 20px;">
                        <button type="button" class="button button-primary button-hero" id="yaa-fetch-revenue">
                            🔍 <?php esc_html_e('Produkte abrufen & CPC berechnen', 'yadore-amazon-api'); ?>
                        </button>
                        <span id="yaa-revenue-status" style="margin-left: 15px;"></span>
                    </div>
                </div>
            </div>
            
            <!-- Ergebnis-Bereich -->
            <div class="yaa-card" id="yaa-revenue-results" style="display: none;">
                <h2>📊 <?php esc_html_e('Ergebnisse', 'yadore-amazon-api'); ?></h2>
                
                <!-- Statistik-Karten -->
                <div class="yaa-grid-4" id="yaa-revenue-stats" style="margin-bottom: 20px;">
                    <!-- Wird per JavaScript gefüllt -->
                </div>
                
                <!-- Shortcode-Vorschau -->
                <div class="yaa-feature-box" style="margin-bottom: 20px;">
                    <h4 style="margin-top: 0;">📝 <?php esc_html_e('Entsprechender Shortcode', 'yadore-amazon-api'); ?></h4>
                    <div class="yaa-shortcode-box" id="yaa-generated-shortcode"></div>
                </div>
                
                <!-- Produkt-Tabelle -->
                <div id="yaa-revenue-table-container">
                    <!-- Wird per JavaScript gefüllt -->
                </div>
            </div>
            
            <!-- Keine Ergebnisse -->
            <div class="yaa-card" id="yaa-revenue-no-results" style="display: none;">
                <p>😕 <?php esc_html_e('Keine Produkte für diese Suche gefunden.', 'yadore-amazon-api'); ?></p>
            </div>
        </div>
        
        <style>
            .yaa-revenue-form { max-width: 800px; }
            .yaa-cpc-cell { font-family: monospace; }
            .yaa-cpc-positive { color: #155724; background: #d4edda; }
            .yaa-cpc-zero { color: #856404; background: #fff3cd; }
            .yaa-product-image { width: 50px; height: 50px; object-fit: contain; border-radius: 4px; }
            .yaa-revenue-table { width: 100%; border-collapse: collapse; }
            .yaa-revenue-table th { background: #f6f7f7; text-align: left; padding: 12px; border-bottom: 2px solid #ccd0d4; }
            .yaa-revenue-table td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
            .yaa-revenue-table tr:hover { background: #f9f9f9; }
            .yaa-revenue-table .yaa-cpc-badge { 
                display: inline-block; 
                padding: 4px 8px; 
                border-radius: 4px; 
                font-weight: 600; 
                font-size: 12px;
                font-family: monospace;
            }
        </style>
        <?php
    }
    
    /**
     * JavaScript für die Seite
     */
    public function get_page_js(): string {
        $no_keyword_text = esc_js(__('Bitte ein Keyword eingeben.', 'yadore-amazon-api'));
        $loading_text = esc_js(__('Lade Produkte...', 'yadore-amazon-api'));
        $error_text = esc_js(__('Fehler beim Laden', 'yadore-amazon-api'));
        $products_found_text = esc_js(__('Produkte gefunden', 'yadore-amazon-api'));
        $avg_cpc_text = esc_js(__('Ø Brutto-CPC', 'yadore-amazon-api'));
        $your_avg_cpc_text = esc_js(__('Ø Dein CPC', 'yadore-amazon-api'));
        $with_cpc_text = esc_js(__('Mit CPC-Daten', 'yadore-amazon-api'));
        $total_potential_text = esc_js(__('Potenzial (alle Klicks)', 'yadore-amazon-api'));
        
        return <<<JS
jQuery(document).ready(function($) {
    
    $("#yaa-fetch-revenue").on("click", function() {
        var keyword = $("#yaa-revenue-keyword").val().trim();
        var market = $("#yaa-revenue-market").val();
        var limit = parseInt($("#yaa-revenue-limit").val()) || 9;
        var revenueShare = parseFloat($("#yaa-revenue-share").val()) / 100 || 0.7;
        
        if (!keyword) {
            alert("{$no_keyword_text}");
            return;
        }
        
        var \$btn = $(this);
        var \$status = $("#yaa-revenue-status");
        var \$results = $("#yaa-revenue-results");
        var \$noResults = $("#yaa-revenue-no-results");
        
        \$btn.prop("disabled", true);
        \$status.html('<span style="color: blue;">⏳ {$loading_text}</span>');
        \$results.hide();
        \$noResults.hide();
        
        $.post(yaaAdmin.ajaxurl, {
            action: "yaa_fetch_offers_with_cpc",
            nonce: yaaAdmin.nonce,
            keyword: keyword,
            market: market,
            limit: limit
        }, function(response) {
            \$btn.prop("disabled", false);
            \$status.html("");
            
            if (response.success && response.data.offers && response.data.offers.length > 0) {
                var offers = response.data.offers;
                
                // Statistiken berechnen
                var totalCpc = 0;
                var withCpc = 0;
                
                offers.forEach(function(offer) {
                    var cpc = parseFloat(offer.cpc_amount) || 0;
                    if (cpc > 0) {
                        totalCpc += cpc;
                        withCpc++;
                    }
                });
                
                var avgCpc = withCpc > 0 ? totalCpc / withCpc : 0;
                var yourAvgCpc = avgCpc * revenueShare;
                var totalPotential = totalCpc * revenueShare;
                
                // Statistik-Karten
                $("#yaa-revenue-stats").html(
                    '<div class="yaa-stat-box" style="background: #f0f6fc;">' +
                        '<div class="yaa-stat-number" style="color: #2271b1;">' + offers.length + '</div>' +
                        '<div class="yaa-stat-label">{$products_found_text}</div>' +
                    '</div>' +
                    '<div class="yaa-stat-box" style="background: #d4edda;">' +
                        '<div class="yaa-stat-number" style="color: #155724;">' + withCpc + '</div>' +
                        '<div class="yaa-stat-label">{$with_cpc_text}</div>' +
                    '</div>' +
                    '<div class="yaa-stat-box" style="background: #fff3cd;">' +
                        '<div class="yaa-stat-number" style="color: #856404;">' + avgCpc.toFixed(4) + ' €</div>' +
                        '<div class="yaa-stat-label">{$avg_cpc_text}</div>' +
                    '</div>' +
                    '<div class="yaa-stat-box" style="background: #d4edda;">' +
                        '<div class="yaa-stat-number" style="color: #155724;">' + yourAvgCpc.toFixed(4) + ' €</div>' +
                        '<div class="yaa-stat-label">{$your_avg_cpc_text}</div>' +
                    '</div>'
                );
                
                // Shortcode generieren
                $("#yaa-generated-shortcode").text(
                    '[yadore_products keyword="' + keyword + '" market="' + market + '" limit="' + limit + '"]'
                );
                
                // Tabelle erstellen
                var tableHtml = '<table class="yaa-revenue-table widefat">' +
                    '<thead><tr>' +
                        '<th width="60">Bild</th>' +
                        '<th>Produkt</th>' +
                        '<th>Händler</th>' +
                        '<th>Preis</th>' +
                        '<th>Brutto-CPC</th>' +
                        '<th>Dein CPC (' + (revenueShare * 100) + '%)</th>' +
                    '</tr></thead><tbody>';
                
                offers.forEach(function(offer, index) {
                    var cpc = parseFloat(offer.cpc_amount) || 0;
                    var yourCpc = cpc * revenueShare;
                    var cpcClass = cpc > 0 ? 'yaa-cpc-positive' : 'yaa-cpc-zero';
                    
                    var imageHtml = offer.image_url 
                        ? '<img src="' + offer.image_url + '" class="yaa-product-image" alt="" referrerpolicy="no-referrer" crossorigin="anonymous">'
                        : '<span style="font-size: 24px;">📦</span>';
                    
                    var priceDisplay = offer.price_display || (offer.price_amount ? offer.price_amount + ' ' + offer.price_currency : '—');
                    
                    tableHtml += '<tr>' +
                        '<td>' + imageHtml + '</td>' +
                        '<td><strong>' + (offer.title || '—').substring(0, 60) + (offer.title && offer.title.length > 60 ? '...' : '') + '</strong></td>' +
                        '<td>' + (offer.merchant_name || '—') + '</td>' +
                        '<td>' + priceDisplay + '</td>' +
                        '<td><span class="yaa-cpc-badge ' + cpcClass + '">' + cpc.toFixed(4) + ' €</span></td>' +
                        '<td><span class="yaa-cpc-badge ' + cpcClass + '">' + yourCpc.toFixed(4) + ' €</span></td>' +
                    '</tr>';
                });
                
                tableHtml += '</tbody></table>';
                
                // Summenzeile
                tableHtml += '<div style="margin-top: 15px; padding: 15px; background: #f0f6fc; border-radius: 4px;">' +
                    '<strong>{$total_potential_text}:</strong> ' +
                    'Wenn jedes Produkt 1× geklickt wird: <strong>' + totalPotential.toFixed(4) + ' €</strong> ' +
                    '(Brutto: ' + totalCpc.toFixed(4) + ' €)' +
                '</div>';
                
                $("#yaa-revenue-table-container").html(tableHtml);
                \$results.show();
                
            } else {
                \$noResults.show();
            }
            
        }).fail(function() {
            \$btn.prop("disabled", false);
            \$status.html('<span style="color: red;">❌ {$error_text}</span>');
        });
    });
    
    // Enter-Taste im Keyword-Feld
    $("#yaa-revenue-keyword").on("keypress", function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $("#yaa-fetch-revenue").click();
        }
    });
});
JS;
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\admin\class-admin-settings.php 
 
<?php
/**
 * Admin Settings Page
 * PHP 8.3+ compatible
 * Version: 1.5.1
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin_Settings {
    
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    private YAA_Cache_Handler $cache;
    
    public function __construct(
        YAA_Yadore_API $yadore_api,
        YAA_Amazon_PAAPI $amazon_api,
        YAA_Cache_Handler $cache
    ) {
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
        $this->cache = $cache;
    }
    
    public function render_page(): void {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $options = get_option('yaa_settings', []);
        if (!is_array($options)) {
            $options = [];
        }
        
        $cache_status = $this->cache->get_status();
        $marketplaces = $this->amazon_api->get_marketplace_options();
        $yadore_markets = $this->yadore_api->get_markets();
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
            
            <form method="post" action="options.php">
                <?php settings_fields('yaa_settings'); ?>
                
                <div class="yaa-tabs">
                    <div class="yaa-tab active" data-tab="yadore">📶 Yadore API</div>
                    <div class="yaa-tab" data-tab="amazon">🛒 Amazon PA-API</div>
                    <div class="yaa-tab" data-tab="custom">⭐ Eigene Produkte</div>
                    <div class="yaa-tab" data-tab="cache">⚡ Cache &amp; Bilder</div>
                    <div class="yaa-tab" data-tab="display">🎨 Darstellung</div>
                </div>
                
                <div id="yaa-tab-yadore" class="yaa-tab-content active">
                    <?php $this->render_yadore_settings($options, $yadore_markets); ?>
                </div>
                
                <div id="yaa-tab-amazon" class="yaa-tab-content">
                    <?php $this->render_amazon_settings($options, $marketplaces); ?>
                </div>
                
                <div id="yaa-tab-custom" class="yaa-tab-content">
                    <?php $this->render_custom_products_settings($options); ?>
                </div>
                
                <div id="yaa-tab-cache" class="yaa-tab-content">
                    <?php $this->render_cache_settings($options, $cache_status); ?>
                </div>
                
                <div id="yaa-tab-display" class="yaa-tab-content">
                    <?php $this->render_display_settings($options); ?>
                </div>
                
                <?php submit_button(__('Einstellungen speichern', 'yadore-amazon-api')); ?>
            </form>
        </div>
        <?php
    }
    
    /**
     * @param array<string, mixed>|null $input
     * @return array<string, mixed>
     */
    public function sanitize_settings(?array $input): array {
        if ($input === null) {
            $input = [];
        }
        
        $sanitized = [];
        
        // Yadore settings
        $sanitized['enable_yadore'] = isset($input['enable_yadore']) ? 'yes' : 'no';
        $sanitized['yadore_api_key'] = sanitize_text_field($input['yadore_api_key'] ?? '');
        $sanitized['yadore_market'] = sanitize_text_field($input['yadore_market'] ?? 'de');
        $sanitized['yadore_precision'] = in_array($input['yadore_precision'] ?? '', ['strict', 'fuzzy'], true) 
            ? $input['yadore_precision'] : 'fuzzy';
        $sanitized['yadore_default_limit'] = max(1, min(50, (int) ($input['yadore_default_limit'] ?? 9)));
        
        $valid_sorts = ['rel_desc', 'price_asc', 'price_desc', 'cpc_desc', 'cpc_asc'];
        $sanitized['yadore_default_sort'] = in_array($input['yadore_default_sort'] ?? '', $valid_sorts, true) 
            ? $input['yadore_default_sort'] : 'rel_desc';
        
        // Merchant Filter
        $sanitized['yadore_merchant_whitelist'] = $this->sanitize_merchant_list($input['yadore_merchant_whitelist'] ?? '');
        $sanitized['yadore_merchant_blacklist'] = $this->sanitize_merchant_list($input['yadore_merchant_blacklist'] ?? '');
        
        // Amazon settings
        $sanitized['enable_amazon'] = isset($input['enable_amazon']) ? 'yes' : 'no';
        $sanitized['amazon_access_key'] = sanitize_text_field($input['amazon_access_key'] ?? '');
        $sanitized['amazon_secret_key'] = sanitize_text_field($input['amazon_secret_key'] ?? '');
        $sanitized['amazon_partner_tag'] = sanitize_text_field($input['amazon_partner_tag'] ?? '');
        $sanitized['amazon_marketplace'] = sanitize_text_field($input['amazon_marketplace'] ?? 'de');
        $sanitized['amazon_default_category'] = sanitize_text_field($input['amazon_default_category'] ?? 'All');
        $sanitized['amazon_language'] = sanitize_text_field($input['amazon_language'] ?? '');
        
        // Cache settings
        $sanitized['cache_duration'] = max(1, min(168, (int) ($input['cache_duration'] ?? 6)));
        $sanitized['fallback_duration'] = max(1, min(720, (int) ($input['fallback_duration'] ?? 24)));
        
        // Redis settings
        $sanitized['enable_redis'] = in_array($input['enable_redis'] ?? '', ['auto', 'yes', 'no'], true) 
            ? $input['enable_redis'] : 'auto';
        $sanitized['redis_host'] = sanitize_text_field($input['redis_host'] ?? '127.0.0.1');
        $sanitized['redis_port'] = max(1, min(65535, (int) ($input['redis_port'] ?? 6379)));
        $sanitized['redis_password'] = sanitize_text_field($input['redis_password'] ?? '');
        $sanitized['redis_database'] = max(0, min(15, (int) ($input['redis_database'] ?? 0)));
        
        // Local Image Storage
        $sanitized['enable_local_images'] = isset($input['enable_local_images']) ? 'yes' : 'no';
        $sanitized['preferred_image_size'] = in_array($input['preferred_image_size'] ?? '', ['Large', 'Medium', 'Small'], true) 
            ? $input['preferred_image_size'] : 'Large';
        $sanitized['image_filename_format'] = in_array($input['image_filename_format'] ?? '', ['seo', 'id'], true) 
            ? $input['image_filename_format'] : 'seo';
        $sanitized['image_resize_enabled'] = isset($input['image_resize_enabled']) ? 'yes' : 'no';
        
        // Fuzzy Search settings
        $sanitized['enable_fuzzy_search'] = isset($input['enable_fuzzy_search']) ? 'yes' : 'no';
        $sanitized['fuzzy_auto_mix'] = isset($input['fuzzy_auto_mix']) ? 'yes' : 'no';
        $sanitized['fuzzy_threshold'] = max(0, min(100, (int) ($input['fuzzy_threshold'] ?? 30)));
        $sanitized['fuzzy_weight_title'] = max(0, min(1, (float) ($input['fuzzy_weight_title'] ?? 0.40)));
        $sanitized['fuzzy_weight_description'] = max(0, min(1, (float) ($input['fuzzy_weight_description'] ?? 0.25)));
        $sanitized['fuzzy_weight_category'] = max(0, min(1, (float) ($input['fuzzy_weight_category'] ?? 0.20)));
        $sanitized['fuzzy_weight_merchant'] = max(0, min(1, (float) ($input['fuzzy_weight_merchant'] ?? 0.10)));
        $sanitized['fuzzy_weight_keywords'] = max(0, min(1, (float) ($input['fuzzy_weight_keywords'] ?? 0.05)));
        
        // Display settings
        $sanitized['disable_default_css'] = isset($input['disable_default_css']) ? 'yes' : 'no';
        $sanitized['grid_columns_desktop'] = max(1, min(6, (int) ($input['grid_columns_desktop'] ?? 3)));
        $sanitized['grid_columns_tablet'] = max(1, min(4, (int) ($input['grid_columns_tablet'] ?? 2)));
        $sanitized['grid_columns_mobile'] = max(1, min(2, (int) ($input['grid_columns_mobile'] ?? 1)));
        $sanitized['button_text_yadore'] = sanitize_text_field($input['button_text_yadore'] ?? 'Zum Angebot');
        $sanitized['button_text_amazon'] = sanitize_text_field($input['button_text_amazon'] ?? 'Bei Amazon kaufen');
        $sanitized['button_text_custom'] = sanitize_text_field($input['button_text_custom'] ?? 'Zum Angebot');
        $sanitized['show_prime_badge'] = isset($input['show_prime_badge']) ? 'yes' : 'no';
        $sanitized['show_merchant'] = isset($input['show_merchant']) ? 'yes' : 'no';
        $sanitized['show_description'] = isset($input['show_description']) ? 'yes' : 'no';
        $sanitized['show_custom_badge'] = isset($input['show_custom_badge']) ? 'yes' : 'no';
        $sanitized['custom_badge_text'] = sanitize_text_field($input['custom_badge_text'] ?? 'Empfohlen');
        $sanitized['color_primary'] = sanitize_hex_color($input['color_primary'] ?? '#ff00cc') ?: '#ff00cc';
        $sanitized['color_secondary'] = sanitize_hex_color($input['color_secondary'] ?? '#00ffff') ?: '#00ffff';
        $sanitized['color_amazon'] = sanitize_hex_color($input['color_amazon'] ?? '#ff9900') ?: '#ff9900';
        $sanitized['color_custom'] = sanitize_hex_color($input['color_custom'] ?? '#4CAF50') ?: '#4CAF50';
        
        // GitHub Token
        $sanitized['github_token'] = sanitize_text_field($input['github_token'] ?? '');
        
        return $sanitized;
    }
    
    private function sanitize_merchant_list(string $input): string {
        $list = array_map('trim', explode(',', $input));
        $list = array_filter($list, fn($item) => $item !== '');
        return implode(', ', $list);
    }
    
    /**
     * @param array<string, mixed> $options
     * @param array<string, string> $markets
     */
    private function render_yadore_settings(array $options, array $markets): void {
        $current_market = $options['yadore_market'] ?? 'de';
        $merchants = class_exists('YAA_Merchant_Filter') ? YAA_Merchant_Filter::get_stored_merchants($current_market) : [];
        $last_update = class_exists('YAA_Merchant_Filter') ? YAA_Merchant_Filter::get_last_update($current_market) : null;
        
        $whitelist = $options['yadore_merchant_whitelist'] ?? '';
        $blacklist = $options['yadore_merchant_blacklist'] ?? '';
        $sort_options = $this->yadore_api->get_sort_options();
        ?>
        <div class="yaa-card">
            <h2>📶 Yadore API Konfiguration</h2>
            <p class="description">
                Yadore bietet Zugang zu über 9.000 Shops und 250 Millionen Produkten. 
                <a href="https://www.yadore.com/publisher" target="_blank" rel="noopener">Publisher-Account erstellen →</a>
            </p>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[enable_yadore]" value="yes" 
                        <?php checked(($options['enable_yadore'] ?? 'yes'), 'yes'); ?>>
                    Yadore API aktivieren
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label for="yadore_api_key">API-Key</label>
                <input type="text" id="yadore_api_key" name="yaa_settings[yadore_api_key]" 
                       value="<?php echo esc_attr($options['yadore_api_key'] ?? ''); ?>"
                       <?php echo defined('YADORE_API_KEY') ? 'disabled' : ''; ?>
                       placeholder="Dein Yadore API-Key">
                <?php if (defined('YADORE_API_KEY')): ?>
                    <p class="description">✅ Via <code>wp-config.php</code> definiert (YADORE_API_KEY)</p>
                <?php else: ?>
                    <p class="description">Den API-Key erhältst du nach der Registrierung bei Yadore.</p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="yadore_market">Standard-Markt</label>
                    <select id="yadore_market" name="yaa_settings[yadore_market]">
                        <?php foreach ($markets as $code => $name): ?>
                            <option value="<?php echo esc_attr($code); ?>" 
                                <?php selected(($options['yadore_market'] ?? 'de'), $code); ?>>
                                <?php echo esc_html($name . ' (' . strtoupper($code) . ')'); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <p class="description">Kann im Shortcode mit <code>market="xx"</code> überschrieben werden.</p>
                </div>
                
                <div class="yaa-form-row">
                    <label for="yadore_precision">Such-Genauigkeit</label>
                    <select id="yadore_precision" name="yaa_settings[yadore_precision]">
                        <option value="fuzzy" <?php selected(($options['yadore_precision'] ?? 'fuzzy'), 'fuzzy'); ?>>
                            Fuzzy (mehr Ergebnisse)
                        </option>
                        <option value="strict" <?php selected(($options['yadore_precision'] ?? 'fuzzy'), 'strict'); ?>>
                            Strict (exaktere Treffer)
                        </option>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="yadore_default_limit">Standard-Limit</label>
                    <input type="number" id="yadore_default_limit" name="yaa_settings[yadore_default_limit]" 
                           value="<?php echo esc_attr($options['yadore_default_limit'] ?? '9'); ?>"
                           min="1" max="50">
                </div>
                
                <div class="yaa-form-row">
                    <label for="yadore_default_sort">Standard-Sortierung</label>
                    <select id="yadore_default_sort" name="yaa_settings[yadore_default_sort]">
                        <?php foreach ($sort_options as $value => $label): ?>
                            <option value="<?php echo esc_attr($value); ?>" 
                                <?php selected(($options['yadore_default_sort'] ?? 'rel_desc'), $value); ?>>
                                <?php echo esc_html($label); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <p class="description">Kann im Shortcode mit <code>sort="price_asc"</code> überschrieben werden.</p>
                </div>
            </div>
            
            <div class="yaa-form-row">
                <button type="button" class="button yaa-test-btn" data-action="yaa_test_yadore">
                    🔍 Verbindung testen
                </button>
                <div class="yaa-test-result"></div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>📊 Sortierungs-Optionen</h2>
            <p class="description">Bestimme, in welcher Reihenfolge die Produkte angezeigt werden.</p>
            
            <table class="widefat striped" style="margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Wert</th>
                        <th>Beschreibung</th>
                        <th>Shortcode-Beispiel</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>rel_desc</code></td>
                        <td>Nach Relevanz (Standard der Yadore API)</td>
                        <td><code>[yadore_products keyword="Laptop" sort="rel_desc"]</code></td>
                    </tr>
                    <tr>
                        <td><code>price_asc</code></td>
                        <td>Günstigste Produkte zuerst ↑</td>
                        <td><code>[yadore_products keyword="Smartphone" sort="price_asc"]</code></td>
                    </tr>
                    <tr>
                        <td><code>price_desc</code></td>
                        <td>Teuerste Produkte zuerst</td>
                        <td><code>[yadore_products keyword="Monitor" sort="price_desc"]</code></td>
                    </tr>
                    <tr style="background: #e8f5e9;">
                        <td><code>cpc_desc</code></td>
                        <td><strong>Höchste Vergütung zuerst</strong> 💵</td>
                        <td><code>[yadore_products keyword="Kopfhörer" sort="cpc_desc"]</code></td>
                    </tr>
                    <tr>
                        <td><code>cpc_asc</code></td>
                        <td>Niedrigste Vergütung zuerst</td>
                        <td><code>[yadore_products keyword="Tablet" sort="cpc_asc"]</code></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="yaa-tip" style="margin-top: 15px;">
                <strong>💡 Tipp:</strong> Mit <code>sort="cpc_desc"</code> werden Produkte mit der höchsten 
                Vergütung pro Klick zuerst angezeigt. So kannst du deinen Revenue maximieren!
            </div>
            
            <div class="yaa-feature-box info" style="margin-top: 15px;">
                <h4 style="margin-top: 0;">⚠️ Hinweis zur CPC-Sortierung</h4>
                <p>
                    Die CPC-Sortierung erfolgt <strong>nach dem API-Abruf</strong> im Plugin, da die Yadore API
                    nur Preis- und Relevanz-Sortierung nativ unterstützt. Bei CPC-Sortierung werden automatisch
                    mehr Produkte geladen, um nach der Sortierung genügend Ergebnisse zu haben.
                </p>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🏪 Händler-Filter (Whitelist / Blacklist)</h2>
            <p class="description">
                Filtere Produkte nach Händlern. <strong>Whitelist hat immer Vorrang</strong> vor der Blacklist.
                Das Matching erfolgt auf dem Händlernamen (case-insensitive, partial match).
            </p>
            
            <div class="yaa-feature-box info" style="margin-bottom: 20px;">
                <h4 style="margin-top: 0;">📋 Händlerliste</h4>
                <p>
                    <strong><?php echo count($merchants); ?></strong> Händler verfügbar
                    <?php if ($last_update): ?>
                        (zuletzt aktualisiert: <?php echo esc_html(date_i18n('d.m.Y H:i', $last_update)); ?>)
                    <?php endif; ?>
                </p>
                <p>
                    <button type="button" class="button" id="yaa-refresh-merchants">
                        🔄 Händlerliste aktualisieren
                    </button>
                    <span id="yaa-merchant-refresh-status" style="margin-left: 10px;"></span>
                </p>
                <p style="margin-top: 10px;">
                    <a href="<?php echo esc_url(admin_url('admin.php?page=yaa-merchants')); ?>" class="button button-secondary">
                        📊 Händlerübersicht mit CPC öffnen
                    </a>
                </p>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="yadore_merchant_whitelist">✅ Whitelist (nur diese Händler anzeigen)</label>
                    <?php if (!empty($merchants)): ?>
                        <select name="yaa_settings_whitelist_select[]" multiple class="yaa-merchant-select" 
                                data-target="yadore_merchant_whitelist" style="height: 150px; width: 100%;">
                            <?php 
                            $whitelist_array = array_map('trim', explode(',', $whitelist));
                            foreach ($merchants as $merchant): 
                                $is_selected = in_array($merchant['name'], $whitelist_array, true);
                            ?>
                                <option value="<?php echo esc_attr($merchant['name']); ?>" <?php selected($is_selected); ?>>
                                    <?php echo esc_html($merchant['name']); ?>
                                    <?php if (!empty($merchant['offerCount'])): ?>
                                        (<?php echo number_format($merchant['offerCount'], 0, ',', '.'); ?>)
                                    <?php endif; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    <?php endif; ?>
                    <input type="text" id="yadore_merchant_whitelist" 
                           name="yaa_settings[yadore_merchant_whitelist]" 
                           value="<?php echo esc_attr($whitelist); ?>"
                           placeholder="amazon, otto, mediamarkt"
                           style="margin-top: 10px;">
                    <p class="description">Komma-separierte Liste. Wenn gesetzt, werden <strong>NUR</strong> Produkte dieser Händler angezeigt.</p>
                </div>
                
                <div class="yaa-form-row">
                    <label for="yadore_merchant_blacklist">❌ Blacklist (diese Händler ausschließen)</label>
                    <?php if (!empty($merchants)): ?>
                        <select name="yaa_settings_blacklist_select[]" multiple class="yaa-merchant-select"
                                data-target="yadore_merchant_blacklist" style="height: 150px; width: 100%;">
                            <?php 
                            $blacklist_array = array_map('trim', explode(',', $blacklist));
                            foreach ($merchants as $merchant): 
                                $is_selected = in_array($merchant['name'], $blacklist_array, true);
                            ?>
                                <option value="<?php echo esc_attr($merchant['name']); ?>" <?php selected($is_selected); ?>>
                                    <?php echo esc_html($merchant['name']); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    <?php endif; ?>
                    <input type="text" id="yadore_merchant_blacklist" 
                           name="yaa_settings[yadore_merchant_blacklist]" 
                           value="<?php echo esc_attr($blacklist); ?>"
                           placeholder="aliexpress, wish"
                           style="margin-top: 10px;">
                    <p class="description">Komma-separierte Liste. Produkte dieser Händler werden ausgeblendet (wenn keine Whitelist aktiv).</p>
                </div>
            </div>
            
            <div class="yaa-tip" style="margin-top: 20px;">
                <strong>⚠️ Whitelist hat Vorrang:</strong> Wenn die Whitelist gesetzt ist, wird die Blacklist ignoriert.
            </div>
            
            <div class="yaa-feature-box" style="margin-top: 20px;">
                <h4 style="margin-top: 0;">📝 Shortcode-Override</h4>
                <p>Du kannst den Filter pro Shortcode überschreiben:</p>
                <div class="yaa-shortcode-box">[yadore_products keyword="Laptop" merchant_whitelist="amazon,otto"]</div>
                <div class="yaa-shortcode-box">[yadore_products keyword="Handy" merchant_blacklist="aliexpress,wish"]</div>
                <div class="yaa-shortcode-box">[yadore_products keyword="Tablet" merchants="mediamarkt,saturn"]</div>
                <p class="description" style="margin-top: 10px;">
                    <code>merchant_whitelist</code> / <code>merchants</code> = Whitelist<br>
                    <code>merchant_blacklist</code> / <code>exclude_merchants</code> = Blacklist
                </p>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>💡 Multi-Keyword Feature</h2>
            <p class="description">Du kannst mehrere Keywords in einem Shortcode verwenden. Das Limit wird automatisch aufgeteilt.</p>
            <div class="yaa-shortcode-box">[yadore_products keywords="Smartphone,Tablet,Laptop" limit="9"]</div>
            <div class="yaa-shortcode-box">[yadore_products keywords="Smartphone,Tablet" limit="6" sort="cpc_desc"]</div>
            <div class="yaa-tip">
                <strong>Tipp:</strong> Bei 3 Keywords und limit="9" werden je 3 Produkte pro Keyword geladen.
            </div>
        </div>
        <?php
    }
    
    /**
     * @param array<string, mixed> $options
     * @param array<string, string> $marketplaces
     */
    private function render_amazon_settings(array $options, array $marketplaces): void {
        $current_marketplace = $options['amazon_marketplace'] ?? 'de';
        $all_marketplaces = $this->amazon_api->get_marketplaces();
        ?>
        <div class="yaa-card">
            <h2>🛒 Amazon Product Advertising API 5.0</h2>
            <p class="description">
                Für die Amazon PA-API benötigst du ein Amazon Associates Konto mit mindestens 10 qualifizierten Verkäufen in 30 Tagen.
                <a href="https://webservices.amazon.com/paapi5/documentation/" target="_blank" rel="noopener">Dokumentation →</a>
            </p>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[enable_amazon]" value="yes" 
                        <?php checked(($options['enable_amazon'] ?? 'yes'), 'yes'); ?>>
                    Amazon PA-API aktivieren
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label for="amazon_access_key">Access Key</label>
                <input type="text" id="amazon_access_key" name="yaa_settings[amazon_access_key]" 
                       value="<?php echo esc_attr($options['amazon_access_key'] ?? ''); ?>"
                       <?php echo defined('AMAZON_PAAPI_ACCESS_KEY') ? 'disabled' : ''; ?>
                       placeholder="AKIAXXXXXXXXXX">
                <?php if (defined('AMAZON_PAAPI_ACCESS_KEY')): ?>
                    <p class="description">✅ Via <code>wp-config.php</code> definiert</p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-form-row">
                <label for="amazon_secret_key">Secret Key</label>
                <input type="password" id="amazon_secret_key" name="yaa_settings[amazon_secret_key]" 
                       value="<?php echo esc_attr($options['amazon_secret_key'] ?? ''); ?>"
                       <?php echo defined('AMAZON_PAAPI_SECRET_KEY') ? 'disabled' : ''; ?>>
                <?php if (defined('AMAZON_PAAPI_SECRET_KEY')): ?>
                    <p class="description">✅ Via <code>wp-config.php</code> definiert</p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-form-row">
                <label for="amazon_partner_tag">Partner Tag (Tracking-ID)</label>
                <input type="text" id="amazon_partner_tag" name="yaa_settings[amazon_partner_tag]" 
                       value="<?php echo esc_attr($options['amazon_partner_tag'] ?? ''); ?>"
                       placeholder="deinshop-21"
                       <?php echo defined('AMAZON_PAAPI_PARTNER_TAG') ? 'disabled' : ''; ?>>
                <p class="description">Deine Tracking-ID aus dem Amazon PartnerNet. <strong>Muss zum Marketplace passen!</strong></p>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="amazon_marketplace">Marketplace</label>
                    <select id="amazon_marketplace" name="yaa_settings[amazon_marketplace]">
                        <optgroup label="🇪🇺 Europa">
                            <?php foreach (['de', 'fr', 'it', 'es', 'co.uk', 'nl', 'pl', 'se', 'be', 'com.tr'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                        <optgroup label="🌍 Naher Osten &amp; Afrika">
                            <?php foreach (['ae', 'sa', 'eg'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                        <optgroup label="🌎 Amerika">
                            <?php foreach (['com', 'ca', 'com.mx', 'com.br'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                        <optgroup label="🌏 Asien-Pazifik">
                            <?php foreach (['co.jp', 'in', 'com.au', 'sg'] as $code): ?>
                                <?php if (isset($marketplaces[$code])): ?>
                                <option value="<?php echo esc_attr($code); ?>" <?php selected($current_marketplace, $code); ?>>
                                    <?php echo esc_html($marketplaces[$code]); ?>
                                </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </optgroup>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="amazon_default_category">Standard-Kategorie</label>
                    <select id="amazon_default_category" name="yaa_settings[amazon_default_category]">
                        <?php 
                        $search_indexes = $this->amazon_api->get_search_indexes();
                        foreach ($search_indexes as $code => $name): 
                        ?>
                            <option value="<?php echo esc_attr($code); ?>" <?php selected(($options['amazon_default_category'] ?? 'All'), $code); ?>>
                                <?php echo esc_html($code === $name ? $code : "$code - $name"); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
            
            <div class="yaa-marketplace-info">
                <h4>📍 Marketplace-Details</h4>
                <?php foreach ($all_marketplaces as $code => $info): ?>
                <div id="marketplace-info-<?php echo esc_attr(str_replace('.', '-', $code)); ?>" 
                     class="yaa-marketplace-detail" 
                     style="<?php echo $code !== $current_marketplace ? 'display:none;' : ''; ?>">
                    <table class="widefat" style="margin-top: 10px;">
                        <tr><td width="150"><strong>Host:</strong></td><td><code><?php echo esc_html($info['host']); ?></code></td></tr>
                        <tr><td><strong>Region:</strong></td><td><?php echo esc_html($info['region']); ?></td></tr>
                        <tr><td><strong>Währung:</strong></td><td><?php echo esc_html($info['currency']); ?></td></tr>
                        <tr><td><strong>Sprache:</strong></td><td><?php echo esc_html($info['language']); ?></td></tr>
                    </table>
                </div>
                <?php endforeach; ?>
            </div>
            
            <div class="yaa-form-row" style="margin-top: 20px;">
                <button type="button" class="button yaa-test-btn" data-action="yaa_test_amazon">
                    🔍 Verbindung testen
                </button>
                <div class="yaa-test-result"></div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>⚠️ Amazon API Einschränkungen</h2>
            <ul style="list-style: disc; margin-left: 20px; line-height: 1.8;">
                <li><strong>10 qualifizierte Verkäufe</strong> in den letzten 30 Tagen erforderlich (seit Nov. 2025)</li>
                <li>Maximal <strong>1 Request/Sekunde</strong> bei wenigen Verkäufen</li>
                <li>Maximal <strong>10 Produkte</strong> pro API-Anfrage</li>
                <li>Partner-Tag <strong>muss zum Marketplace</strong> passen</li>
            </ul>
        </div>
        <?php
    }
    
    /**
     * @param array<string, mixed> $options
     */
    private function render_custom_products_settings(array $options): void {
        $product_count = wp_count_posts(YAA_Custom_Products::get_post_type());
        $published_count = is_object($product_count) ? ($product_count->publish ?? 0) : 0;
        
        $categories = get_terms([
            'taxonomy' => YAA_Custom_Products::get_taxonomy(),
            'hide_empty' => false,
        ]);
        $category_count = is_array($categories) ? count($categories) : 0;
        ?>
        <div class="yaa-card">
            <h2>⭐ Eigene Produkte</h2>
            <p class="description">Erstelle eigene Produkteinträge mit individuellen Links, Bildern und Preisen.</p>
            
            <div class="yaa-grid" style="margin: 20px 0;">
                <div class="yaa-stat-box" style="background: #f0f6fc;">
                    <div class="yaa-stat-number" style="color: #0073aa;"><?php echo (int) $published_count; ?></div>
                    <div class="yaa-stat-label">Produkte</div>
                </div>
                <div class="yaa-stat-box" style="background: #f0f9ff;">
                    <div class="yaa-stat-number" style="color: #00a0d2;"><?php echo (int) $category_count; ?></div>
                    <div class="yaa-stat-label">Kategorien</div>
                </div>
            </div>
            
            <p>
                <a href="<?php echo esc_url(admin_url('edit.php?post_type=' . YAA_Custom_Products::get_post_type())); ?>" class="button button-primary">
                    📦 Produkte verwalten
                </a>
                <a href="<?php echo esc_url(admin_url('post-new.php?post_type=' . YAA_Custom_Products::get_post_type())); ?>" class="button">
                    ➕ Neues Produkt
                </a>
                <a href="<?php echo esc_url(admin_url('edit-tags.php?taxonomy=' . YAA_Custom_Products::get_taxonomy() . '&post_type=' . YAA_Custom_Products::get_post_type())); ?>" class="button">
                    🏷️ Kategorien
                </a>
            </p>
        </div>
        
        <div class="yaa-card">
            <h2>🔍 Fuzzy-Suche für eigene Produkte</h2>
            <p class="description">Die Fuzzy-Suche findet ähnliche Produkte auch bei Tippfehlern oder unvollständigen Suchbegriffen.</p>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[enable_fuzzy_search]" value="yes" 
                        <?php checked(($options['enable_fuzzy_search'] ?? 'yes'), 'yes'); ?>>
                    Fuzzy-Suche aktivieren
                </label>
            </div>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[fuzzy_auto_mix]" value="yes" 
                        <?php checked(($options['fuzzy_auto_mix'] ?? 'no'), 'yes'); ?>>
                    Automatisch eigene Produkte in Yadore/Amazon-Ergebnisse einmischen
                </label>
                <p class="description">Wenn aktiviert, werden passende eigene Produkte automatisch bei allen Suchanfragen hinzugefügt.</p>
            </div>
            
            <div class="yaa-form-row">
                <label for="fuzzy_threshold">Mindest-Score für Treffer (%)</label>
                <input type="range" id="fuzzy_threshold" name="yaa_settings[fuzzy_threshold]" 
                       value="<?php echo esc_attr($options['fuzzy_threshold'] ?? '30'); ?>"
                       min="0" max="100" step="5"
                       oninput="document.getElementById('fuzzy_threshold_value').textContent = this.value + '%'">
                <span id="fuzzy_threshold_value" style="margin-left: 10px; font-weight: bold;">
                    <?php echo esc_html($options['fuzzy_threshold'] ?? '30'); ?>%
                </span>
                <p class="description">Produkte mit einem Score unter diesem Wert werden nicht angezeigt.</p>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>⚖️ Gewichtung der Suchfelder</h2>
            <p class="description">Bestimme, wie stark jedes Feld in die Berechnung des Scores einfließt. Die Summe sollte 1.0 ergeben.</p>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="fuzzy_weight_title">Titel</label>
                    <input type="number" id="fuzzy_weight_title" name="yaa_settings[fuzzy_weight_title]" 
                           value="<?php echo esc_attr($options['fuzzy_weight_title'] ?? '0.40'); ?>"
                           min="0" max="1" step="0.05">
                </div>
                <div class="yaa-form-row">
                    <label for="fuzzy_weight_description">Beschreibung</label>
                    <input type="number" id="fuzzy_weight_description" name="yaa_settings[fuzzy_weight_description]" 
                           value="<?php echo esc_attr($options['fuzzy_weight_description'] ?? '0.25'); ?>"
                           min="0" max="1" step="0.05">
                </div>
                <div class="yaa-form-row">
                    <label for="fuzzy_weight_category">Kategorie</label>
                    <input type="number" id="fuzzy_weight_category" name="yaa_settings[fuzzy_weight_category]" 
                           value="<?php echo esc_attr($options['fuzzy_weight_category'] ?? '0.20'); ?>"
                           min="0" max="1" step="0.05">
                </div>
                <div class="yaa-form-row">
                    <label for="fuzzy_weight_merchant">Händler</label>
                    <input type="number" id="fuzzy_weight_merchant" name="yaa_settings[fuzzy_weight_merchant]" 
                           value="<?php echo esc_attr($options['fuzzy_weight_merchant'] ?? '0.10'); ?>"
                           min="0" max="1" step="0.05">
                </div>
                <div class="yaa-form-row">
                    <label for="fuzzy_weight_keywords">Keywords</label>
                    <input type="number" id="fuzzy_weight_keywords" name="yaa_settings[fuzzy_weight_keywords]" 
                           value="<?php echo esc_attr($options['fuzzy_weight_keywords'] ?? '0.05'); ?>"
                           min="0" max="1" step="0.05">
                </div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>📝 Shortcode-Beispiele</h2>
            
            <h4>Eigene Produkte anzeigen:</h4>
            <div class="yaa-shortcode-box">[custom_products limit="6"]</div>
            <div class="yaa-shortcode-box">[custom_products ids="123,456,789"]</div>
            <div class="yaa-shortcode-box">[custom_products category="elektronik" limit="4"]</div>
            
            <h4>Fuzzy-Suche:</h4>
            <div class="yaa-shortcode-box">[fuzzy_products keyword="Smartphone" limit="5"]</div>
            <div class="yaa-shortcode-box">[custom_products keyword="Laptop" fuzzy="yes"]</div>
            
            <h4>Eigene Produkte einmischen:</h4>
            <div class="yaa-shortcode-box">[yadore_products keyword="Kopfhörer" mix_custom="yes" custom_limit="2"]</div>
            <div class="yaa-shortcode-box">[amazon_products keyword="Tablet" mix_custom="yes" custom_position="alternate"]</div>
            
            <p class="description" style="margin-top: 15px;">
                <strong>custom_position</strong> Optionen: <code>start</code>, <code>end</code>, <code>shuffle</code>, <code>alternate</code>
            </p>
        </div>
        <?php
    }
    
    /**
     * @param array<string, mixed> $options
     * @param array<string, mixed> $cache_status
     */
    private function render_cache_settings(array $options, array $cache_status): void {
        ?>
        <div class="yaa-card">
            <h2>⚡ Cache-Einstellungen</h2>
            
            <div class="yaa-cache-status">
                <h4>Status</h4>
                <table class="widefat striped">
                    <tr>
                        <td width="200"><strong>Cache-Typ:</strong></td>
                        <td>
                            <?php 
                            $type = $cache_status['type'] ?? 'transient';
                            echo $type === 'redis' ? '🚀 Redis' : '💾 WordPress Transients';
                            ?>
                        </td>
                    </tr>
                    <?php if ($type === 'redis'): ?>
                    <tr>
                        <td><strong>Redis-Status:</strong></td>
                        <td>
                            <?php if ($cache_status['connected'] ?? false): ?>
                                ✅ Verbunden
                            <?php else: ?>
                                ❌ Nicht verbunden
                            <?php endif; ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <tr>
                        <td><strong>Einträge:</strong></td>
                        <td><?php echo number_format((int) ($cache_status['entries'] ?? 0), 0, ',', '.'); ?></td>
                    </tr>
                </table>
            </div>
            
            <div class="yaa-grid" style="margin-top: 20px;">
                <div class="yaa-form-row">
                    <label for="cache_duration">Cache-Dauer (Stunden)</label>
                    <input type="number" id="cache_duration" name="yaa_settings[cache_duration]" 
                           value="<?php echo esc_attr($options['cache_duration'] ?? '6'); ?>"
                           min="1" max="168">
                    <p class="description">Wie lange API-Ergebnisse gecacht werden.</p>
                </div>
                
                <div class="yaa-form-row">
                    <label for="fallback_duration">Fallback-Dauer (Stunden)</label>
                    <input type="number" id="fallback_duration" name="yaa_settings[fallback_duration]" 
                           value="<?php echo esc_attr($options['fallback_duration'] ?? '24'); ?>"
                           min="1" max="720">
                    <p class="description">Wie lange alte Daten bei API-Fehlern verwendet werden.</p>
                </div>
            </div>
            
            <div class="yaa-form-row" style="margin-top: 20px;">
                <button type="button" class="button button-secondary" id="yaa-clear-cache">
                    🗑️ Cache leeren
                </button>
                <button type="button" class="button" id="yaa-preload-cache" style="margin-left: 10px;">
                    ⏳ Cache vorwärmen
                </button>
                <span id="yaa-cache-status" style="margin-left: 10px;"></span>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🔴 Redis-Konfiguration</h2>
            <p class="description">Redis bietet schnelleres Caching als WordPress Transients. Optional.</p>
            
            <div class="yaa-form-row">
                <label for="enable_redis">Redis verwenden</label>
                <select id="enable_redis" name="yaa_settings[enable_redis]">
                    <option value="auto" <?php selected(($options['enable_redis'] ?? 'auto'), 'auto'); ?>>
                        Automatisch (wenn verfügbar)
                    </option>
                    <option value="yes" <?php selected(($options['enable_redis'] ?? 'auto'), 'yes'); ?>>
                        Immer verwenden
                    </option>
                    <option value="no" <?php selected(($options['enable_redis'] ?? 'auto'), 'no'); ?>>
                        Deaktiviert
                    </option>
                </select>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="redis_host">Host</label>
                    <input type="text" id="redis_host" name="yaa_settings[redis_host]" 
                           value="<?php echo esc_attr($options['redis_host'] ?? '127.0.0.1'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="redis_port">Port</label>
                    <input type="number" id="redis_port" name="yaa_settings[redis_port]" 
                           value="<?php echo esc_attr($options['redis_port'] ?? '6379'); ?>"
                           min="1" max="65535">
                </div>
                
                <div class="yaa-form-row">
                    <label for="redis_password">Passwort</label>
                    <input type="password" id="redis_password" name="yaa_settings[redis_password]" 
                           value="<?php echo esc_attr($options['redis_password'] ?? ''); ?>"
                           placeholder="Optional">
                </div>
                
                <div class="yaa-form-row">
                    <label for="redis_database">Datenbank (0-15)</label>
                    <input type="number" id="redis_database" name="yaa_settings[redis_database]" 
                           value="<?php echo esc_attr($options['redis_database'] ?? '0'); ?>"
                           min="0" max="15">
                </div>
            </div>
            
            <div class="yaa-form-row" style="margin-top: 15px;">
                <button type="button" class="button yaa-test-btn" data-action="yaa_test_redis">
                    🔍 Redis-Verbindung testen
                </button>
                <div class="yaa-test-result"></div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🖼️ Lokale Bilderspeicherung</h2>
            <p class="description">Speichere Produktbilder lokal für schnellere Ladezeiten und mehr Kontrolle.</p>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[enable_local_images]" value="yes" 
                        <?php checked(($options['enable_local_images'] ?? 'yes'), 'yes'); ?>>
                    Bilder lokal speichern
                </label>
                <p class="description">Bilder werden in <code>/wp-content/uploads/yaa-products/</code> gespeichert.</p>
            </div>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="preferred_image_size">Bevorzugte Bildgröße</label>
                    <select id="preferred_image_size" name="yaa_settings[preferred_image_size]">
                        <option value="Large" <?php selected(($options['preferred_image_size'] ?? 'Large'), 'Large'); ?>>
                            Large (max. verfügbar)
                        </option>
                        <option value="Medium" <?php selected(($options['preferred_image_size'] ?? 'Large'), 'Medium'); ?>>
                            Medium
                        </option>
                        <option value="Small" <?php selected(($options['preferred_image_size'] ?? 'Large'), 'Small'); ?>>
                            Small (schneller)
                        </option>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="image_filename_format">Dateiname-Format</label>
                    <select id="image_filename_format" name="yaa_settings[image_filename_format]">
                        <option value="seo" <?php selected(($options['image_filename_format'] ?? 'seo'), 'seo'); ?>>
                            SEO-freundlich (produktname-source.jpg)
                        </option>
                        <option value="id" <?php selected(($options['image_filename_format'] ?? 'seo'), 'id'); ?>>
                            ID-basiert (asin/ean_hash.jpg)
                        </option>
                    </select>
                    <p class="description">SEO-freundliche Dateinamen können das Ranking in der Bildersuche verbessern.</p>
                </div>
            </div>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[image_resize_enabled]" value="yes" 
                        <?php checked(($options['image_resize_enabled'] ?? 'no'), 'yes'); ?>>
                    Bilder auf max. 800px verkleinern (spart Speicherplatz)
                </label>
            </div>
            
            <?php
            $upload_dir = wp_upload_dir();
            $yaa_dir = $upload_dir['basedir'] . '/yaa-products';
            $image_count = 0;
            $total_size = 0;
            
            if (is_dir($yaa_dir)) {
                $files = glob($yaa_dir . '/*/*.{jpg,jpeg,png,gif,webp}', GLOB_BRACE);
                if (is_array($files) && $files !== []) {
                    $image_count = count($files);
                    foreach ($files as $file) {
                        $total_size += filesize($file);
                    }
                }
            }
            ?>
            
            <div class="yaa-feature-box info" style="margin-top: 20px;">
                <h4 style="margin-top: 0;">📊 Lokale Bilder-Statistik</h4>
                <p>
                    <strong><?php echo number_format($image_count, 0, ',', '.'); ?></strong> Bilder gespeichert<br>
                    <strong><?php echo size_format($total_size); ?></strong> Speicherverbrauch
                </p>
                <p>
                    <button type="button" class="button button-secondary" id="yaa-cleanup-images">
                        🧹 Ungenutzte Bilder löschen
                    </button>
                    <span id="yaa-image-cleanup-status" style="margin-left: 10px;"></span>
                </p>
            </div>
        </div>
        <?php
    }
    
    /**
     * @param array<string, mixed> $options
     */
    private function render_display_settings(array $options): void {
        ?>
        <div class="yaa-card">
            <h2>🎨 Darstellungs-Optionen</h2>
            
            <div class="yaa-form-row">
                <label>
                    <input type="checkbox" name="yaa_settings[disable_default_css]" value="yes" 
                        <?php checked(($options['disable_default_css'] ?? 'no'), 'yes'); ?>>
                    Standard-CSS deaktivieren (eigenes Styling verwenden)
                </label>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>📐 Grid-Spalten</h2>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="grid_columns_desktop">Desktop (≥1024px)</label>
                    <select id="grid_columns_desktop" name="yaa_settings[grid_columns_desktop]">
                        <?php for ($i = 1; $i <= 6; $i++): ?>
                            <option value="<?php echo $i; ?>" <?php selected(($options['grid_columns_desktop'] ?? 3), $i); ?>>
                                <?php echo $i; ?> Spalte<?php echo $i > 1 ? 'n' : ''; ?>
                            </option>
                        <?php endfor; ?>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="grid_columns_tablet">Tablet (768-1023px)</label>
                    <select id="grid_columns_tablet" name="yaa_settings[grid_columns_tablet]">
                        <?php for ($i = 1; $i <= 4; $i++): ?>
                            <option value="<?php echo $i; ?>" <?php selected(($options['grid_columns_tablet'] ?? 2), $i); ?>>
                                <?php echo $i; ?> Spalte<?php echo $i > 1 ? 'n' : ''; ?>
                            </option>
                        <?php endfor; ?>
                    </select>
                </div>
                
                <div class="yaa-form-row">
                    <label for="grid_columns_mobile">Mobile (&lt;768px)</label>
                    <select id="grid_columns_mobile" name="yaa_settings[grid_columns_mobile]">
                        <?php for ($i = 1; $i <= 2; $i++): ?>
                            <option value="<?php echo $i; ?>" <?php selected(($options['grid_columns_mobile'] ?? 1), $i); ?>>
                                <?php echo $i; ?> Spalte<?php echo $i > 1 ? 'n' : ''; ?>
                            </option>
                        <?php endfor; ?>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🔒 Button-Texte</h2>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="button_text_yadore">Yadore-Produkte</label>
                    <input type="text" id="button_text_yadore" name="yaa_settings[button_text_yadore]" 
                           value="<?php echo esc_attr($options['button_text_yadore'] ?? 'Zum Angebot'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="button_text_amazon">Amazon-Produkte</label>
                    <input type="text" id="button_text_amazon" name="yaa_settings[button_text_amazon]" 
                           value="<?php echo esc_attr($options['button_text_amazon'] ?? 'Bei Amazon kaufen'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="button_text_custom">Eigene Produkte</label>
                    <input type="text" id="button_text_custom" name="yaa_settings[button_text_custom]" 
                           value="<?php echo esc_attr($options['button_text_custom'] ?? 'Zum Angebot'); ?>">
                </div>
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>👁️ Anzeige-Optionen</h2>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label>
                        <input type="checkbox" name="yaa_settings[show_prime_badge]" value="yes" 
                            <?php checked(($options['show_prime_badge'] ?? 'yes'), 'yes'); ?>>
                        Prime-Badge anzeigen (Amazon)
                    </label>
                </div>
                
                <div class="yaa-form-row">
                    <label>
                        <input type="checkbox" name="yaa_settings[show_merchant]" value="yes" 
                            <?php checked(($options['show_merchant'] ?? 'yes'), 'yes'); ?>>
                        Händlername anzeigen
                    </label>
                </div>
                
                <div class="yaa-form-row">
                    <label>
                        <input type="checkbox" name="yaa_settings[show_description]" value="yes" 
                            <?php checked(($options['show_description'] ?? 'yes'), 'yes'); ?>>
                        Beschreibung anzeigen
                    </label>
                </div>
                
                <div class="yaa-form-row">
                    <label>
                        <input type="checkbox" name="yaa_settings[show_custom_badge]" value="yes" 
                            <?php checked(($options['show_custom_badge'] ?? 'yes'), 'yes'); ?>>
                        Badge für eigene Produkte anzeigen
                    </label>
                </div>
            </div>
            
            <div class="yaa-form-row" style="margin-top: 15px;">
                <label for="custom_badge_text">Badge-Text für eigene Produkte</label>
                <input type="text" id="custom_badge_text" name="yaa_settings[custom_badge_text]" 
                       value="<?php echo esc_attr($options['custom_badge_text'] ?? 'Empfohlen'); ?>"
                       style="width: 200px;">
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🎨 Farben</h2>
            
            <div class="yaa-grid">
                <div class="yaa-form-row">
                    <label for="color_primary">Primärfarbe (Yadore)</label>
                    <input type="color" id="color_primary" name="yaa_settings[color_primary]" 
                           value="<?php echo esc_attr($options['color_primary'] ?? '#ff00cc'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="color_secondary">Sekundärfarbe</label>
                    <input type="color" id="color_secondary" name="yaa_settings[color_secondary]" 
                           value="<?php echo esc_attr($options['color_secondary'] ?? '#00ffff'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="color_amazon">Amazon-Farbe</label>
                    <input type="color" id="color_amazon" name="yaa_settings[color_amazon]" 
                           value="<?php echo esc_attr($options['color_amazon'] ?? '#ff9900'); ?>">
                </div>
                
                <div class="yaa-form-row">
                    <label for="color_custom">Eigene Produkte</label>
                    <input type="color" id="color_custom" name="yaa_settings[color_custom]" 
                           value="<?php echo esc_attr($options['color_custom'] ?? '#4CAF50'); ?>">
                </div>
            </div>
            
            <div class="yaa-tip" style="margin-top: 15px;">
                <strong>Hinweis:</strong> Farben werden als CSS Custom Properties (<code>--yaa-color-*</code>) ausgegeben 
                und können auch im Theme überschrieben werden.
            </div>
        </div>
        
        <div class="yaa-card">
            <h2>🔄 Plugin-Updates (GitHub)</h2>
            <p class="description">
                Das Plugin kann automatisch Updates von GitHub beziehen. Dafür ist ein Personal Access Token mit 
                <code>repo</code>-Berechtigung erforderlich (für private Repositories).
            </p>
            
            <div class="yaa-form-row">
                <label for="github_token">GitHub Personal Access Token</label>
                <input type="password" id="github_token" name="yaa_settings[github_token]" 
                       value="<?php echo esc_attr($options['github_token'] ?? ''); ?>"
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <p class="description">
                    <a href="https://github.com/settings/tokens/new?scopes=repo&description=YAA%20Plugin%20Updates" target="_blank" rel="noopener">
                        Token erstellen →
                    </a>
                </p>
            </div>
        </div>
        <?php
    }
}
 
Beginn des Codes C:\Users\rando\OneDrive\Dokumente\Websites\matthesv.de\yadore-amazon-api\includes\admin\class-admin-status.php 
 
<?php
/**
 * Admin Status Page
 * Cache & Status Übersicht + Dashboard Widget
 * PHP 8.3+ compatible
 * Version: 1.4.0
 */

declare(strict_types=1);

if (!defined('ABSPATH')) {
    exit;
}

final class YAA_Admin_Status {
    
    private YAA_Cache_Handler $cache;
    private YAA_Yadore_API $yadore_api;
    private YAA_Amazon_PAAPI $amazon_api;
    
    public function __construct(
        YAA_Cache_Handler $cache,
        YAA_Yadore_API $yadore_api,
        YAA_Amazon_PAAPI $amazon_api
    ) {
        $this->cache = $cache;
        $this->yadore_api = $yadore_api;
        $this->amazon_api = $amazon_api;
    }
    
    /**
     * Render status page
     */
    public function render_page(): void {
        global $wpdb;
        
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $cache_status = $this->cache->get_status();
        $cached_keywords = get_option('yaa_cached_keywords', []);
        if (!is_array($cached_keywords)) {
            $cached_keywords = [];
        }
        $next_cron = wp_next_scheduled('yaa_cache_refresh_event');
        
        $cache_count = (int) $wpdb->get_var(
            "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '_transient_yaa_%' AND option_name NOT LIKE '_transient_timeout_%'"
        );
        
        $image_stats = $this->get_local_image_stats();
        
        // CPC-Statistiken laden
        $cpc_stats = $this->yadore_api->get_cpc_statistics(yaa_get_option('yadore_market', 'de'));
        
        ?>
        <div class="wrap yaa-admin-wrap">
            <h1><?php esc_html_e('Cache & Status', 'yadore-amazon-api'); ?></h1>
            
            <div class="yaa-grid">
                <div class="yaa-card">
                    <h2>📊 Cache-Status</h2>
                    <table class="widefat striped">
                        <tr>
                            <td><strong>Backend:</strong></td>
                            <td>
                                <span class="yaa-status-badge <?php echo $cache_status['redis_available'] ? 'yaa-status-success' : 'yaa-status-warning'; ?>">
                                    <?php echo esc_html($cache_status['cache_backend']); ?>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Cache-Einträge:</strong></td>
                            <td><?php echo $cache_count; ?></td>
                        </tr>
                        <tr>
                            <td><strong>Getrackte Keywords:</strong></td>
                            <td><?php echo count($cached_keywords); ?></td>
                        </tr>
                        <tr>
                            <td><strong>Nächster Cron:</strong></td>
                            <td><?php echo $next_cron ? esc_html(date_i18n('d.m.Y H:i', $next_cron)) : 'Nicht geplant'; ?></td>
                        </tr>
                        <tr>
                            <td><strong>Lokale Bilder:</strong></td>
                            <td><?php echo (int) $image_stats['count']; ?> (<?php echo esc_html($image_stats['size']); ?>)</td>
                        </tr>
                        <tr>
                            <td><strong>Bildformat:</strong></td>
                            <td>
                                <?php 
                                $format = yaa_get_option('image_filename_format', 'seo');
                                echo $format === 'seo' ? '🔍 SEO-optimiert' : '🔢 Technisch (ID)';
                                ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Bildgröße:</strong></td>
                            <td><?php echo esc_html(yaa_get_option('preferred_image_size', 'Large')); ?></td>
                        </tr>
                    </table>
                    
                    <p style="margin-top: 15px;">
                        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin-post.php?action=yaa_clear_cache'), 'yaa_clear_cache_nonce')); ?>" 
                           class="button button-primary">
                            🗑️ Cache leeren
                        </a>
                        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin-post.php?action=yaa_clear_images'), 'yaa_clear_images_nonce')); ?>" 
                           class="button"
                           onclick="return confirm('Alle lokal gespeicherten Bilder löschen?');">
                            🖼️ Bilder löschen
                        </a>
                    </p>
                </div>
                
                <div class="yaa-card">
                    <h2>🔌 API-Status</h2>
                    <table class="widefat striped">
                        <tr>
                            <td><strong>Yadore API:</strong></td>
                            <td>
                                <?php if ($this->yadore_api->is_configured()): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Aktiv</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-error">❌ Nicht konfiguriert</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Amazon PA-API:</strong></td>
                            <td>
                                <?php if ($this->amazon_api->is_configured()): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Aktiv</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-error">❌ Nicht konfiguriert</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Redis:</strong></td>
                            <td>
                                <?php if ($cache_status['redis_available']): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Verbunden</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-warning">⚠️ Nicht verfügbar</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Lokale Bilder:</strong></td>
                            <td>
                                <?php if (yaa_get_option('enable_local_images', 'yes') === 'yes'): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Aktiviert</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-warning">⚠️ Deaktiviert</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Fuzzy-Suche:</strong></td>
                            <td>
                                <?php if (yaa_get_option('enable_fuzzy_search', 'yes') === 'yes'): ?>
                                    <span class="yaa-status-badge yaa-status-success">✅ Aktiviert</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-warning">⚠️ Deaktiviert</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Merchant Filter:</strong></td>
                            <td>
                                <?php 
                                $whitelist = yaa_get_option('yadore_merchant_whitelist', '');
                                $blacklist = yaa_get_option('yadore_merchant_blacklist', '');
                                if ($whitelist !== ''): ?>
                                    <span class="yaa-status-badge yaa-status-info">Whitelist aktiv</span>
                                <?php elseif ($blacklist !== ''): ?>
                                    <span class="yaa-status-badge yaa-status-warning">Blacklist aktiv</span>
                                <?php else: ?>
                                    <span class="yaa-status-badge yaa-status-info">Kein Filter</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- CPC-Statistiken -->
            <div class="yaa-card">
                <h2>💰 CPC-Statistiken (Yadore Deeplink-Händler)</h2>
                
                <?php if ($cpc_stats['total'] > 0): ?>
                    <div class="yaa-grid-4" style="margin: 20px 0;">
                        <div class="yaa-stat-box" style="background: #f0f6fc;">
                            <div class="yaa-stat-number" style="color: #2271b1;"><?php echo $cpc_stats['total']; ?></div>
                            <div class="yaa-stat-label">Deeplink-Händler gesamt</div>
                        </div>
                        <div class="yaa-stat-box" style="background: #d4edda;">
                            <div class="yaa-stat-number" style="color: #155724;"><?php echo $cpc_stats['with_cpc']; ?></div>
                            <div class="yaa-stat-label">Mit CPC-Daten</div>
                        </div>
                        <div class="yaa-stat-box" style="background: #fff3cd;">
                            <div class="yaa-stat-number" style="color: #856404;">
                                <?php echo number_format($cpc_stats['avg_cpc'], 4, ',', '.'); ?> €
                            </div>
                            <div class="yaa-stat-label">Durchschnitt CPC</div>
                        </div>
                        <div class="yaa-stat-box" style="background: #f0faf0;">
                            <div class="yaa-stat-number" style="color: #155724;">
                                <?php echo number_format($cpc_stats['max_cpc'], 4, ',', '.'); ?> €
                            </div>
                            <div class="yaa-stat-label">Höchster CPC</div>
                        </div>
                    </div>
                    
                    <p>
                        <a href="<?php echo esc_url(admin_url('admin.php?page=yaa-merchants')); ?>" class="button button-primary">
                            📊 Händlerübersicht mit CPC öffnen
                        </a>
                    </p>
                <?php else: ?>
                    <p>
                        Keine Deeplink-Händler-Daten vorhanden. 
                        <a href="<?php echo esc_url(admin_url('admin.php?page=yaa-merchants')); ?>">Händlerübersicht öffnen</a> und Daten laden.
                    </p>
                <?php endif; ?>
            </div>
            
            <div class="yaa-card">
                <h2>🛠️ System-Informationen</h2>
                <table class="widefat striped">
                    <tr>
                        <td><strong>PHP Version:</strong></td>
                        <td><?php echo esc_html(PHP_VERSION); ?>
                            <?php if (version_compare(PHP_VERSION, '8.1', '>=')): ?>
                                <span class="yaa-status-badge yaa-status-success">✓</span>
                            <?php else: ?>
                                <span class="yaa-status-badge yaa-status-error">Minimum 8.1 erforderlich</span>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>WordPress Version:</strong></td>
                        <td><?php echo esc_html(get_bloginfo('version')); ?></td>
                    </tr>
                    <tr>
                        <td><strong>Plugin Version:</strong></td>
                        <td><?php echo esc_html(YAA_VERSION); ?></td>
                    </tr>
                    <tr>
                        <td><strong>PHP Redis Extension:</strong></td>
                        <td>
                            <?php if (extension_loaded('redis')): ?>
                                <span class="yaa-status-badge yaa-status-success">✅ Installiert</span>
                            <?php else: ?>
                                <span class="yaa-status-badge yaa-status-warning">Nicht installiert</span>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Bildverarbeitung:</strong></td>
                        <td>
                            <?php 
                            $image_library = class_exists('YAA_Image_Handler') ? YAA_Image_Handler::get_image_library() : 'Unknown';
                            if ($image_library !== 'None'): ?>
                                <span class="yaa-status-badge yaa-status-success">✅ <?php echo esc_html($image_library); ?></span>
                            <?php else: ?>
                                <span class="yaa-status-badge yaa-status-warning">Nicht verfügbar</span>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Bild-Verzeichnis:</strong></td>
                        <td>
                            <?php 
                            $upload_dir = wp_upload_dir();
                            $image_dir = $upload_dir['basedir'] . '/yadore-amazon-api';
                            if (is_dir($image_dir) && is_writable($image_dir)): ?>
                                <span class="yaa-status-badge yaa-status-success">✅ Beschreibbar</span>
                                <code style="margin-left: 10px;"><?php echo esc_html($image_dir); ?></code>
                            <?php elseif (is_dir($image_dir)): ?>
                                <span class="yaa-status-badge yaa-status-error">❌ Nicht beschreibbar</span>
                            <?php else: ?>
                                <span class="yaa-status-badge yaa-status-info">📁 Wird bei Bedarf erstellt</span>
                            <?php endif; ?>
                        </td>
                    </tr>
                </table>
            </div>
            
            <!-- Top CPC Händler -->
            <?php 
            $top_merchants = $this->yadore_api->get_merchants_by_cpc(yaa_get_option('yadore_market', 'de'), 10);
            if (!empty($top_merchants)):
            ?>
            <div class="yaa-card">
                <h2>🏆 Top 10 Händler nach CPC</h2>
                <table class="widefat striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Händler</th>
                            <th>CPC</th>
                            <th>Smartlink</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($top_merchants as $index => $merchant): ?>
                        <tr>
                            <td><?php echo $index + 1; ?></td>
                            <td><strong><?php echo esc_html($merchant['name']); ?></strong></td>
                            <td>
                                <span class="yaa-status-badge yaa-status-success">
                                    <?php echo number_format($merchant['cpc_amount'], 4, ',', '.'); ?> €
                                </span>
                            </td>
                            <td>
                                <?php if ($merchant['is_smartlink']): ?>
                                    <span class="yaa-status-badge yaa-status-info">Ja</span>
                                <?php else: ?>
                                    —
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <?php endif; ?>
        </div>
        <?php
    }
    
    /**
     * Dashboard widget content
     */
    public function render_dashboard_widget(): void {
        $cache_status = $this->cache->get_status();
        $next_cron = wp_next_scheduled('yaa_cache_refresh_event');
        $image_stats = $this->get_local_image_stats();
        
        echo '<table class="widefat striped" style="border:none;">';
        echo '<tr><td>Yadore API:</td><td>' . ($this->yadore_api->is_configured() ? '✅ Aktiv' : '❌') . '</td></tr>';
        echo '<tr><td>Amazon PA-API:</td><td>' . ($this->amazon_api->is_configured() ? '✅ Aktiv' : '❌') . '</td></tr>';
        echo '<tr><td>Cache:</td><td>' . esc_html($cache_status['cache_backend']) . '</td></tr>';
        echo '<tr><td>Lokale Bilder:</td><td>' . (int) $image_stats['count'] . ' (' . esc_html($image_stats['size']) . ')</td></tr>';
        echo '<tr><td>Nächster Cron:</td><td>' . ($next_cron ? esc_html(date_i18n('d.m.Y H:i', $next_cron)) : '-') . '</td></tr>';
        echo '</table>';
        
        echo '<p style="margin-top:15px;">';
        echo '<a href="' . esc_url(admin_url('admin.php?page=yaa-settings')) . '" class="button">⚙️ Einstellungen</a> ';
        echo '<a href="' . esc_url(admin_url('admin.php?page=yaa-merchants')) . '" class="button">🏪 Händler</a> ';
        echo '<a href="' . esc_url(admin_url('admin.php?page=yaa-status')) . '" class="button">📊 Status</a>';
        echo '</p>';
    }
    
    /**
     * Get local image statistics
     * 
     * @return array{count: int, size: string}
     */
    private function get_local_image_stats(): array {
        $upload_dir = wp_upload_dir();
        $image_dir = $upload_dir['basedir'] . '/yadore-amazon-api';
        
        $count = 0;
        $total_size = 0;
        
        if (is_dir($image_dir)) {
            $files = glob($image_dir . '/*');
            if ($files !== false) {
                $count = count($files);
                foreach ($files as $file) {
                    if (is_file($file)) {
                        $total_size += filesize($file);
                    }
                }
            }
        }
        
        if ($total_size < 1024) {
            $size = $total_size . ' B';
        } elseif ($total_size < 1024 * 1024) {
            $size = round($total_size / 1024, 1) . ' KB';
        } else {
            $size = round($total_size / (1024 * 1024), 2) . ' MB';
        }
        
        return ['count' => $count, 'size' => $size];
    }
}
 
