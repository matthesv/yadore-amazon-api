(function(){'use strict';document.addEventListener('DOMContentLoaded',function(){initReadMoreButtons();initLazyLoadImages();initAccessibilityEnhancements();initImageErrorHandling()});function initReadMoreButtons(){var buttons=document.querySelectorAll('.yaa-read-more');buttons.forEach(function(button){button.addEventListener('click',handleReadMoreClick);button.addEventListener('keydown',handleReadMoreKeydown)})}
function handleReadMoreClick(event){event.preventDefault();var button=event.currentTarget;var targetId=button.getAttribute('data-target');var description=document.getElementById('desc-'+targetId);if(!description){return}
toggleDescription(description,button)}
function handleReadMoreKeydown(event){if(event.key==='Enter'||event.key===' '){event.preventDefault();handleReadMoreClick(event)}}
function toggleDescription(description,button){var isExpanded=description.classList.contains('expanded');var expandText=button.getAttribute('data-expand-text')||'mehr lesen';var collapseText=button.getAttribute('data-collapse-text')||'weniger';if(isExpanded){description.classList.remove('expanded');button.classList.remove('expanded');button.textContent=expandText;button.setAttribute('aria-expanded','false')}else{description.classList.add('expanded');button.classList.add('expanded');button.textContent=collapseText;button.setAttribute('aria-expanded','true')}}
function initLazyLoadImages(){if('loading' in HTMLImageElement.prototype){return}
var images=document.querySelectorAll('.yaa-image-wrapper img[loading="lazy"]');if(images.length===0){return}
if('IntersectionObserver' in window){var imageObserver=new IntersectionObserver(function(entries,observer){entries.forEach(function(entry){if(entry.isIntersecting){var image=entry.target;if(image.dataset.src){image.src=image.dataset.src;image.removeAttribute('data-src')}
observer.unobserve(image)}})},{rootMargin:'50px 0px',threshold:0.01});images.forEach(function(image){imageObserver.observe(image)})}}
function initImageErrorHandling(){var images=document.querySelectorAll('.yaa-image-wrapper img');images.forEach(function(img){if(!img.hasAttribute('data-fallback-attempted')){img.setAttribute('data-fallback-attempted','false')}
var currentSrc=img.getAttribute('src')||'';var proxySrc=img.getAttribute('data-proxy-src')||'';var originalSrc=img.getAttribute('data-original-src')||'';if(currentSrc===''||currentSrc===window.location.href){if(proxySrc!==''){if(window.console){console.log('YAA: Empty src detected, using proxy:',proxySrc)}
img.setAttribute('data-fallback-attempted','proxy');img.src=proxySrc;return}else if(originalSrc!==''){if(window.console){console.log('YAA: Empty src detected, using original:',originalSrc)}
img.setAttribute('data-fallback-attempted','original');img.src=originalSrc;return}}
if(img.complete){if(img.naturalWidth===0||img.naturalHeight===0){attemptImageFallback(img)}else{img.classList.add('yaa-img-loaded')}}
img.addEventListener('load',function(){img.classList.add('yaa-img-loaded');img.classList.remove('yaa-img-loading')});img.addEventListener('error',function(){attemptImageFallback(img)})})}
function attemptImageFallback(img){var wrapper=img.closest('.yaa-image-wrapper');if(!wrapper){return}
if(!img.hasAttribute('referrerpolicy')){img.setAttribute('referrerpolicy','no-referrer')}
var fallbackAttempted=img.getAttribute('data-fallback-attempted');var thumbnailUrl=img.getAttribute('data-thumbnail');var originalSrc=img.getAttribute('data-original-src')||img.src;var shopLogoUrl=img.getAttribute('data-shop-logo');if(!img.hasAttribute('data-original-src')){img.setAttribute('data-original-src',img.src)}
if(fallbackAttempted==='false'&&thumbnailUrl&&thumbnailUrl!==''&&thumbnailUrl!==originalSrc){if(window.console){console.log('YAA: Original image failed, trying thumbnail:',thumbnailUrl)}
img.setAttribute('data-fallback-attempted','thumbnail');img.classList.add('yaa-img-loading');img.src=thumbnailUrl;return}
if(fallbackAttempted==='thumbnail'||(fallbackAttempted==='false'&&!thumbnailUrl)){if(isProxyEnabled()){var proxyUrl=img.getAttribute('data-proxy-src')||getProxyUrl(originalSrc);if(proxyUrl&&proxyUrl!==''){if(window.console){console.log('YAA: Trying server-side proxy for:',originalSrc)}
img.setAttribute('data-fallback-attempted','proxy');img.classList.add('yaa-img-loading');img.src=proxyUrl;return}}
img.setAttribute('data-fallback-attempted','proxy-skipped')}
if(fallbackAttempted==='proxy'||fallbackAttempted==='proxy-skipped'||(fallbackAttempted==='false'&&!thumbnailUrl&&!isProxyEnabled())){if(shopLogoUrl&&shopLogoUrl!==''){if(window.console){console.log('YAA: Trying shop logo as fallback:',shopLogoUrl)}
img.setAttribute('data-fallback-attempted','shop-logo');img.classList.add('yaa-img-loading');img.classList.add('yaa-shop-logo-fallback');img.src=shopLogoUrl;return}}
if(fallbackAttempted==='false'||fallbackAttempted==='thumbnail'||fallbackAttempted==='proxy'||fallbackAttempted==='proxy-skipped'||fallbackAttempted==='shop-logo'){if(window.console){var reason='Unknown';if(fallbackAttempted==='shop-logo'){reason='Shop logo also failed'}else if(fallbackAttempted==='proxy'){reason='Proxy failed, no shop logo available'}else if(fallbackAttempted==='thumbnail'){reason='Thumbnail failed, no proxy/shop logo available'}else{reason='No fallbacks available'}
console.warn('YAA: '+reason+', showing placeholder for:',originalSrc)}
img.setAttribute('data-fallback-attempted','complete');showCSSPlaceholder(img,wrapper)}}
function isProxyEnabled(){if(typeof window.yaaProxy!=='undefined'&&window.yaaProxy.enabled){return!0}
return!1}
function getProxyUrl(originalUrl){if(!originalUrl||originalUrl===''){return null}
if(originalUrl.indexOf(window.location.origin)===0){return null}
if(originalUrl.indexOf('data:')===0){return null}
if(originalUrl.indexOf('action=yaa_proxy_image')!==-1){return null}
if(typeof window.yaaProxy!=='undefined'&&window.yaaProxy.endpoint){var params=new URLSearchParams();params.append('action',window.yaaProxy.action||'yaa_proxy_image');params.append('url',originalUrl);return window.yaaProxy.endpoint+'?'+params.toString()}
return null}
function showCSSPlaceholder(img,wrapper){if(wrapper.classList.contains('yaa-image-error')){return}
wrapper.classList.add('yaa-image-error');img.style.display='none';img.style.visibility='hidden';img.classList.remove('yaa-img-loading');img.classList.remove('yaa-shop-logo-fallback');if(wrapper.querySelector('.yaa-placeholder')){return}
var placeholder=document.createElement('div');placeholder.className='yaa-placeholder';placeholder.setAttribute('aria-hidden','true');placeholder.setAttribute('role','img');placeholder.setAttribute('aria-label','Bild nicht verfügbar');var item=wrapper.closest('.yaa-item');if(item){if(item.classList.contains('yaa-amazon')){placeholder.classList.add('yaa-placeholder-amazon')}else if(item.classList.contains('yaa-custom')){placeholder.classList.add('yaa-placeholder-custom')}else if(item.classList.contains('yaa-yadore')){placeholder.classList.add('yaa-placeholder-yadore')}}
var link=wrapper.querySelector('a');if(link){link.appendChild(placeholder)}else{wrapper.appendChild(placeholder)}}
function handleBrokenImage(img){attemptImageFallback(img)}
function initAccessibilityEnhancements(){var buttons=document.querySelectorAll('.yaa-read-more');buttons.forEach(function(button){if(!button.hasAttribute('aria-expanded')){button.setAttribute('aria-expanded','false')}
if(!button.hasAttribute('role')){button.setAttribute('role','button')}
if(!button.hasAttribute('tabindex')){button.setAttribute('tabindex','0')}});var productLinks=document.querySelectorAll('.yaa-item .yaa-title a, .yaa-item .yaa-button');productLinks.forEach(function(link){if(link.hasAttribute('target')&&link.getAttribute('target')==='_blank'){if(!link.querySelector('.screen-reader-text')){var srText=document.createElement('span');srText.className='screen-reader-text';srText.textContent=' (öffnet in neuem Tab)';srText.style.cssText='position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;';link.appendChild(srText)}}})}
window.YAA=window.YAA||{};window.YAA.toggleDescription=function(id){var description=document.getElementById('desc-'+id);var button=description?description.parentElement.querySelector('.yaa-read-more'):null;if(description&&button){toggleDescription(description,button)}};window.YAA.refresh=function(){initReadMoreButtons();initLazyLoadImages();initAccessibilityEnhancements();initImageErrorHandling()};window.YAA.checkImages=function(){initImageErrorHandling()};window.YAA.recheckImage=function(img){if(img&&img.tagName==='IMG'){img.setAttribute('data-fallback-attempted','false');if(img.complete&&(img.naturalWidth===0||img.naturalHeight===0)){attemptImageFallback(img)}}};window.YAA.tryThumbnail=function(img){if(!img||img.tagName!=='IMG'){return!1}
var thumbnailUrl=img.getAttribute('data-thumbnail');if(thumbnailUrl&&thumbnailUrl!==''){img.setAttribute('data-fallback-attempted','false');attemptImageFallback(img);return!0}
return!1};window.YAA.tryProxy=function(img){if(!img||img.tagName!=='IMG'){return!1}
if(!isProxyEnabled()){if(window.console){console.warn('YAA: Image proxy is not enabled')}
return!1}
var originalSrc=img.getAttribute('data-original-src')||img.src;var proxyUrl=getProxyUrl(originalSrc);if(proxyUrl){img.setAttribute('data-fallback-attempted','proxy');img.src=proxyUrl;return!0}
return!1};window.YAA.tryShopLogo=function(img){if(!img||img.tagName!=='IMG'){return!1}
var shopLogoUrl=img.getAttribute('data-shop-logo');if(shopLogoUrl&&shopLogoUrl!==''){img.setAttribute('data-fallback-attempted','shop-logo');img.classList.add('yaa-shop-logo-fallback');img.src=shopLogoUrl;return!0}
if(window.console){console.warn('YAA: No shop logo available for this image')}
return!1};window.YAA.getProxyUrl=function(imageUrl){return getProxyUrl(imageUrl)};window.YAA.isProxyEnabled=function(){return isProxyEnabled()};window.YAA.getProductData=function(item){if(!item||!item.classList.contains('yaa-item')){return null}
var titleElement=item.querySelector('.yaa-title a');var priceElement=item.querySelector('.yaa-price');var merchantElement=item.querySelector('.yaa-merchant');var imageElement=item.querySelector('.yaa-image-wrapper img');var wrapper=item.querySelector('.yaa-image-wrapper');return{title:titleElement?titleElement.textContent.trim():'',url:titleElement?titleElement.href:'',price:priceElement?priceElement.textContent.trim():'',merchant:merchantElement?merchantElement.textContent.replace('via ','').trim():'',image:imageElement?imageElement.src:'',originalImage:imageElement?imageElement.getAttribute('data-original-src'):'',thumbnail:imageElement?imageElement.getAttribute('data-thumbnail'):'',shopLogo:imageElement?imageElement.getAttribute('data-shop-logo'):'',proxyUrl:imageElement?getProxyUrl(imageElement.getAttribute('data-original-src')||imageElement.src):'',isAmazon:item.classList.contains('yaa-amazon'),isCustom:item.classList.contains('yaa-custom'),isYadore:item.classList.contains('yaa-yadore'),isPrime:item.querySelector('.yaa-prime-badge')!==null,hasImageError:wrapper?wrapper.classList.contains('yaa-image-error'):!1,imageLoaded:imageElement?imageElement.classList.contains('yaa-img-loaded'):!1,isShowingShopLogo:imageElement?imageElement.classList.contains('yaa-shop-logo-fallback'):!1,fallbackAttempted:imageElement?imageElement.getAttribute('data-fallback-attempted'):null}};window.YAA.getAllProducts=function(container){var containerEl=container;if(typeof container==='string'){containerEl=document.querySelector(container)}
if(!containerEl){containerEl=document}
var items=containerEl.querySelectorAll('.yaa-item');var products=[];items.forEach(function(item){var data=window.YAA.getProductData(item);if(data){products.push(data)}});return products};window.YAA.getBrokenImageCount=function(){return document.querySelectorAll('.yaa-image-wrapper.yaa-image-error').length};window.YAA.getLoadingThumbnailCount=function(){return document.querySelectorAll('.yaa-image-wrapper img[data-fallback-attempted="thumbnail"]').length};window.YAA.getProxyImageCount=function(){return document.querySelectorAll('.yaa-image-wrapper img[data-fallback-attempted="proxy"]').length};window.YAA.getShopLogoCount=function(){return document.querySelectorAll('.yaa-image-wrapper img.yaa-shop-logo-fallback').length};window.YAA.getImageStats=function(){var images=document.querySelectorAll('.yaa-image-wrapper img');var loaded=0;var broken=0;var loadingThumbnail=0;var loadingProxy=0;var showingShopLogo=0;var hasThumbnail=0;var hasProxy=0;var hasShopLogo=0;images.forEach(function(img){if(img.classList.contains('yaa-img-loaded')){loaded++}
if(img.classList.contains('yaa-shop-logo-fallback')){showingShopLogo++}
var fallbackState=img.getAttribute('data-fallback-attempted');if(fallbackState==='complete'){broken++}else if(fallbackState==='thumbnail'){loadingThumbnail++}else if(fallbackState==='proxy'){loadingProxy++}
if(img.getAttribute('data-thumbnail')){hasThumbnail++}
if(img.getAttribute('data-shop-logo')){hasShopLogo++}
var originalSrc=img.getAttribute('data-original-src')||img.src;if(getProxyUrl(originalSrc)){hasProxy++}});return{total:images.length,loaded:loaded,broken:broken,loadingThumbnail:loadingThumbnail,loadingProxy:loadingProxy,showingShopLogo:showingShopLogo,withThumbnailFallback:hasThumbnail,withProxyAvailable:hasProxy,withShopLogoAvailable:hasShopLogo,proxyEnabled:isProxyEnabled()}}})()